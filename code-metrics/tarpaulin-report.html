<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <style>html, body {
  margin: 0;
  padding: 0;
}

.app {
  margin: 10px;
  padding: 0;
}

.files-list {
  margin: 10px 0 0;
  width: 100%;
  border-collapse: collapse;
}
.files-list__head {
  border: 1px solid #999;
}
.files-list__head > tr > th {
  padding: 10px;
  border: 1px solid #999;
  text-align: left;
  font-weight: normal;
  background: #ddd;
}
.files-list__body {
}
.files-list__file {
  cursor: pointer;
}
.files-list__file:hover {
  background: #ccf;
}
.files-list__file > td {
  padding: 10px;
  border: 1px solid #999;
}
.files-list__file > td:first-child::before {
  content: '\01F4C4';
  margin-right: 1em;
}
.files-list__file_low {
  background: #fcc;
}
.files-list__file_medium {
  background: #ffc;
}
.files-list__file_high {
  background: #cfc;
}
.files-list__file_folder > td:first-child::before {
  content: '\01F4C1';
  margin-right: 1em;
}

.file-header {
  border: 1px solid #999;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  background: white;
}

.file-header__back {
  margin: 10px;
  cursor: pointer;
  flex-shrink: 0;
  flex-grow: 0;
  text-decoration: underline;
  color: #338;
}

.file-header__name {
  margin: 10px;
  flex-shrink: 2;
  flex-grow: 2;
}

.file-header__stat {
  margin: 10px;
  flex-shrink: 0;
  flex-grow: 0;
}

.file-content {
  margin: 10px 0 0;
  border: 1px solid #999;
  padding: 10px;
  counter-reset: line;
  display: flex;
  flex-direction: column;
}

.code-line::before {
    content: counter(line);
    margin-right: 10px;
}
.code-line {
  margin: 0;
  padding: 0.3em;
  height: 1em;
  counter-increment: line;
}
.code-line_covered {
  background: #cfc;
}
.code-line_uncovered {
  background: #fcc;
}
</style>
</head>
<body>
    <div id="root"></div>
    <script>
        var data = {"files":[{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","examples","Q42.rs"],"content":"use wikibase_rest_api::prelude::*;\n\n#[cfg(not(tarpaulin_include))]\n#[tokio::main]\nasync fn main() -\u003e Result\u003c(), RestApiError\u003e {\n    // #lizard forgives the complexity\n\n    // Use the Wikidata API\n    let api = RestApi::wikidata()?;\n\n    // Use Q42 as an example item\n    let id_q42 = EntityId::new(\"Q42\")?;\n\n    // Get the label and sitelink of Q42\n    let q42_label_en = Label::get(\u0026id_q42, \"en\", \u0026api).await?.value().to_owned();\n    let q42_sitelink = Sitelink::get(\u0026id_q42, \"enwiki\", \u0026api)\n        .await?\n        .title()\n        .to_owned();\n    println!(\"Q42 '{q42_label_en}' =\u003e [[enwiki:{q42_sitelink}]]\");\n\n    // Get the statements of Q42\n    let statements = Statements::get(\u0026id_q42, \u0026api).await?;\n    for statement in statements.property(\"P31\") {\n        if let StatementValue::Value(StatementValueContent::String(id)) = statement.value() {\n            let label = Label::get(\u0026EntityId::Item(id.to_owned()), \"en\", \u0026api)\n                .await?\n                .value()\n                .to_owned();\n            println!(\"{q42_label_en} ([[Q42]]) is a {label} ([[{id}]])\");\n        }\n    }\n\n    Ok(())\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","examples","container.rs"],"content":"use std::sync::Arc;\nuse wikibase_rest_api::prelude::*;\n\n#[cfg(not(tarpaulin_include))]\n#[tokio::main]\nasync fn main() -\u003e Result\u003c(), RestApiError\u003e {\n    // #lizard forgives the complexity\n    let api = RestApi::builder(\"https://www.wikidata.org/w/rest.php\")?.build();\n    let api = Arc::new(api);\n\n    // Load several items at once\n    // Try to load some items, and a property; Q6, Q7, and Q9 do not exist though.\n    // They will be silently ignored.\n    let entity_ids = [\n        \"Q42\", \"Q1\", \"Q2\", \"Q3\", \"Q4\", \"Q5\", \"Q6\", \"Q7\", \"Q8\", \"Q9\", \"P214\",\n    ]\n    .iter()\n    .map(|id| EntityId::new(*id))\n    .collect::\u003cResult\u003cVec\u003c_\u003e, RestApiError\u003e\u003e()?;\n\n    let entity_container = EntityContainer::builder()\n        .api(api)\n        .max_concurrent(5)\n        .build()?;\n    println!(\"Trying to load {} items\u0026properties\", entity_ids.len());\n    entity_container.load(\u0026entity_ids).await?;\n    println!(\n        \"Loaded {} items\",\n        entity_container.items().read().await.len()\n    );\n    println!(\n        \"Loaded {} properties\",\n        entity_container.properties().read().await.len()\n    );\n    println!(\n        \"Items loaded: {:?}\",\n        entity_container.items().read().await.keys()\n    );\n    println!(\n        \"Properties loaded: {:?}\",\n        entity_container.properties().read().await.keys()\n    );\n\n    // Access item info from the container\n    let q42 = entity_container\n        .items()\n        .read()\n        .await\n        .get(\"Q42\")\n        .ok_or_else(|| RestApiError::IsNone)?\n        .to_owned();\n    let q42_label_en = q42\n        .labels()\n        .get_lang(\"en\")\n        .ok_or_else(|| RestApiError::IsNone)?;\n    println!(\"Container item Q42 label is '{q42_label_en}'\");\n\n    Ok(())\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","examples","create_item.rs"],"content":"use wikibase_rest_api::prelude::*;\n\n#[cfg(not(tarpaulin_include))]\n#[tokio::main]\nasync fn main() -\u003e Result\u003c(), RestApiError\u003e {\n    // #lizard forgives the complexity\n    // let token = \"MY_ACCESS_TOKEN\";\n    let api = RestApi::builder(\"https://test.wikidata.org/w/rest.php\")?\n        // .with_access_token(token)\n        .build();\n    let mut item = Item::default();\n    item.labels_mut()\n        .insert(LanguageString::new(\"en\", \"My label\"));\n    item.descriptions_mut()\n        .insert(LanguageString::new(\"en\", \"My description123\"));\n    item.statements_mut()\n        .insert(Statement::new_string(\"P31\", \"Q13406268\"));\n    let item = item.post(\u0026api).await?;\n    println!(\n        \"Created new item https://test.wikidata.org/wiki/{}\",\n        item.id()\n    );\n\n    Ok(())\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","aliases.rs"],"content":"use crate::{\n    aliases_patch::AliasesPatch, prelude::LanguageStrings, EntityId, FromJson, HeaderInfo,\n    LanguageString, RestApi, RestApiError, RevisionMatch,\n};\nuse derivative::Derivative;\nuse reqwest::StatusCode;\nuse serde::ser::{Serialize, SerializeMap};\nuse serde_json::{json, Value};\nuse std::collections::HashMap;\n\n#[derive(Derivative, Debug, Clone, Default)]\n#[derivative(PartialEq)]\npub struct Aliases {\n    ls: HashMap\u003cString, Vec\u003cString\u003e\u003e,\n    #[derivative(PartialEq = \"ignore\")]\n    header_info: HeaderInfo,\n}\n\nimpl Aliases {\n    /// Creates a new `Aliases` struct for the given entity ID.\n    /// If the API cannot find anything, the `Aliases` struct will be empty.\n    pub async fn get_match(\n        id: \u0026EntityId,\n        api: \u0026RestApi,\n        rm: RevisionMatch,\n    ) -\u003e Result\u003cSelf, RestApiError\u003e {\n        let response = Self::get_match_response(id, api, rm).await?;\n\n        let header_info = HeaderInfo::from_header(response.headers());\n        let ls = Self::get_match_check_response(response).await?;\n        Ok(Self { ls, header_info })\n    }\n\n    /// Creates a new `Aliases` struct for the given entity ID.\n    /// If the API cannot find anything, the `Aliases` struct will be empty.\n    pub async fn get(id: \u0026EntityId, api: \u0026RestApi) -\u003e Result\u003cSelf, RestApiError\u003e {\n        Self::get_match(id, api, RevisionMatch::default()).await\n    }\n\n    /// Returns the list of values for a language\n    pub fn get_lang\u003cS: Into\u003cString\u003e\u003e(\u0026self, language: S) -\u003e Vec\u003c\u0026str\u003e {\n        self.ls\n            .get(\u0026language.into())\n            .map_or_else(Vec::new, |v| v.iter().map(|s| s.as_str()).collect())\n    }\n\n    /// Returns the list of values for a language, mutable\n    pub fn get_lang_mut\u003cS: Into\u003cString\u003e\u003e(\u0026mut self, language: S) -\u003e \u0026mut Vec\u003cString\u003e {\n        self.ls.entry(language.into()).or_default()\n    }\n\n    /// Generates a patch to transform `other` into `self`\n    pub fn patch(\u0026self, other: \u0026Self) -\u003e Result\u003cAliasesPatch, RestApiError\u003e {\n        let patch = json_patch::diff(\u0026json!(\u0026other), \u0026json!(\u0026self));\n        let patch = AliasesPatch::from_json(\u0026json!(patch))?;\n        Ok(patch)\n    }\n\n    /// Returns the number of languages\n    pub fn len(\u0026self) -\u003e usize {\n        self.ls.len()\n    }\n\n    /// Returns true if there are no language strings\n    pub fn is_empty(\u0026self) -\u003e bool {\n        self.ls.is_empty()\n    }\n\n    fn from_json_header_info_part(\n        language: \u0026str,\n        values: \u0026[Value],\n    ) -\u003e Result\u003c(String, Vec\u003cString\u003e), RestApiError\u003e {\n        let values = values\n            .iter()\n            .map(|v| {\n                Ok(v.as_str()\n                    .ok_or_else(|| RestApiError::MissingOrInvalidField {\n                        field: \"LanguageStringsMultiple\".into(),\n                        j: v.to_owned(),\n                    })?\n                    .to_string())\n            })\n            .collect::\u003cResult\u003cVec\u003cString\u003e, RestApiError\u003e\u003e()?;\n        Ok((language.to_owned(), values))\n    }\n\n    async fn get_match_response(\n        id: \u0026EntityId,\n        api: \u0026RestApi,\n        rm: RevisionMatch,\n    ) -\u003e Result\u003creqwest::Response, RestApiError\u003e {\n        let path = format!(\"/entities/{group}/{id}/aliases\", group = id.group()?);\n        let mut request = api\n            .wikibase_request_builder(\u0026path, HashMap::new(), reqwest::Method::GET)\n            .await?\n            .build()?;\n        rm.modify_headers(request.headers_mut())?;\n        let response = api.execute(request).await?;\n        Ok(response)\n    }\n\n    async fn get_match_check_response(\n        response: reqwest::Response,\n    ) -\u003e Result\u003cHashMap\u003cString, Vec\u003cString\u003e\u003e, RestApiError\u003e {\n        let ls: HashMap\u003cString, Vec\u003cString\u003e\u003e = match response.error_for_status() {\n            Ok(response) =\u003e response.json().await?,\n            Err(e) =\u003e {\n                if e.status() == Some(StatusCode::NOT_FOUND) {\n                    HashMap::new()\n                } else {\n                    return Err(e.into());\n                }\n            }\n        };\n        Ok(ls)\n    }\n}\n\nimpl FromJson for Aliases {\n    fn header_info(\u0026self) -\u003e \u0026HeaderInfo {\n        \u0026self.header_info\n    }\n\n    fn from_json_header_info(j: \u0026Value, header_info: HeaderInfo) -\u003e Result\u003cSelf, RestApiError\u003e {\n        let ls = j\n            .as_object()\n            .ok_or_else(|| RestApiError::MissingOrInvalidField {\n                field: \"LanguageStringsMultiple\".into(),\n                j: j.to_owned(),\n            })?\n            .iter()\n            .map(|(language, value)| {\n                value.as_array().map_or_else(\n                    || {\n                        Err(RestApiError::MissingOrInvalidField {\n                            field: \"LanguageStringsMultiple\".into(),\n                            j: value.to_owned(),\n                        })\n                    },\n                    |v| Self::from_json_header_info_part(language, v),\n                )\n            })\n            .collect::\u003cResult\u003cHashMap\u003cString, Vec\u003cString\u003e\u003e, RestApiError\u003e\u003e()?;\n        let ret = Self { ls, header_info };\n        Ok(ret)\n    }\n}\n\nimpl LanguageStrings for Aliases {\n    fn has_language\u003cS: Into\u003cString\u003e\u003e(\u0026self, language: S) -\u003e bool {\n        self.ls.contains_key(\u0026language.into())\n    }\n\n    fn insert(\u0026mut self, ls: LanguageString) {\n        let entry = self.ls.entry(ls.language().to_string()).or_default();\n        if !entry.contains(ls.value()) {\n            entry.push(ls.value().to_owned());\n        }\n    }\n}\n\nimpl Serialize for Aliases {\n    fn serialize\u003cS\u003e(\u0026self, serializer: S) -\u003e Result\u003cS::Ok, S::Error\u003e\n    where\n        S: serde::Serializer,\n    {\n        let mut s = serializer.serialize_map(Some(self.ls.len()))?;\n        for (language, values) in \u0026self.ls {\n            s.serialize_entry(language, \u0026values)?;\n        }\n        s.end()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use serde_json::json;\n    use wiremock::matchers::{method, path};\n    use wiremock::{Mock, MockServer, ResponseTemplate};\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_aliases_get() {\n        let v = std::fs::read_to_string(\"test_data/Q42.json\").unwrap();\n        let v: Value = serde_json::from_str(\u0026v).unwrap();\n        let id = v[\"id\"].as_str().unwrap();\n        let v: Value = v[\"aliases\"].clone();\n\n        let mock_path = format!(\"/w/rest.php/wikibase/v1/entities/items/{id}/aliases\");\n        let mock_server = MockServer::start().await;\n        Mock::given(method(\"GET\"))\n            .and(path(\u0026mock_path))\n            .respond_with(ResponseTemplate::new(200).set_body_json(\u0026v))\n            .mount(\u0026mock_server)\n            .await;\n        let api = RestApi::builder(\u0026(mock_server.uri() + \"/w/rest.php\"))\n            .unwrap()\n            .build();\n\n        let sitelinks = Aliases::get(\u0026EntityId::item(\"Q42\"), \u0026api).await.unwrap();\n        assert_eq!(sitelinks.ls.len(), 64);\n        assert_eq!(sitelinks.get_lang(\"tok\")[0], \"jan Takala Atan\");\n    }\n\n    #[test]\n    fn test_aliases() {\n        let j = json!({\n            \"en\": [\"Hello\", \"Hi\"],\n            \"de\": [\"Hallo\", \"Hi\"],\n        });\n        let ls = Aliases::from_json(\u0026j).unwrap();\n        assert_eq!(ls.get_lang(\"en\"), vec![\"Hello\", \"Hi\"]);\n        assert_eq!(ls.get_lang(\"de\"), vec![\"Hallo\", \"Hi\"]);\n        assert!(ls.get_lang(\"fr\").is_empty());\n    }\n\n    #[test]\n    fn test_aliases_insert() {\n        let mut ls = Aliases::default();\n        ls.insert(LanguageString::new(\"en\", \"Hello\"));\n        ls.insert(LanguageString::new(\"de\", \"Hallo\"));\n        ls.insert(LanguageString::new(\"en\", \"Hi\"));\n        assert_eq!(ls.get_lang(\"en\"), vec![\"Hello\", \"Hi\"]);\n        assert_eq!(ls.get_lang(\"de\"), vec![\"Hallo\"]);\n    }\n\n    #[test]\n    fn test_patch_aliases() {\n        let mut l1 = Aliases::default();\n        l1.insert(LanguageString::new(\"en\", \"Foo\"));\n        l1.insert(LanguageString::new(\"en\", \"Bar\"));\n        l1.insert(LanguageString::new(\"en\", \"Baz\"));\n        l1.insert(LanguageString::new(\"de\", \"Foobar\"));\n        let mut l2 = l1.clone();\n        l2.get_lang_mut(\"en\")[2] = \"Boo\".to_string();\n        l2.get_lang_mut(\"en\").remove(1);\n        l2.insert(LanguageString::new(\"de\", \"Foobaz\"));\n\n        let patch = l2.patch(\u0026l1).unwrap();\n        let patch_json = json!(patch);\n        assert_eq!(\n            patch_json,\n            json!({\"patch\":[{\"op\":\"add\",\"path\":\"/de/1\",\"value\":\"Foobaz\"},{\"op\":\"replace\",\"path\":\"/en/1\",\"value\":\"Boo\"},{\"op\":\"remove\",\"path\":\"/en/2\"}]})\n        );\n    }\n\n    #[test]\n    fn test_header_info_multiple() {\n        let l = Aliases::default();\n        assert_eq!(l.header_info(), \u0026HeaderInfo::default());\n    }\n\n    #[test]\n    fn test_serialize2() {\n        let mut l = Aliases::default();\n        l.insert(LanguageString::new(\"en\", \"Foo\"));\n        l.insert(LanguageString::new(\"en\", \"Bar\"));\n        l.insert(LanguageString::new(\"de\", \"Baz\"));\n        let s = serde_json::to_string(\u0026l).unwrap();\n        assert!(s.contains(r#\"\"en\":[\"Foo\",\"Bar\"]\"#));\n        assert!(s.contains(r#\"\"de\":[\"Baz\"]\"#));\n    }\n\n    #[test]\n    fn test_is_empty() {\n        let mut l = Aliases::default();\n        assert!(l.is_empty());\n        l.insert(LanguageString::new(\"en\", \"Foo\"));\n        assert!(!l.is_empty());\n    }\n}\n","traces":[{"line":22,"address":[],"length":0,"stats":{"Line":1}},{"line":27,"address":[],"length":0,"stats":{"Line":2}},{"line":30,"address":[],"length":0,"stats":{"Line":1}},{"line":36,"address":[],"length":0,"stats":{"Line":2}},{"line":37,"address":[],"length":0,"stats":{"Line":1}},{"line":41,"address":[],"length":0,"stats":{"Line":11}},{"line":42,"address":[],"length":0,"stats":{"Line":11}},{"line":43,"address":[],"length":0,"stats":{"Line":11}},{"line":44,"address":[],"length":0,"stats":{"Line":57}},{"line":48,"address":[],"length":0,"stats":{"Line":2}},{"line":49,"address":[],"length":0,"stats":{"Line":2}},{"line":53,"address":[],"length":0,"stats":{"Line":2}},{"line":54,"address":[],"length":0,"stats":{"Line":2}},{"line":55,"address":[],"length":0,"stats":{"Line":4}},{"line":60,"address":[],"length":0,"stats":{"Line":4}},{"line":61,"address":[],"length":0,"stats":{"Line":4}},{"line":65,"address":[],"length":0,"stats":{"Line":18}},{"line":66,"address":[],"length":0,"stats":{"Line":18}},{"line":69,"address":[],"length":0,"stats":{"Line":1246}},{"line":73,"address":[],"length":0,"stats":{"Line":2492}},{"line":75,"address":[],"length":0,"stats":{"Line":3383}},{"line":76,"address":[],"length":0,"stats":{"Line":2137}},{"line":77,"address":[],"length":0,"stats":{"Line":2137}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":2137}},{"line":87,"address":[],"length":0,"stats":{"Line":1}},{"line":92,"address":[],"length":0,"stats":{"Line":2}},{"line":93,"address":[],"length":0,"stats":{"Line":1}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":2}},{"line":102,"address":[],"length":0,"stats":{"Line":1}},{"line":105,"address":[],"length":0,"stats":{"Line":2}},{"line":106,"address":[],"length":0,"stats":{"Line":1}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":1}},{"line":121,"address":[],"length":0,"stats":{"Line":1}},{"line":124,"address":[],"length":0,"stats":{"Line":17}},{"line":125,"address":[],"length":0,"stats":{"Line":34}},{"line":127,"address":[],"length":0,"stats":{"Line":17}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":1263}},{"line":133,"address":[],"length":0,"stats":{"Line":1246}},{"line":134,"address":[],"length":0,"stats":{"Line":1246}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":3738}},{"line":150,"address":[],"length":0,"stats":{"Line":1}},{"line":151,"address":[],"length":0,"stats":{"Line":1}},{"line":154,"address":[],"length":0,"stats":{"Line":17}},{"line":155,"address":[],"length":0,"stats":{"Line":17}},{"line":156,"address":[],"length":0,"stats":{"Line":34}},{"line":157,"address":[],"length":0,"stats":{"Line":17}},{"line":163,"address":[],"length":0,"stats":{"Line":12}},{"line":167,"address":[],"length":0,"stats":{"Line":24}},{"line":168,"address":[],"length":0,"stats":{"Line":1160}},{"line":169,"address":[],"length":0,"stats":{"Line":574}},{"line":171,"address":[],"length":0,"stats":{"Line":12}}],"covered":51,"coverable":64},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","aliases_in_language.rs"],"content":"use crate::{\n    EditMetadata, EntityId, HeaderInfo, HttpGet, HttpMisc, RestApi, RestApiError, RevisionMatch,\n};\nuse async_trait::async_trait;\nuse derivative::Derivative;\nuse reqwest::{Response, StatusCode};\nuse serde_json::{json, Value};\nuse std::collections::HashMap;\n\n/// A group of aliases in a specific language.\n#[derive(Derivative, Debug, Clone)]\n#[derivative(PartialEq)]\npub struct AliasesInLanguage {\n    language: String,\n    values: Vec\u003cString\u003e,\n    #[derivative(PartialEq = \"ignore\")]\n    header_info: HeaderInfo,\n}\n\nimpl AliasesInLanguage {\n    /// Constructs a new `Aliases` object from a language code and a list of aliases.\n    pub fn new\u003cS: Into\u003cString\u003e\u003e(language: S, values: Vec\u003cString\u003e) -\u003e Self {\n        Self {\n            language: language.into(),\n            values,\n            header_info: HeaderInfo::default(),\n        }\n    }\n\n    /// Constructs a new `Aliases` object from a language code and a JSON array of (string) aliases.\n    pub fn from_json\u003cS: Into\u003cString\u003e\u003e(language: S, j: \u0026Value) -\u003e Result\u003cSelf, RestApiError\u003e {\n        Self::from_json_header_info(language, j, HeaderInfo::default())\n    }\n\n    /// Constructs a new `Aliases` object from a language code and a JSON array of (string) aliases.\n    pub fn from_json_header_info\u003cS: Into\u003cString\u003e\u003e(\n        language: S,\n        j: \u0026Value,\n        header_info: HeaderInfo,\n    ) -\u003e Result\u003cSelf, RestApiError\u003e {\n        let language = language.into();\n        if language.trim().is_empty() {\n            return Err(RestApiError::EmptyValue(\"Language\".into()));\n        }\n        let aliases = j\n            .as_array()\n            .ok_or_else(|| RestApiError::MissingOrInvalidField {\n                field: \"Aliases\".into(),\n                j: j.to_owned(),\n            })?\n            .iter()\n            .map(|v| {\n                Ok(v.as_str()\n                    .ok_or_else(|| RestApiError::MissingOrInvalidField {\n                        field: \"Aliases\".into(),\n                        j: v.to_owned(),\n                    })?\n                    .to_string())\n            })\n            .collect::\u003cResult\u003cVec\u003cString\u003e, RestApiError\u003e\u003e()?;\n        Ok(Self {\n            language,\n            values: aliases,\n            header_info,\n        })\n    }\n\n    /// Adds an alias to the list of aliases (only if it is not already present).\n    pub fn push(\u0026mut self, alias: String) {\n        if !self.values.contains(\u0026alias) {\n            self.values.push(alias);\n        }\n    }\n\n    /// Returns the list of aliases.\n    pub const fn values(\u0026self) -\u003e \u0026Vec\u003cString\u003e {\n        \u0026self.values\n    }\n\n    /// Returns the number of aliases.\n    pub fn len(\u0026self) -\u003e usize {\n        self.values.len()\n    }\n\n    /// Returns true if the list of aliases is empty.\n    pub fn is_empty(\u0026self) -\u003e bool {\n        self.values.is_empty()\n    }\n\n    /// Returns the language code of the aliases.\n    pub fn language(\u0026self) -\u003e \u0026str {\n        \u0026self.language\n    }\n\n    /// Adds one or more aliases to the list of aliases.\n    pub async fn post(\u0026self, id: \u0026EntityId, api: \u0026mut RestApi) -\u003e Result\u003cSelf, RestApiError\u003e {\n        self.post_meta(id, api, EditMetadata::default()).await\n    }\n\n    /// Adds one or more aliases to the list of aliases, using conditions and edit metadata.\n    pub async fn post_meta(\n        \u0026self,\n        id: \u0026EntityId,\n        api: \u0026mut RestApi,\n        em: EditMetadata,\n    ) -\u003e Result\u003cSelf, RestApiError\u003e {\n        let j = json!({\"aliases\": self.values});\n        let (j, header_info) = self\n            .run_json_query(id, reqwest::Method::POST, j, api, \u0026em)\n            .await?;\n        Self::from_json_header_info(\u0026self.language, \u0026j, header_info)\n    }\n\n    /// Returns the header information of the last HTTP response (revision ID, last modified).\n    pub const fn header_info(\u0026self) -\u003e \u0026HeaderInfo {\n        \u0026self.header_info\n    }\n\n    async fn check_get_match_response(\n        language: \u0026str,\n        response: Response,\n    ) -\u003e Result\u003cSelf, RestApiError\u003e {\n        let header_info = HeaderInfo::from_header(response.headers());\n        let j: Value = match response.error_for_status() {\n            Ok(response) =\u003e response.json().await?,\n            Err(e) =\u003e {\n                if e.status() == Some(StatusCode::NOT_FOUND) {\n                    json!([])\n                } else {\n                    return Err(e.into());\n                }\n            }\n        };\n        Self::from_json_header_info(language, \u0026j, header_info)\n    }\n}\n\nimpl HttpMisc for AliasesInLanguage {\n    fn get_my_rest_api_path(\u0026self, id: \u0026EntityId) -\u003e Result\u003cString, RestApiError\u003e {\n        Ok(format!(\n            \"/entities/{group}/{id}/aliases/{language}\",\n            group = id.group()?,\n            language = self.language\n        ))\n    }\n}\n\n#[async_trait]\nimpl HttpGet for AliasesInLanguage {\n    async fn get_match(\n        id: \u0026EntityId,\n        language: \u0026str,\n        api: \u0026RestApi,\n        rm: RevisionMatch,\n    ) -\u003e Result\u003cSelf, RestApiError\u003e {\n        let path = format!(\n            \"/entities/{group}/{id}/aliases/{language}\",\n            group = id.group()?\n        );\n        let mut request = api\n            .wikibase_request_builder(\u0026path, HashMap::new(), reqwest::Method::GET)\n            .await?\n            .build()?;\n        rm.modify_headers(request.headers_mut())?;\n        let response = api.execute(request).await?;\n        Self::check_get_match_response(language, response).await\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use wiremock::matchers::{bearer_token, body_partial_json, method, path};\n    use wiremock::{Mock, MockServer, ResponseTemplate};\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_aliases_get() {\n        let v = std::fs::read_to_string(\"test_data/Q42.json\").unwrap();\n        let v: Value = serde_json::from_str(\u0026v).unwrap();\n        let id_q42 = v[\"id\"].as_str().unwrap();\n\n        let mock_path = format!(\"/w/rest.php/wikibase/v1/entities/items/{id_q42}/aliases/en\");\n        let mock_server = MockServer::start().await;\n        Mock::given(method(\"GET\"))\n            .and(path(\u0026mock_path))\n            .respond_with(ResponseTemplate::new(200).set_body_json(\u0026v[\"aliases\"][\"en\"]))\n            .mount(\u0026mock_server)\n            .await;\n        let api = RestApi::builder(\u0026(mock_server.uri() + \"/w/rest.php\"))\n            .unwrap()\n            .build();\n\n        let id = EntityId::item(\"Q42\");\n        let aliases = AliasesInLanguage::get(\u0026id, \"en\", \u0026api).await.unwrap();\n        assert!(aliases.values.contains(\u0026\"Douglas Noël Adams\".to_string()));\n    }\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_aliases_post() {\n        // #lizard forgives the complexity\n        let v = std::fs::read_to_string(\"test_data/Q42.json\").unwrap();\n        let v: Value = serde_json::from_str(\u0026v).unwrap();\n        let id = v[\"id\"].as_str().unwrap();\n        let new_alias = \"Foo bar baz\";\n        let mut new_aliases = v[\"aliases\"][\"en\"].to_owned();\n        new_aliases.as_array_mut().unwrap().push(json!(new_alias));\n\n        let mock_path = format!(\"/w/rest.php/wikibase/v1/entities/items/{id}/aliases/en\");\n        let mock_server = MockServer::start().await;\n        let token = \"FAKE_TOKEN\";\n        Mock::given(method(\"GET\"))\n            .and(path(\u0026mock_path))\n            .respond_with(ResponseTemplate::new(200).set_body_json(\u0026v[\"aliases\"][\"en\"]))\n            .mount(\u0026mock_server)\n            .await;\n        Mock::given(body_partial_json(json!({\"aliases\": [new_alias]})))\n            .and(method(\"POST\"))\n            .and(path(\u0026mock_path))\n            .and(bearer_token(token))\n            .respond_with(ResponseTemplate::new(200).set_body_json(\u0026new_aliases))\n            .mount(\u0026mock_server)\n            .await;\n        let mut api = RestApi::builder(\u0026(mock_server.uri() + \"/w/rest.php\"))\n            .unwrap()\n            .with_access_token(token)\n            .build();\n\n        let id2 = EntityId::item(\"Q42\");\n        let aliases = AliasesInLanguage::get(\u0026id2, \"en\", \u0026api).await.unwrap();\n        let new_aliases2 = AliasesInLanguage::new(\"en\", vec![new_alias.to_string()]);\n        let new_aliases2 = new_aliases2.post(\u0026id2, \u0026mut api).await.unwrap();\n        assert_eq!(new_aliases2.len(), aliases.len() + 1);\n        assert!(new_aliases2.values.contains(\u0026new_alias.to_string()));\n\n        // Check non-existing item\n        let id3 = EntityId::item(\"Q12345\");\n        assert_eq!(\n            AliasesInLanguage::get(\u0026id3, \"en\", \u0026api)\n                .await\n                .unwrap()\n                .len(),\n            0\n        );\n    }\n\n    #[test]\n    fn test_aliases_new() {\n        let aliases = AliasesInLanguage::new(\"en\", vec![\"Foo\".to_string(), \"Bar\".to_string()]);\n        assert_eq!(aliases.language(), \"en\");\n        assert_eq!(aliases.len(), 2);\n    }\n\n    #[test]\n    fn test_aliases_from_json() {\n        let j = json!([\"Foo\", \"Bar\"]);\n        let aliases = AliasesInLanguage::from_json(\"en\", \u0026j).unwrap();\n        assert_eq!(aliases.language(), \"en\");\n        assert_eq!(aliases.len(), 2);\n    }\n\n    #[test]\n    fn test_aliases_push() {\n        let mut aliases = AliasesInLanguage::new(\"en\", vec![\"Foo\".to_string()]);\n        aliases.push(\"Bar\".to_string());\n        aliases.push(\"Foo\".to_string());\n        assert_eq!(aliases.len(), 2);\n    }\n\n    #[test]\n    fn test_aliases_values() {\n        let aliases = AliasesInLanguage::new(\"en\", vec![\"Foo\".to_string(), \"Bar\".to_string()]);\n        assert_eq!(\n            aliases.values(),\n            \u0026vec![\"Foo\".to_string(), \"Bar\".to_string()]\n        );\n    }\n\n    #[test]\n    fn test_aliases_len() {\n        let aliases = AliasesInLanguage::new(\"en\", vec![\"Foo\".to_string(), \"Bar\".to_string()]);\n        assert_eq!(aliases.len(), 2);\n    }\n\n    #[test]\n    fn test_aliases_header_info() {\n        let aliases = AliasesInLanguage::new(\"en\", vec![\"Foo\".to_string(), \"Bar\".to_string()]);\n        assert_eq!(aliases.header_info(), \u0026HeaderInfo::default());\n    }\n\n    #[test]\n    fn test_from_json_header_info() {\n        let j = json!(12345);\n\n        let aliases = AliasesInLanguage::from_json(\"\", \u0026j).unwrap_err();\n        assert_eq!(aliases.to_string(), \"Empty value: Language\");\n\n        let aliases2 = AliasesInLanguage::from_json(\"en\", \u0026j).unwrap_err();\n        assert_eq!(aliases2.to_string(), \"Missing field Aliases: 12345\");\n    }\n\n    #[test]\n    fn test_is_empty() {\n        let aliases = AliasesInLanguage::new(\"en\", vec![\"Foo\".to_string(), \"Bar\".to_string()]);\n        assert!(!aliases.is_empty());\n        let aliases2 = AliasesInLanguage::new(\"en\", vec![]);\n        assert!(aliases2.is_empty());\n    }\n}\n","traces":[{"line":22,"address":[],"length":0,"stats":{"Line":10}},{"line":24,"address":[],"length":0,"stats":{"Line":10}},{"line":26,"address":[],"length":0,"stats":{"Line":10}},{"line":31,"address":[],"length":0,"stats":{"Line":3}},{"line":32,"address":[],"length":0,"stats":{"Line":3}},{"line":36,"address":[],"length":0,"stats":{"Line":7}},{"line":41,"address":[],"length":0,"stats":{"Line":7}},{"line":42,"address":[],"length":0,"stats":{"Line":7}},{"line":43,"address":[],"length":0,"stats":{"Line":1}},{"line":45,"address":[],"length":0,"stats":{"Line":5}},{"line":47,"address":[],"length":0,"stats":{"Line":1}},{"line":48,"address":[],"length":0,"stats":{"Line":1}},{"line":49,"address":[],"length":0,"stats":{"Line":1}},{"line":52,"address":[],"length":0,"stats":{"Line":14}},{"line":53,"address":[],"length":0,"stats":{"Line":9}},{"line":54,"address":[],"length":0,"stats":{"Line":9}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":9}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":2}},{"line":70,"address":[],"length":0,"stats":{"Line":3}},{"line":71,"address":[],"length":0,"stats":{"Line":1}},{"line":76,"address":[],"length":0,"stats":{"Line":1}},{"line":77,"address":[],"length":0,"stats":{"Line":1}},{"line":81,"address":[],"length":0,"stats":{"Line":9}},{"line":82,"address":[],"length":0,"stats":{"Line":9}},{"line":86,"address":[],"length":0,"stats":{"Line":2}},{"line":87,"address":[],"length":0,"stats":{"Line":2}},{"line":91,"address":[],"length":0,"stats":{"Line":2}},{"line":92,"address":[],"length":0,"stats":{"Line":2}},{"line":96,"address":[],"length":0,"stats":{"Line":2}},{"line":97,"address":[],"length":0,"stats":{"Line":1}},{"line":101,"address":[],"length":0,"stats":{"Line":1}},{"line":107,"address":[],"length":0,"stats":{"Line":1}},{"line":108,"address":[],"length":0,"stats":{"Line":2}},{"line":109,"address":[],"length":0,"stats":{"Line":1}},{"line":110,"address":[],"length":0,"stats":{"Line":1}},{"line":115,"address":[],"length":0,"stats":{"Line":1}},{"line":116,"address":[],"length":0,"stats":{"Line":1}},{"line":119,"address":[],"length":0,"stats":{"Line":3}},{"line":123,"address":[],"length":0,"stats":{"Line":3}},{"line":124,"address":[],"length":0,"stats":{"Line":6}},{"line":125,"address":[],"length":0,"stats":{"Line":2}},{"line":126,"address":[],"length":0,"stats":{"Line":1}},{"line":127,"address":[],"length":0,"stats":{"Line":1}},{"line":128,"address":[],"length":0,"stats":{"Line":1}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":1}},{"line":140,"address":[],"length":0,"stats":{"Line":1}},{"line":141,"address":[],"length":0,"stats":{"Line":1}},{"line":142,"address":[],"length":0,"stats":{"Line":1}},{"line":156,"address":[],"length":0,"stats":{"Line":3}},{"line":158,"address":[],"length":0,"stats":{"Line":3}},{"line":160,"address":[],"length":0,"stats":{"Line":3}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":6}}],"covered":52,"coverable":61},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","aliases_patch.rs"],"content":"use crate::{\n    aliases::Aliases, patch_entry::PatchEntry, EditMetadata, EntityId, FromJson, HttpMisc, Patch,\n    PatchApply, RestApi, RestApiError,\n};\nuse async_trait::async_trait;\nuse serde::Serialize;\nuse serde_json::{json, Value};\n\n#[derive(Debug, Clone, Default, PartialEq, Serialize)]\npub struct AliasesPatch {\n    patch: Vec\u003cPatchEntry\u003e,\n}\n\nimpl AliasesPatch {\n    /// Adds a command to replace an alias in a specific language, at a specific position\n    pub fn replace\u003cS1: Into\u003cString\u003e, S2: Into\u003cString\u003e\u003e(\n        \u0026mut self,\n        language: S1,\n        num: usize,\n        value: S2,\n    ) {\n        \u003cSelf as Patch\u003e::replace(\n            self,\n            format!(\"/{}/{num}\", language.into()),\n            value.into().into(),\n        );\n    }\n\n    /// Adds a command to remove an alias in a specific language, at a specific position\n    pub fn remove\u003cS: Into\u003cString\u003e\u003e(\u0026mut self, language: S, num: usize) {\n        \u003cSelf as Patch\u003e::remove(self, format!(\"/{}/{num}\", language.into()));\n    }\n\n    /// Generates a patch from JSON, presumably from `json_patch`\n    pub fn from_json(j: \u0026Value) -\u003e Result\u003cSelf, RestApiError\u003e {\n        let pe = j\n            .as_array()\n            .ok_or(RestApiError::MissingOrInvalidField {\n                field: \"AliasPatch\".to_string(),\n                j: j.clone(),\n            })?\n            .iter()\n            .map(|x| serde_json::from_value(x.clone()))\n            .collect::\u003cResult\u003cVec\u003cPatchEntry\u003e, serde_json::Error\u003e\u003e()?;\n        Ok(Self { patch: pe })\n    }\n}\n\nimpl Patch for AliasesPatch {\n    fn patch(\u0026self) -\u003e \u0026Vec\u003cPatchEntry\u003e {\n        \u0026self.patch\n    }\n\n    fn patch_mut(\u0026mut self) -\u003e \u0026mut Vec\u003cPatchEntry\u003e {\n        \u0026mut self.patch\n    }\n}\n\n#[async_trait]\nimpl PatchApply\u003cAliases\u003e for AliasesPatch {\n    async fn apply_match(\n        \u0026self,\n        id: \u0026EntityId,\n        api: \u0026mut RestApi,\n        em: EditMetadata,\n    ) -\u003e Result\u003cAliases, RestApiError\u003e {\n        let j = json!({\"patch\": self.patch});\n        let request = self\n            .generate_json_request(id, reqwest::Method::PATCH, j, api, \u0026em)\n            .await?;\n        let response = api.execute(request).await?;\n        let (j2, header_info) = self.filter_response_error(response).await?;\n        Aliases::from_json_header_info(\u0026j2, header_info)\n    }\n}\n\nimpl HttpMisc for AliasesPatch {\n    fn get_my_rest_api_path(\u0026self, id: \u0026EntityId) -\u003e Result\u003cString, RestApiError\u003e {\n        Ok(format!(\"/entities/{}/{id}/aliases\", id.group()?))\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use serde_json::Value;\n    use wiremock::matchers::{bearer_token, body_partial_json, header, method, path};\n    use wiremock::{Mock, MockServer, ResponseTemplate};\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_aliases_patch() {\n        let id = \"Q42\";\n        let new_alias = \"Foo bar baz\";\n        let v = std::fs::read_to_string(\"test_data/Q42.json\").unwrap();\n        let v: Value = serde_json::from_str(\u0026v).unwrap();\n        let mut new_aliases = v[\"aliases\"].to_owned();\n        new_aliases[\"en\"][1] = json!(new_alias);\n\n        let mock_path = format!(\"/w/rest.php/wikibase/v1/entities/items/{id}/aliases\");\n        let mock_server = MockServer::start().await;\n        let token = \"FAKE_TOKEN\";\n        Mock::given(body_partial_json(\n            json!({\"patch\":[{\"op\": \"replace\",\"path\": \"/en/1\",\"value\": new_alias}]}),\n        ))\n        .and(method(\"PATCH\"))\n        .and(path(\u0026mock_path))\n        .and(bearer_token(token))\n        .and(header(\"content-type\", \"application/json-patch+json\"))\n        .respond_with(\n            ResponseTemplate::new(200)\n                .insert_header(\"ETag\", \"12345\")\n                .set_body_json(\u0026new_aliases),\n        )\n        .mount(\u0026mock_server)\n        .await;\n        let mut api = RestApi::builder(\u0026(mock_server.uri() + \"/w/rest.php\"))\n            .unwrap()\n            .with_access_token(token)\n            .build();\n\n        // Apply patch\n        let id = EntityId::new(id).unwrap();\n        let mut patch = AliasesPatch::default();\n        patch.replace(\"en\", 1, new_alias);\n        let new_aliases2 = patch.apply(\u0026id, \u0026mut api).await.unwrap();\n        assert_eq!(new_aliases2.get_lang(\"en\")[1], new_alias);\n    }\n}\n","traces":[{"line":16,"address":[],"length":0,"stats":{"Line":2}},{"line":23,"address":[],"length":0,"stats":{"Line":2}},{"line":24,"address":[],"length":0,"stats":{"Line":2}},{"line":25,"address":[],"length":0,"stats":{"Line":2}},{"line":30,"address":[],"length":0,"stats":{"Line":1}},{"line":31,"address":[],"length":0,"stats":{"Line":1}},{"line":35,"address":[],"length":0,"stats":{"Line":2}},{"line":36,"address":[],"length":0,"stats":{"Line":4}},{"line":38,"address":[],"length":0,"stats":{"Line":2}},{"line":39,"address":[],"length":0,"stats":{"Line":2}},{"line":40,"address":[],"length":0,"stats":{"Line":2}},{"line":43,"address":[],"length":0,"stats":{"Line":5}},{"line":50,"address":[],"length":0,"stats":{"Line":5}},{"line":51,"address":[],"length":0,"stats":{"Line":5}},{"line":54,"address":[],"length":0,"stats":{"Line":4}},{"line":55,"address":[],"length":0,"stats":{"Line":4}},{"line":67,"address":[],"length":0,"stats":{"Line":1}},{"line":68,"address":[],"length":0,"stats":{"Line":2}},{"line":69,"address":[],"length":0,"stats":{"Line":1}},{"line":70,"address":[],"length":0,"stats":{"Line":1}},{"line":71,"address":[],"length":0,"stats":{"Line":1}},{"line":72,"address":[],"length":0,"stats":{"Line":1}},{"line":78,"address":[],"length":0,"stats":{"Line":1}},{"line":79,"address":[],"length":0,"stats":{"Line":2}}],"covered":24,"coverable":24},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","bearer_token.rs"],"content":"use std::collections::HashMap;\n\nuse reqwest::Request;\nuse serde_json::Value;\n\nuse crate::{RestApi, RestApiError};\n\n/// The default time to wait until bearer token is renewed. API says 4h so setting it to 3h50min\nconst DEFAULT_RENEWAL_INTERVAL_SEC: u64 = (3 * 60 + 50) * 60;\n\n#[derive(Debug, Clone, Default)]\npub struct BearerToken {\n    client_id: Option\u003cString\u003e,\n    client_secret: Option\u003cString\u003e,\n    access_token: Option\u003cString\u003e,\n    refresh_token: Option\u003cString\u003e,\n    last_update: Option\u003cstd::time::Instant\u003e,\n    renewal_interval: std::time::Duration,\n}\n\nimpl BearerToken {\n    /// Returns the `OAuth2` bearer token\n    pub const fn get(\u0026self) -\u003e \u0026Option\u003cString\u003e {\n        \u0026self.access_token\n    }\n\n    /// For non-owner-only clients, returns a URL to send the user to login and authorize the client.\n    /// Upon authorizing, the user will be redirected to the URL with a code, which can be exchanged for an access token, via `get_access_token`.\n    pub fn authorization_code_url(\u0026self, api: \u0026RestApi) -\u003e Result\u003cString, RestApiError\u003e {\n        let client_id = self\n            .client_id\n            .as_ref()\n            .ok_or_else(|| RestApiError::ClientIdRequired)?;\n        let api_url = api.api_url();\n        Ok(format!(\n            \"{api_url}/oauth2/authorize?client_id={client_id}\u0026response_type=code\"\n        ))\n    }\n\n    /// Returns the renewal interval for the `OAuth2` bearer token.\n    pub const fn access_token_renewal_interval(\u0026self) -\u003e std::time::Duration {\n        self.renewal_interval\n    }\n\n    /// Internal use only.\n    pub const fn client_id(\u0026self) -\u003e \u0026Option\u003cString\u003e {\n        \u0026self.client_id\n    }\n\n    /// Internal use only.\n    pub const fn client_secret(\u0026self) -\u003e \u0026Option\u003cString\u003e {\n        \u0026self.client_secret\n    }\n\n    fn generate_get_access_token_parameters(\n        \u0026self,\n        code: \u0026str,\n    ) -\u003e Result\u003cHashMap\u003cString, String\u003e, RestApiError\u003e {\n        let client_id = self\n            .client_id\n            .as_ref()\n            .ok_or(RestApiError::ClientIdRequired)?;\n        let client_secret = self\n            .client_secret\n            .as_ref()\n            .ok_or(RestApiError::ClientSecretRequired)?;\n\n        let params = [\n            (\"grant_type\", \"authorization_code\"),\n            (\"client_id\", client_id.as_str()),\n            (\"client_secret\", client_secret.as_str()),\n            (\"code\", code),\n        ];\n        Ok(Self::array2hashmap(\u0026params))\n    }\n\n    async fn generate_get_access_token_request(\n        \u0026self,\n        api: \u0026RestApi,\n        code: \u0026str,\n    ) -\u003e Result\u003cRequest, RestApiError\u003e {\n        let params = self.generate_get_access_token_parameters(code)?;\n        let headers = api.headers_from_token(self).await?;\n        let url = format!(\"{api_url}/oauth2/access_token\", api_url = api.api_url());\n        let mut request = api\n            .client()\n            .post(url)\n            .headers(headers)\n            .form(\u0026params)\n            .build()?;\n        request.headers_mut().insert(\n            reqwest::header::CONTENT_TYPE,\n            \"application/x-www-form-urlencoded\".parse()?,\n        );\n        Ok(request)\n    }\n\n    /// Exchanges a code for an access token\n    pub async fn get_access_token(\n        \u0026mut self,\n        api: \u0026RestApi,\n        code: \u0026str,\n    ) -\u003e Result\u003c(), RestApiError\u003e {\n        let request = self.generate_get_access_token_request(api, code).await?;\n        let response = api.client().execute(request).await?;\n        let j: Value = response.json().await?;\n        self.set_tokens_from_json(j)\n    }\n\n    /// Sets the `OAuth2` bearer token and refresh token from a JSON response\n    fn set_tokens_from_json(\u0026mut self, j: Value) -\u003e Result\u003c(), RestApiError\u003e {\n        let access_token = j[\"access_token\"]\n            .as_str()\n            .ok_or(RestApiError::AccessTokenRequired)?\n            .to_string();\n        let refresh_token = j[\"refresh_token\"]\n            .as_str()\n            .ok_or(RestApiError::RefreshTokenRequired)?\n            .to_string();\n        let renewal_interval = j[\"expires_in\"].as_u64().unwrap_or_default() / 10 * 9; // 90% of max duration\n        self.set_tokens(Some(access_token), Some(refresh_token));\n        self.set_renewal_interval(renewal_interval);\n        self.touch_access_token();\n        Ok(())\n    }\n\n    /// Updates the last bearer token update time to current time\n    fn touch_access_token(\u0026mut self) {\n        self.last_update = Some(std::time::Instant::now());\n    }\n\n    pub const fn refresh_token(\u0026self) -\u003e \u0026Option\u003cString\u003e {\n        \u0026self.refresh_token\n    }\n\n    /// Sets the renewal interval for the `OAuth2` bearer token\n    pub const fn set_renewal_interval(\u0026mut self, renewal_interval: u64) {\n        let renewal_interval = match renewal_interval {\n            0 =\u003e DEFAULT_RENEWAL_INTERVAL_SEC,\n            renewal_interval =\u003e renewal_interval,\n        };\n        self.renewal_interval = std::time::Duration::from_secs(renewal_interval);\n    }\n\n    /// Sets the `OAuth2` bearer token and refresh token\n    pub fn set_tokens(\u0026mut self, access_token: Option\u003cString\u003e, refresh_token: Option\u003cString\u003e) {\n        self.access_token = access_token;\n        self.refresh_token = refresh_token;\n    }\n\n    /// Checks if the bearer token needs to be updated, and updates it if necessary\n    pub async fn check(\u0026mut self, api: \u0026RestApi, request: \u0026Request) -\u003e Result\u003c(), RestApiError\u003e {\n        let method = request.method();\n        if method == reqwest::Method::GET {\n            return Ok(());\n        }\n        if self.can_update_access_token() {\n            self.renew_access_token(api).await?;\n        }\n        Ok(())\n    }\n\n    /// Sets the `OAuth2` bearer token (owner-only clients are supported)\n    pub fn set_access_token\u003cS: Into\u003cString\u003e\u003e(\u0026mut self, access_token: S) {\n        self.access_token = Some(access_token.into());\n    }\n\n    //// Sets the OAuth2 client ID and client secret\n    pub fn set_oauth2_info\u003cS1: Into\u003cString\u003e, S2: Into\u003cString\u003e\u003e(\n        \u0026mut self,\n        client_id: S1,\n        client_secret: S2,\n    ) {\n        self.client_id = Some(client_id.into());\n        self.client_secret = Some(client_secret.into());\n    }\n\n    /// Returns `true` if an `OAuth2` bearer token is present\n    pub const fn has_access_token(\u0026self) -\u003e bool {\n        self.access_token.is_some()\n    }\n\n    /// Returns `true` if the client ID and client secret are present\n    const fn can_update_access_token(\u0026self) -\u003e bool {\n        self.client_id.is_some() \u0026\u0026 self.client_secret.is_some()\n    }\n\n    /// Check if last bearer token update is within the renewal interval\n    fn does_access_token_need_updating(\u0026self) -\u003e bool {\n        if let Some(last_update) = self.last_update {\n            let elapsed = last_update.elapsed();\n            if elapsed \u003c self.renewal_interval {\n                return false;\n            }\n        }\n        true\n    }\n\n    fn get_renew_access_token_parameters(\u0026self) -\u003e Result\u003cHashMap\u003cString, String\u003e, RestApiError\u003e {\n        let client_id = self\n            .client_id\n            .as_ref()\n            .ok_or(RestApiError::ClientIdRequired)?;\n        let client_secret = self\n            .client_secret\n            .as_ref()\n            .ok_or(RestApiError::ClientSecretRequired)?;\n        let refresh_token = self\n            .refresh_token\n            .as_ref()\n            .ok_or_else(|| RestApiError::RefreshTokenRequired)?;\n        let params = [\n            (\"client_id\", client_id.as_str()),\n            (\"client_secret\", client_secret.as_str()),\n            (\"grant_type\", \"refresh_token\"),\n            (\"refresh_token\", refresh_token.as_str()),\n        ];\n        Ok(Self::array2hashmap(\u0026params))\n    }\n\n    async fn get_renew_access_token_request(\u0026self, api: \u0026RestApi) -\u003e Result\u003cRequest, RestApiError\u003e {\n        let params = self.get_renew_access_token_parameters()?;\n        let headers = api.headers_from_token(self).await?;\n        let url = format!(\"{}{}\", api.api_url(), \"/oauth2/access_token\");\n        let mut request = api\n            .client()\n            .post(url)\n            .headers(headers)\n            .form(\u0026params)\n            .build()?;\n\n        request.headers_mut().insert(\n            reqwest::header::CONTENT_TYPE,\n            \"application/x-www-form-urlencoded\".parse()?,\n        );\n        Ok(request)\n    }\n\n    /// Refresh the `OAuth2` bearer token for Non-owner-only clients\n    pub async fn renew_access_token(\u0026mut self, api: \u0026RestApi) -\u003e Result\u003c(), RestApiError\u003e {\n        if !self.does_access_token_need_updating() {\n            return Ok(());\n        }\n        let request = self.get_renew_access_token_request(api).await?;\n        let response = api.client().execute(request).await?;\n        let j: Value = response.json().await?;\n        self.set_tokens_from_json(j)\n    }\n\n    fn array2hashmap(array: \u0026[(\u0026str, \u0026str)]) -\u003e HashMap\u003cString, String\u003e {\n        array\n            .iter()\n            .map(|(k, v)| (k.to_string(), v.to_string()))\n            .collect()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use serde_json::json;\n    use wiremock::matchers::{body_string_contains, method, path};\n    use wiremock::{Mock, MockServer, ResponseTemplate};\n\n    #[test]\n    fn test_has_access_token() {\n        let mut token = BearerToken::default();\n        assert!(!token.has_access_token());\n        token.set_access_token(\"test\");\n        assert!(token.has_access_token());\n    }\n\n    #[test]\n    fn test_can_update_access_token() {\n        let mut token = BearerToken::default();\n        assert!(!token.can_update_access_token());\n        token.set_oauth2_info(\"client_id\", \"client_secret\");\n        assert!(token.can_update_access_token());\n    }\n\n    #[test]\n    fn test_does_access_token_need_updating() {\n        let mut token = BearerToken::default();\n        assert!(token.does_access_token_need_updating());\n        token.touch_access_token();\n        assert!(token.does_access_token_need_updating());\n        token.set_renewal_interval(0);\n        assert!(!token.does_access_token_need_updating());\n    }\n\n    #[test]\n    fn test_get() {\n        let mut token = BearerToken::default();\n        assert_eq!(token.get(), \u0026None);\n        token.set_access_token(\"test\");\n        assert_eq!(token.get(), \u0026Some(\"test\".to_string()));\n    }\n\n    #[test]\n    #[cfg_attr(miri, ignore)] // TODO this should work in miri\n    fn test_authorization_code_url() {\n        let mut token = BearerToken::default();\n        let api = RestApi::builder(\"https://www.wikidata.org/w/rest.php\")\n            .unwrap()\n            .build();\n        token.set_oauth2_info(\"client_id\", \"client_secret\");\n        assert_eq!(token.authorization_code_url(\u0026api).unwrap(), \"https://www.wikidata.org/w/rest.php/oauth2/authorize?client_id=client_id\u0026response_type=code\");\n    }\n\n    #[test]\n    fn test_set_tokens_from_json() {\n        let mut token = BearerToken::default();\n        let j = serde_json::json!({\n            \"access_token\": \"foo\",\n            \"refresh_token\": \"bar\",\n            \"expires_in\": 3600,\n        });\n        token.set_tokens_from_json(j).unwrap();\n        assert_eq!(token.get(), \u0026Some(\"foo\".to_string()));\n        assert_eq!(token.refresh_token(), \u0026Some(\"bar\".to_string()));\n        assert_eq!(\n            token.renewal_interval,\n            std::time::Duration::from_secs(3600 / 10 * 9)\n        );\n    }\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_get_access_token() {\n        // #lizard forgives the complexity\n        let client_id = \"client_id_foobar\";\n        let client_secret = \"client_secret_foobar\";\n        let code = \"code_foobar\";\n        let mock_path = \"/w/rest.php/oauth2/access_token\";\n\n        let mock_server = MockServer::start().await;\n        Mock::given(method(\"POST\"))\n            .and(body_string_contains(\"grant_type=authorization_code\"))\n            .and(body_string_contains(format!(\"client_id={client_id}\")))\n            .and(body_string_contains(format!(\n                \"client_secret={client_secret}\"\n            )))\n            .and(body_string_contains(format!(\"code={code}\")))\n            .and(path(mock_path))\n            .respond_with(ResponseTemplate::new(200).set_body_json(json!({\n                \"access_token\": \"access_token_foobar\",\n                \"refresh_token\": \"refresh_token_foobar\",\n                \"expires_in\": 3600,\n            })))\n            .mount(\u0026mock_server)\n            .await;\n        let api = RestApi::builder(\u0026(mock_server.uri() + \"/w/rest.php\"))\n            .unwrap()\n            .build();\n\n        // Test error cases\n        assert!(api\n            .token\n            .write()\n            .await\n            .get_access_token(\u0026api, code)\n            .await\n            .is_err());\n\n        // Test success case\n        api.token\n            .write()\n            .await\n            .set_oauth2_info(client_id, client_secret);\n        api.token\n            .write()\n            .await\n            .get_access_token(\u0026api, code)\n            .await\n            .unwrap();\n        assert_eq!(\n            api.token.read().await.get().to_owned().unwrap(),\n            \"access_token_foobar\"\n        );\n        assert_eq!(\n            api.token.read().await.refresh_token().to_owned().unwrap(),\n            \"refresh_token_foobar\"\n        );\n        assert_eq!(\n            api.token.read().await.renewal_interval,\n            std::time::Duration::from_secs(3600 / 10 * 9)\n        );\n    }\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_renew_access_token() {\n        // #lizard forgives the complexity\n        let client_id = \"client_id_foobar\";\n        let client_secret = \"client_secret_foobar\";\n        let refresh_token = \"refresh_token_foobar\";\n        let mock_path = \"/w/rest.php/oauth2/access_token\";\n\n        let mock_server = MockServer::start().await;\n        Mock::given(method(\"POST\"))\n            .and(body_string_contains(\"grant_type=refresh_token\"))\n            .and(body_string_contains(format!(\"client_id={client_id}\")))\n            .and(body_string_contains(format!(\n                \"client_secret={client_secret}\"\n            )))\n            .and(body_string_contains(format!(\n                \"refresh_token={refresh_token}\"\n            )))\n            .and(path(mock_path))\n            .respond_with(ResponseTemplate::new(200).set_body_json(json!({\n                \"access_token\": \"access_token_foobar2\",\n                \"refresh_token\": \"refresh_token_foobar2\",\n                \"expires_in\": 3600,\n            })))\n            .mount(\u0026mock_server)\n            .await;\n        let api = RestApi::builder(\u0026(mock_server.uri() + \"/w/rest.php\"))\n            .unwrap()\n            .build();\n\n        // Test error cases\n        assert!(api\n            .token\n            .write()\n            .await\n            .renew_access_token(\u0026api)\n            .await\n            .is_err());\n\n        // Test success case\n        api.token\n            .write()\n            .await\n            .set_oauth2_info(client_id, client_secret);\n        api.token\n            .write()\n            .await\n            .set_tokens(None, Some(\"refresh_token_foobar\".to_string()));\n        api.token\n            .write()\n            .await\n            .renew_access_token(\u0026api)\n            .await\n            .unwrap();\n        assert_eq!(\n            api.token.read().await.get().to_owned().unwrap(),\n            \"access_token_foobar2\"\n        );\n        assert_eq!(\n            api.token.read().await.refresh_token().to_owned().unwrap(),\n            \"refresh_token_foobar2\"\n        );\n        assert_eq!(\n            api.token.read().await.renewal_interval,\n            std::time::Duration::from_secs(3600 / 10 * 9)\n        );\n    }\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_renew_access_token_no_need() {\n        let api = RestApi::builder(\"https://test.wikidata.org/w/rest.php\")\n            .unwrap()\n            .build();\n        let mut bt = BearerToken::default();\n        bt.touch_access_token();\n        bt.renewal_interval = std::time::Duration::from_secs(3600);\n        // This will fail if not for \"no update needed\", since client ID and secret are not set\n        assert!(bt.renew_access_token(\u0026api).await.is_ok());\n    }\n\n    #[test]\n    fn test_array2hashmap() {\n        let array = [(\"a\", \"1\"), (\"b\", \"2\")];\n        let hashmap = BearerToken::array2hashmap(\u0026array);\n        assert_eq!(hashmap.get(\"a\"), Some(\u0026\"1\".to_string()));\n        assert_eq!(hashmap.get(\"b\"), Some(\u0026\"2\".to_string()));\n    }\n}\n","traces":[{"line":23,"address":[],"length":0,"stats":{"Line":56}},{"line":24,"address":[],"length":0,"stats":{"Line":56}},{"line":29,"address":[],"length":0,"stats":{"Line":1}},{"line":30,"address":[],"length":0,"stats":{"Line":2}},{"line":31,"address":[],"length":0,"stats":{"Line":1}},{"line":33,"address":[],"length":0,"stats":{"Line":2}},{"line":41,"address":[],"length":0,"stats":{"Line":2}},{"line":42,"address":[],"length":0,"stats":{"Line":2}},{"line":46,"address":[],"length":0,"stats":{"Line":2}},{"line":47,"address":[],"length":0,"stats":{"Line":2}},{"line":51,"address":[],"length":0,"stats":{"Line":2}},{"line":52,"address":[],"length":0,"stats":{"Line":2}},{"line":55,"address":[],"length":0,"stats":{"Line":2}},{"line":59,"address":[],"length":0,"stats":{"Line":3}},{"line":60,"address":[],"length":0,"stats":{"Line":2}},{"line":62,"address":[],"length":0,"stats":{"Line":3}},{"line":63,"address":[],"length":0,"stats":{"Line":1}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":2}},{"line":82,"address":[],"length":0,"stats":{"Line":4}},{"line":83,"address":[],"length":0,"stats":{"Line":1}},{"line":85,"address":[],"length":0,"stats":{"Line":1}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":1}},{"line":99,"address":[],"length":0,"stats":{"Line":2}},{"line":104,"address":[],"length":0,"stats":{"Line":4}},{"line":105,"address":[],"length":0,"stats":{"Line":1}},{"line":106,"address":[],"length":0,"stats":{"Line":1}},{"line":111,"address":[],"length":0,"stats":{"Line":3}},{"line":112,"address":[],"length":0,"stats":{"Line":6}},{"line":114,"address":[],"length":0,"stats":{"Line":3}},{"line":116,"address":[],"length":0,"stats":{"Line":3}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":5}},{"line":129,"address":[],"length":0,"stats":{"Line":5}},{"line":132,"address":[],"length":0,"stats":{"Line":3}},{"line":133,"address":[],"length":0,"stats":{"Line":3}},{"line":137,"address":[],"length":0,"stats":{"Line":5}},{"line":138,"address":[],"length":0,"stats":{"Line":10}},{"line":139,"address":[],"length":0,"stats":{"Line":1}},{"line":140,"address":[],"length":0,"stats":{"Line":4}},{"line":142,"address":[],"length":0,"stats":{"Line":5}},{"line":146,"address":[],"length":0,"stats":{"Line":4}},{"line":147,"address":[],"length":0,"stats":{"Line":4}},{"line":148,"address":[],"length":0,"stats":{"Line":4}},{"line":152,"address":[],"length":0,"stats":{"Line":98}},{"line":153,"address":[],"length":0,"stats":{"Line":49}},{"line":154,"address":[],"length":0,"stats":{"Line":49}},{"line":155,"address":[],"length":0,"stats":{"Line":31}},{"line":157,"address":[],"length":0,"stats":{"Line":18}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":18}},{"line":164,"address":[],"length":0,"stats":{"Line":15}},{"line":165,"address":[],"length":0,"stats":{"Line":15}},{"line":169,"address":[],"length":0,"stats":{"Line":5}},{"line":174,"address":[],"length":0,"stats":{"Line":5}},{"line":175,"address":[],"length":0,"stats":{"Line":5}},{"line":179,"address":[],"length":0,"stats":{"Line":2}},{"line":180,"address":[],"length":0,"stats":{"Line":2}},{"line":184,"address":[],"length":0,"stats":{"Line":20}},{"line":185,"address":[],"length":0,"stats":{"Line":21}},{"line":189,"address":[],"length":0,"stats":{"Line":6}},{"line":190,"address":[],"length":0,"stats":{"Line":9}},{"line":193,"address":[],"length":0,"stats":{"Line":2}},{"line":196,"address":[],"length":0,"stats":{"Line":4}},{"line":199,"address":[],"length":0,"stats":{"Line":2}},{"line":200,"address":[],"length":0,"stats":{"Line":3}},{"line":201,"address":[],"length":0,"stats":{"Line":2}},{"line":203,"address":[],"length":0,"stats":{"Line":3}},{"line":204,"address":[],"length":0,"stats":{"Line":1}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":1}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":4}},{"line":222,"address":[],"length":0,"stats":{"Line":4}},{"line":223,"address":[],"length":0,"stats":{"Line":1}},{"line":225,"address":[],"length":0,"stats":{"Line":1}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":1}},{"line":240,"address":[],"length":0,"stats":{"Line":6}},{"line":241,"address":[],"length":0,"stats":{"Line":3}},{"line":242,"address":[],"length":0,"stats":{"Line":1}},{"line":244,"address":[],"length":0,"stats":{"Line":4}},{"line":245,"address":[],"length":0,"stats":{"Line":1}},{"line":246,"address":[],"length":0,"stats":{"Line":1}},{"line":250,"address":[],"length":0,"stats":{"Line":3}},{"line":251,"address":[],"length":0,"stats":{"Line":3}},{"line":253,"address":[],"length":0,"stats":{"Line":16}}],"covered":81,"coverable":88},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","config.rs"],"content":"#[derive(Debug, Clone, Copy, PartialEq)]\npub struct Config {\n    item_letter: char,\n    property_letter: char,\n}\n\nimpl Config {\n    /// Constructs a new `Config` object from item and property letters.\n    pub const fn new(item_letter: char, property_letter: char) -\u003e Config {\n        Config {\n            item_letter,\n            property_letter,\n        }\n    }\n\n    /// Returns the letter used for items.\n    pub const fn item_letter(\u0026self) -\u003e char {\n        self.item_letter\n    }\n\n    /// Returns the letter used for properties.\n    pub const fn property_letter(\u0026self) -\u003e char {\n        self.property_letter\n    }\n}\n\npub const WIKIDATA_CONFIG: Config = Config {\n    item_letter: 'Q',\n    property_letter: 'P',\n};\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_config() {\n        let config = Config::new('Q', 'P');\n        assert_eq!(config.item_letter(), 'Q');\n        assert_eq!(config.property_letter(), 'P');\n    }\n}\n","traces":[{"line":9,"address":[],"length":0,"stats":{"Line":2}},{"line":17,"address":[],"length":0,"stats":{"Line":20}},{"line":18,"address":[],"length":0,"stats":{"Line":20}},{"line":22,"address":[],"length":0,"stats":{"Line":6}},{"line":23,"address":[],"length":0,"stats":{"Line":6}}],"covered":5,"coverable":5},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","data_type.rs"],"content":"use crate::RestApiError;\n\n#[derive(Debug, Clone, PartialEq, Default, Copy)]\npub enum DataType {\n    #[default]\n    String,\n    Item,\n    Property,\n    Url,\n    Time,\n    GlobeCoordinate,\n    Quantity,\n    Monolingualtext,\n    CommonsMedia,\n    GeoShape,\n    TabularData,\n    Math,\n    MusicalNotation,\n    ExternalId,\n    WikibaseItem,\n    WikibaseProperty,\n    Lexeme,\n    Form,\n    Sense,\n    EntitySchema,\n}\n\nimpl DataType {\n    /// Constructs a new `DataType` object from a (valid) string.\n    /// # Errors\n    /// Returns a `RestApiError` if the string is not a valid `DataType`.\n    pub fn new\u003cS: Into\u003cString\u003e\u003e(s: S) -\u003e Result\u003cSelf, RestApiError\u003e {\n        match s.into().as_str() {\n            \"wikibase-item\" =\u003e Ok(DataType::WikibaseItem),\n            \"external-id\" =\u003e Ok(DataType::ExternalId),\n            \"url\" =\u003e Ok(DataType::Url),\n            \"commonsMedia\" =\u003e Ok(DataType::CommonsMedia),\n            \"monolingualtext\" =\u003e Ok(DataType::Monolingualtext),\n            \"quantity\" =\u003e Ok(DataType::Quantity),\n            \"string\" =\u003e Ok(DataType::String),\n            \"time\" =\u003e Ok(DataType::Time),\n            \"globe-coordinate\" =\u003e Ok(DataType::GlobeCoordinate),\n            \"wikibase-property\" =\u003e Ok(DataType::WikibaseProperty),\n            \"wikibase-lexeme\" =\u003e Ok(DataType::Lexeme),\n            \"wikibase-form\" =\u003e Ok(DataType::Form),\n            \"wikibase-sense\" =\u003e Ok(DataType::Sense),\n            \"geo-shape\" =\u003e Ok(DataType::GeoShape),\n            \"tabular-data\" =\u003e Ok(DataType::TabularData),\n            \"math\" =\u003e Ok(DataType::Math),\n            \"item\" =\u003e Ok(DataType::Item),\n            \"property\" =\u003e Ok(DataType::Property),\n            \"musical-notation\" =\u003e Ok(DataType::MusicalNotation),\n            \"entity-schema\" =\u003e Ok(DataType::EntitySchema),\n            other =\u003e Err(RestApiError::UnknownDataType(other.into())),\n        }\n    }\n\n    /// Returns the string representation of the data type.\n    pub const fn as_str(\u0026self) -\u003e \u0026str {\n        match self {\n            DataType::WikibaseItem =\u003e \"wikibase-item\",\n            DataType::ExternalId =\u003e \"external-id\",\n            DataType::Url =\u003e \"url\",\n            DataType::CommonsMedia =\u003e \"commonsMedia\",\n            DataType::Monolingualtext =\u003e \"monolingualtext\",\n            DataType::Quantity =\u003e \"quantity\",\n            DataType::String =\u003e \"string\",\n            DataType::Time =\u003e \"time\",\n            DataType::GlobeCoordinate =\u003e \"globe-coordinate\",\n            DataType::WikibaseProperty =\u003e \"wikibase-property\",\n            DataType::Lexeme =\u003e \"wikibase-lexeme\",\n            DataType::Form =\u003e \"wikibase-form\",\n            DataType::Sense =\u003e \"wikibase-sense\",\n            DataType::GeoShape =\u003e \"geo-shape\",\n            DataType::TabularData =\u003e \"tabular-data\",\n            DataType::Math =\u003e \"math\",\n            DataType::Item =\u003e \"item\",\n            DataType::Property =\u003e \"property\",\n            DataType::MusicalNotation =\u003e \"musical-notation\",\n            DataType::EntitySchema =\u003e \"entity-schema\",\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::RestApi;\n    use std::collections::HashMap;\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_data_type_from_str() {\n        // Useful to have this query the live API, and fast enough.\n        let api = RestApi::builder(\"https://www.wikidata.org/w/rest.php\")\n            .unwrap()\n            .build();\n        let request = api\n            .wikibase_request_builder(\"/property-data-types\", HashMap::new(), reqwest::Method::GET)\n            .await\n            .unwrap()\n            .build()\n            .unwrap();\n        let h: HashMap\u003cString, String\u003e = api\n            .execute(request)\n            .await\n            .unwrap()\n            .error_for_status()\n            .unwrap()\n            .json()\n            .await\n            .unwrap();\n        for (k, _v) in h {\n            let dt = DataType::new(\u0026k).unwrap();\n            assert_eq!(dt.as_str(), k);\n        }\n        assert!(DataType::new(\"not-a-data-type\").is_err());\n    }\n\n    #[test]\n    fn test_as_str() {\n        assert_eq!(DataType::WikibaseItem.as_str(), \"wikibase-item\");\n        assert_eq!(DataType::ExternalId.as_str(), \"external-id\");\n        assert_eq!(DataType::Url.as_str(), \"url\");\n        assert_eq!(DataType::CommonsMedia.as_str(), \"commonsMedia\");\n        assert_eq!(DataType::Monolingualtext.as_str(), \"monolingualtext\");\n        assert_eq!(DataType::Quantity.as_str(), \"quantity\");\n        assert_eq!(DataType::String.as_str(), \"string\");\n        assert_eq!(DataType::Time.as_str(), \"time\");\n        assert_eq!(DataType::GlobeCoordinate.as_str(), \"globe-coordinate\");\n        assert_eq!(DataType::WikibaseProperty.as_str(), \"wikibase-property\");\n        assert_eq!(DataType::Lexeme.as_str(), \"wikibase-lexeme\");\n        assert_eq!(DataType::Form.as_str(), \"wikibase-form\");\n        assert_eq!(DataType::Sense.as_str(), \"wikibase-sense\");\n        assert_eq!(DataType::GeoShape.as_str(), \"geo-shape\");\n        assert_eq!(DataType::TabularData.as_str(), \"tabular-data\");\n        assert_eq!(DataType::Math.as_str(), \"math\");\n        assert_eq!(DataType::Item.as_str(), \"item\");\n        assert_eq!(DataType::Property.as_str(), \"property\");\n        assert_eq!(DataType::MusicalNotation.as_str(), \"musical-notation\");\n        assert_eq!(DataType::EntitySchema.as_str(), \"entity-schema\");\n    }\n}\n","traces":[{"line":32,"address":[],"length":0,"stats":{"Line":9832}},{"line":33,"address":[],"length":0,"stats":{"Line":9832}},{"line":34,"address":[],"length":0,"stats":{"Line":12731}},{"line":35,"address":[],"length":0,"stats":{"Line":10230}},{"line":36,"address":[],"length":0,"stats":{"Line":4417}},{"line":37,"address":[],"length":0,"stats":{"Line":2899}},{"line":38,"address":[],"length":0,"stats":{"Line":3318}},{"line":39,"address":[],"length":0,"stats":{"Line":2377}},{"line":40,"address":[],"length":0,"stats":{"Line":2909}},{"line":41,"address":[],"length":0,"stats":{"Line":2992}},{"line":42,"address":[],"length":0,"stats":{"Line":123}},{"line":43,"address":[],"length":0,"stats":{"Line":201}},{"line":44,"address":[],"length":0,"stats":{"Line":10}},{"line":45,"address":[],"length":0,"stats":{"Line":9}},{"line":46,"address":[],"length":0,"stats":{"Line":8}},{"line":47,"address":[],"length":0,"stats":{"Line":7}},{"line":48,"address":[],"length":0,"stats":{"Line":6}},{"line":49,"address":[],"length":0,"stats":{"Line":5}},{"line":50,"address":[],"length":0,"stats":{"Line":3}},{"line":51,"address":[],"length":0,"stats":{"Line":3}},{"line":52,"address":[],"length":0,"stats":{"Line":4}},{"line":53,"address":[],"length":0,"stats":{"Line":3}},{"line":54,"address":[],"length":0,"stats":{"Line":1}},{"line":59,"address":[],"length":0,"stats":{"Line":3145}},{"line":60,"address":[],"length":0,"stats":{"Line":3145}},{"line":61,"address":[],"length":0,"stats":{"Line":893}},{"line":62,"address":[],"length":0,"stats":{"Line":974}},{"line":63,"address":[],"length":0,"stats":{"Line":275}},{"line":64,"address":[],"length":0,"stats":{"Line":14}},{"line":65,"address":[],"length":0,"stats":{"Line":185}},{"line":66,"address":[],"length":0,"stats":{"Line":26}},{"line":67,"address":[],"length":0,"stats":{"Line":229}},{"line":68,"address":[],"length":0,"stats":{"Line":467}},{"line":69,"address":[],"length":0,"stats":{"Line":5}},{"line":70,"address":[],"length":0,"stats":{"Line":59}},{"line":71,"address":[],"length":0,"stats":{"Line":2}},{"line":72,"address":[],"length":0,"stats":{"Line":2}},{"line":73,"address":[],"length":0,"stats":{"Line":2}},{"line":74,"address":[],"length":0,"stats":{"Line":2}},{"line":75,"address":[],"length":0,"stats":{"Line":2}},{"line":76,"address":[],"length":0,"stats":{"Line":2}},{"line":77,"address":[],"length":0,"stats":{"Line":1}},{"line":78,"address":[],"length":0,"stats":{"Line":1}},{"line":79,"address":[],"length":0,"stats":{"Line":2}},{"line":80,"address":[],"length":0,"stats":{"Line":2}}],"covered":45,"coverable":45},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","description.rs"],"content":"use crate::HttpGetEntityWithFallback;\nuse crate::{\n    get_put_delete::HttpMisc, EditMetadata, EntityId, HeaderInfo, HttpDelete, HttpGet, HttpPut,\n    LanguageString, RestApi, RestApiError, RevisionMatch,\n};\nuse async_trait::async_trait;\nuse derivative::Derivative;\nuse reqwest::Request;\nuse serde_json::json;\nuse std::collections::HashMap;\nuse std::ops::Deref;\n\n#[derive(Derivative, Debug, Clone)]\n#[derivative(PartialEq)]\npub struct Description {\n    ls: LanguageString,\n    #[derivative(PartialEq = \"ignore\")]\n    header_info: HeaderInfo,\n}\n\nimpl Description {\n    /// Constructs a new `Description` object from a language code and a description.\n    pub fn new\u003cS1: Into\u003cString\u003e, S2: Into\u003cString\u003e\u003e(language: S1, value: S2) -\u003e Description {\n        Self {\n            ls: LanguageString::new(language, value),\n            header_info: HeaderInfo::default(),\n        }\n    }\n\n    async fn generate_get_match_request(\n        id: \u0026EntityId,\n        language: \u0026str,\n        api: \u0026RestApi,\n        rm: RevisionMatch,\n        mode: \u0026str,\n    ) -\u003e Result\u003cRequest, RestApiError\u003e {\n        let path = format!(\n            \"/entities/{group}/{id}/{mode}/{language}\",\n            group = id.group()?\n        );\n        let mut request = api\n            .wikibase_request_builder(\u0026path, HashMap::new(), reqwest::Method::GET)\n            .await?\n            .build()?;\n        rm.modify_headers(request.headers_mut())?;\n        Ok(request)\n    }\n}\n\nimpl Deref for Description {\n    type Target = LanguageString;\n\n    fn deref(\u0026self) -\u003e \u0026Self::Target {\n        \u0026self.ls\n    }\n}\n\nimpl From\u003cLanguageString\u003e for Description {\n    fn from(ls: LanguageString) -\u003e Self {\n        Self {\n            ls,\n            header_info: HeaderInfo::default(),\n        }\n    }\n}\n\nimpl From\u003cDescription\u003e for LanguageString {\n    fn from(val: Description) -\u003e Self {\n        val.ls\n    }\n}\n\nimpl HttpMisc for Description {\n    fn get_my_rest_api_path(\u0026self, id: \u0026EntityId) -\u003e Result\u003cString, RestApiError\u003e {\n        Ok(format!(\n            \"/entities/{group}/{id}/descriptions/{language}\",\n            group = id.group()?,\n            language = self.ls.language()\n        ))\n    }\n}\n\n#[async_trait]\nimpl HttpGetEntityWithFallback for Description {\n    async fn get_match_with_fallback(\n        id: \u0026EntityId,\n        language: \u0026str,\n        api: \u0026RestApi,\n        rm: RevisionMatch,\n    ) -\u003e Result\u003cSelf, RestApiError\u003e {\n        let request = Self::generate_get_match_request(\n            id,\n            language,\n            api,\n            rm,\n            \"descriptions_with_language_fallback\",\n        )\n        .await?;\n        let (j, header_info) = Self::api_execute(api, request).await?;\n        let s = j\n            .as_str()\n            .ok_or_else(|| RestApiError::MissingOrInvalidField {\n                field: \"Descriptions\".into(),\n                j: j.to_owned(),\n            })?;\n        Ok(Self {\n            ls: LanguageString::new(language, s),\n            header_info,\n        })\n    }\n}\n\n#[async_trait]\nimpl HttpGet for Description {\n    async fn get_match(\n        id: \u0026EntityId,\n        language: \u0026str,\n        api: \u0026RestApi,\n        rm: RevisionMatch,\n    ) -\u003e Result\u003cSelf, RestApiError\u003e {\n        let request =\n            Self::generate_get_match_request(id, language, api, rm, \"descriptions\").await?;\n        let (j, header_info) = Self::api_execute(api, request).await?;\n        let s = j\n            .as_str()\n            .ok_or_else(|| RestApiError::MissingOrInvalidField {\n                field: \"Description\".into(),\n                j: j.to_owned(),\n            })?;\n        Ok(Self {\n            ls: LanguageString::new(language, s),\n            header_info,\n        })\n    }\n}\n\n#[async_trait]\nimpl HttpDelete for Description {\n    async fn delete_meta(\n        \u0026self,\n        id: \u0026EntityId,\n        api: \u0026mut RestApi,\n        em: EditMetadata,\n    ) -\u003e Result\u003c(), RestApiError\u003e {\n        let j = json!({});\n        self.run_json_query(id, reqwest::Method::DELETE, j, api, \u0026em)\n            .await?;\n        Ok(())\n    }\n}\n\n#[async_trait]\nimpl HttpPut for Description {\n    async fn put_meta(\n        \u0026self,\n        id: \u0026EntityId,\n        api: \u0026mut RestApi,\n        em: EditMetadata,\n    ) -\u003e Result\u003cSelf, RestApiError\u003e {\n        let j = json!({\"description\": self.ls.value()});\n        let (j, header_info) = self\n            .run_json_query(id, reqwest::Method::PUT, j, api, \u0026em)\n            .await?;\n        let value = j\n            .as_str()\n            .ok_or_else(|| RestApiError::MissingOrInvalidField {\n                field: \"Description\".into(),\n                j: j.to_owned(),\n            })?;\n        let mut ret = Self::new(self.language(), value);\n        ret.header_info = header_info;\n        Ok(ret)\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use wiremock::matchers::{bearer_token, body_partial_json, method, path};\n    use wiremock::{Mock, MockServer, ResponseTemplate};\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_descriptions_get_match_with_fallback() {\n        let id = \"Q42\";\n        let mock_path = format!(\n            \"/w/rest.php/wikibase/v1/entities/items/{id}/descriptions_with_language_fallback/foo\"\n        );\n        let mock_server = MockServer::start().await;\n        Mock::given(method(\"GET\"))\n            .and(path(\u0026mock_path))\n            .respond_with(ResponseTemplate::new(200).set_body_json(json!(\"Douglas Adams\")))\n            .mount(\u0026mock_server)\n            .await;\n        let api = RestApi::builder(\u0026(mock_server.uri() + \"/w/rest.php\"))\n            .unwrap()\n            .build();\n\n        let id = EntityId::item(id);\n        let description = Description::get_with_fallback(\u0026id, \"foo\", \u0026api)\n            .await\n            .unwrap();\n        assert_eq!(description.language(), \"foo\");\n        assert_eq!(description.value(), \"Douglas Adams\");\n    }\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_description_get() {\n        let id = \"Q42\";\n        let mock_description = \"Foo bar baz\";\n        let mock_path = format!(\"/w/rest.php/wikibase/v1/entities/items/{id}/descriptions/en\");\n        let mock_server = MockServer::start().await;\n        Mock::given(method(\"GET\"))\n            .and(path(\u0026mock_path))\n            .respond_with(ResponseTemplate::new(200).set_body_json(mock_description))\n            .mount(\u0026mock_server)\n            .await;\n        let api = RestApi::builder(\u0026(mock_server.uri() + \"/w/rest.php\"))\n            .unwrap()\n            .build();\n\n        let id = EntityId::item(id);\n        let description = Description::get(\u0026id, \"en\", \u0026api).await.unwrap();\n        assert_eq!(description.language(), \"en\");\n        assert_eq!(description.value(), mock_description);\n    }\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_description_put() {\n        let description = \"Foo bar baz\";\n        let id = \"Q42\";\n        let mock_path = format!(\"/w/rest.php/wikibase/v1/entities/items/{id}/descriptions/en\");\n        let mock_server = MockServer::start().await;\n        let token = \"FAKE_TOKEN\";\n        Mock::given(body_partial_json(json!({\"description\": description})))\n            .and(method(\"PUT\"))\n            .and(path(\u0026mock_path))\n            .and(bearer_token(token))\n            .respond_with(ResponseTemplate::new(200).set_body_json(json!(description)))\n            .mount(\u0026mock_server)\n            .await;\n        let mut api = RestApi::builder(\u0026(mock_server.uri() + \"/w/rest.php\"))\n            .unwrap()\n            .with_access_token(token)\n            .build();\n\n        let id = EntityId::item(id);\n        let new_description = Description::new(\"en\", description);\n        let return_description = new_description.put(\u0026id, \u0026mut api).await.unwrap();\n        assert_eq!(return_description.language(), \"en\");\n        assert_eq!(return_description.value(), description);\n    }\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_description_delete() {\n        let id = \"Q42\";\n        let mock_path = format!(\"/w/rest.php/wikibase/v1/entities/items/{id}/descriptions/en\");\n        let mock_server = MockServer::start().await;\n        let token = \"FAKE_TOKEN\";\n        Mock::given(method(\"DELETE\"))\n            .and(path(\u0026mock_path))\n            .and(bearer_token(token))\n            .respond_with(ResponseTemplate::new(200).set_body_json(json!(\"Description deleted\")))\n            .mount(\u0026mock_server)\n            .await;\n        let mut api = RestApi::builder(\u0026(mock_server.uri() + \"/w/rest.php\"))\n            .unwrap()\n            .with_access_token(token)\n            .build();\n\n        let id = EntityId::item(id);\n        let description = Description::new(\"en\", \"\");\n        let result = description.delete(\u0026id, \u0026mut api).await;\n        assert!(result.is_ok());\n    }\n\n    #[test]\n    fn test_from() {\n        let ls = LanguageString::new(\"en\", \"Foo bar baz\");\n        let description = Description::from(ls);\n        assert_eq!(description.language(), \"en\");\n        assert_eq!(description.value(), \"Foo bar baz\");\n    }\n\n    #[test]\n    fn test_into() {\n        let description = Description::new(\"en\", \"Foo bar baz\");\n        let ls: LanguageString = description.into();\n        assert_eq!(ls.language(), \"en\");\n        assert_eq!(ls.value(), \"Foo bar baz\");\n    }\n}\n","traces":[{"line":23,"address":[],"length":0,"stats":{"Line":4}},{"line":25,"address":[],"length":0,"stats":{"Line":4}},{"line":26,"address":[],"length":0,"stats":{"Line":4}},{"line":30,"address":[],"length":0,"stats":{"Line":2}},{"line":37,"address":[],"length":0,"stats":{"Line":2}},{"line":39,"address":[],"length":0,"stats":{"Line":2}},{"line":41,"address":[],"length":0,"stats":{"Line":2}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":2}},{"line":53,"address":[],"length":0,"stats":{"Line":9}},{"line":54,"address":[],"length":0,"stats":{"Line":9}},{"line":59,"address":[],"length":0,"stats":{"Line":1}},{"line":62,"address":[],"length":0,"stats":{"Line":1}},{"line":68,"address":[],"length":0,"stats":{"Line":1}},{"line":69,"address":[],"length":0,"stats":{"Line":1}},{"line":74,"address":[],"length":0,"stats":{"Line":2}},{"line":75,"address":[],"length":0,"stats":{"Line":2}},{"line":76,"address":[],"length":0,"stats":{"Line":2}},{"line":77,"address":[],"length":0,"stats":{"Line":2}},{"line":92,"address":[],"length":0,"stats":{"Line":1}},{"line":93,"address":[],"length":0,"stats":{"Line":1}},{"line":94,"address":[],"length":0,"stats":{"Line":1}},{"line":95,"address":[],"length":0,"stats":{"Line":1}},{"line":98,"address":[],"length":0,"stats":{"Line":1}},{"line":99,"address":[],"length":0,"stats":{"Line":1}},{"line":100,"address":[],"length":0,"stats":{"Line":1}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":1}},{"line":122,"address":[],"length":0,"stats":{"Line":1}},{"line":123,"address":[],"length":0,"stats":{"Line":1}},{"line":124,"address":[],"length":0,"stats":{"Line":1}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":1}},{"line":146,"address":[],"length":0,"stats":{"Line":1}},{"line":147,"address":[],"length":0,"stats":{"Line":1}},{"line":148,"address":[],"length":0,"stats":{"Line":1}},{"line":160,"address":[],"length":0,"stats":{"Line":1}},{"line":161,"address":[],"length":0,"stats":{"Line":2}},{"line":162,"address":[],"length":0,"stats":{"Line":1}},{"line":163,"address":[],"length":0,"stats":{"Line":1}},{"line":164,"address":[],"length":0,"stats":{"Line":1}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}}],"covered":38,"coverable":49},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","descriptions.rs"],"content":"use crate::{\n    language_strings_patch::LanguageStringsPatch, prelude::LanguageStrings, EntityId, FromJson,\n    HeaderInfo, HttpGetEntity, HttpMisc, LanguageString, RestApi, RestApiError, RevisionMatch,\n};\nuse async_trait::async_trait;\nuse derivative::Derivative;\nuse serde::ser::{Serialize, SerializeMap};\nuse serde_json::{json, Value};\nuse std::collections::HashMap;\n\n#[derive(Derivative, Debug, Clone, Default)]\n#[derivative(PartialEq)]\npub struct Descriptions {\n    ls: HashMap\u003cString, String\u003e,\n    #[derivative(PartialEq = \"ignore\")]\n    header_info: HeaderInfo,\n}\n\nimpl Descriptions {\n    /// Returns the value for a language\n    pub fn get_lang\u003cS: Into\u003cString\u003e\u003e(\u0026self, language: S) -\u003e Option\u003c\u0026str\u003e {\n        self.ls.get(\u0026language.into()).map(|s| s.as_str())\n    }\n\n    /// Returns the number of labels/languages\n    pub fn len(\u0026self) -\u003e usize {\n        self.ls.len()\n    }\n\n    /// Returns true if there are no labels/languages\n    pub fn is_empty(\u0026self) -\u003e bool {\n        self.ls.is_empty()\n    }\n\n    /// Generates a patch to transform `other` into `self`\n    pub fn patch(\u0026self, other: \u0026Self) -\u003e Result\u003cLanguageStringsPatch, RestApiError\u003e {\n        let patch = json_patch::diff(\u0026json!(\u0026other), \u0026json!(\u0026self));\n        let patch = LanguageStringsPatch::descriptions_from_json(\u0026json!(patch))?;\n        Ok(patch)\n    }\n}\n\nimpl HttpMisc for Descriptions {\n    fn get_rest_api_path(id: \u0026EntityId) -\u003e Result\u003cString, RestApiError\u003e {\n        Ok(format!(\n            \"/entities/{group}/{id}/descriptions\",\n            group = id.group()?\n        ))\n    }\n}\n\n#[async_trait]\nimpl HttpGetEntity for Descriptions {\n    async fn get_match(\n        id: \u0026EntityId,\n        api: \u0026RestApi,\n        rm: RevisionMatch,\n    ) -\u003e Result\u003cSelf, RestApiError\u003e {\n        let path = Self::get_rest_api_path(id)?;\n        let (j, header_info) = Self::get_match_internal(api, \u0026path, rm).await?;\n        Self::from_json_header_info(\u0026j, header_info)\n    }\n}\n\nimpl FromJson for Descriptions {\n    fn header_info(\u0026self) -\u003e \u0026HeaderInfo {\n        \u0026self.header_info\n    }\n\n    fn from_json_header_info(j: \u0026Value, header_info: HeaderInfo) -\u003e Result\u003cSelf, RestApiError\u003e {\n        let ls = j\n            .as_object()\n            .ok_or_else(|| RestApiError::WrongType {\n                field: \"Descriptions\".to_string(),\n                j: j.to_owned(),\n            })?\n            .iter()\n            .map(|(language, value)| {\n                let value = value\n                    .as_str()\n                    .ok_or_else(|| RestApiError::MissingOrInvalidField {\n                        field: \"Descriptions\".into(),\n                        j: value.to_owned(),\n                    })?;\n                Ok((language.to_owned(), value.to_string()))\n            })\n            .collect::\u003cResult\u003cHashMap\u003cString, String\u003e, RestApiError\u003e\u003e()?;\n        let ret = Self { ls, header_info };\n        Ok(ret)\n    }\n}\n\nimpl LanguageStrings for Descriptions {\n    fn has_language\u003cS: Into\u003cString\u003e\u003e(\u0026self, language: S) -\u003e bool {\n        self.ls.contains_key(\u0026language.into())\n    }\n\n    fn insert(\u0026mut self, ls: LanguageString) {\n        self.ls\n            .insert(ls.language().to_string(), ls.value().to_string());\n    }\n}\n\nimpl Serialize for Descriptions {\n    fn serialize\u003cS\u003e(\u0026self, serializer: S) -\u003e Result\u003cS::Ok, S::Error\u003e\n    where\n        S: serde::Serializer,\n    {\n        let mut s = serializer.serialize_map(Some(self.ls.len()))?;\n        for (language, ls) in \u0026self.ls {\n            s.serialize_entry(language, ls)?;\n        }\n        s.end()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use serde_json::json;\n    use wiremock::matchers::{method, path};\n    use wiremock::{Mock, MockServer, ResponseTemplate};\n\n    #[test]\n    fn test_language_strings_single() {\n        let j = json!({\n            \"en\": \"Hello\",\n            \"de\": \"Hallo\",\n        });\n        let ls = Descriptions::from_json(\u0026j).unwrap();\n        assert_eq!(ls.get_lang(\"en\"), Some(\"Hello\"));\n        assert_eq!(ls.get_lang(\"de\"), Some(\"Hallo\"));\n        assert_eq!(ls.get_lang(\"fr\"), None);\n    }\n\n    #[test]\n    fn test_language_strings_insert() {\n        let mut ls = Descriptions::default();\n        ls.insert(LanguageString::new(\"en\", \"Hello\"));\n        ls.insert(LanguageString::new(\"de\", \"Hallo\"));\n        ls.insert(LanguageString::new(\"en\", \"Hi\"));\n        assert_eq!(ls.get_lang(\"en\"), Some(\"Hi\"));\n        assert_eq!(ls.get_lang(\"de\"), Some(\"Hallo\"));\n    }\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_language_strings_single_get() {\n        let v = std::fs::read_to_string(\"test_data/Q42.json\").unwrap();\n        let v: Value = serde_json::from_str(\u0026v).unwrap();\n\n        let mock_path = \"/w/rest.php/wikibase/v1/entities/items/Q42/descriptions\";\n        let mock_server = MockServer::start().await;\n        Mock::given(method(\"GET\"))\n            .and(path(mock_path))\n            .respond_with(ResponseTemplate::new(200).set_body_json(\u0026v[\"descriptions\"]))\n            .mount(\u0026mock_server)\n            .await;\n        let api = RestApi::builder(\u0026(mock_server.uri() + \"/w/rest.php\"))\n            .unwrap()\n            .build();\n\n        let id = EntityId::new(\"Q42\").unwrap();\n        let ls = Descriptions::get(\u0026id, \u0026api).await.unwrap();\n        assert_eq!(ls.get_lang(\"en-gb\"), Some(\"English writer and humourist\"));\n    }\n\n    #[test]\n    fn test_patch_descriptions() {\n        let mut l1 = Descriptions::default();\n        l1.insert(LanguageString::new(\"en\", \"Foo\"));\n        l1.insert(LanguageString::new(\"de\", \"Bar\"));\n        let mut l2 = l1.clone();\n        l2.insert(LanguageString::new(\"en\", \"Baz\"));\n\n        let patch = l2.patch(\u0026l1).unwrap();\n        let patch_json = json!(patch);\n        assert_eq!(\n            patch_json,\n            json!({\"mode\":\"Descriptions\",\"patch\":[{\"op\":\"replace\",\"path\":\"/en\",\"value\":\"Baz\"}]})\n        );\n    }\n\n    #[test]\n    fn test_get_rest_api_path() {\n        let l = Descriptions::default();\n        let id = EntityId::new(\"Q42\").unwrap();\n        assert_eq!(\n            l.get_my_rest_api_path(\u0026id).unwrap(),\n            \"/entities/items/Q42/descriptions\"\n        );\n    }\n\n    #[test]\n    fn test_header_info_single() {\n        let l = Descriptions::default();\n        assert_eq!(l.header_info(), \u0026HeaderInfo::default());\n    }\n\n    #[test]\n    fn test_serialize() {\n        let mut l = Descriptions::default();\n        l.insert(LanguageString::new(\"en\", \"Foo\"));\n        l.insert(LanguageString::new(\"de\", \"Bar\"));\n        let s = serde_json::to_string(\u0026l).unwrap();\n        assert!(s.contains(r#\"\"en\":\"Foo\"\"#));\n        assert!(s.contains(r#\"\"de\":\"Bar\"\"#));\n    }\n\n    #[test]\n    fn test_is_empty() {\n        let mut l = Descriptions::default();\n        assert!(l.is_empty());\n        l.insert(LanguageString::new(\"en\", \"Foo\"));\n        assert!(!l.is_empty());\n    }\n}\n","traces":[{"line":21,"address":[],"length":0,"stats":{"Line":7}},{"line":22,"address":[],"length":0,"stats":{"Line":20}},{"line":26,"address":[],"length":0,"stats":{"Line":4}},{"line":27,"address":[],"length":0,"stats":{"Line":4}},{"line":31,"address":[],"length":0,"stats":{"Line":18}},{"line":32,"address":[],"length":0,"stats":{"Line":18}},{"line":36,"address":[],"length":0,"stats":{"Line":2}},{"line":37,"address":[],"length":0,"stats":{"Line":2}},{"line":38,"address":[],"length":0,"stats":{"Line":4}},{"line":44,"address":[],"length":0,"stats":{"Line":2}},{"line":45,"address":[],"length":0,"stats":{"Line":2}},{"line":46,"address":[],"length":0,"stats":{"Line":2}},{"line":47,"address":[],"length":0,"stats":{"Line":2}},{"line":59,"address":[],"length":0,"stats":{"Line":2}},{"line":60,"address":[],"length":0,"stats":{"Line":1}},{"line":66,"address":[],"length":0,"stats":{"Line":1}},{"line":67,"address":[],"length":0,"stats":{"Line":1}},{"line":70,"address":[],"length":0,"stats":{"Line":17}},{"line":71,"address":[],"length":0,"stats":{"Line":34}},{"line":73,"address":[],"length":0,"stats":{"Line":17}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":1300}},{"line":79,"address":[],"length":0,"stats":{"Line":2566}},{"line":80,"address":[],"length":0,"stats":{"Line":1283}},{"line":81,"address":[],"length":0,"stats":{"Line":1283}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":1}},{"line":95,"address":[],"length":0,"stats":{"Line":1}},{"line":98,"address":[],"length":0,"stats":{"Line":12}},{"line":99,"address":[],"length":0,"stats":{"Line":12}},{"line":100,"address":[],"length":0,"stats":{"Line":12}},{"line":105,"address":[],"length":0,"stats":{"Line":12}},{"line":109,"address":[],"length":0,"stats":{"Line":24}},{"line":110,"address":[],"length":0,"stats":{"Line":1004}},{"line":111,"address":[],"length":0,"stats":{"Line":496}},{"line":113,"address":[],"length":0,"stats":{"Line":12}}],"covered":34,"coverable":38},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","descriptions_patch.rs"],"content":"use crate::{patch_entry::PatchEntry, EntityId, HttpMisc, Patch, RestApiError};\nuse serde::Serialize;\nuse serde_json::Value;\n\n#[derive(Debug, Clone, PartialEq, Serialize, Default)]\npub struct DescriptionsPatch {\n    patch: Vec\u003cPatchEntry\u003e,\n}\n\nimpl DescriptionsPatch {\n    pub fn from_json(j: \u0026Value) -\u003e Result\u003cVec\u003cPatchEntry\u003e, RestApiError\u003e {\n        j.as_array()\n            .ok_or_else(|| RestApiError::MissingOrInvalidField {\n                field: \"DescriptionsPatch\".into(),\n                j: j.to_owned(),\n            })?\n            .iter()\n            .map(|x| serde_json::from_value(x.clone()).map_err(|e| e.into()))\n            .collect::\u003cResult\u003cVec\u003cPatchEntry\u003e, RestApiError\u003e\u003e()\n    }\n\n    // TODO add?\n\n    /// Adds a command to replace the value of a language string.\n    pub fn replace\u003cS1: Into\u003cString\u003e, S2: Into\u003cString\u003e\u003e(\u0026mut self, language: S1, value: S2) {\n        \u003cSelf as Patch\u003e::replace(self, format!(\"/{}\", language.into()), value.into().into());\n    }\n\n    /// Adds a command to remove the value for the language.\n    pub fn remove\u003cS: Into\u003cString\u003e\u003e(\u0026mut self, language: S) {\n        \u003cSelf as Patch\u003e::remove(self, format!(\"/{}\", language.into()));\n    }\n}\n\nimpl Patch for DescriptionsPatch {\n    fn patch(\u0026self) -\u003e \u0026Vec\u003cPatchEntry\u003e {\n        \u0026self.patch\n    }\n\n    fn patch_mut(\u0026mut self) -\u003e \u0026mut Vec\u003cPatchEntry\u003e {\n        \u0026mut self.patch\n    }\n}\n\nimpl HttpMisc for DescriptionsPatch {\n    fn get_my_rest_api_path(\u0026self, id: \u0026EntityId) -\u003e Result\u003cString, RestApiError\u003e {\n        Ok(format!(\n            \"/entities/{group}/{id}/descriptions\",\n            group = id.group()?\n        ))\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use serde_json::{json, Value};\n\n    #[test]\n    fn test_remove() {\n        let mut patch = DescriptionsPatch::default();\n        patch.remove(\"en\");\n        assert_eq!(\n            patch.patch,\n            vec![PatchEntry::new(\"remove\", \"/en\", Value::Null)]\n        );\n    }\n\n    #[test]\n    fn test_patch() {\n        let mut patch = DescriptionsPatch::default();\n        patch.replace(\"en\", \"Foo Bar\");\n        assert_eq!(\n            patch.patch,\n            vec![PatchEntry::new(\"replace\", \"/en\", json!(\"Foo Bar\"))]\n        );\n    }\n\n    #[test]\n    fn test_descriptions() {\n        let mut patch = DescriptionsPatch::default();\n        patch.replace(\"en\", \"Foo Bar\");\n        assert_eq!(\n            patch.patch,\n            vec![PatchEntry::new(\"replace\", \"/en\", json!(\"Foo Bar\"))]\n        );\n    }\n\n    #[test]\n    fn test_patch_fn() {\n        let mut patch = DescriptionsPatch::default();\n        patch.replace(\"en\", \"Foo Bar\");\n        assert_eq!(\n            *\u003cDescriptionsPatch as Patch\u003e::patch(\u0026patch),\n            vec![PatchEntry::new(\"replace\", \"/en\", json!(\"Foo Bar\"))]\n        );\n    }\n\n    #[test]\n    fn test_from_json() {\n        let j = json!([\n            {\"op\": \"replace\", \"path\": \"/en\", \"value\": \"Foo Bar\"},\n            {\"op\": \"remove\", \"path\": \"/de\"}\n        ]);\n        let patch = DescriptionsPatch::from_json(\u0026j).unwrap();\n        assert_eq!(\n            patch,\n            vec![\n                PatchEntry::new(\"replace\", \"/en\", json!(\"Foo Bar\")),\n                PatchEntry::new(\"remove\", \"/de\", Value::Null)\n            ]\n        );\n    }\n\n    #[test]\n    fn test_get_rest_api_path() {\n        let patch = DescriptionsPatch::default();\n        let id = EntityId::new(\"Q123\").unwrap();\n        assert_eq!(\n            patch.get_my_rest_api_path(\u0026id).unwrap(),\n            \"/entities/items/Q123/descriptions\"\n        );\n    }\n}\n","traces":[{"line":11,"address":[],"length":0,"stats":{"Line":1}},{"line":12,"address":[],"length":0,"stats":{"Line":1}},{"line":13,"address":[],"length":0,"stats":{"Line":1}},{"line":14,"address":[],"length":0,"stats":{"Line":0}},{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":5}},{"line":25,"address":[],"length":0,"stats":{"Line":3}},{"line":26,"address":[],"length":0,"stats":{"Line":3}},{"line":30,"address":[],"length":0,"stats":{"Line":1}},{"line":31,"address":[],"length":0,"stats":{"Line":1}},{"line":36,"address":[],"length":0,"stats":{"Line":1}},{"line":37,"address":[],"length":0,"stats":{"Line":1}},{"line":40,"address":[],"length":0,"stats":{"Line":4}},{"line":41,"address":[],"length":0,"stats":{"Line":4}},{"line":46,"address":[],"length":0,"stats":{"Line":1}},{"line":47,"address":[],"length":0,"stats":{"Line":1}},{"line":48,"address":[],"length":0,"stats":{"Line":1}},{"line":49,"address":[],"length":0,"stats":{"Line":1}}],"covered":16,"coverable":18},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","edit_metadata.rs"],"content":"use crate::RevisionMatch;\n\n#[derive(Debug, Clone, Default, PartialEq)]\npub struct EditMetadata {\n    comment: Option\u003cString\u003e,\n    bot: bool,\n    minor: bool,\n    tags: Vec\u003cString\u003e,\n    revision_match: RevisionMatch,\n}\n\nimpl EditMetadata {\n    pub fn comment(\u0026self) -\u003e Option\u003cString\u003e {\n        self.comment.to_owned()\n    }\n\n    pub const fn bot(\u0026self) -\u003e bool {\n        self.bot\n    }\n\n    pub const fn minor(\u0026self) -\u003e bool {\n        self.minor\n    }\n\n    pub fn tags(\u0026self) -\u003e \u0026[String] {\n        \u0026self.tags\n    }\n\n    pub const fn revision_match(\u0026self) -\u003e \u0026RevisionMatch {\n        \u0026self.revision_match\n    }\n\n    pub fn set_comment(\u0026mut self, comment: Option\u003cString\u003e) {\n        self.comment = comment;\n    }\n\n    pub const fn set_bot(\u0026mut self, bot: bool) {\n        self.bot = bot;\n    }\n\n    pub const fn set_minor(\u0026mut self, minor: bool) {\n        self.minor = minor;\n    }\n\n    pub fn set_tags(\u0026mut self, tags: Vec\u003cString\u003e) {\n        self.tags = tags;\n    }\n\n    pub fn set_revision_match(\u0026mut self, revision_match: RevisionMatch) {\n        self.revision_match = revision_match;\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_edit_metadata() {\n        let mut edit_metadata = EditMetadata::default();\n        assert_eq!(edit_metadata.comment(), None);\n        assert!(!edit_metadata.bot());\n        assert!(!edit_metadata.minor());\n        assert!(edit_metadata.tags().is_empty());\n\n        edit_metadata.set_comment(Some(\"Test\".to_string()));\n        assert_eq!(edit_metadata.comment(), Some(\"Test\".to_string()));\n\n        edit_metadata.set_bot(true);\n        assert!(edit_metadata.bot());\n\n        edit_metadata.set_minor(true);\n        assert!(edit_metadata.minor());\n\n        edit_metadata.set_tags(vec![\"Test\".to_string()]);\n        assert_eq!(edit_metadata.tags(), \u0026[\"Test\".to_string()]);\n    }\n\n    #[test]\n    fn test_set_revision_match() {\n        let mut edit_metadata = EditMetadata::default();\n        let mut revision_match = RevisionMatch::default();\n        revision_match.set_modified_since_revisions(vec![1]);\n        edit_metadata.set_revision_match(revision_match.clone());\n        assert_eq!(edit_metadata.revision_match(), \u0026revision_match);\n    }\n}\n","traces":[{"line":13,"address":[],"length":0,"stats":{"Line":20}},{"line":14,"address":[],"length":0,"stats":{"Line":20}},{"line":17,"address":[],"length":0,"stats":{"Line":20}},{"line":18,"address":[],"length":0,"stats":{"Line":20}},{"line":21,"address":[],"length":0,"stats":{"Line":2}},{"line":22,"address":[],"length":0,"stats":{"Line":2}},{"line":25,"address":[],"length":0,"stats":{"Line":20}},{"line":26,"address":[],"length":0,"stats":{"Line":20}},{"line":29,"address":[],"length":0,"stats":{"Line":16}},{"line":30,"address":[],"length":0,"stats":{"Line":16}},{"line":33,"address":[],"length":0,"stats":{"Line":1}},{"line":34,"address":[],"length":0,"stats":{"Line":1}},{"line":37,"address":[],"length":0,"stats":{"Line":1}},{"line":38,"address":[],"length":0,"stats":{"Line":1}},{"line":41,"address":[],"length":0,"stats":{"Line":1}},{"line":42,"address":[],"length":0,"stats":{"Line":1}},{"line":45,"address":[],"length":0,"stats":{"Line":1}},{"line":46,"address":[],"length":0,"stats":{"Line":1}},{"line":49,"address":[],"length":0,"stats":{"Line":1}},{"line":50,"address":[],"length":0,"stats":{"Line":1}}],"covered":20,"coverable":20},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","entity.rs"],"content":"use crate::{EditMetadata, EntityId, HeaderInfo, HttpMisc, RestApi, RestApiError, RevisionMatch};\nuse async_trait::async_trait;\nuse reqwest::{Request, Response};\nuse serde::ser::Serialize;\nuse serde_json::{json, Value};\nuse std::collections::HashMap;\n\n#[derive(Debug, Clone, Copy, PartialEq)]\npub enum EntityType {\n    Item,\n    Property,\n}\n\nimpl EntityType {\n    pub const fn type_name(\u0026self) -\u003e \u0026str {\n        match self {\n            EntityType::Item =\u003e \"item\",\n            EntityType::Property =\u003e \"property\",\n        }\n    }\n\n    pub const fn group_name(\u0026self) -\u003e \u0026str {\n        match self {\n            EntityType::Item =\u003e \"items\",\n            EntityType::Property =\u003e \"properties\",\n        }\n    }\n}\n\n#[async_trait]\npub trait Entity: Default + Sized + Serialize + HttpMisc {\n    fn id(\u0026self) -\u003e EntityId;\n    fn from_json_header_info(j: Value, header_info: HeaderInfo) -\u003e Result\u003cSelf, RestApiError\u003e;\n\n    fn from_json(j: Value) -\u003e Result\u003cSelf, RestApiError\u003e {\n        Self::from_json_header_info(j, HeaderInfo::default())\n    }\n\n    async fn get(id: EntityId, api: \u0026RestApi) -\u003e Result\u003cSelf, RestApiError\u003e {\n        Self::get_match(id, api, RevisionMatch::default()).await\n    }\n\n    async fn generate_get_match_request(\n        id: EntityId,\n        api: \u0026RestApi,\n        rm: RevisionMatch,\n    ) -\u003e Result\u003cRequest, RestApiError\u003e {\n        let path = format!(\"/entities/{group}/{id}\", group = id.group()?);\n        let mut request = api\n            .wikibase_request_builder(\u0026path, HashMap::new(), reqwest::Method::GET)\n            .await?\n            .build()?;\n        rm.modify_headers(request.headers_mut())?;\n        Ok(request)\n    }\n\n    async fn get_match(\n        id: EntityId,\n        api: \u0026RestApi,\n        rm: RevisionMatch,\n    ) -\u003e Result\u003cSelf, RestApiError\u003e {\n        let request = Self::generate_get_match_request(id, api, rm).await?;\n        let response = api.execute(request).await?;\n        if !response.status().is_success() {\n            return Err(RestApiError::from_response(response).await);\n        }\n        let hi = HeaderInfo::from_header(response.headers());\n        let j: Value = response.error_for_status()?.json().await?;\n        let ret = Self::from_json_header_info(j, hi)?;\n        Ok(ret)\n    }\n\n    async fn post(\u0026self, api: \u0026RestApi) -\u003e Result\u003cSelf, RestApiError\u003e;\n\n    async fn post_with_type(\n        \u0026self,\n        entity_type: EntityType,\n        api: \u0026RestApi,\n    ) -\u003e Result\u003cSelf, RestApiError\u003e {\n        self.post_with_type_and_metadata(entity_type, api, EditMetadata::default())\n            .await\n    }\n\n    async fn build_post_with_type_and_metadata_request(\n        \u0026self,\n        entity_type: EntityType,\n        path: \u0026str,\n        api: \u0026RestApi,\n        em: EditMetadata,\n    ) -\u003e Result\u003creqwest::Request, RestApiError\u003e {\n        let mut request = api\n            .wikibase_request_builder(path, HashMap::new(), reqwest::Method::POST)\n            .await?\n            .build()?;\n        let mut j: Value = json!({entity_type.type_name(): self});\n        Self::add_metadata_to_json(\u0026mut j, \u0026em);\n        *request.body_mut() = Some(format!(\"{j}\").into());\n        Ok(request)\n    }\n\n    async fn check_post_with_type_and_metadata_response(\n        path: \u0026str,\n        response: Response,\n    ) -\u003e Result\u003cResponse, RestApiError\u003e {\n        if response.status().is_success() {\n            return Ok(response);\n        }\n        let status_code = response.status();\n        if status_code == 404 {\n            return Err(RestApiError::NotImplementedInRestApi {\n                method: reqwest::Method::POST,\n                path: path.to_string(),\n            });\n        }\n        Err(RestApiError::from_response(response).await)\n    }\n\n    async fn post_with_type_and_metadata(\n        \u0026self,\n        entity_type: EntityType,\n        api: \u0026RestApi,\n        em: EditMetadata,\n    ) -\u003e Result\u003cSelf, RestApiError\u003e {\n        if self.id().is_some() {\n            return Err(RestApiError::HasId);\n        }\n        let path = format!(\"/entities/{group}\", group = entity_type.group_name());\n        let request = self\n            .build_post_with_type_and_metadata_request(entity_type, \u0026path, api, em)\n            .await?;\n        let response = api.execute(request).await?;\n        let response = Self::check_post_with_type_and_metadata_response(\u0026path, response).await?;\n\n        let j: Value = response.json().await?;\n        // TODO return entire entity? Check if it's the same as this one?\n        let ret = Self::from_json(j)?;\n        Ok(ret)\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_entity_type() {\n        assert_eq!(EntityType::Item.type_name(), \"item\");\n        assert_eq!(EntityType::Property.type_name(), \"property\");\n        assert_eq!(EntityType::Item.group_name(), \"items\");\n        assert_eq!(EntityType::Property.group_name(), \"properties\");\n    }\n}\n","traces":[{"line":15,"address":[],"length":0,"stats":{"Line":5}},{"line":16,"address":[],"length":0,"stats":{"Line":5}},{"line":17,"address":[],"length":0,"stats":{"Line":3}},{"line":18,"address":[],"length":0,"stats":{"Line":2}},{"line":22,"address":[],"length":0,"stats":{"Line":8}},{"line":23,"address":[],"length":0,"stats":{"Line":8}},{"line":24,"address":[],"length":0,"stats":{"Line":5}},{"line":25,"address":[],"length":0,"stats":{"Line":3}},{"line":35,"address":[],"length":0,"stats":{"Line":6}},{"line":36,"address":[],"length":0,"stats":{"Line":6}},{"line":39,"address":[],"length":0,"stats":{"Line":11}},{"line":40,"address":[],"length":0,"stats":{"Line":11}},{"line":43,"address":[],"length":0,"stats":{"Line":11}},{"line":48,"address":[],"length":0,"stats":{"Line":22}},{"line":49,"address":[],"length":0,"stats":{"Line":11}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":11}},{"line":62,"address":[],"length":0,"stats":{"Line":22}},{"line":63,"address":[],"length":0,"stats":{"Line":11}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":2}},{"line":67,"address":[],"length":0,"stats":{"Line":9}},{"line":68,"address":[],"length":0,"stats":{"Line":27}},{"line":69,"address":[],"length":0,"stats":{"Line":9}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":5}},{"line":81,"address":[],"length":0,"stats":{"Line":5}},{"line":91,"address":[],"length":0,"stats":{"Line":6}},{"line":92,"address":[],"length":0,"stats":{"Line":3}},{"line":93,"address":[],"length":0,"stats":{"Line":3}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":3}},{"line":105,"address":[],"length":0,"stats":{"Line":3}},{"line":106,"address":[],"length":0,"stats":{"Line":2}},{"line":108,"address":[],"length":0,"stats":{"Line":1}},{"line":109,"address":[],"length":0,"stats":{"Line":1}},{"line":110,"address":[],"length":0,"stats":{"Line":1}},{"line":111,"address":[],"length":0,"stats":{"Line":1}},{"line":112,"address":[],"length":0,"stats":{"Line":1}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":5}},{"line":125,"address":[],"length":0,"stats":{"Line":2}},{"line":127,"address":[],"length":0,"stats":{"Line":3}},{"line":128,"address":[],"length":0,"stats":{"Line":3}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":3}},{"line":132,"address":[],"length":0,"stats":{"Line":3}},{"line":134,"address":[],"length":0,"stats":{"Line":2}},{"line":136,"address":[],"length":0,"stats":{"Line":2}},{"line":137,"address":[],"length":0,"stats":{"Line":0}}],"covered":43,"coverable":56},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","entity_container.rs"],"content":"use crate::{entity::Entity, EntityId, Item, Property, RestApi, RestApiError};\nuse futures::prelude::*;\nuse std::{collections::HashMap, sync::Arc};\nuse tokio::sync::RwLock;\n\nconst MAX_CONCURRENT_LOAD_DEFAULT: usize = 10;\n\n#[derive(Debug, Clone)]\npub struct EntityContainer {\n    api: Arc\u003cRestApi\u003e,\n    items: Arc\u003cRwLock\u003cHashMap\u003cString, Item\u003e\u003e\u003e,\n    properties: Arc\u003cRwLock\u003cHashMap\u003cString, Property\u003e\u003e\u003e,\n    max_concurrent_load: usize,\n}\n\nimpl EntityContainer {\n    /// Returns a new `EntityContainerBuilder` to configure a new `EntityContainer`.\n    pub fn builder() -\u003e EntityContainerBuilder {\n        EntityContainerBuilder::default()\n    }\n\n    /// Loads the entities with the given `EntityId`s into the container.\n    pub async fn load(\u0026self, entity_ids: \u0026[EntityId]) -\u003e Result\u003c(), RestApiError\u003e {\n        let mut items = self.items.write().await;\n        let item_ids = Self::get_items_to_load(\u0026items, entity_ids);\n        self.load_items(\u0026mut items, \u0026item_ids).await?;\n        drop(items);\n\n        let mut properties = self.properties.write().await;\n        let property_ids = Self::get_properties_to_load(\u0026properties, entity_ids);\n        self.load_properties(\u0026mut properties, \u0026property_ids).await?;\n        drop(properties);\n\n        Ok(())\n    }\n\n    fn get_items_to_load(items: \u0026HashMap\u003cString, Item\u003e, entity_ids: \u0026[EntityId]) -\u003e Vec\u003cString\u003e {\n        entity_ids\n            .iter()\n            .filter_map(|id| match id {\n                EntityId::Item(id) =\u003e Some(id.to_owned()),\n                _ =\u003e None,\n            })\n            .filter(|id| !items.contains_key(id))\n            .collect()\n    }\n\n    async fn load_items(\n        \u0026self,\n        items: \u0026mut HashMap\u003cString, Item\u003e,\n        item_ids: \u0026[String],\n    ) -\u003e Result\u003c(), RestApiError\u003e {\n        if item_ids.is_empty() {\n            return Ok(());\n        }\n        let futures = item_ids\n            .iter()\n            .map(|id| Item::get(EntityId::item(id), \u0026self.api))\n            .collect::\u003cVec\u003c_\u003e\u003e();\n        let stream = futures::stream::iter(futures).buffer_unordered(self.max_concurrent_load);\n        let results = stream.collect::\u003cVec\u003c_\u003e\u003e().await;\n        let results = results\n            .into_iter()\n            .collect::\u003cVec\u003cResult\u003cItem, RestApiError\u003e\u003e\u003e();\n        for item in results.into_iter().flatten() {\n            let id = item.id().id()?.to_owned();\n            items.insert(id, item);\n        }\n        Ok(())\n    }\n\n    fn get_properties_to_load(\n        properties: \u0026HashMap\u003cString, Property\u003e,\n        entity_ids: \u0026[EntityId],\n    ) -\u003e Vec\u003cString\u003e {\n        entity_ids\n            .iter()\n            .filter_map(|id| match id {\n                EntityId::Property(id) =\u003e Some(id.to_owned()),\n                _ =\u003e None,\n            })\n            .filter(|id| !properties.contains_key(id))\n            .collect()\n    }\n\n    async fn load_properties(\n        \u0026self,\n        properties: \u0026mut HashMap\u003cString, Property\u003e,\n        property_ids: \u0026[String],\n    ) -\u003e Result\u003c(), RestApiError\u003e {\n        if property_ids.is_empty() {\n            return Ok(());\n        }\n        let futures = property_ids\n            .iter()\n            .map(|id| Property::get(EntityId::property(id), \u0026self.api))\n            .collect::\u003cVec\u003c_\u003e\u003e();\n        let stream = futures::stream::iter(futures).buffer_unordered(self.max_concurrent_load);\n        let results = stream.collect::\u003cVec\u003c_\u003e\u003e().await;\n        let results = results\n            .into_iter()\n            .collect::\u003cVec\u003cResult\u003cProperty, RestApiError\u003e\u003e\u003e();\n        for property in results.into_iter().flatten() {\n            let id = property.id().id()?.to_owned();\n            properties.insert(id, property);\n        }\n        Ok(())\n    }\n\n    /// Returns a reference to the items in the container.\n    pub fn items(\u0026self) -\u003e Arc\u003cRwLock\u003cHashMap\u003cString, Item\u003e\u003e\u003e {\n        self.items.clone()\n    }\n\n    /// Returns a reference to the properties in the container.\n    pub fn properties(\u0026self) -\u003e Arc\u003cRwLock\u003cHashMap\u003cString, Property\u003e\u003e\u003e {\n        self.properties.clone()\n    }\n}\n\n#[derive(Debug, Default)]\npub struct EntityContainerBuilder {\n    api: Option\u003cArc\u003cRestApi\u003e\u003e,\n    max_concurrent_load: usize,\n}\n\nimpl EntityContainerBuilder {\n    /// Sets the `RestApi` to use for loading entities. **Mandatory**\n    pub fn api(mut self, api: Arc\u003cRestApi\u003e) -\u003e Self {\n        self.api = Some(api);\n        self\n    }\n\n    /// Sets the maximum number of concurrent loads to perform. Default is 10.\n    pub const fn max_concurrent(mut self, max_concurrent_load: usize) -\u003e Self {\n        self.max_concurrent_load = max_concurrent_load;\n        self\n    }\n\n    /// Builds a new `EntityContainer` with the configured options.\n    pub fn build(self) -\u003e Result\u003cEntityContainer, RestApiError\u003e {\n        let api = self.api.ok_or_else(|| RestApiError::ApiNotSet)?;\n        let mut max_concurrent_load = self.max_concurrent_load;\n        if max_concurrent_load == 0 {\n            max_concurrent_load = MAX_CONCURRENT_LOAD_DEFAULT;\n        }\n        Ok(EntityContainer {\n            api,\n            items: Arc::new(RwLock::new(HashMap::new())),\n            properties: Arc::new(RwLock::new(HashMap::new())),\n            max_concurrent_load,\n        })\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::RestApi;\n    use serde_json::Value;\n    use wiremock::matchers::{method, path};\n    use wiremock::{Mock, MockServer, ResponseTemplate};\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_entity_container() {\n        // #lizard forgives the complexity\n        let q42_str = std::fs::read_to_string(\"test_data/Q42.json\").unwrap();\n        let q42: Value = serde_json::from_str(\u0026q42_str).unwrap();\n        let q255_str = std::fs::read_to_string(\"test_data/Q255.json\").unwrap();\n        let q255: Value = serde_json::from_str(\u0026q255_str).unwrap();\n        let p214_str = std::fs::read_to_string(\"test_data/P214.json\").unwrap();\n        let p214: Value = serde_json::from_str(\u0026p214_str).unwrap();\n\n        let mock_server = MockServer::start().await;\n        Mock::given(method(\"GET\"))\n            .and(path(\"/w/rest.php/wikibase/v1/entities/items/Q42\"))\n            .respond_with(ResponseTemplate::new(200).set_body_json(\u0026q42))\n            .mount(\u0026mock_server)\n            .await;\n        Mock::given(method(\"GET\"))\n            .and(path(\"/w/rest.php/wikibase/v1/entities/items/Q255\"))\n            .respond_with(ResponseTemplate::new(200).set_body_json(\u0026q255))\n            .mount(\u0026mock_server)\n            .await;\n        Mock::given(method(\"GET\"))\n            .and(path(\"/w/rest.php/wikibase/v1/entities/properties/P214\"))\n            .respond_with(ResponseTemplate::new(200).set_body_json(\u0026p214))\n            .mount(\u0026mock_server)\n            .await;\n        let api = RestApi::builder(\u0026(mock_server.uri() + \"/w/rest.php\"))\n            .unwrap()\n            .build();\n\n        let ec = EntityContainer::builder()\n            .api(Arc::new(api))\n            .build()\n            .unwrap();\n        ec.load(\u0026[\n            EntityId::item(\"Q42\"),\n            EntityId::property(\"P214\"),\n            EntityId::item(\"Q255\"),\n        ])\n        .await\n        .unwrap();\n        assert!(ec.items().read().await.contains_key(\"Q42\"));\n        assert!(ec.items().read().await.contains_key(\"Q255\"));\n        assert!(ec.properties().read().await.contains_key(\"P214\"));\n        assert!(!ec.properties().read().await.contains_key(\"Q42\"));\n        assert!(!ec.items().read().await.contains_key(\"P214\"));\n    }\n\n    #[test]\n    #[cfg_attr(miri, ignore)] // TODO this should work in miri\n    fn test_max_concurrent() {\n        let api = Arc::new(\n            RestApi::builder(\"https://test.wikidata.org/w/rest.php\")\n                .unwrap()\n                .build(),\n        );\n        let ec = EntityContainer::builder()\n            .api(api.clone())\n            .max_concurrent(5)\n            .build()\n            .unwrap();\n        assert_eq!(ec.max_concurrent_load, 5);\n    }\n\n    #[test]\n    #[cfg_attr(miri, ignore)] // TODO this should work in miri\n    fn test_max_concurrent_default() {\n        let api = Arc::new(\n            RestApi::builder(\"https://test.wikidata.org/w/rest.php\")\n                .unwrap()\n                .build(),\n        );\n        let ec = EntityContainer::builder()\n            .api(api.clone())\n            .max_concurrent(0)\n            .build()\n            .unwrap();\n        assert_eq!(ec.max_concurrent_load, MAX_CONCURRENT_LOAD_DEFAULT);\n    }\n}\n","traces":[{"line":18,"address":[],"length":0,"stats":{"Line":3}},{"line":19,"address":[],"length":0,"stats":{"Line":3}},{"line":23,"address":[],"length":0,"stats":{"Line":2}},{"line":24,"address":[],"length":0,"stats":{"Line":2}},{"line":25,"address":[],"length":0,"stats":{"Line":1}},{"line":26,"address":[],"length":0,"stats":{"Line":1}},{"line":27,"address":[],"length":0,"stats":{"Line":1}},{"line":29,"address":[],"length":0,"stats":{"Line":1}},{"line":30,"address":[],"length":0,"stats":{"Line":1}},{"line":31,"address":[],"length":0,"stats":{"Line":1}},{"line":32,"address":[],"length":0,"stats":{"Line":1}},{"line":34,"address":[],"length":0,"stats":{"Line":1}},{"line":37,"address":[],"length":0,"stats":{"Line":1}},{"line":38,"address":[],"length":0,"stats":{"Line":1}},{"line":40,"address":[],"length":0,"stats":{"Line":4}},{"line":41,"address":[],"length":0,"stats":{"Line":2}},{"line":42,"address":[],"length":0,"stats":{"Line":1}},{"line":44,"address":[],"length":0,"stats":{"Line":4}},{"line":48,"address":[],"length":0,"stats":{"Line":1}},{"line":53,"address":[],"length":0,"stats":{"Line":1}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":1}},{"line":58,"address":[],"length":0,"stats":{"Line":3}},{"line":61,"address":[],"length":0,"stats":{"Line":1}},{"line":62,"address":[],"length":0,"stats":{"Line":1}},{"line":65,"address":[],"length":0,"stats":{"Line":3}},{"line":66,"address":[],"length":0,"stats":{"Line":4}},{"line":69,"address":[],"length":0,"stats":{"Line":1}},{"line":72,"address":[],"length":0,"stats":{"Line":1}},{"line":76,"address":[],"length":0,"stats":{"Line":1}},{"line":78,"address":[],"length":0,"stats":{"Line":4}},{"line":79,"address":[],"length":0,"stats":{"Line":1}},{"line":80,"address":[],"length":0,"stats":{"Line":2}},{"line":82,"address":[],"length":0,"stats":{"Line":3}},{"line":86,"address":[],"length":0,"stats":{"Line":1}},{"line":91,"address":[],"length":0,"stats":{"Line":1}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":1}},{"line":96,"address":[],"length":0,"stats":{"Line":2}},{"line":99,"address":[],"length":0,"stats":{"Line":1}},{"line":100,"address":[],"length":0,"stats":{"Line":1}},{"line":103,"address":[],"length":0,"stats":{"Line":2}},{"line":104,"address":[],"length":0,"stats":{"Line":2}},{"line":107,"address":[],"length":0,"stats":{"Line":1}},{"line":111,"address":[],"length":0,"stats":{"Line":3}},{"line":112,"address":[],"length":0,"stats":{"Line":3}},{"line":116,"address":[],"length":0,"stats":{"Line":2}},{"line":117,"address":[],"length":0,"stats":{"Line":2}},{"line":129,"address":[],"length":0,"stats":{"Line":3}},{"line":130,"address":[],"length":0,"stats":{"Line":3}},{"line":131,"address":[],"length":0,"stats":{"Line":3}},{"line":135,"address":[],"length":0,"stats":{"Line":2}},{"line":136,"address":[],"length":0,"stats":{"Line":2}},{"line":137,"address":[],"length":0,"stats":{"Line":2}},{"line":141,"address":[],"length":0,"stats":{"Line":3}},{"line":142,"address":[],"length":0,"stats":{"Line":9}},{"line":144,"address":[],"length":0,"stats":{"Line":2}},{"line":145,"address":[],"length":0,"stats":{"Line":2}}],"covered":56,"coverable":58},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","entity_id.rs"],"content":"use std::fmt;\n\nuse crate::{config::WIKIDATA_CONFIG, Config, RestApiError};\n\n#[derive(Debug, Clone, Default, PartialEq)]\npub enum EntityId {\n    #[default]\n    None,\n    Item(String),\n    Property(String),\n}\n\nimpl EntityId {\n    /// Returns the ID of the entity.\n    pub const fn id(\u0026self) -\u003e Result\u003c\u0026String, RestApiError\u003e {\n        match self {\n            EntityId::None =\u003e Err(RestApiError::IsNone),\n            EntityId::Item(id) =\u003e Ok(id),\n            EntityId::Property(id) =\u003e Ok(id),\n        }\n    }\n\n    /// Returns the group of the entity.\n    pub const fn group(\u0026self) -\u003e Result\u003c\u0026str, RestApiError\u003e {\n        match self {\n            EntityId::Item(_) =\u003e Ok(\"items\"),\n            EntityId::Property(_) =\u003e Ok(\"properties\"),\n            _ =\u003e Err(RestApiError::IsNone),\n        }\n    }\n\n    /// Returns the entity type of the entity.\n    pub const fn entity_type(\u0026self) -\u003e Result\u003c\u0026str, RestApiError\u003e {\n        match self {\n            EntityId::Item(_) =\u003e Ok(\"item\"),\n            EntityId::Property(_) =\u003e Ok(\"property\"),\n            _ =\u003e Err(RestApiError::IsNone),\n        }\n    }\n\n    /// Creates a new entity ID from a string, using the default Wikidata configuration.\n    pub fn new\u003cS: Into\u003cString\u003e\u003e(id: S) -\u003e Result\u003cEntityId, RestApiError\u003e {\n        Self::new_from_config(id, \u0026WIKIDATA_CONFIG)\n    }\n\n    /// Creates a new entity ID from a string, using a bespoke configuration.\n    pub fn new_from_config\u003cS: Into\u003cString\u003e\u003e(\n        id: S,\n        config: \u0026Config,\n    ) -\u003e Result\u003cEntityId, RestApiError\u003e {\n        let id = id.into();\n        if id.starts_with(config.item_letter()) {\n            Ok(EntityId::Item(id.to_string()))\n        } else if id.starts_with(config.property_letter()) {\n            Ok(EntityId::Property(id.to_string()))\n        } else {\n            Err(RestApiError::UnknownEntityLetter(id))\n        }\n    }\n\n    /// Returns an unset (None) entity ID.\n    pub const fn none() -\u003e EntityId {\n        EntityId::None\n    }\n\n    /// Returns a new entity ID for an item.\n    pub fn item\u003cS: Into\u003cString\u003e\u003e(s: S) -\u003e EntityId {\n        EntityId::Item(s.into())\n    }\n\n    /// Returns a new entity ID for a property.\n    pub fn property(s: \u0026str) -\u003e EntityId {\n        EntityId::Property(s.to_string())\n    }\n\n    /// Returns true if the entity ID is an item or a property.\n    pub fn is_some(\u0026self) -\u003e bool {\n        *self != EntityId::None\n    }\n\n    /// Returns true if the entity ID is unset (None).\n    pub fn is_none(\u0026self) -\u003e bool {\n        *self == EntityId::None\n    }\n}\n\nimpl From\u003cEntityId\u003e for String {\n    fn from(val: EntityId) -\u003e Self {\n        match val {\n            EntityId::Item(id) =\u003e id.to_string(),\n            EntityId::Property(id) =\u003e id.to_string(),\n            EntityId::None =\u003e String::new(),\n        }\n    }\n}\n\nimpl fmt::Display for EntityId {\n    fn fmt(\u0026self, f: \u0026mut fmt::Formatter\u003c'_\u003e) -\u003e fmt::Result {\n        match self {\n            EntityId::Item(id) =\u003e write!(f, \"{}\", id),\n            EntityId::Property(id) =\u003e write!(f, \"{}\", id),\n            EntityId::None =\u003e Err(fmt::Error),\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_entity_id_item() {\n        let id = EntityId::item(\"Q123\");\n        assert_eq!(id, EntityId::item(\"Q123\"));\n    }\n\n    #[test]\n    fn test_entity_id_property() {\n        let id = EntityId::property(\"P123\");\n        assert_eq!(id, EntityId::property(\"P123\"));\n    }\n\n    #[test]\n    fn test_entity_id_none() {\n        let id = EntityId::none();\n        assert_eq!(id, EntityId::None);\n    }\n\n    #[test]\n    fn test_entity_id_item_is_some() {\n        let id = EntityId::item(\"Q123\");\n        assert!(id.is_some());\n    }\n\n    #[test]\n    fn test_entity_id_property_is_some() {\n        let id = EntityId::property(\"P123\");\n        assert!(id.is_some());\n    }\n\n    #[test]\n    fn test_entity_id_none_is_some() {\n        let id = EntityId::none();\n        assert!(!id.is_some());\n    }\n\n    #[test]\n    fn test_entity_id_item_is_none() {\n        let id = EntityId::item(\"Q123\");\n        assert!(!id.is_none());\n    }\n\n    #[test]\n    fn test_entity_id_property_is_none() {\n        let id = EntityId::property(\"P123\");\n        assert!(!id.is_none());\n    }\n\n    #[test]\n    fn test_entity_id_none_is_none() {\n        let id = EntityId::none();\n        assert!(id.is_none());\n    }\n\n    #[test]\n    fn test_entity_id_default() {\n        let id = EntityId::default();\n        assert_eq!(id, EntityId::None);\n    }\n\n    #[test]\n    fn test_entity_id_item_id() {\n        let id = EntityId::item(\"Q123\");\n        assert_eq!(id.id().unwrap(), \"Q123\");\n    }\n\n    #[test]\n    fn test_entity_id_property_id() {\n        let id = EntityId::property(\"P123\");\n        assert_eq!(id.id().unwrap(), \"P123\");\n    }\n\n    #[test]\n    fn test_entity_id_none_id() {\n        let id = EntityId::none();\n        assert!(id.id().is_err());\n    }\n\n    #[test]\n    fn test_entity_id_item_group() {\n        let id = EntityId::item(\"Q123\");\n        assert_eq!(id.group().unwrap(), \"items\");\n    }\n\n    #[test]\n    fn test_entity_id_property_group() {\n        let id = EntityId::property(\"P123\");\n        assert_eq!(id.group().unwrap(), \"properties\");\n    }\n\n    #[test]\n    fn test_entity_id_none_group() {\n        let id = EntityId::none();\n        assert!(id.group().is_err());\n    }\n\n    #[test]\n    fn test_entity_id_entity_item_type() {\n        let id = EntityId::item(\"Q123\");\n        assert_eq!(id.entity_type().unwrap(), \"item\");\n    }\n\n    #[test]\n    fn test_entity_id_entity_property_type() {\n        let id = EntityId::property(\"P123\");\n        assert_eq!(id.entity_type().unwrap(), \"property\");\n    }\n\n    #[test]\n    fn test_entity_id_entity_none_type() {\n        let id = EntityId::none();\n        assert!(id.entity_type().is_err());\n    }\n\n    #[test]\n    fn test_entity_id_item_new() {\n        let id = EntityId::new(\"Q123\").unwrap();\n        assert_eq!(id, EntityId::item(\"Q123\"));\n    }\n\n    #[test]\n    fn test_entity_id_property_new() {\n        let id = EntityId::new(\"P123\").unwrap();\n        assert_eq!(id, EntityId::property(\"P123\"));\n    }\n\n    #[test]\n    fn test_entity_id_none_new() {\n        let id = EntityId::new(\"X123\");\n        assert!(id.is_err());\n    }\n\n    #[test]\n    fn test_entity_id_new_from_config() {\n        let config = Config::new('A', 'B');\n        let id_a = EntityId::new_from_config(\"A123\", \u0026config).unwrap();\n        assert_eq!(id_a, EntityId::item(\"A123\"));\n        let id_b = EntityId::new_from_config(\"B123\", \u0026config).unwrap();\n        assert_eq!(id_b, EntityId::property(\"B123\"));\n        let id_x = EntityId::new_from_config(\"X123\", \u0026config);\n        assert!(id_x.is_err());\n    }\n}\n","traces":[{"line":15,"address":[],"length":0,"stats":{"Line":6}},{"line":16,"address":[],"length":0,"stats":{"Line":6}},{"line":17,"address":[],"length":0,"stats":{"Line":1}},{"line":18,"address":[],"length":0,"stats":{"Line":3}},{"line":19,"address":[],"length":0,"stats":{"Line":2}},{"line":24,"address":[],"length":0,"stats":{"Line":48}},{"line":25,"address":[],"length":0,"stats":{"Line":48}},{"line":26,"address":[],"length":0,"stats":{"Line":43}},{"line":27,"address":[],"length":0,"stats":{"Line":4}},{"line":28,"address":[],"length":0,"stats":{"Line":1}},{"line":33,"address":[],"length":0,"stats":{"Line":3}},{"line":34,"address":[],"length":0,"stats":{"Line":3}},{"line":35,"address":[],"length":0,"stats":{"Line":1}},{"line":36,"address":[],"length":0,"stats":{"Line":1}},{"line":37,"address":[],"length":0,"stats":{"Line":1}},{"line":42,"address":[],"length":0,"stats":{"Line":16}},{"line":43,"address":[],"length":0,"stats":{"Line":16}},{"line":47,"address":[],"length":0,"stats":{"Line":19}},{"line":51,"address":[],"length":0,"stats":{"Line":19}},{"line":52,"address":[],"length":0,"stats":{"Line":19}},{"line":53,"address":[],"length":0,"stats":{"Line":14}},{"line":54,"address":[],"length":0,"stats":{"Line":5}},{"line":55,"address":[],"length":0,"stats":{"Line":3}},{"line":57,"address":[],"length":0,"stats":{"Line":2}},{"line":62,"address":[],"length":0,"stats":{"Line":6}},{"line":63,"address":[],"length":0,"stats":{"Line":6}},{"line":67,"address":[],"length":0,"stats":{"Line":42}},{"line":68,"address":[],"length":0,"stats":{"Line":42}},{"line":72,"address":[],"length":0,"stats":{"Line":21}},{"line":73,"address":[],"length":0,"stats":{"Line":21}},{"line":77,"address":[],"length":0,"stats":{"Line":24}},{"line":78,"address":[],"length":0,"stats":{"Line":24}},{"line":82,"address":[],"length":0,"stats":{"Line":3}},{"line":83,"address":[],"length":0,"stats":{"Line":3}},{"line":88,"address":[],"length":0,"stats":{"Line":5}},{"line":89,"address":[],"length":0,"stats":{"Line":5}},{"line":90,"address":[],"length":0,"stats":{"Line":2}},{"line":91,"address":[],"length":0,"stats":{"Line":3}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":46}},{"line":99,"address":[],"length":0,"stats":{"Line":46}},{"line":100,"address":[],"length":0,"stats":{"Line":43}},{"line":101,"address":[],"length":0,"stats":{"Line":3}},{"line":102,"address":[],"length":0,"stats":{"Line":0}}],"covered":42,"coverable":44},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","entity_patch.rs"],"content":"/// NOTE: THIS IS INCOMPLETE AND UNTESTED!\nuse crate::{\n    entity::Entity, patch_entry::PatchEntry, EditMetadata, EntityId, HttpMisc, Item, Property,\n    RestApi, RestApiError,\n};\nuse serde::Serialize;\nuse serde_json::json;\n\n#[derive(Debug, Clone, PartialEq, Serialize)]\nenum Mode {\n    Item,\n    Property,\n}\n\nimpl Mode {\n    const fn as_str(\u0026self) -\u003e \u0026str {\n        match self {\n            Mode::Item =\u003e \"item\",\n            Mode::Property =\u003e \"property\",\n        }\n    }\n}\n\n#[derive(Debug, Clone, PartialEq, Serialize)]\npub struct EntityPatch {\n    patch: Vec\u003cPatchEntry\u003e,\n    mode: Mode,\n}\n\nimpl EntityPatch {\n    pub const fn item() -\u003e Self {\n        Self {\n            patch: vec![],\n            mode: Mode::Item,\n        }\n    }\n\n    pub const fn property() -\u003e Self {\n        Self {\n            patch: vec![],\n            mode: Mode::Property,\n        }\n    }\n    /* DO WE NEED THIS?\n       /// Generates a patch from JSON, presumably from `json_patch`\n       pub fn item_from_json(j: \u0026Value) -\u003e Result\u003cSelf, RestApiError\u003e {\n           Ok(Self {\n               patch: Self::patch_from_json(j)?,\n               mode: Mode::Item,\n           })\n       }\n\n       /// Generates a patch from JSON, presumably from `json_patch`\n       pub fn property_from_json(j: \u0026Value) -\u003e Result\u003cSelf, RestApiError\u003e {\n           Ok(Self {\n               patch: Self::patch_from_json(j)?,\n               mode: Mode::Property,\n           })\n       }\n\n       fn patch_from_json(j: \u0026Value) -\u003e Result\u003cVec\u003cPatchEntry\u003e, RestApiError\u003e {\n           j.as_array()\n               .ok_or_else(|| RestApiError::MissingOrInvalidField {\n                   field: \"EntityPatch\".into(),\n                   j: j.to_owned(),\n               })?\n               .iter()\n               .map(|x| serde_json::from_value(x.clone()).map_err(|e| e.into()))\n               .collect::\u003cResult\u003cVec\u003cPatchEntry\u003e, RestApiError\u003e\u003e()\n       }\n    */\n    /// Returns the patch entries\n    pub const fn patch(\u0026self) -\u003e \u0026Vec\u003cPatchEntry\u003e {\n        \u0026self.patch\n    }\n\n    /// Returns the mutable patch entries\n    pub const fn patch_mut(\u0026mut self) -\u003e \u0026mut Vec\u003cPatchEntry\u003e {\n        \u0026mut self.patch\n    }\n\n    // /// `path` is a JSON patch path, eg \"/enwiki/title\"\n    // pub fn add\u003cS: Into\u003cString\u003e\u003e(\u0026mut self, path: S, value: Value) {\n    //     self.patch_mut()\n    //         .push(PatchEntry::new(\"add\", path.into(), value));\n    // }\n\n    // /// `path` is a JSON patch path, eg \"/enwiki/title\"\n    // pub fn replace\u003cS: Into\u003cString\u003e\u003e(\u0026mut self, path: S, value: Value) {\n    //     self.patch_mut()\n    //         .push(PatchEntry::new(\"replace\", path.into(), value));\n    // }\n\n    // /// `path` is a JSON patch path, eg \"/enwiki/title\"\n    // pub fn remove\u003cS: Into\u003cString\u003e\u003e(\u0026mut self, path: S) {\n    //     self.patch_mut()\n    //         .push(PatchEntry::new(\"remove\", path.into(), Value::Null));\n    // }\n\n    /// checks if the patch list is empty\n    pub fn is_empty(\u0026self) -\u003e bool {\n        self.patch().is_empty()\n    }\n\n    /// Applies the entire patch against the API\n    pub async fn apply_item(\u0026self, id: \u0026EntityId, api: \u0026mut RestApi) -\u003e Result\u003cItem, RestApiError\u003e {\n        self.apply_match_item(id, api, EditMetadata::default())\n            .await\n    }\n\n    pub async fn apply_property(\n        \u0026self,\n        id: \u0026EntityId,\n        api: \u0026mut RestApi,\n    ) -\u003e Result\u003cProperty, RestApiError\u003e {\n        self.apply_match_property(id, api, EditMetadata::default())\n            .await\n    }\n\n    /// Applies the entire patch against the API\n    pub async fn apply_match_item(\n        \u0026self,\n        id: \u0026EntityId,\n        api: \u0026mut RestApi,\n        em: EditMetadata,\n    ) -\u003e Result\u003cItem, RestApiError\u003e {\n        let j0 = json!({\"patch\": self.patch()});\n        let request = self\n            .generate_json_request(id, reqwest::Method::PATCH, j0, api, \u0026em)\n            .await?;\n        let response = api.execute(request).await?;\n        let (j1, header_info) = self.filter_response_error(response).await?;\n        Item::from_json_header_info(j1, header_info)\n    }\n\n    /// Applies the entire patch against the API, conditional on metadata\n    pub async fn apply_match_property(\n        // TODO\n        \u0026self,\n        id: \u0026EntityId,\n        api: \u0026mut RestApi,\n        em: EditMetadata,\n    ) -\u003e Result\u003cProperty, RestApiError\u003e {\n        let j0 = json!({\"patch\": self.patch()});\n        let request = self\n            .generate_json_request(id, reqwest::Method::PATCH, j0, api, \u0026em)\n            .await?;\n        let response = api.execute(request).await?;\n        let (j1, header_info) = self.filter_response_error(response).await?;\n        Property::from_json_header_info(j1, header_info)\n    }\n}\n\nimpl HttpMisc for EntityPatch {\n    fn get_my_rest_api_path(\u0026self, id: \u0026EntityId) -\u003e Result\u003cString, RestApiError\u003e {\n        Ok(format!(\n            \"/entities/{group}/{id}/{mode}\",\n            group = id.group()?,\n            mode = self.mode.as_str()\n        ))\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use serde_json::json;\n\n    #[test]\n    fn test_mode() {\n        assert_eq!(Mode::Item.as_str(), \"item\");\n        assert_eq!(Mode::Property.as_str(), \"property\");\n    }\n\n    #[test]\n    fn test_get_rest_api_path() {\n        let patch = EntityPatch::item();\n        let id = EntityId::new(\"Q123\").unwrap();\n        assert_eq!(\n            patch.get_my_rest_api_path(\u0026id).unwrap(),\n            \"/entities/items/Q123/item\"\n        );\n    }\n\n    #[test]\n    fn test_item() {\n        let patch = EntityPatch::item();\n        assert!(patch.is_empty());\n        assert_eq!(patch.mode, Mode::Item);\n    }\n\n    #[test]\n    fn test_property() {\n        let patch = EntityPatch::property();\n        assert!(patch.is_empty());\n        assert_eq!(patch.mode, Mode::Property);\n    }\n\n    #[test]\n    fn test_patch() {\n        let mut patch = EntityPatch::item();\n        assert!(patch.is_empty());\n        patch\n            .patch_mut()\n            .push(PatchEntry::new(\"add\", \"/enwiki/title\", json!(\"foo\")));\n        assert_eq!(patch.patch().len(), 1);\n    }\n\n    #[test]\n    fn test_is_empty() {\n        let mut patch = EntityPatch::item();\n        assert!(patch.is_empty());\n        patch\n            .patch_mut()\n            .push(PatchEntry::new(\"add\", \"/enwiki/title\", json!(\"foo\")));\n        assert!(!patch.is_empty());\n    }\n}\n","traces":[{"line":16,"address":[],"length":0,"stats":{"Line":3}},{"line":17,"address":[],"length":0,"stats":{"Line":3}},{"line":18,"address":[],"length":0,"stats":{"Line":2}},{"line":19,"address":[],"length":0,"stats":{"Line":1}},{"line":31,"address":[],"length":0,"stats":{"Line":5}},{"line":33,"address":[],"length":0,"stats":{"Line":5}},{"line":38,"address":[],"length":0,"stats":{"Line":1}},{"line":40,"address":[],"length":0,"stats":{"Line":1}},{"line":73,"address":[],"length":0,"stats":{"Line":7}},{"line":74,"address":[],"length":0,"stats":{"Line":7}},{"line":78,"address":[],"length":0,"stats":{"Line":7}},{"line":79,"address":[],"length":0,"stats":{"Line":7}},{"line":101,"address":[],"length":0,"stats":{"Line":5}},{"line":102,"address":[],"length":0,"stats":{"Line":5}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":1}},{"line":156,"address":[],"length":0,"stats":{"Line":1}},{"line":157,"address":[],"length":0,"stats":{"Line":1}},{"line":158,"address":[],"length":0,"stats":{"Line":1}}],"covered":18,"coverable":40},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","error.rs"],"content":"use reqwest::header::InvalidHeaderValue;\nuse serde::Deserialize;\nuse serde_json::{json, Value};\nuse std::{\n    collections::HashMap,\n    fmt::{self, Display, Formatter},\n};\nuse thiserror::Error;\n\n#[derive(Debug, Clone, Deserialize, Default, PartialEq)]\npub struct RestApiErrorPayload {\n    code: String,\n    message: String,\n    #[serde(default)]\n    context: HashMap\u003cString, Value\u003e,\n}\n\nimpl RestApiErrorPayload {\n    pub fn code(\u0026self) -\u003e \u0026str {\n        \u0026self.code\n    }\n\n    pub fn message(\u0026self) -\u003e \u0026str {\n        \u0026self.message\n    }\n\n    pub const fn context(\u0026self) -\u003e \u0026HashMap\u003cString, Value\u003e {\n        \u0026self.context\n    }\n}\n\nimpl Display for RestApiErrorPayload {\n    fn fmt(\u0026self, f: \u0026mut Formatter) -\u003e fmt::Result {\n        write!(\n            f,\n            \"{}: {} / {}\",\n            self.code,\n            self.message,\n            json!(self.context)\n        )\n    }\n}\n\n#[derive(Error, Debug)]\npub enum RestApiError {\n    #[error(\"ApiError: {status} {status_text} / {payload:?}\")]\n    ApiError {\n        status: reqwest::StatusCode,\n        status_text: String,\n        payload: RestApiErrorPayload,\n    },\n    #[error(\"Client ID required\")]\n    ClientIdRequired,\n    #[error(\"Client secret required\")]\n    ClientSecretRequired,\n    #[error(\"Refresh token required\")]\n    RefreshTokenRequired,\n    #[error(\"Access token required\")]\n    AccessTokenRequired,\n    #[error(\"Reqwest Error: {0}\")]\n    Reqwest(reqwest::Error),\n    #[error(\"Invalid header value: {0}\")]\n    InvalidHeaderValue(InvalidHeaderValue),\n    #[error(\"Method {method} not implemented for path {path} in REST API\")]\n    NotImplementedInRestApi {\n        method: reqwest::Method,\n        path: String,\n    },\n    #[error(\"Unexpected response: {0}\")]\n    UnexpectedResponse(Value),\n    #[error(\"Missing ID\")]\n    MissingId,\n    #[error(\"ID already set\")]\n    HasId,\n    #[error(\"Missing field {field}: {j}\")]\n    MissingOrInvalidField { field: String, j: Value },\n    #[error(\"Wrong type for {field}: {j}\")]\n    WrongType { field: String, j: Value },\n    #[error(\"Entity ID is None\")]\n    IsNone,\n    #[error(\"Unrecognized entity ID letter: {0}\")]\n    UnknownEntityLetter(String),\n    #[error(\"Unknown value: {0}\")]\n    UnknownValue(String),\n    #[error(\"Unknown data type: {0}\")]\n    UnknownDataType(String),\n    #[error(\"Serde JSON error: {0}\")]\n    SerdeJson(serde_json::Error),\n    #[error(\"Unknown statement rank: {0}\")]\n    UnknownStatementRank(String),\n    #[error(\"API not set\")]\n    ApiNotSet,\n    #[error(\"Empty value: {0}\")]\n    EmptyValue(String),\n    #[error(\"Unsupported method: {0}\")]\n    UnsupportedMethod(reqwest::Method),\n    #[error(\"REST API URL is invalid: {0}\")]\n    RestApiUrlInvalid(String),\n    #[error(\"Invalid precision\")]\n    InvalidPrecision,\n    #[error(\"Missing results field in response\")]\n    MissingResults,\n}\n\nimpl From\u003creqwest::Error\u003e for RestApiError {\n    fn from(e: reqwest::Error) -\u003e Self {\n        Self::Reqwest(e)\n    }\n}\n\nimpl From\u003cInvalidHeaderValue\u003e for RestApiError {\n    fn from(e: InvalidHeaderValue) -\u003e Self {\n        Self::InvalidHeaderValue(e)\n    }\n}\n\nimpl From\u003cserde_json::Error\u003e for RestApiError {\n    fn from(e: serde_json::Error) -\u003e Self {\n        Self::SerdeJson(e)\n    }\n}\n\nimpl RestApiError {\n    pub async fn from_response(response: reqwest::Response) -\u003e Self {\n        let status = response.status();\n        let status_text = status.canonical_reason().unwrap_or_default().to_owned();\n        let payload = response\n            .json()\n            .await\n            .unwrap_or(RestApiErrorPayload::default());\n        RestApiError::ApiError {\n            status,\n            status_text,\n            payload,\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use http::HeaderValue;\n    use serde_json::json;\n\n    #[test]\n    fn test_rest_api_error_payload() {\n        let payload = RestApiErrorPayload {\n            code: \"code\".to_owned(),\n            message: \"message\".to_owned(),\n            context: [(\"key\".to_owned(), json!(\"value\"))]\n                .iter()\n                .cloned()\n                .collect(),\n        };\n        assert_eq!(payload.code(), \"code\");\n        assert_eq!(payload.message(), \"message\");\n        assert_eq!(payload.context().get(\"key\").unwrap(), \u0026json!(\"value\"));\n    }\n\n    #[test]\n    fn test_rest_api_error_display() {\n        let payload = RestApiErrorPayload {\n            code: \"code\".to_owned(),\n            message: \"message\".to_owned(),\n            context: [(\"key\".to_owned(), json!(\"value\"))]\n                .iter()\n                .cloned()\n                .collect(),\n        };\n        let error = RestApiError::ApiError {\n            status: reqwest::StatusCode::BAD_REQUEST,\n            status_text: \"Bad Request\".to_owned(),\n            payload,\n        };\n        assert_eq!(\n            error.to_string(),\n            \"ApiError: 400 Bad Request Bad Request / RestApiErrorPayload { code: \\\"code\\\", message: \\\"message\\\", context: {\\\"key\\\": String(\\\"value\\\")} }\"\n        );\n    }\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_error_reqwest() {\n        let error = reqwest::get(\"not a url\").await.unwrap_err();\n        let rest_api_error: RestApiError = error.into();\n        assert_eq!(rest_api_error.to_string(), \"Reqwest Error: builder error\");\n    }\n\n    #[test]\n    fn test_invalid_header_value() {\n        let error = HeaderValue::from_str(\"\\u{0}\").unwrap_err();\n        let rest_api_error: RestApiError = error.into();\n        assert_eq!(\n            rest_api_error.to_string(),\n            \"Invalid header value: failed to parse header value\"\n        );\n    }\n\n    #[test]\n    fn test_payload_code() {\n        let payload = RestApiErrorPayload {\n            code: \"code\".to_owned(),\n            message: \"message\".to_owned(),\n            context: HashMap::new(),\n        };\n        assert_eq!(payload.code(), \"code\");\n    }\n\n    #[test]\n    fn test_payload_message() {\n        let payload = RestApiErrorPayload {\n            code: \"code\".to_owned(),\n            message: \"message\".to_owned(),\n            context: HashMap::new(),\n        };\n        assert_eq!(payload.message(), \"message\");\n    }\n\n    #[test]\n    fn test_payload_context() {\n        let payload = RestApiErrorPayload {\n            code: \"code\".to_owned(),\n            message: \"message\".to_owned(),\n            context: [(\"key\".to_owned(), json!(\"value\"))]\n                .iter()\n                .cloned()\n                .collect(),\n        };\n        assert_eq!(payload.context().get(\"key\").unwrap(), \u0026json!(\"value\"));\n    }\n\n    #[test]\n    fn test_payload_fmt() {\n        let payload = RestApiErrorPayload {\n            code: \"code\".to_owned(),\n            message: \"message\".to_owned(),\n            context: [(\"key\".to_owned(), json!(\"value\"))]\n                .iter()\n                .cloned()\n                .collect(),\n        };\n        let s = format!(\"{payload}\");\n        assert_eq!(s, \"code: message / {\\\"key\\\":\\\"value\\\"}\");\n    }\n\n    #[test]\n    fn test_from_serde_json_error() {\n        let error = serde_json::from_str::\u003cValue\u003e(\"{\").unwrap_err();\n        let rest_api_error: RestApiError = error.into();\n        assert_eq!(\n            rest_api_error.to_string(),\n            \"Serde JSON error: EOF while parsing an object at line 1 column 1\"\n        );\n    }\n}\n","traces":[{"line":19,"address":[],"length":0,"stats":{"Line":4}},{"line":20,"address":[],"length":0,"stats":{"Line":4}},{"line":23,"address":[],"length":0,"stats":{"Line":4}},{"line":24,"address":[],"length":0,"stats":{"Line":4}},{"line":27,"address":[],"length":0,"stats":{"Line":4}},{"line":28,"address":[],"length":0,"stats":{"Line":4}},{"line":33,"address":[],"length":0,"stats":{"Line":1}},{"line":34,"address":[],"length":0,"stats":{"Line":1}},{"line":35,"address":[],"length":0,"stats":{"Line":1}},{"line":37,"address":[],"length":0,"stats":{"Line":1}},{"line":38,"address":[],"length":0,"stats":{"Line":1}},{"line":39,"address":[],"length":0,"stats":{"Line":1}},{"line":106,"address":[],"length":0,"stats":{"Line":2}},{"line":107,"address":[],"length":0,"stats":{"Line":2}},{"line":112,"address":[],"length":0,"stats":{"Line":1}},{"line":113,"address":[],"length":0,"stats":{"Line":1}},{"line":118,"address":[],"length":0,"stats":{"Line":1}},{"line":119,"address":[],"length":0,"stats":{"Line":1}},{"line":124,"address":[],"length":0,"stats":{"Line":6}},{"line":125,"address":[],"length":0,"stats":{"Line":3}},{"line":126,"address":[],"length":0,"stats":{"Line":3}},{"line":127,"address":[],"length":0,"stats":{"Line":6}},{"line":129,"address":[],"length":0,"stats":{"Line":3}}],"covered":23,"coverable":23},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","get_put_delete.rs"],"content":"use crate::{prelude::RestApiError, EditMetadata, EntityId, HeaderInfo, RestApi, RevisionMatch};\nuse async_trait::async_trait;\nuse reqwest::Request;\nuse serde_json::{json, Value};\nuse std::collections::HashMap;\n\n#[async_trait]\npub trait HttpMisc {\n    fn get_my_rest_api_path(\u0026self, id: \u0026EntityId) -\u003e Result\u003cString, RestApiError\u003e {\n        Self::get_rest_api_path(id)\n    }\n\n    fn get_rest_api_path(id: \u0026EntityId) -\u003e Result\u003cString, RestApiError\u003e {\n        panic!(\n            \"{}::get_rest_api_path is not implemented but was used for {id}\",\n            std::any::type_name::\u003cSelf\u003e()\n        );\n    }\n\n    fn add_metadata_to_json(j: \u0026mut Value, em: \u0026EditMetadata) {\n        if j.get(\"tags\").is_none() {\n            j[\"tags\"] = json!(em.tags());\n        }\n        if j.get(\"bot\").is_none() {\n            j[\"bot\"] = json!(em.bot());\n        }\n        if j.get(\"comment\").is_none() {\n            j[\"comment\"] = json!(em.comment().unwrap_or_default());\n        }\n    }\n\n    async fn get_match_internal(\n        api: \u0026RestApi,\n        path: \u0026str,\n        rm: RevisionMatch,\n    ) -\u003e Result\u003c(Value, HeaderInfo), RestApiError\u003e {\n        let mut request = api\n            .wikibase_request_builder(path, HashMap::new(), reqwest::Method::GET)\n            .await?\n            .build()?;\n        rm.modify_headers(request.headers_mut())?;\n        Self::api_execute(api, request).await\n    }\n\n    async fn api_execute(\n        api: \u0026RestApi,\n        request: Request,\n    ) -\u003e Result\u003c(Value, HeaderInfo), RestApiError\u003e {\n        let response = api.execute(request).await?;\n        let header_info = HeaderInfo::from_header(response.headers());\n        let j = response.error_for_status()?.json().await?;\n        Ok((j, header_info))\n    }\n\n    async fn run_json_query(\n        \u0026self,\n        id: \u0026EntityId,\n        method: reqwest::Method,\n        j: Value,\n        api: \u0026mut RestApi,\n        em: \u0026EditMetadata,\n    ) -\u003e Result\u003c(Value, HeaderInfo), RestApiError\u003e {\n        let request = self.generate_json_request(id, method, j, api, em).await?;\n        let response = api.execute(request).await?;\n        self.filter_response_error(response).await\n    }\n\n    async fn generate_json_request(\n        \u0026self,\n        id: \u0026EntityId,\n        method: reqwest::Method,\n        mut j: Value,\n        api: \u0026mut RestApi,\n        em: \u0026EditMetadata,\n    ) -\u003e Result\u003creqwest::Request, RestApiError\u003e {\n        Self::add_metadata_to_json(\u0026mut j, em);\n        let path = self.get_my_rest_api_path(id)?;\n        let content_type = match method {\n            reqwest::Method::PATCH =\u003e \"application/json-patch+json\",\n            _ =\u003e \"application/json\",\n        }\n        .parse()?;\n        let mut request = api\n            .wikibase_request_builder(\u0026path, HashMap::new(), method)\n            .await?\n            .build()?;\n        request\n            .headers_mut()\n            .insert(reqwest::header::CONTENT_TYPE, content_type);\n        em.revision_match().modify_headers(request.headers_mut())?;\n        *request.body_mut() = Some(format!(\"{j}\").into());\n        Ok(request)\n    }\n\n    async fn filter_response_error(\n        \u0026self,\n        response: reqwest::Response,\n    ) -\u003e Result\u003c(Value, HeaderInfo), RestApiError\u003e {\n        if !response.status().is_success() {\n            return Err(RestApiError::from_response(response).await);\n        }\n        let header_info = HeaderInfo::from_header(response.headers());\n        let j: Value = response.error_for_status()?.json().await?;\n        Ok((j, header_info))\n    }\n}\n\n/// A trait implementing a HTTP GET operation.\n#[async_trait]\npub trait HttpGet: Sized + HttpMisc {\n    async fn get_match(\n        id: \u0026EntityId,\n        part_id: \u0026str,\n        api: \u0026RestApi,\n        rm: RevisionMatch,\n    ) -\u003e Result\u003cSelf, RestApiError\u003e;\n\n    async fn get(id: \u0026EntityId, part_id: \u0026str, api: \u0026RestApi) -\u003e Result\u003cSelf, RestApiError\u003e {\n        Self::get_match(id, part_id, api, RevisionMatch::default()).await\n    }\n}\n\n/// A trait implementing a HTTP PUT operation.\n#[async_trait]\npub trait HttpPut: Sized + HttpMisc {\n    async fn put_meta(\n        \u0026self,\n        id: \u0026EntityId,\n        api: \u0026mut RestApi,\n        em: EditMetadata,\n    ) -\u003e Result\u003cSelf, RestApiError\u003e;\n\n    async fn put(\u0026self, id: \u0026EntityId, api: \u0026mut RestApi) -\u003e Result\u003cSelf, RestApiError\u003e {\n        self.put_meta(id, api, EditMetadata::default()).await\n    }\n}\n\n/// A trait implementing a HTTP DELETE operation.\n#[async_trait]\npub trait HttpDelete: Sized + HttpMisc {\n    async fn delete_meta(\n        \u0026self,\n        id: \u0026EntityId,\n        api: \u0026mut RestApi,\n        em: EditMetadata,\n    ) -\u003e Result\u003c(), RestApiError\u003e;\n\n    async fn delete(\u0026self, id: \u0026EntityId, api: \u0026mut RestApi) -\u003e Result\u003c(), RestApiError\u003e {\n        self.delete_meta(id, api, EditMetadata::default()).await\n    }\n}\n\n#[async_trait]\npub trait HttpGetEntity: Sized + HttpMisc {\n    async fn get_match(\n        id: \u0026EntityId,\n        api: \u0026RestApi,\n        rm: RevisionMatch,\n    ) -\u003e Result\u003cSelf, RestApiError\u003e\n    where\n        Self: Sized;\n\n    async fn get(id: \u0026EntityId, api: \u0026RestApi) -\u003e Result\u003cSelf, RestApiError\u003e\n    where\n        Self: Sized,\n    {\n        Self::get_match(id, api, RevisionMatch::default()).await\n    }\n}\n\n#[async_trait]\npub trait HttpGetEntityWithFallback: Sized + HttpMisc {\n    async fn get_match_with_fallback(\n        id: \u0026EntityId,\n        language: \u0026str,\n        api: \u0026RestApi,\n        rm: RevisionMatch,\n    ) -\u003e Result\u003cSelf, RestApiError\u003e;\n\n    async fn get_with_fallback(\n        id: \u0026EntityId,\n        language: \u0026str,\n        api: \u0026RestApi,\n    ) -\u003e Result\u003cSelf, RestApiError\u003e\n    where\n        Self: Sized,\n    {\n        Self::get_match_with_fallback(id, language, api, RevisionMatch::default()).await\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use crate::Sitelinks;\n\n    use super::*;\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_filter_response_error() {\n        let sl = Sitelinks::default();\n        let response = reqwest::Response::from(http::Response::new(\"body text\"));\n        let result = sl.filter_response_error(response).await;\n        assert!(result.is_err());\n    }\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_filter_response_error2() {\n        let sl = Sitelinks::default();\n        let response = reqwest::Response::from(\n            http::Response::builder()\n                .status(400)\n                .body(r#\"{\"code\":\"foo\",\"message\":\"bar\"}\"#)\n                .unwrap(),\n        );\n        let result = sl.filter_response_error(response).await;\n        assert!(result.is_err());\n        assert_eq!(\n            result.unwrap_err().to_string(),\n            \"ApiError: 400 Bad Request Bad Request / RestApiErrorPayload { code: \\\"foo\\\", message: \\\"bar\\\", context: {} }\"\n        );\n    }\n}\n","traces":[{"line":9,"address":[],"length":0,"stats":{"Line":3}},{"line":10,"address":[],"length":0,"stats":{"Line":3}},{"line":13,"address":[],"length":0,"stats":{"Line":0}},{"line":14,"address":[],"length":0,"stats":{"Line":0}},{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":18}},{"line":21,"address":[],"length":0,"stats":{"Line":36}},{"line":22,"address":[],"length":0,"stats":{"Line":18}},{"line":24,"address":[],"length":0,"stats":{"Line":36}},{"line":25,"address":[],"length":0,"stats":{"Line":18}},{"line":27,"address":[],"length":0,"stats":{"Line":36}},{"line":28,"address":[],"length":0,"stats":{"Line":18}},{"line":37,"address":[],"length":0,"stats":{"Line":18}},{"line":38,"address":[],"length":0,"stats":{"Line":9}},{"line":39,"address":[],"length":0,"stats":{"Line":9}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":9}},{"line":45,"address":[],"length":0,"stats":{"Line":13}},{"line":49,"address":[],"length":0,"stats":{"Line":26}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":26}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":14}},{"line":64,"address":[],"length":0,"stats":{"Line":7}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":15}},{"line":77,"address":[],"length":0,"stats":{"Line":30}},{"line":78,"address":[],"length":0,"stats":{"Line":15}},{"line":79,"address":[],"length":0,"stats":{"Line":4}},{"line":80,"address":[],"length":0,"stats":{"Line":11}},{"line":83,"address":[],"length":0,"stats":{"Line":15}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":15}},{"line":92,"address":[],"length":0,"stats":{"Line":15}},{"line":99,"address":[],"length":0,"stats":{"Line":14}},{"line":100,"address":[],"length":0,"stats":{"Line":1}},{"line":102,"address":[],"length":0,"stats":{"Line":13}},{"line":103,"address":[],"length":0,"stats":{"Line":39}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":6}},{"line":119,"address":[],"length":0,"stats":{"Line":6}},{"line":133,"address":[],"length":0,"stats":{"Line":3}},{"line":134,"address":[],"length":0,"stats":{"Line":3}},{"line":148,"address":[],"length":0,"stats":{"Line":3}},{"line":149,"address":[],"length":0,"stats":{"Line":3}},{"line":167,"address":[],"length":0,"stats":{"Line":6}},{"line":188,"address":[],"length":0,"stats":{"Line":2}}],"covered":38,"coverable":52},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","header_info.rs"],"content":"#[derive(Debug, Clone, Default, PartialEq, Copy)]\npub struct HeaderInfo {\n    revision_id: Option\u003cu64\u003e,\n    last_modified: Option\u003cchrono::DateTime\u003cchrono::Utc\u003e\u003e,\n}\n\nimpl HeaderInfo {\n    /// Constructs a new `HeaderInfo` object from a `HeaderMap` (from a `reqwest::Response`).\n    pub fn from_header(header: \u0026reqwest::header::HeaderMap) -\u003e Self {\n        let revision_id = header\n            .get(\"ETag\")\n            .and_then(|v| v.to_str().ok())\n            .and_then(|s| s.replace('\"', \"\").parse::\u003cu64\u003e().ok());\n        let last_modified = header\n            .get(\"Last-Modified\")\n            .and_then(|v| v.to_str().ok())\n            .and_then(|s| chrono::DateTime::parse_from_rfc2822(s).ok())\n            .map(|dt| dt.to_utc());\n        Self {\n            revision_id,\n            last_modified,\n        }\n    }\n\n    /// Returns the revision ID.\n    pub const fn revision_id(\u0026self) -\u003e Option\u003cu64\u003e {\n        self.revision_id\n    }\n\n    /// Returns the last modified date.\n    pub const fn last_modified(\u0026self) -\u003e Option\u003c\u0026chrono::DateTime\u003cchrono::Utc\u003e\u003e {\n        self.last_modified.as_ref()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use http::HeaderValue;\n    use reqwest::header::HeaderMap;\n\n    #[test]\n    fn test_header_info() {\n        let mut headers = HeaderMap::new();\n        headers.insert(\"ETag\", HeaderValue::from_str(\"1234567890\").unwrap());\n        headers.insert(\n            \"Last-Modified\",\n            HeaderValue::from_str(\"Wed, 21 Oct 2015 07:28:00 GMT\").unwrap(),\n        );\n        let hi = HeaderInfo::from_header(\u0026headers);\n        assert_eq!(hi.revision_id(), Some(1234567890));\n        assert_eq!(\n            hi.last_modified().unwrap().to_rfc2822(),\n            \"Wed, 21 Oct 2015 07:28:00 +0000\"\n        );\n    }\n}\n","traces":[{"line":9,"address":[],"length":0,"stats":{"Line":42}},{"line":10,"address":[],"length":0,"stats":{"Line":42}},{"line":12,"address":[],"length":0,"stats":{"Line":92}},{"line":13,"address":[],"length":0,"stats":{"Line":92}},{"line":14,"address":[],"length":0,"stats":{"Line":42}},{"line":16,"address":[],"length":0,"stats":{"Line":86}},{"line":17,"address":[],"length":0,"stats":{"Line":86}},{"line":18,"address":[],"length":0,"stats":{"Line":86}},{"line":26,"address":[],"length":0,"stats":{"Line":2}},{"line":27,"address":[],"length":0,"stats":{"Line":2}},{"line":31,"address":[],"length":0,"stats":{"Line":1}},{"line":32,"address":[],"length":0,"stats":{"Line":1}}],"covered":12,"coverable":12},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","item.rs"],"content":"use crate::{\n    aliases::Aliases,\n    aliases_in_language::AliasesInLanguage,\n    descriptions::Descriptions,\n    entity::{Entity, EntityType},\n    entity_patch::EntityPatch,\n    labels::Labels,\n    sitelinks::Sitelinks,\n    statements::Statements,\n    EntityId, FromJson, HeaderInfo, HttpMisc, Patch, RestApi, RestApiError,\n};\nuse async_trait::async_trait;\nuse derivative::Derivative;\nuse serde::ser::{Serialize, SerializeStruct, Serializer};\nuse serde_json::Value;\n\n#[derive(Derivative, Debug, Clone, Default)]\n#[derivative(PartialEq)]\npub struct Item {\n    id: EntityId,\n    labels: Labels,\n    descriptions: Descriptions,\n    aliases: Aliases,\n    sitelinks: Sitelinks,\n    statements: Statements,\n    #[derivative(PartialEq = \"ignore\")]\n    header_info: HeaderInfo,\n}\n\nimpl HttpMisc for Item {\n    fn get_my_rest_api_path(\u0026self, id: \u0026EntityId) -\u003e Result\u003cString, RestApiError\u003e {\n        Ok(format!(\"/entities/{}/{id}\", id.group()?))\n    }\n}\n\n#[async_trait]\nimpl Entity for Item {\n    fn id(\u0026self) -\u003e EntityId {\n        self.id.to_owned()\n    }\n\n    fn from_json_header_info(j: Value, header_info: HeaderInfo) -\u003e Result\u003cSelf, RestApiError\u003e {\n        let id = j[\"id\"]\n            .as_str()\n            .ok_or(RestApiError::MissingOrInvalidField {\n                field: \"id\".into(),\n                j: j.to_owned(),\n            })?\n            .to_string();\n        Ok(Self {\n            id: EntityId::Item(id),\n            labels: Labels::from_json(\u0026j[\"labels\"])?,\n            descriptions: Descriptions::from_json(\u0026j[\"descriptions\"])?,\n            aliases: Aliases::from_json(\u0026j[\"aliases\"])?,\n            sitelinks: Sitelinks::from_json(\u0026j[\"sitelinks\"])?,\n            statements: Statements::from_json(\u0026j[\"statements\"])?,\n            header_info,\n        })\n    }\n\n    async fn post(\u0026self, api: \u0026RestApi) -\u003e Result\u003cSelf, RestApiError\u003e {\n        self.post_with_type(EntityType::Item, api).await\n    }\n}\n\nimpl Serialize for Item {\n    fn serialize\u003cS\u003e(\u0026self, serializer: S) -\u003e Result\u003cS::Ok, S::Error\u003e\n    where\n        S: Serializer,\n    {\n        // #lizard forgives the complexity\n        let mut fields = 5;\n        if self.id.is_some() {\n            fields += 1;\n        }\n        if self.labels.is_empty() {\n            fields -= 1;\n        }\n        if self.descriptions.is_empty() {\n            fields -= 1;\n        }\n        if self.aliases.is_empty() {\n            fields -= 1;\n        }\n        if self.sitelinks.is_empty() {\n            fields -= 1;\n        }\n        if self.statements.is_empty() {\n            fields -= 1;\n        }\n        let mut s = serializer.serialize_struct(\"Item\", fields)?;\n        if self.id.is_some() {\n            let id: String = self.id.to_owned().into();\n            s.serialize_field(\"id\", \u0026id)?;\n        }\n        if !self.labels.is_empty() {\n            s.serialize_field(\"labels\", \u0026self.labels)?;\n        }\n        if !self.descriptions.is_empty() {\n            s.serialize_field(\"descriptions\", \u0026self.descriptions)?;\n        }\n        if !self.aliases.is_empty() {\n            s.serialize_field(\"aliases\", \u0026self.aliases)?;\n        }\n        if !self.sitelinks.is_empty() {\n            s.serialize_field(\"sitelinks\", \u0026self.sitelinks)?;\n        }\n        if !self.statements.is_empty() {\n            s.serialize_field(\"statements\", \u0026self.statements)?;\n        }\n        s.end()\n    }\n}\n\nimpl Item {\n    /// Returns the statements of the item.\n    pub const fn statements(\u0026self) -\u003e \u0026Statements {\n        \u0026self.statements\n    }\n\n    /// Returns the statements of the item (mutable).\n    pub const fn statements_mut(\u0026mut self) -\u003e \u0026mut Statements {\n        \u0026mut self.statements\n    }\n\n    /// Returns the labels of the item.\n    pub const fn labels(\u0026self) -\u003e \u0026Labels {\n        \u0026self.labels\n    }\n\n    /// Returns the labels of the item (mutable).\n    pub const fn labels_mut(\u0026mut self) -\u003e \u0026mut Labels {\n        \u0026mut self.labels\n    }\n\n    /// Returns the descriptions of the item.\n    pub const fn descriptions(\u0026self) -\u003e \u0026Descriptions {\n        \u0026self.descriptions\n    }\n\n    /// Returns the descriptions of the item (mutable).\n    pub const fn descriptions_mut(\u0026mut self) -\u003e \u0026mut Descriptions {\n        \u0026mut self.descriptions\n    }\n\n    /// Returns the aliases of the item.\n    pub const fn aliases(\u0026self) -\u003e \u0026Aliases {\n        \u0026self.aliases\n    }\n\n    /// Returns the aliases of the item (mutable).\n    pub const fn aliases_mut(\u0026mut self) -\u003e \u0026mut Aliases {\n        \u0026mut self.aliases\n    }\n\n    /// Returns the aliases of the item as an `Aliases` object.\n    pub fn as_aliases\u003cS: Into\u003cString\u003e\u003e(\u0026self, lang: S) -\u003e AliasesInLanguage {\n        let lang: String = lang.into();\n        let v: Vec\u003cString\u003e = self\n            .aliases\n            .get_lang(\u0026lang)\n            .iter()\n            .map(|x| x.to_string())\n            .collect();\n        AliasesInLanguage::new(lang, v)\n    }\n\n    /// Returns the sitelinks of the item.\n    pub const fn sitelinks(\u0026self) -\u003e \u0026Sitelinks {\n        \u0026self.sitelinks\n    }\n\n    /// Returns the sitelinks of the item (mutable).\n    pub const fn sitelinks_mut(\u0026mut self) -\u003e \u0026mut Sitelinks {\n        \u0026mut self.sitelinks\n    }\n\n    /// Returns the header information of the item.\n    pub const fn header_info(\u0026self) -\u003e \u0026HeaderInfo {\n        \u0026self.header_info\n    }\n\n    /// Generates a patch to transform `other` into `self`\n    pub fn patch(\u0026self, other: \u0026Self) -\u003e Result\u003cEntityPatch, RestApiError\u003e {\n        let labels_patch = self.labels.patch(other.labels())?;\n        let descriptions_patch = self.descriptions.patch(other.descriptions())?;\n        let aliases_patch = self.aliases.patch(other.aliases())?;\n        let sitelinks_patch = self.sitelinks.patch(other.sitelinks())?;\n        let statements_patch = self.statements.patch(other.statements())?;\n\n        let mut ret = EntityPatch::item();\n        ret.patch_mut().extend(labels_patch.patch().to_owned());\n        ret.patch_mut()\n            .extend(descriptions_patch.patch().to_owned());\n        ret.patch_mut().extend(aliases_patch.patch().to_owned());\n        ret.patch_mut().extend(sitelinks_patch.patch().to_owned());\n        ret.patch_mut().extend(statements_patch.patch().to_owned());\n\n        Ok(ret)\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::language_strings::LanguageStrings;\n    use crate::{LanguageString, RestApi, Sitelink, Statement};\n    use serde_json::json;\n    use wiremock::matchers::{body_partial_json, method, path};\n    use wiremock::{Mock, MockServer, ResponseTemplate};\n\n    async fn get_test_item(id: \u0026str) -\u003e Result\u003cItem, RestApiError\u003e {\n        let v = std::fs::read_to_string(\"test_data/Q42.json\").unwrap();\n        let v: Value = serde_json::from_str(\u0026v).unwrap();\n\n        let mock_server = MockServer::start().await;\n        Mock::given(method(\"GET\"))\n            .and(path(\"/w/rest.php/wikibase/v1/entities/items/Q42\"))\n            .respond_with(ResponseTemplate::new(200).set_body_json(\u0026v))\n            .mount(\u0026mock_server)\n            .await;\n        Mock::given(method(\"GET\"))\n            .and(path(\"/w/rest.php/wikibase/v1/entities/items/Q0\"))\n            .respond_with(ResponseTemplate::new(400).set_body_json(\n                json!({\"code\": \"invalid-item-id\",\"message\": \"Not a valid item ID: Q0\"}),\n            ))\n            .mount(\u0026mock_server)\n            .await;\n        Mock::given(method(\"GET\"))\n            .and(path(\"/w/rest.php/wikibase/v1/entities/items/Q6\"))\n            .respond_with(ResponseTemplate::new(404).set_body_json(json!({\"code\": \"item-not-found\",\"message\": \"Could not find an item with the ID: Q6\"})))\n            .mount(\u0026mock_server).await;\n        let api = RestApi::builder(\u0026(mock_server.uri() + \"/w/rest.php\"))\n            .unwrap()\n            .build();\n\n        Item::get(EntityId::item(id), \u0026api).await\n    }\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_item_get() {\n        let item = get_test_item(\"Q42\").await.unwrap();\n        assert_eq!(item.id(), EntityId::item(\"Q42\"));\n        assert!(item.labels.has_language(\"en\"));\n        assert_eq!(item.labels().get_lang(\"en\").unwrap(), \"Douglas Adams\");\n        assert!(item\n            .aliases()\n            .get_lang(\"en\")\n            .contains(\u0026\"Douglas Noël Adams\"));\n        assert!(item.descriptions.has_language(\"en\"));\n        assert!(item.aliases.has_language(\"en\"));\n        assert!(item.sitelinks.get_wiki(\"enwiki\").is_some());\n        assert!(!item.statements.is_empty());\n    }\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_item_post() {\n        let mut item = get_test_item(\"Q42\").await.unwrap();\n        let v = item.to_owned();\n\n        let mock_server = MockServer::start().await;\n        Mock::given(method(\"POST\"))\n            .and(path(\"/w/rest.php/wikibase/v1/entities/items\"))\n            .and(body_partial_json(\n                json!({\"item\": {\"labels\": {\"en\": item.labels().get_lang(\"en\")}}}),\n            ))\n            .respond_with(ResponseTemplate::new(200).set_body_json(\u0026v))\n            .mount(\u0026mock_server)\n            .await;\n        let api = RestApi::builder(\u0026(mock_server.uri() + \"/w/rest.php\"))\n            .unwrap()\n            .build();\n\n        // Check that an error is returned when trying to post an item that already has an ID\n        let r0 = item.post(\u0026api).await;\n        assert_eq!(r0.err().unwrap().to_string(), \"ID already set\");\n\n        // Clear the ID and try again\n        item.id = EntityId::None;\n        let r1 = item.post(\u0026api).await.unwrap();\n        assert_eq!(r1.id(), v.id());\n    }\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_item_post_404() {\n        let item = Item::default();\n        let mock_server = MockServer::start().await;\n        let api = RestApi::builder(\u0026(mock_server.uri() + \"/w/rest.php\"))\n            .unwrap()\n            .build();\n        let r = item.post(\u0026api).await;\n        assert_eq!(\n            r.err().unwrap().to_string(),\n            \"Method POST not implemented for path /entities/items in REST API\"\n        );\n    }\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_invalid_item() {\n        let item = get_test_item(\"Q0\").await;\n        // assert_eq!(item.err().unwrap().to_string(), \"invalid-item-id\");\n        let err = item.err().unwrap();\n        match err {\n            RestApiError::ApiError {\n                status,\n                status_text,\n                payload,\n            } =\u003e {\n                assert_eq!(status, 400);\n                assert_eq!(status_text, \"Bad Request\");\n                assert_eq!(payload.code(), \"invalid-item-id\");\n                assert_eq!(payload.message(), \"Not a valid item ID: Q0\");\n                assert_eq!(payload.context().len(), 0);\n            }\n            _ =\u003e panic!(\"Wrong error type\"),\n        }\n    }\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_deleted_item() {\n        let item = get_test_item(\"Q6\").await;\n        let err = item.err().unwrap();\n        match err {\n            RestApiError::ApiError {\n                status,\n                status_text,\n                payload,\n            } =\u003e {\n                assert_eq!(status, 404);\n                assert_eq!(status_text, \"Not Found\");\n                assert_eq!(payload.code(), \"item-not-found\");\n                assert_eq!(payload.message(), \"Could not find an item with the ID: Q6\");\n                assert_eq!(payload.context().len(), 0);\n            }\n            _ =\u003e panic!(\"Wrong error type\"),\n        }\n    }\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_json_serialize() {\n        let item = get_test_item(\"Q42\").await.unwrap();\n        let j = serde_json::to_string(\u0026item).unwrap(); // Convert item to JSON text\n        let v: Value = serde_json::from_str(\u0026j).unwrap(); // Convert to JSON value\n        let item_from_json = Item::from_json(v).unwrap(); // Convert back to Item\n        assert_eq!(item, item_from_json); // Check if the reconstituted item is identical to the original\n    }\n\n    #[test]\n    fn test_labels() {\n        let mut item = Item::default();\n        assert_eq!(item.labels().len(), 0);\n        item.labels_mut().insert(LanguageString::new(\"en\", \"label\"));\n        assert_eq!(item.labels().len(), 1);\n    }\n\n    #[test]\n    fn test_descriptions() {\n        let mut item = Item::default();\n        assert_eq!(item.descriptions().len(), 0);\n        item.descriptions_mut()\n            .insert(LanguageString::new(\"en\", \"description\"));\n        assert_eq!(item.descriptions().len(), 1);\n    }\n\n    #[test]\n    fn test_aliases() {\n        let mut item = Item::default();\n        assert_eq!(item.aliases().len(), 0);\n        item.aliases_mut()\n            .insert(LanguageString::new(\"en\", \"alias\"));\n        assert_eq!(item.aliases().len(), 1);\n    }\n\n    #[test]\n    fn test_as_aliases() {\n        let mut item = Item::default();\n        item.aliases_mut()\n            .insert(LanguageString::new(\"en\", \"alias\"));\n        let aliases = item.as_aliases(\"en\");\n        assert_eq!(aliases.len(), 1);\n    }\n\n    #[test]\n    fn test_statements() {\n        let mut item = Item::default();\n        assert_eq!(item.statements().len(), 0);\n        item.statements_mut()\n            .insert(Statement::new_string(\"P31\", \"Q42\"));\n        assert_eq!(item.statements().len(), 1);\n    }\n\n    #[test]\n    fn test_sitelinks() {\n        let mut item = Item::default();\n        assert_eq!(item.sitelinks().len(), 0);\n        item.sitelinks_mut()\n            .set_wiki(Sitelink::new(\"enwiki\", \"Q42\"));\n        assert_eq!(item.sitelinks().len(), 1);\n    }\n\n    #[test]\n    fn test_header_info() {\n        let hi = HeaderInfo::default();\n        let item = Item::default();\n        assert_eq!(item.header_info(), \u0026hi);\n    }\n\n    #[test]\n    fn test_get_rest_api_path() {\n        let item = Item::default();\n        let id = EntityId::item(\"Q42\");\n        let path = item.get_my_rest_api_path(\u0026id).unwrap();\n        assert_eq!(path, \"/entities/items/Q42\");\n    }\n\n    #[test]\n    fn test_patch() {\n        let mut item1 = Item::default();\n        let mut item2 = Item::default();\n        item1\n            .labels_mut()\n            .insert(LanguageString::new(\"en\", \"label\"));\n        item2\n            .labels_mut()\n            .insert(LanguageString::new(\"en\", \"label2\"));\n        let patch = item1.patch(\u0026item2).unwrap();\n        assert_eq!(patch.patch().len(), 1);\n    }\n}\n","traces":[{"line":31,"address":[],"length":0,"stats":{"Line":1}},{"line":32,"address":[],"length":0,"stats":{"Line":2}},{"line":38,"address":[],"length":0,"stats":{"Line":8}},{"line":39,"address":[],"length":0,"stats":{"Line":8}},{"line":42,"address":[],"length":0,"stats":{"Line":9}},{"line":43,"address":[],"length":0,"stats":{"Line":18}},{"line":45,"address":[],"length":0,"stats":{"Line":9}},{"line":46,"address":[],"length":0,"stats":{"Line":9}},{"line":47,"address":[],"length":0,"stats":{"Line":9}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":9}},{"line":54,"address":[],"length":0,"stats":{"Line":9}},{"line":55,"address":[],"length":0,"stats":{"Line":9}},{"line":56,"address":[],"length":0,"stats":{"Line":9}},{"line":57,"address":[],"length":0,"stats":{"Line":9}},{"line":61,"address":[],"length":0,"stats":{"Line":3}},{"line":62,"address":[],"length":0,"stats":{"Line":3}},{"line":67,"address":[],"length":0,"stats":{"Line":4}},{"line":72,"address":[],"length":0,"stats":{"Line":4}},{"line":73,"address":[],"length":0,"stats":{"Line":6}},{"line":74,"address":[],"length":0,"stats":{"Line":2}},{"line":76,"address":[],"length":0,"stats":{"Line":5}},{"line":77,"address":[],"length":0,"stats":{"Line":1}},{"line":79,"address":[],"length":0,"stats":{"Line":5}},{"line":80,"address":[],"length":0,"stats":{"Line":1}},{"line":82,"address":[],"length":0,"stats":{"Line":5}},{"line":83,"address":[],"length":0,"stats":{"Line":1}},{"line":85,"address":[],"length":0,"stats":{"Line":5}},{"line":86,"address":[],"length":0,"stats":{"Line":1}},{"line":88,"address":[],"length":0,"stats":{"Line":5}},{"line":89,"address":[],"length":0,"stats":{"Line":1}},{"line":91,"address":[],"length":0,"stats":{"Line":8}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":2}},{"line":94,"address":[],"length":0,"stats":{"Line":2}},{"line":96,"address":[],"length":0,"stats":{"Line":4}},{"line":97,"address":[],"length":0,"stats":{"Line":3}},{"line":99,"address":[],"length":0,"stats":{"Line":4}},{"line":100,"address":[],"length":0,"stats":{"Line":3}},{"line":102,"address":[],"length":0,"stats":{"Line":4}},{"line":103,"address":[],"length":0,"stats":{"Line":3}},{"line":105,"address":[],"length":0,"stats":{"Line":4}},{"line":106,"address":[],"length":0,"stats":{"Line":3}},{"line":108,"address":[],"length":0,"stats":{"Line":4}},{"line":109,"address":[],"length":0,"stats":{"Line":3}},{"line":111,"address":[],"length":0,"stats":{"Line":4}},{"line":117,"address":[],"length":0,"stats":{"Line":5}},{"line":118,"address":[],"length":0,"stats":{"Line":5}},{"line":122,"address":[],"length":0,"stats":{"Line":1}},{"line":123,"address":[],"length":0,"stats":{"Line":1}},{"line":127,"address":[],"length":0,"stats":{"Line":5}},{"line":128,"address":[],"length":0,"stats":{"Line":5}},{"line":132,"address":[],"length":0,"stats":{"Line":3}},{"line":133,"address":[],"length":0,"stats":{"Line":3}},{"line":137,"address":[],"length":0,"stats":{"Line":3}},{"line":138,"address":[],"length":0,"stats":{"Line":3}},{"line":142,"address":[],"length":0,"stats":{"Line":1}},{"line":143,"address":[],"length":0,"stats":{"Line":1}},{"line":147,"address":[],"length":0,"stats":{"Line":4}},{"line":148,"address":[],"length":0,"stats":{"Line":4}},{"line":152,"address":[],"length":0,"stats":{"Line":2}},{"line":153,"address":[],"length":0,"stats":{"Line":2}},{"line":157,"address":[],"length":0,"stats":{"Line":1}},{"line":158,"address":[],"length":0,"stats":{"Line":1}},{"line":159,"address":[],"length":0,"stats":{"Line":1}},{"line":160,"address":[],"length":0,"stats":{"Line":1}},{"line":161,"address":[],"length":0,"stats":{"Line":1}},{"line":163,"address":[],"length":0,"stats":{"Line":3}},{"line":165,"address":[],"length":0,"stats":{"Line":1}},{"line":169,"address":[],"length":0,"stats":{"Line":3}},{"line":170,"address":[],"length":0,"stats":{"Line":3}},{"line":174,"address":[],"length":0,"stats":{"Line":1}},{"line":175,"address":[],"length":0,"stats":{"Line":1}},{"line":179,"address":[],"length":0,"stats":{"Line":1}},{"line":180,"address":[],"length":0,"stats":{"Line":1}},{"line":184,"address":[],"length":0,"stats":{"Line":1}},{"line":185,"address":[],"length":0,"stats":{"Line":2}},{"line":186,"address":[],"length":0,"stats":{"Line":1}},{"line":187,"address":[],"length":0,"stats":{"Line":1}},{"line":188,"address":[],"length":0,"stats":{"Line":1}},{"line":189,"address":[],"length":0,"stats":{"Line":1}}],"covered":79,"coverable":81},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","label.rs"],"content":"use crate::{\n    EditMetadata, EntityId, HeaderInfo, HttpDelete, HttpGet, HttpGetEntityWithFallback, HttpMisc,\n    HttpPut, LanguageString, RestApi, RestApiError, RevisionMatch,\n};\nuse async_trait::async_trait;\nuse derivative::Derivative;\nuse reqwest::Request;\nuse serde_json::json;\nuse std::collections::HashMap;\nuse std::ops::Deref;\n\n#[derive(Derivative, Debug, Clone)]\n#[derivative(PartialEq)]\npub struct Label {\n    ls: LanguageString,\n    #[derivative(PartialEq = \"ignore\")]\n    header_info: HeaderInfo,\n}\n\nimpl Label {\n    /// Constructs a new `Label` object from a language code and a label.\n    pub fn new\u003cS1: Into\u003cString\u003e, S2: Into\u003cString\u003e\u003e(language: S1, value: S2) -\u003e Label {\n        Self {\n            ls: LanguageString::new(language, value),\n            header_info: HeaderInfo::default(),\n        }\n    }\n\n    async fn generate_get_match_request(\n        id: \u0026EntityId,\n        language: \u0026str,\n        api: \u0026RestApi,\n        rm: RevisionMatch,\n        mode: \u0026str,\n    ) -\u003e Result\u003cRequest, RestApiError\u003e {\n        let path = format!(\n            \"/entities/{group}/{id}/{mode}/{language}\",\n            group = id.group()?\n        );\n        let mut request = api\n            .wikibase_request_builder(\u0026path, HashMap::new(), reqwest::Method::GET)\n            .await?\n            .build()?;\n        rm.modify_headers(request.headers_mut())?;\n        Ok(request)\n    }\n}\n\nimpl Deref for Label {\n    type Target = LanguageString;\n\n    fn deref(\u0026self) -\u003e \u0026Self::Target {\n        \u0026self.ls\n    }\n}\n\nimpl From\u003cLanguageString\u003e for Label {\n    fn from(ls: LanguageString) -\u003e Self {\n        Self {\n            ls,\n            header_info: HeaderInfo::default(),\n        }\n    }\n}\n\nimpl From\u003cLabel\u003e for LanguageString {\n    fn from(val: Label) -\u003e Self {\n        val.ls\n    }\n}\n\nimpl HttpMisc for Label {\n    fn get_my_rest_api_path(\u0026self, id: \u0026EntityId) -\u003e Result\u003cString, RestApiError\u003e {\n        Ok(format!(\n            \"/entities/{group}/{id}/labels/{language}\",\n            group = id.group()?,\n            language = self.ls.language()\n        ))\n    }\n}\n\n#[async_trait]\nimpl HttpGetEntityWithFallback for Label {\n    async fn get_match_with_fallback(\n        id: \u0026EntityId,\n        language: \u0026str,\n        api: \u0026RestApi,\n        rm: RevisionMatch,\n    ) -\u003e Result\u003cSelf, RestApiError\u003e {\n        let request = Self::generate_get_match_request(\n            id,\n            language,\n            api,\n            rm,\n            \"labels_with_language_fallback\",\n        )\n        .await?;\n        let (j, header_info) = Self::api_execute(api, request).await?;\n        let s = j\n            .as_str()\n            .ok_or_else(|| RestApiError::MissingOrInvalidField {\n                field: \"Label\".into(),\n                j: j.to_owned(),\n            })?;\n        Ok(Self {\n            ls: LanguageString::new(language, s),\n            header_info,\n        })\n    }\n}\n\n#[async_trait]\nimpl HttpGet for Label {\n    async fn get_match(\n        id: \u0026EntityId,\n        language: \u0026str,\n        api: \u0026RestApi,\n        rm: RevisionMatch,\n    ) -\u003e Result\u003cSelf, RestApiError\u003e {\n        let request = Self::generate_get_match_request(id, language, api, rm, \"labels\").await?;\n        let (j, header_info) = Self::api_execute(api, request).await?;\n        let s = j\n            .as_str()\n            .ok_or_else(|| RestApiError::MissingOrInvalidField {\n                field: \"Label\".into(),\n                j: j.to_owned(),\n            })?;\n        Ok(Self {\n            ls: LanguageString::new(language, s),\n            header_info,\n        })\n    }\n}\n\n#[async_trait]\nimpl HttpDelete for Label {\n    async fn delete_meta(\n        \u0026self,\n        id: \u0026EntityId,\n        api: \u0026mut RestApi,\n        em: EditMetadata,\n    ) -\u003e Result\u003c(), RestApiError\u003e {\n        let j = json!({});\n        let (j, _header_info) = self\n            .run_json_query(id, reqwest::Method::DELETE, j, api, \u0026em)\n            .await?;\n        match j.as_str() {\n            Some(\"Label deleted\") =\u003e Ok(()),\n            Some(\"Description deleted\") =\u003e Ok(()),\n            _ =\u003e Err(RestApiError::UnexpectedResponse(j)),\n        }\n    }\n}\n\n#[async_trait]\nimpl HttpPut for Label {\n    async fn put_meta(\n        \u0026self,\n        id: \u0026EntityId,\n        api: \u0026mut RestApi,\n        em: EditMetadata,\n    ) -\u003e Result\u003cSelf, RestApiError\u003e {\n        let j = json!({\"label\": self.ls.value()});\n        let (j, header_info) = self\n            .run_json_query(id, reqwest::Method::PUT, j, api, \u0026em)\n            .await?;\n        let value = j\n            .as_str()\n            .ok_or_else(|| RestApiError::MissingOrInvalidField {\n                field: \"Label\".into(),\n                j: j.to_owned(),\n            })?;\n        let mut ret = Self::new(self.language(), value);\n        ret.header_info = header_info;\n        Ok(ret)\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use wiremock::matchers::{bearer_token, body_partial_json, method, path};\n    use wiremock::{Mock, MockServer, ResponseTemplate};\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_labels_get_match_with_fallback() {\n        let id = \"Q42\";\n        let mock_path = format!(\n            \"/w/rest.php/wikibase/v1/entities/items/{id}/labels_with_language_fallback/foo\"\n        );\n        let mock_server = MockServer::start().await;\n        Mock::given(method(\"GET\"))\n            .and(path(\u0026mock_path))\n            .respond_with(ResponseTemplate::new(200).set_body_json(json!(\"Douglas Adams\")))\n            .mount(\u0026mock_server)\n            .await;\n        let api = RestApi::builder(\u0026(mock_server.uri() + \"/w/rest.php\"))\n            .unwrap()\n            .build();\n\n        let id = EntityId::item(id);\n        let label = Label::get_with_fallback(\u0026id, \"foo\", \u0026api).await.unwrap();\n        assert_eq!(label.language(), \"foo\");\n        assert_eq!(label.value(), \"Douglas Adams\");\n    }\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_label_get() {\n        let id = \"Q42\";\n        let mock_path = format!(\"/w/rest.php/wikibase/v1/entities/items/{id}/labels/en\");\n        let mock_server = MockServer::start().await;\n        Mock::given(method(\"GET\"))\n            .and(path(\u0026mock_path))\n            .respond_with(ResponseTemplate::new(200).set_body_json(json!(\"Douglas Adams\")))\n            .mount(\u0026mock_server)\n            .await;\n        let api = RestApi::builder(\u0026(mock_server.uri() + \"/w/rest.php\"))\n            .unwrap()\n            .build();\n\n        let id = EntityId::item(id);\n        let label = Label::get(\u0026id, \"en\", \u0026api).await.unwrap();\n        assert_eq!(label.language(), \"en\");\n        assert_eq!(label.value(), \"Douglas Adams\");\n    }\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_label_put() {\n        let label = \"Foo bar\";\n        let id = \"Q42\";\n        let mock_path = format!(\"/w/rest.php/wikibase/v1/entities/items/{id}/labels/en\");\n        let mock_server = MockServer::start().await;\n        let token = \"FAKE_TOKEN\";\n        Mock::given(body_partial_json(json!({\"label\": label})))\n            .and(method(\"PUT\"))\n            .and(path(\u0026mock_path))\n            .and(bearer_token(token))\n            .respond_with(ResponseTemplate::new(200).set_body_json(json!(label)))\n            .mount(\u0026mock_server)\n            .await;\n        let mut api = RestApi::builder(\u0026(mock_server.uri() + \"/w/rest.php\"))\n            .unwrap()\n            .with_access_token(token)\n            .build();\n\n        let id = EntityId::item(id);\n        let new_label = Label::new(\"en\", label);\n        let return_label = new_label.put(\u0026id, \u0026mut api).await.unwrap();\n        assert_eq!(return_label.language(), \"en\");\n        assert_eq!(return_label.value(), label);\n    }\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_label_delete() {\n        let id = \"Q42\";\n        let mock_path = format!(\"/w/rest.php/wikibase/v1/entities/items/{id}/labels/en\");\n        let mock_server = MockServer::start().await;\n        let token = \"FAKE_TOKEN\";\n        Mock::given(method(\"DELETE\"))\n            .and(path(\u0026mock_path))\n            .and(bearer_token(token))\n            .respond_with(ResponseTemplate::new(200).set_body_json(json!(\"Label deleted\")))\n            .mount(\u0026mock_server)\n            .await;\n        let mut api = RestApi::builder(\u0026(mock_server.uri() + \"/w/rest.php\"))\n            .unwrap()\n            .with_access_token(token)\n            .build();\n\n        let id = EntityId::item(id);\n        let label = Label::new(\"en\", \"\");\n        let result = label.delete(\u0026id, \u0026mut api).await;\n        assert!(result.is_ok());\n    }\n\n    #[test]\n    fn test_into_language_string() {\n        let label = Label::new(\"en\", \"Foo bar\");\n        let ls: LanguageString = label.into();\n        assert_eq!(ls.language(), \"en\");\n        assert_eq!(ls.value(), \"Foo bar\");\n    }\n\n    #[test]\n    fn test_from_language_string() {\n        let ls = LanguageString::new(\"en\", \"Foo bar\");\n        let label = Label::from(ls);\n        assert_eq!(label.language(), \"en\");\n        assert_eq!(label.value(), \"Foo bar\");\n    }\n}\n","traces":[{"line":22,"address":[],"length":0,"stats":{"Line":4}},{"line":24,"address":[],"length":0,"stats":{"Line":4}},{"line":25,"address":[],"length":0,"stats":{"Line":4}},{"line":29,"address":[],"length":0,"stats":{"Line":2}},{"line":36,"address":[],"length":0,"stats":{"Line":2}},{"line":38,"address":[],"length":0,"stats":{"Line":2}},{"line":40,"address":[],"length":0,"stats":{"Line":2}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":2}},{"line":52,"address":[],"length":0,"stats":{"Line":9}},{"line":53,"address":[],"length":0,"stats":{"Line":9}},{"line":58,"address":[],"length":0,"stats":{"Line":1}},{"line":61,"address":[],"length":0,"stats":{"Line":1}},{"line":67,"address":[],"length":0,"stats":{"Line":1}},{"line":68,"address":[],"length":0,"stats":{"Line":1}},{"line":73,"address":[],"length":0,"stats":{"Line":2}},{"line":74,"address":[],"length":0,"stats":{"Line":2}},{"line":75,"address":[],"length":0,"stats":{"Line":2}},{"line":76,"address":[],"length":0,"stats":{"Line":2}},{"line":91,"address":[],"length":0,"stats":{"Line":1}},{"line":92,"address":[],"length":0,"stats":{"Line":1}},{"line":93,"address":[],"length":0,"stats":{"Line":1}},{"line":94,"address":[],"length":0,"stats":{"Line":1}},{"line":97,"address":[],"length":0,"stats":{"Line":1}},{"line":98,"address":[],"length":0,"stats":{"Line":1}},{"line":99,"address":[],"length":0,"stats":{"Line":1}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":2}},{"line":121,"address":[],"length":0,"stats":{"Line":1}},{"line":122,"address":[],"length":0,"stats":{"Line":1}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":1}},{"line":144,"address":[],"length":0,"stats":{"Line":2}},{"line":145,"address":[],"length":0,"stats":{"Line":1}},{"line":146,"address":[],"length":0,"stats":{"Line":1}},{"line":148,"address":[],"length":0,"stats":{"Line":2}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":1}},{"line":164,"address":[],"length":0,"stats":{"Line":2}},{"line":165,"address":[],"length":0,"stats":{"Line":1}},{"line":166,"address":[],"length":0,"stats":{"Line":1}},{"line":167,"address":[],"length":0,"stats":{"Line":1}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}}],"covered":38,"coverable":51},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","labels.rs"],"content":"use crate::{\n    language_strings_patch::LanguageStringsPatch, prelude::LanguageStrings, EntityId, FromJson,\n    HeaderInfo, HttpGetEntity, HttpMisc, LanguageString, RestApi, RestApiError, RevisionMatch,\n};\nuse async_trait::async_trait;\nuse derivative::Derivative;\nuse serde::ser::{Serialize, SerializeMap};\nuse serde_json::{json, Value};\nuse std::collections::HashMap;\n\n#[derive(Derivative, Debug, Clone, Default)]\n#[derivative(PartialEq)]\npub struct Labels {\n    ls: HashMap\u003cString, String\u003e,\n    #[derivative(PartialEq = \"ignore\")]\n    header_info: HeaderInfo,\n}\n\nimpl Labels {\n    /// Returns the value for a language\n    pub fn get_lang\u003cS: Into\u003cString\u003e\u003e(\u0026self, language: S) -\u003e Option\u003c\u0026str\u003e {\n        self.ls.get(\u0026language.into()).map(|s| s.as_str())\n    }\n\n    /// Returns the number of labels/languages\n    pub fn len(\u0026self) -\u003e usize {\n        self.ls.len()\n    }\n\n    /// Returns true if there are no labels/languages\n    pub fn is_empty(\u0026self) -\u003e bool {\n        self.ls.is_empty()\n    }\n\n    /// Generates a patch to transform `other` into `self`\n    pub fn patch(\u0026self, other: \u0026Self) -\u003e Result\u003cLanguageStringsPatch, RestApiError\u003e {\n        let patch = json_patch::diff(\u0026json!(\u0026other), \u0026json!(\u0026self));\n        let patch = LanguageStringsPatch::labels_from_json(\u0026json!(patch))?;\n        Ok(patch)\n    }\n}\n\nimpl HttpMisc for Labels {\n    fn get_my_rest_api_path(\u0026self, id: \u0026EntityId) -\u003e Result\u003cString, RestApiError\u003e {\n        Ok(format!(\n            \"/entities/{group}/{id}/labels\",\n            group = id.group()?\n        ))\n    }\n}\n\n#[async_trait]\nimpl HttpGetEntity for Labels {\n    async fn get_match(\n        id: \u0026EntityId,\n        api: \u0026RestApi,\n        rm: RevisionMatch,\n    ) -\u003e Result\u003cSelf, RestApiError\u003e {\n        let path = format!(\"/entities/{group}/{id}/labels\", group = id.group()?);\n        let (j, header_info) = Self::get_match_internal(api, \u0026path, rm).await?;\n        Self::from_json_header_info(\u0026j, header_info)\n    }\n}\n\nimpl FromJson for Labels {\n    fn header_info(\u0026self) -\u003e \u0026HeaderInfo {\n        \u0026self.header_info\n    }\n\n    fn from_json_header_info(j: \u0026Value, header_info: HeaderInfo) -\u003e Result\u003cSelf, RestApiError\u003e {\n        let ls = j\n            .as_object()\n            .ok_or_else(|| RestApiError::WrongType {\n                field: \"Labels\".to_string(),\n                j: j.to_owned(),\n            })?\n            .iter()\n            .map(|(language, value)| {\n                let value = value\n                    .as_str()\n                    .ok_or_else(|| RestApiError::MissingOrInvalidField {\n                        field: \"Labels\".into(),\n                        j: value.to_owned(),\n                    })?;\n                Ok((language.to_owned(), value.to_string()))\n            })\n            .collect::\u003cResult\u003cHashMap\u003cString, String\u003e, RestApiError\u003e\u003e()?;\n        let ret = Self { ls, header_info };\n        Ok(ret)\n    }\n}\n\nimpl LanguageStrings for Labels {\n    fn has_language\u003cS: Into\u003cString\u003e\u003e(\u0026self, language: S) -\u003e bool {\n        self.ls.contains_key(\u0026language.into())\n    }\n\n    fn insert(\u0026mut self, ls: LanguageString) {\n        self.ls\n            .insert(ls.language().to_string(), ls.value().to_string());\n    }\n}\n\nimpl Serialize for Labels {\n    fn serialize\u003cS\u003e(\u0026self, serializer: S) -\u003e Result\u003cS::Ok, S::Error\u003e\n    where\n        S: serde::Serializer,\n    {\n        let mut s = serializer.serialize_map(Some(self.ls.len()))?;\n        for (language, ls) in \u0026self.ls {\n            s.serialize_entry(language, ls)?;\n        }\n        s.end()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use serde_json::json;\n    use wiremock::matchers::{method, path};\n    use wiremock::{Mock, MockServer, ResponseTemplate};\n\n    #[test]\n    fn test_language_strings_single() {\n        let j = json!({\n            \"en\": \"Hello\",\n            \"de\": \"Hallo\",\n        });\n        let ls = Labels::from_json(\u0026j).unwrap();\n        assert_eq!(ls.get_lang(\"en\"), Some(\"Hello\"));\n        assert_eq!(ls.get_lang(\"de\"), Some(\"Hallo\"));\n        assert_eq!(ls.get_lang(\"fr\"), None);\n    }\n\n    #[test]\n    fn test_language_strings_insert() {\n        let mut ls = Labels::default();\n        ls.insert(LanguageString::new(\"en\", \"Hello\"));\n        ls.insert(LanguageString::new(\"de\", \"Hallo\"));\n        ls.insert(LanguageString::new(\"en\", \"Hi\"));\n        assert_eq!(ls.get_lang(\"en\"), Some(\"Hi\"));\n        assert_eq!(ls.get_lang(\"de\"), Some(\"Hallo\"));\n    }\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_language_strings_single_get() {\n        let v = std::fs::read_to_string(\"test_data/Q42.json\").unwrap();\n        let v: Value = serde_json::from_str(\u0026v).unwrap();\n\n        let mock_path = \"/w/rest.php/wikibase/v1/entities/items/Q42/labels\";\n        let mock_server = MockServer::start().await;\n        Mock::given(method(\"GET\"))\n            .and(path(mock_path))\n            .respond_with(ResponseTemplate::new(200).set_body_json(\u0026v[\"labels\"]))\n            .mount(\u0026mock_server)\n            .await;\n        let api = RestApi::builder(\u0026(mock_server.uri() + \"/w/rest.php\"))\n            .unwrap()\n            .build();\n\n        let id = EntityId::new(\"Q42\").unwrap();\n        let ls = Labels::get(\u0026id, \u0026api).await.unwrap();\n        assert_eq!(ls.get_lang(\"en\"), Some(\"Douglas Adams\"));\n    }\n\n    #[test]\n    fn test_patch_labels() {\n        let mut l1 = Labels::default();\n        l1.insert(LanguageString::new(\"en\", \"Foo\"));\n        l1.insert(LanguageString::new(\"de\", \"Bar\"));\n        let mut l2 = l1.clone();\n        l2.insert(LanguageString::new(\"en\", \"Baz\"));\n\n        let patch = l2.patch(\u0026l1).unwrap();\n        let patch_json = json!(patch);\n        assert_eq!(\n            patch_json,\n            json!({\"mode\":\"Labels\",\"patch\":[{\"op\":\"replace\",\"path\":\"/en\",\"value\":\"Baz\"}]})\n        );\n    }\n\n    #[test]\n    fn test_get_rest_api_path() {\n        let l = Labels::default();\n        let id = EntityId::new(\"Q42\").unwrap();\n        assert_eq!(\n            l.get_my_rest_api_path(\u0026id).unwrap(),\n            \"/entities/items/Q42/labels\"\n        );\n    }\n\n    #[test]\n    fn test_header_info_single() {\n        let l = Labels::default();\n        assert_eq!(l.header_info(), \u0026HeaderInfo::default());\n    }\n\n    #[test]\n    fn test_serialize() {\n        let mut l = Labels::default();\n        l.insert(LanguageString::new(\"en\", \"Foo\"));\n        l.insert(LanguageString::new(\"de\", \"Bar\"));\n        let s = serde_json::to_string(\u0026l).unwrap();\n        assert!(s.contains(r#\"\"en\":\"Foo\"\"#));\n        assert!(s.contains(r#\"\"de\":\"Bar\"\"#));\n    }\n}\n","traces":[{"line":21,"address":[],"length":0,"stats":{"Line":11}},{"line":22,"address":[],"length":0,"stats":{"Line":32}},{"line":26,"address":[],"length":0,"stats":{"Line":4}},{"line":27,"address":[],"length":0,"stats":{"Line":4}},{"line":31,"address":[],"length":0,"stats":{"Line":16}},{"line":32,"address":[],"length":0,"stats":{"Line":16}},{"line":36,"address":[],"length":0,"stats":{"Line":2}},{"line":37,"address":[],"length":0,"stats":{"Line":2}},{"line":38,"address":[],"length":0,"stats":{"Line":4}},{"line":44,"address":[],"length":0,"stats":{"Line":1}},{"line":45,"address":[],"length":0,"stats":{"Line":1}},{"line":46,"address":[],"length":0,"stats":{"Line":1}},{"line":47,"address":[],"length":0,"stats":{"Line":1}},{"line":59,"address":[],"length":0,"stats":{"Line":2}},{"line":60,"address":[],"length":0,"stats":{"Line":1}},{"line":66,"address":[],"length":0,"stats":{"Line":1}},{"line":67,"address":[],"length":0,"stats":{"Line":1}},{"line":70,"address":[],"length":0,"stats":{"Line":18}},{"line":71,"address":[],"length":0,"stats":{"Line":36}},{"line":73,"address":[],"length":0,"stats":{"Line":18}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":2810}},{"line":79,"address":[],"length":0,"stats":{"Line":5584}},{"line":80,"address":[],"length":0,"stats":{"Line":2792}},{"line":81,"address":[],"length":0,"stats":{"Line":2792}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":1}},{"line":95,"address":[],"length":0,"stats":{"Line":1}},{"line":98,"address":[],"length":0,"stats":{"Line":13}},{"line":99,"address":[],"length":0,"stats":{"Line":13}},{"line":100,"address":[],"length":0,"stats":{"Line":13}},{"line":105,"address":[],"length":0,"stats":{"Line":12}},{"line":109,"address":[],"length":0,"stats":{"Line":24}},{"line":110,"address":[],"length":0,"stats":{"Line":1980}},{"line":111,"address":[],"length":0,"stats":{"Line":984}},{"line":113,"address":[],"length":0,"stats":{"Line":12}}],"covered":34,"coverable":38},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","labels_patch.rs"],"content":"use crate::{patch_entry::PatchEntry, EntityId, HttpMisc, Patch, RestApiError};\nuse serde::Serialize;\nuse serde_json::Value;\n\n#[derive(Debug, Clone, PartialEq, Serialize, Default)]\npub struct LabelsPatch {\n    patch: Vec\u003cPatchEntry\u003e,\n}\n\nimpl LabelsPatch {\n    pub fn from_json(j: \u0026Value) -\u003e Result\u003cVec\u003cPatchEntry\u003e, RestApiError\u003e {\n        j.as_array()\n            .ok_or_else(|| RestApiError::MissingOrInvalidField {\n                field: \"LabelsPatch\".into(),\n                j: j.to_owned(),\n            })?\n            .iter()\n            .map(|x| serde_json::from_value(x.clone()).map_err(|e| e.into()))\n            .collect::\u003cResult\u003cVec\u003cPatchEntry\u003e, RestApiError\u003e\u003e()\n    }\n\n    // TODO add?\n\n    /// Adds a command to replace the value of a language string.\n    pub fn replace\u003cS1: Into\u003cString\u003e, S2: Into\u003cString\u003e\u003e(\u0026mut self, language: S1, value: S2) {\n        \u003cSelf as Patch\u003e::replace(self, format!(\"/{}\", language.into()), value.into().into());\n    }\n\n    /// Adds a command to remove the value for the language.\n    pub fn remove\u003cS: Into\u003cString\u003e\u003e(\u0026mut self, language: S) {\n        \u003cSelf as Patch\u003e::remove(self, format!(\"/{}\", language.into()));\n    }\n}\n\nimpl Patch for LabelsPatch {\n    fn patch(\u0026self) -\u003e \u0026Vec\u003cPatchEntry\u003e {\n        \u0026self.patch\n    }\n\n    fn patch_mut(\u0026mut self) -\u003e \u0026mut Vec\u003cPatchEntry\u003e {\n        \u0026mut self.patch\n    }\n}\n\nimpl HttpMisc for LabelsPatch {\n    fn get_my_rest_api_path(\u0026self, id: \u0026EntityId) -\u003e Result\u003cString, RestApiError\u003e {\n        Ok(format!(\n            \"/entities/{group}/{id}/labels\",\n            group = id.group()?\n        ))\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use serde_json::{json, Value};\n\n    #[test]\n    fn test_remove() {\n        let mut patch = LabelsPatch::default();\n        patch.remove(\"en\");\n        assert_eq!(\n            patch.patch,\n            vec![PatchEntry::new(\"remove\", \"/en\", Value::Null)]\n        );\n    }\n\n    #[test]\n    fn test_patch() {\n        let mut patch = LabelsPatch::default();\n        patch.replace(\"en\", \"Foo Bar\");\n        assert_eq!(\n            patch.patch,\n            vec![PatchEntry::new(\"replace\", \"/en\", json!(\"Foo Bar\"))]\n        );\n    }\n\n    #[test]\n    fn test_patch_fn() {\n        let mut patch = LabelsPatch::default();\n        patch.replace(\"en\", \"Foo Bar\");\n        assert_eq!(\n            *\u003cLabelsPatch as Patch\u003e::patch(\u0026patch),\n            vec![PatchEntry::new(\"replace\", \"/en\", json!(\"Foo Bar\"))]\n        );\n    }\n\n    #[test]\n    fn test_from_json() {\n        let j = json!([\n            {\"op\": \"replace\", \"path\": \"/en\", \"value\": \"Foo Bar\"},\n            {\"op\": \"remove\", \"path\": \"/de\"}\n        ]);\n        let patch = LabelsPatch::from_json(\u0026j).unwrap();\n        assert_eq!(\n            patch,\n            vec![\n                PatchEntry::new(\"replace\", \"/en\", json!(\"Foo Bar\")),\n                PatchEntry::new(\"remove\", \"/de\", Value::Null)\n            ]\n        );\n    }\n\n    #[test]\n    fn test_get_rest_api_path_items() {\n        let patch = LabelsPatch::default();\n        let id = EntityId::new(\"Q12345\").unwrap();\n        assert_eq!(\n            patch.get_my_rest_api_path(\u0026id).unwrap(),\n            \"/entities/items/Q12345/labels\"\n        );\n    }\n\n    #[test]\n    fn test_get_rest_api_path_properties() {\n        let patch = LabelsPatch::default();\n        let id = EntityId::new(\"P123\").unwrap();\n        assert_eq!(\n            patch.get_my_rest_api_path(\u0026id).unwrap(),\n            \"/entities/properties/P123/labels\"\n        );\n    }\n}\n","traces":[{"line":11,"address":[],"length":0,"stats":{"Line":1}},{"line":12,"address":[],"length":0,"stats":{"Line":1}},{"line":13,"address":[],"length":0,"stats":{"Line":1}},{"line":14,"address":[],"length":0,"stats":{"Line":0}},{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":5}},{"line":25,"address":[],"length":0,"stats":{"Line":2}},{"line":26,"address":[],"length":0,"stats":{"Line":2}},{"line":30,"address":[],"length":0,"stats":{"Line":1}},{"line":31,"address":[],"length":0,"stats":{"Line":1}},{"line":36,"address":[],"length":0,"stats":{"Line":1}},{"line":37,"address":[],"length":0,"stats":{"Line":1}},{"line":40,"address":[],"length":0,"stats":{"Line":3}},{"line":41,"address":[],"length":0,"stats":{"Line":3}},{"line":46,"address":[],"length":0,"stats":{"Line":2}},{"line":47,"address":[],"length":0,"stats":{"Line":2}},{"line":48,"address":[],"length":0,"stats":{"Line":2}},{"line":49,"address":[],"length":0,"stats":{"Line":2}}],"covered":16,"coverable":18},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","language_string.rs"],"content":"use nutype::nutype;\nuse serde::{Deserialize, Serialize};\n\n#[nutype(\n    sanitize(trim, lowercase),\n    validate(regex = \"^[a-z]{2}[a-z0-9-]*$\"),\n    derive(Debug, Display, Clone, PartialEq)\n)]\npub struct Language(String);\n\n#[derive(Debug, Clone, Default, PartialEq, Serialize, Deserialize)]\npub struct LanguageString {\n    language: String,\n    value: String,\n}\n\nimpl LanguageString {\n    /// Constructs a new `LanguageString` object from a language code and a string.\n    pub fn new\u003cS1: Into\u003cString\u003e, S2: Into\u003cString\u003e\u003e(language: S1, value: S2) -\u003e LanguageString {\n        LanguageString {\n            language: language.into(),\n            value: value.into(),\n        }\n    }\n\n    /// Returns the language code of the language string.\n    pub const fn language(\u0026self) -\u003e \u0026String {\n        \u0026self.language\n    }\n\n    /// Returns the value (test) of the language string.\n    pub const fn value(\u0026self) -\u003e \u0026String {\n        \u0026self.value\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_language_string() {\n        let s = LanguageString::new(\"en\", \"Hello\");\n        assert_eq!(s.language(), \"en\");\n        assert_eq!(s.value(), \"Hello\");\n    }\n\n    #[test]\n    fn test_language_string_serialize() {\n        let s = LanguageString::new(\"en\", \"Hello\");\n        let json = serde_json::to_string(\u0026s).unwrap();\n        assert_eq!(json, r#\"{\"language\":\"en\",\"value\":\"Hello\"}\"#);\n    }\n}\n","traces":[{"line":19,"address":[],"length":0,"stats":{"Line":58}},{"line":21,"address":[],"length":0,"stats":{"Line":58}},{"line":22,"address":[],"length":0,"stats":{"Line":58}},{"line":27,"address":[],"length":0,"stats":{"Line":59}},{"line":28,"address":[],"length":0,"stats":{"Line":59}},{"line":32,"address":[],"length":0,"stats":{"Line":72}},{"line":33,"address":[],"length":0,"stats":{"Line":72}}],"covered":7,"coverable":7},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","language_strings.rs"],"content":"use crate::LanguageString;\n\npub trait LanguageStrings {\n    fn insert(\u0026mut self, ls: LanguageString);\n    fn has_language\u003cS: Into\u003cString\u003e\u003e(\u0026self, language: S) -\u003e bool;\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","language_strings_patch.rs"],"content":"use crate::{\n    descriptions::Descriptions, labels::Labels, patch_entry::PatchEntry, EditMetadata, EntityId,\n    FromJson, HttpMisc, Patch, PatchApply, RestApi, RestApiError,\n};\nuse async_trait::async_trait;\nuse serde::Serialize;\nuse serde_json::{json, Value};\n\n#[derive(Debug, Clone, PartialEq, Serialize)]\nenum Mode {\n    Labels,\n    Descriptions,\n}\n\nimpl Mode {\n    const fn as_str(\u0026self) -\u003e \u0026str {\n        match self {\n            Mode::Labels =\u003e \"labels\",\n            Mode::Descriptions =\u003e \"descriptions\",\n        }\n    }\n}\n\n#[derive(Debug, Clone, PartialEq, Serialize)]\npub struct LanguageStringsPatch {\n    patch: Vec\u003cPatchEntry\u003e,\n    mode: Mode,\n}\n\nimpl LanguageStringsPatch {\n    pub const fn labels() -\u003e Self {\n        Self {\n            patch: vec![],\n            mode: Mode::Labels,\n        }\n    }\n\n    pub const fn descriptions() -\u003e Self {\n        Self {\n            patch: vec![],\n            mode: Mode::Descriptions,\n        }\n    }\n\n    /// Generates a patch from JSON, presumably from `json_patch`\n    pub fn labels_from_json(j: \u0026Value) -\u003e Result\u003cSelf, RestApiError\u003e {\n        Ok(Self {\n            patch: Self::from_json(j)?,\n            mode: Mode::Labels,\n        })\n    }\n\n    /// Generates a patch from JSON, presumably from `json_patch`\n    pub fn descriptions_from_json(j: \u0026Value) -\u003e Result\u003cSelf, RestApiError\u003e {\n        Ok(Self {\n            patch: Self::from_json(j)?,\n            mode: Mode::Descriptions,\n        })\n    }\n\n    fn from_json(j: \u0026Value) -\u003e Result\u003cVec\u003cPatchEntry\u003e, RestApiError\u003e {\n        j.as_array()\n            .ok_or_else(|| RestApiError::MissingOrInvalidField {\n                field: \"LanguageStringsPatch\".into(),\n                j: j.to_owned(),\n            })?\n            .iter()\n            .map(|x| serde_json::from_value(x.clone()).map_err(|e| e.into()))\n            .collect::\u003cResult\u003cVec\u003cPatchEntry\u003e, RestApiError\u003e\u003e()\n    }\n\n    // TODO add?\n\n    /// Adds a command to replace the value of a language string.\n    /// TODO Labels?\n    pub fn replace\u003cS1: Into\u003cString\u003e, S2: Into\u003cString\u003e\u003e(\u0026mut self, language: S1, value: S2) {\n        \u003cSelf as Patch\u003e::replace(self, format!(\"/{}\", language.into()), value.into().into());\n    }\n\n    /// Adds a command to remove the value for the language.\n    /// TODO Labels?\n    pub fn remove\u003cS: Into\u003cString\u003e\u003e(\u0026mut self, language: S) {\n        \u003cSelf as Patch\u003e::remove(self, format!(\"/{}\", language.into()));\n    }\n}\n\nimpl Patch for LanguageStringsPatch {\n    fn patch(\u0026self) -\u003e \u0026Vec\u003cPatchEntry\u003e {\n        \u0026self.patch\n    }\n\n    fn patch_mut(\u0026mut self) -\u003e \u0026mut Vec\u003cPatchEntry\u003e {\n        \u0026mut self.patch\n    }\n}\n\n#[async_trait]\nimpl PatchApply\u003cLabels\u003e for LanguageStringsPatch {\n    async fn apply_match(\n        \u0026self,\n        id: \u0026EntityId,\n        api: \u0026mut RestApi,\n        em: EditMetadata,\n    ) -\u003e Result\u003cLabels, RestApiError\u003e {\n        let j0 = json!({\"patch\": self.patch});\n        let request = self\n            .generate_json_request(id, reqwest::Method::PATCH, j0, api, \u0026em)\n            .await?;\n        let response = api.execute(request).await?;\n        let (j, header_info) = self.filter_response_error(response).await?;\n        Ok(Labels::from_json_header_info(\u0026j, header_info)?)\n    }\n}\n\n#[async_trait]\nimpl PatchApply\u003cDescriptions\u003e for LanguageStringsPatch {\n    async fn apply_match(\n        \u0026self,\n        id: \u0026EntityId,\n        api: \u0026mut RestApi,\n        em: EditMetadata,\n    ) -\u003e Result\u003cDescriptions, RestApiError\u003e {\n        let j0 = json!({\"patch\": self.patch});\n        let request = self\n            .generate_json_request(id, reqwest::Method::PATCH, j0, api, \u0026em)\n            .await?;\n        let response = api.execute(request).await?;\n        let (j, header_info) = self.filter_response_error(response).await?;\n        Ok(Descriptions::from_json_header_info(\u0026j, header_info)?)\n    }\n}\n\nimpl HttpMisc for LanguageStringsPatch {\n    fn get_my_rest_api_path(\u0026self, id: \u0026EntityId) -\u003e Result\u003cString, RestApiError\u003e {\n        Ok(format!(\n            \"/entities/{group}/{id}/{mode}\",\n            group = id.group()?,\n            mode = self.mode.as_str()\n        ))\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use serde_json::Value;\n    use wiremock::matchers::{bearer_token, body_partial_json, header, method, path};\n    use wiremock::{Mock, MockServer, ResponseTemplate};\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_language_strings_single_patch() {\n        let id = \"Q42\";\n        let page_title = \"Foo Bar\";\n        let v = std::fs::read_to_string(\"test_data/Q42.json\").unwrap();\n        let v: Value = serde_json::from_str(\u0026v).unwrap();\n        let mut new_label = v[\"labels\"].clone();\n        new_label[\"en\"] = json!(page_title);\n\n        let mock_path = format!(\"/w/rest.php/wikibase/v1/entities/items/{id}/labels\");\n        let mock_server = MockServer::start().await;\n        let token = \"FAKE_TOKEN\";\n        Mock::given(body_partial_json(\n            json!({\"patch\":[{\"op\": \"replace\",\"path\": \"/en\",\"value\": page_title}]}),\n        ))\n        .and(method(\"PATCH\"))\n        .and(path(\u0026mock_path))\n        .and(bearer_token(token))\n        .and(header(\"content-type\", \"application/json-patch+json\"))\n        .respond_with(\n            ResponseTemplate::new(200)\n                .insert_header(\"ETag\", \"12345\")\n                .set_body_json(new_label),\n        )\n        .mount(\u0026mock_server)\n        .await;\n        let mut api = RestApi::builder(\u0026(mock_server.uri() + \"/w/rest.php\"))\n            .unwrap()\n            .with_access_token(token)\n            .build();\n\n        // Apply patch and check API response\n        let id = EntityId::new(id).unwrap();\n        let mut patch = LanguageStringsPatch::labels();\n        patch.replace(\"en\", page_title);\n        let ls: Labels = patch.apply(\u0026id, \u0026mut api).await.unwrap();\n        assert_eq!(ls.get_lang(\"en\").unwrap(), page_title);\n    }\n\n    #[test]\n    fn test_remove() {\n        let mut patch = LanguageStringsPatch::labels();\n        patch.remove(\"en\");\n        assert_eq!(\n            patch.patch,\n            vec![PatchEntry::new(\"remove\", \"/en\", Value::Null)]\n        );\n    }\n\n    #[test]\n    fn test_patch() {\n        let mut patch = LanguageStringsPatch::labels();\n        patch.replace(\"en\", \"Foo Bar\");\n        assert_eq!(\n            patch.patch,\n            vec![PatchEntry::new(\"replace\", \"/en\", json!(\"Foo Bar\"))]\n        );\n    }\n\n    #[test]\n    fn test_descriptions() {\n        let mut patch = LanguageStringsPatch::descriptions();\n        patch.replace(\"en\", \"Foo Bar\");\n        assert_eq!(\n            patch.patch,\n            vec![PatchEntry::new(\"replace\", \"/en\", json!(\"Foo Bar\"))]\n        );\n    }\n\n    #[test]\n    fn test_mode_as_str() {\n        assert_eq!(Mode::Labels.as_str(), \"labels\");\n        assert_eq!(Mode::Descriptions.as_str(), \"descriptions\");\n    }\n\n    #[test]\n    fn test_patch_fn() {\n        let mut patch = LanguageStringsPatch::labels();\n        patch.replace(\"en\", \"Foo Bar\");\n        assert_eq!(\n            *\u003cLanguageStringsPatch as Patch\u003e::patch(\u0026patch),\n            vec![PatchEntry::new(\"replace\", \"/en\", json!(\"Foo Bar\"))]\n        );\n    }\n\n    #[test]\n    fn test_from_json() {\n        let j = json!([\n            {\"op\": \"replace\", \"path\": \"/en\", \"value\": \"Foo Bar\"},\n            {\"op\": \"remove\", \"path\": \"/de\"}\n        ]);\n        let patch = LanguageStringsPatch::from_json(\u0026j).unwrap();\n        assert_eq!(\n            patch,\n            vec![\n                PatchEntry::new(\"replace\", \"/en\", json!(\"Foo Bar\")),\n                PatchEntry::new(\"remove\", \"/de\", Value::Null)\n            ]\n        );\n    }\n}\n","traces":[{"line":16,"address":[],"length":0,"stats":{"Line":3}},{"line":17,"address":[],"length":0,"stats":{"Line":3}},{"line":18,"address":[],"length":0,"stats":{"Line":2}},{"line":19,"address":[],"length":0,"stats":{"Line":1}},{"line":31,"address":[],"length":0,"stats":{"Line":4}},{"line":33,"address":[],"length":0,"stats":{"Line":4}},{"line":38,"address":[],"length":0,"stats":{"Line":1}},{"line":40,"address":[],"length":0,"stats":{"Line":1}},{"line":46,"address":[],"length":0,"stats":{"Line":2}},{"line":47,"address":[],"length":0,"stats":{"Line":2}},{"line":48,"address":[],"length":0,"stats":{"Line":2}},{"line":49,"address":[],"length":0,"stats":{"Line":2}},{"line":54,"address":[],"length":0,"stats":{"Line":2}},{"line":55,"address":[],"length":0,"stats":{"Line":2}},{"line":56,"address":[],"length":0,"stats":{"Line":2}},{"line":57,"address":[],"length":0,"stats":{"Line":2}},{"line":61,"address":[],"length":0,"stats":{"Line":5}},{"line":62,"address":[],"length":0,"stats":{"Line":5}},{"line":63,"address":[],"length":0,"stats":{"Line":5}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":15}},{"line":76,"address":[],"length":0,"stats":{"Line":4}},{"line":77,"address":[],"length":0,"stats":{"Line":4}},{"line":82,"address":[],"length":0,"stats":{"Line":1}},{"line":83,"address":[],"length":0,"stats":{"Line":1}},{"line":88,"address":[],"length":0,"stats":{"Line":3}},{"line":89,"address":[],"length":0,"stats":{"Line":3}},{"line":92,"address":[],"length":0,"stats":{"Line":5}},{"line":93,"address":[],"length":0,"stats":{"Line":5}},{"line":105,"address":[],"length":0,"stats":{"Line":1}},{"line":106,"address":[],"length":0,"stats":{"Line":2}},{"line":107,"address":[],"length":0,"stats":{"Line":1}},{"line":108,"address":[],"length":0,"stats":{"Line":1}},{"line":109,"address":[],"length":0,"stats":{"Line":1}},{"line":110,"address":[],"length":0,"stats":{"Line":1}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":1}},{"line":135,"address":[],"length":0,"stats":{"Line":1}},{"line":136,"address":[],"length":0,"stats":{"Line":1}},{"line":137,"address":[],"length":0,"stats":{"Line":1}}],"covered":38,"coverable":48},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","lib.rs"],"content":"#![forbid(unsafe_code)]\n#![warn(\n    clippy::cognitive_complexity,\n    clippy::dbg_macro,\n    clippy::debug_assert_with_mut_call,\n    clippy::doc_link_with_quotes,\n    clippy::doc_markdown,\n    clippy::empty_line_after_outer_attr,\n    clippy::empty_structs_with_brackets,\n    clippy::float_cmp,\n    clippy::float_cmp_const,\n    clippy::float_equality_without_abs,\n    keyword_idents,\n    // clippy::missing_const_for_fn, // Wrong calls by clippy\n    missing_copy_implementations,\n    missing_debug_implementations,\n    // clippy::missing_errors_doc,\n    clippy::missing_panics_doc,\n    clippy::mod_module_files,\n    non_ascii_idents,\n    noop_method_call,\n    clippy::option_if_let_else,\n    clippy::print_stderr,\n    clippy::print_stdout,\n    clippy::semicolon_if_nothing_returned,\n    clippy::unseparated_literal_suffix,\n    clippy::shadow_unrelated,\n    clippy::similar_names,\n    clippy::suspicious_operation_groupings,\n    unused_crate_dependencies,\n    unused_extern_crates,\n    unused_import_braces,\n    clippy::unused_self,\n    clippy::use_debug,\n    clippy::used_underscore_binding,\n    clippy::useless_let_if_seq,\n    clippy::wildcard_dependencies,\n    clippy::wildcard_imports\n)]\n\n//! **Wikibase REST API** is a Rust library for interacting with the\n//! [Wikibase REST API](https://www.wikidata.org/wiki/Wikidata:REST_API)\n//! for [Wikibase](https://www.mediawiki.org/wiki/Wikibase) instances.\n//! It provides a set of types and methods for interacting with the API,\n//! and implements all the [API endpoints](https://doc.wikimedia.org/Wikibase/master/js/rest-api/).\n\npub mod aliases;\npub mod aliases_in_language;\npub mod aliases_patch;\npub mod bearer_token;\npub mod config;\npub mod data_type;\npub mod description;\npub mod descriptions;\npub mod descriptions_patch;\npub mod edit_metadata;\npub mod entity;\npub mod entity_container;\npub mod entity_id;\npub mod entity_patch;\npub mod error;\npub mod get_put_delete;\npub mod header_info;\npub mod item;\npub mod label;\npub mod labels;\npub mod labels_patch;\npub mod language_string;\npub mod language_strings;\npub mod language_strings_patch;\npub mod patch;\npub mod patch_entry;\npub mod prelude;\npub mod property;\npub mod property_value;\npub mod reference;\npub mod rest_api;\npub mod rest_api_builder;\npub mod revision_match;\npub mod search;\npub mod sitelink;\npub mod sitelinks;\npub mod sitelinks_patch;\npub mod statement;\npub mod statement_patch;\npub mod statement_rank;\npub mod statement_value;\npub mod statement_value_content;\npub mod statements;\npub mod statements_patch;\n\npub use config::Config;\npub use data_type::DataType;\npub use edit_metadata::EditMetadata;\npub use entity_id::EntityId;\npub use error::RestApiError;\npub use get_put_delete::*;\npub use header_info::HeaderInfo;\npub use item::Item;\npub use language_string::{Language, LanguageString};\npub use patch::*;\npub use property::Property;\npub use reference::Reference;\npub use rest_api::RestApi;\npub use revision_match::RevisionMatch;\npub use sitelink::Sitelink;\npub use sitelinks::Sitelinks;\npub use statement::Statement;\npub use statement_rank::StatementRank;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","patch.rs"],"content":"use crate::{\n    patch_entry::PatchEntry, EditMetadata, EntityId, HeaderInfo, HttpMisc, RestApi, RestApiError,\n};\nuse async_trait::async_trait;\nuse serde_json::{json, Value};\n\n#[async_trait]\npub trait Patch: Sized {\n    /// Returns the patch entries\n    fn patch(\u0026self) -\u003e \u0026Vec\u003cPatchEntry\u003e;\n\n    /// Returns the mutable patch entries\n    fn patch_mut(\u0026mut self) -\u003e \u0026mut Vec\u003cPatchEntry\u003e;\n\n    /// `path` is a JSON patch path, eg \"/enwiki/title\"\n    fn add\u003cS: Into\u003cString\u003e\u003e(\u0026mut self, path: S, value: Value) {\n        self.patch_mut()\n            .push(PatchEntry::new(\"add\", path.into(), value));\n    }\n\n    /// `path` is a JSON patch path, eg \"/enwiki/title\"\n    fn replace\u003cS: Into\u003cString\u003e\u003e(\u0026mut self, path: S, value: Value) {\n        self.patch_mut()\n            .push(PatchEntry::new(\"replace\", path.into(), value));\n    }\n\n    /// `path` is a JSON patch path, eg \"/enwiki/title\"\n    fn remove\u003cS: Into\u003cString\u003e\u003e(\u0026mut self, path: S) {\n        self.patch_mut()\n            .push(PatchEntry::new(\"remove\", path.into(), Value::Null));\n    }\n\n    /// checks if the patch list is empty\n    fn is_empty(\u0026self) -\u003e bool {\n        self.patch().is_empty()\n    }\n}\n\n#[async_trait]\npub trait PatchApply\u003cT: FromJson\u003e: HttpMisc + Patch {\n    /// Applies the entire patch against the API\n    async fn apply(\u0026self, id: \u0026EntityId, api: \u0026mut RestApi) -\u003e Result\u003cT, RestApiError\u003e {\n        self.apply_match(id, api, EditMetadata::default()).await\n    }\n\n    /// Applies the entire patch against the API, conditional on metadata\n    async fn apply_match(\n        \u0026self,\n        id: \u0026EntityId,\n        api: \u0026mut RestApi,\n        em: EditMetadata,\n    ) -\u003e Result\u003cT, RestApiError\u003e {\n        let j0 = json!({\"patch\": self.patch()});\n        let request = self\n            .generate_json_request(id, reqwest::Method::PATCH, j0, api, \u0026em)\n            .await?;\n        let response = api.execute(request).await?;\n        let (j1, header_info) = self.filter_response_error(response).await?;\n        Ok(T::from_json_header_info(\u0026j1, header_info)?)\n    }\n}\n\npub trait FromJson: Sized {\n    fn from_json_header_info(j: \u0026Value, header_info: HeaderInfo) -\u003e Result\u003cSelf, RestApiError\u003e;\n    fn header_info(\u0026self) -\u003e \u0026HeaderInfo;\n\n    fn from_json(j: \u0026Value) -\u003e Result\u003cSelf, RestApiError\u003e {\n        Self::from_json_header_info(j, HeaderInfo::default())\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use crate::aliases_patch::AliasesPatch;\n\n    use super::*;\n\n    #[test]\n    fn test_add() {\n        let mut p = AliasesPatch::default();\n        p.add(\"en\", json!(\"foo\"));\n        assert_eq!(\n            p.patch(),\n            \u0026vec![PatchEntry::new(\"add\", \"en\", json!(\"foo\")),]\n        );\n    }\n\n    #[test]\n    fn test_replace() {\n        let mut p = AliasesPatch::default();\n        p.replace(\"en\", 0, \"foo\");\n        assert_eq!(\n            p.patch(),\n            \u0026vec![PatchEntry::new(\"replace\", \"/en/0\", json!(\"foo\")),]\n        );\n    }\n\n    #[test]\n    fn test_remove() {\n        let mut p = AliasesPatch::default();\n        p.remove(\"en\", 1);\n        assert_eq!(\n            p.patch(),\n            \u0026vec![PatchEntry::new(\"remove\", \"/en/1\", Value::Null),]\n        );\n    }\n\n    #[test]\n    fn test_is_empty() {\n        let p = AliasesPatch::default();\n        assert!(p.is_empty());\n    }\n}\n","traces":[{"line":16,"address":[],"length":0,"stats":{"Line":3}},{"line":17,"address":[],"length":0,"stats":{"Line":3}},{"line":18,"address":[],"length":0,"stats":{"Line":3}},{"line":22,"address":[],"length":0,"stats":{"Line":15}},{"line":23,"address":[],"length":0,"stats":{"Line":15}},{"line":24,"address":[],"length":0,"stats":{"Line":15}},{"line":28,"address":[],"length":0,"stats":{"Line":5}},{"line":29,"address":[],"length":0,"stats":{"Line":5}},{"line":30,"address":[],"length":0,"stats":{"Line":5}},{"line":34,"address":[],"length":0,"stats":{"Line":1}},{"line":35,"address":[],"length":0,"stats":{"Line":1}},{"line":42,"address":[],"length":0,"stats":{"Line":3}},{"line":43,"address":[],"length":0,"stats":{"Line":3}},{"line":53,"address":[],"length":0,"stats":{"Line":1}},{"line":54,"address":[],"length":0,"stats":{"Line":2}},{"line":55,"address":[],"length":0,"stats":{"Line":1}},{"line":56,"address":[],"length":0,"stats":{"Line":1}},{"line":57,"address":[],"length":0,"stats":{"Line":1}},{"line":58,"address":[],"length":0,"stats":{"Line":1}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":3754}},{"line":68,"address":[],"length":0,"stats":{"Line":3754}}],"covered":21,"coverable":22},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","patch_entry.rs"],"content":"use serde::{Deserialize, Serialize};\nuse serde_json::Value;\n\n#[derive(Debug, Clone, PartialEq, Serialize, Deserialize, Default)]\npub struct PatchEntry {\n    op: String,\n    path: String,\n    #[serde(default)]\n    #[serde(skip_serializing_if = \"Value::is_null\")]\n    value: Value,\n}\n\nimpl PatchEntry {\n    /// Constructs a new `PatchEntry` object from an operation, a path, and a value.\n    pub fn new\u003cS1: Into\u003cString\u003e, S2: Into\u003cString\u003e\u003e(op: S1, path: S2, value: Value) -\u003e Self {\n        Self {\n            op: op.into(),\n            path: path.into(),\n            value,\n        }\n    }\n\n    /// Returns the operation.\n    pub fn op(\u0026self) -\u003e \u0026str {\n        \u0026self.op\n    }\n\n    /// Returns the path.\n    pub fn path(\u0026self) -\u003e \u0026str {\n        \u0026self.path\n    }\n\n    /// Returns the value.\n    pub const fn value(\u0026self) -\u003e \u0026Value {\n        \u0026self.value\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use serde_json::json;\n\n    #[test]\n    fn test_patch_entry() {\n        let pe = PatchEntry::new(\"replace\", \"/enwiki/title\", json!(\"Foo Bar\"));\n        assert_eq!(pe.op, \"replace\");\n        assert_eq!(pe.path, \"/enwiki/title\");\n        assert_eq!(pe.value, json!(\"Foo Bar\"));\n    }\n\n    #[test]\n    fn test_patch_entry_default() {\n        let pe = PatchEntry::default();\n        assert_eq!(pe.op, \"\");\n        assert_eq!(pe.path, \"\");\n        assert_eq!(pe.value, Value::Null);\n    }\n\n    #[test]\n    fn test_patch_entry_methods() {\n        let pe = PatchEntry::new(\"replace\", \"/enwiki/title\", json!(\"Foo Bar\"));\n        assert_eq!(pe.op(), \"replace\");\n        assert_eq!(pe.path(), \"/enwiki/title\");\n        assert_eq!(pe.value(), \u0026json!(\"Foo Bar\"));\n    }\n}\n","traces":[{"line":15,"address":[],"length":0,"stats":{"Line":50}},{"line":17,"address":[],"length":0,"stats":{"Line":50}},{"line":18,"address":[],"length":0,"stats":{"Line":50}},{"line":24,"address":[],"length":0,"stats":{"Line":3}},{"line":25,"address":[],"length":0,"stats":{"Line":3}},{"line":29,"address":[],"length":0,"stats":{"Line":1}},{"line":30,"address":[],"length":0,"stats":{"Line":1}},{"line":34,"address":[],"length":0,"stats":{"Line":1}},{"line":35,"address":[],"length":0,"stats":{"Line":1}}],"covered":9,"coverable":9},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","prelude.rs"],"content":"// Traits\npub use crate::entity::Entity;\npub use crate::get_put_delete::*;\npub use crate::language_strings::LanguageStrings;\n\n// Structs and enums\npub use crate::aliases_in_language::AliasesInLanguage;\npub use crate::description::Description;\npub use crate::edit_metadata::EditMetadata;\npub use crate::entity_container::*;\npub use crate::entity_id::EntityId;\npub use crate::error::RestApiError;\npub use crate::item::Item;\npub use crate::label::Label;\npub use crate::language_string::{Language, LanguageString};\npub use crate::property::Property;\npub use crate::property_value::PropertyType;\npub use crate::rest_api::RestApi;\npub use crate::rest_api_builder::RestApiBuilder;\npub use crate::search::{Search, SearchLimit, SearchResult};\npub use crate::sitelink::Sitelink;\npub use crate::sitelinks::Sitelinks;\npub use crate::statement::Statement;\npub use crate::statement_value::StatementValue;\npub use crate::statement_value_content::{\n    StatementValueContent, TimePrecision, GREGORIAN_CALENDAR, JULIAN_CALENDAR,\n};\npub use crate::statements::Statements;\npub use crate::Patch;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","property.rs"],"content":"use crate::{\n    aliases::Aliases,\n    aliases_in_language::AliasesInLanguage,\n    descriptions::Descriptions,\n    entity::{Entity, EntityType},\n    entity_patch::EntityPatch,\n    labels::Labels,\n    statements::Statements,\n    EntityId, FromJson, HeaderInfo, HttpMisc, RestApi, RestApiError,\n};\nuse async_trait::async_trait;\nuse derivative::Derivative;\nuse serde::ser::{Serialize, SerializeStruct, Serializer};\nuse serde_json::Value;\n\n#[derive(Derivative, Debug, Clone, Default)]\n#[derivative(PartialEq)]\npub struct Property {\n    id: EntityId,\n    labels: Labels,\n    descriptions: Descriptions,\n    aliases: Aliases,\n    statements: Statements,\n    #[derivative(PartialEq = \"ignore\")]\n    header_info: HeaderInfo,\n}\n\nimpl HttpMisc for Property {\n    fn get_my_rest_api_path(\u0026self, id: \u0026EntityId) -\u003e Result\u003cString, RestApiError\u003e {\n        Ok(format!(\"/entities/{}/{id}\", id.group()?))\n    }\n}\n\n#[async_trait]\nimpl Entity for Property {\n    fn id(\u0026self) -\u003e EntityId {\n        self.id.to_owned()\n    }\n\n    fn from_json_header_info(j: Value, header_info: HeaderInfo) -\u003e Result\u003cSelf, RestApiError\u003e {\n        let id = j[\"id\"]\n            .as_str()\n            .ok_or(RestApiError::MissingOrInvalidField {\n                field: \"id\".to_string(),\n                j: j.clone(),\n            })?;\n        Ok(Self {\n            id: EntityId::property(id),\n            labels: Labels::from_json(\u0026j[\"labels\"])?,\n            descriptions: Descriptions::from_json(\u0026j[\"descriptions\"])?,\n            aliases: Aliases::from_json(\u0026j[\"aliases\"])?,\n            statements: Statements::from_json(\u0026j[\"statements\"])?,\n            header_info,\n        })\n    }\n\n    async fn post(\u0026self, api: \u0026RestApi) -\u003e Result\u003cSelf, RestApiError\u003e {\n        self.post_with_type(EntityType::Property, api).await\n    }\n}\n\nimpl Serialize for Property {\n    fn serialize\u003cS\u003e(\u0026self, serializer: S) -\u003e Result\u003cS::Ok, S::Error\u003e\n    where\n        S: Serializer,\n    {\n        // #lizard forgives the complexity\n        let mut fields = 5;\n        if self.id.is_some() {\n            fields += 1;\n        }\n        if self.labels.is_empty() {\n            fields -= 1;\n        }\n        if self.descriptions.is_empty() {\n            fields -= 1;\n        }\n        if self.aliases.is_empty() {\n            fields -= 1;\n        }\n        if self.statements.is_empty() {\n            fields -= 1;\n        }\n        let mut s = serializer.serialize_struct(\"Property\", fields)?;\n        if self.id.is_some() {\n            let id: String = self.id.to_owned().into();\n            s.serialize_field(\"id\", \u0026id)?;\n        }\n        if !self.labels.is_empty() {\n            s.serialize_field(\"labels\", \u0026self.labels)?;\n        }\n        if !self.descriptions.is_empty() {\n            s.serialize_field(\"descriptions\", \u0026self.descriptions)?;\n        }\n        if !self.aliases.is_empty() {\n            s.serialize_field(\"aliases\", \u0026self.aliases)?;\n        }\n        if !self.statements.is_empty() {\n            s.serialize_field(\"statements\", \u0026self.statements)?;\n        }\n        s.end()\n    }\n}\n\nimpl Property {\n    /// Returns the statements of the property\n    pub const fn statements(\u0026self) -\u003e \u0026Statements {\n        \u0026self.statements\n    }\n\n    /// Returns the statements of the property, mutable\n    pub const fn statements_mut(\u0026mut self) -\u003e \u0026mut Statements {\n        \u0026mut self.statements\n    }\n\n    /// Returns the labels of the property\n    pub const fn labels(\u0026self) -\u003e \u0026Labels {\n        \u0026self.labels\n    }\n\n    /// Returns the labels of the property, mutable\n    pub fn labels_mut(\u0026mut self) -\u003e \u0026mut Labels {\n        \u0026mut self.labels\n    }\n\n    /// Returns the descriptions of the property\n    pub const fn descriptions(\u0026self) -\u003e \u0026Descriptions {\n        \u0026self.descriptions\n    }\n\n    /// Returns the descriptions of the property, mutable\n    pub const fn descriptions_mut(\u0026mut self) -\u003e \u0026mut Descriptions {\n        \u0026mut self.descriptions\n    }\n\n    /// Returns the aliases of the property\n    pub const fn aliases(\u0026self) -\u003e \u0026Aliases {\n        \u0026self.aliases\n    }\n\n    /// Returns the aliases of the property, mutable\n    pub fn aliases_mut(\u0026mut self) -\u003e \u0026mut Aliases {\n        \u0026mut self.aliases\n    }\n\n    /// Returns the aliases of the property for a specific language, as an `Aliases` object\n    pub fn as_aliases\u003cS: Into\u003cString\u003e\u003e(\u0026self, lang: S) -\u003e AliasesInLanguage {\n        let lang: String = lang.into();\n        let v: Vec\u003cString\u003e = self\n            .aliases\n            .get_lang(\u0026lang)\n            .iter()\n            .map(|x| x.to_string())\n            .collect();\n        AliasesInLanguage::new(lang, v)\n    }\n\n    /// Returns the header info of the property\n    pub const fn header_info(\u0026self) -\u003e \u0026HeaderInfo {\n        \u0026self.header_info\n    }\n\n    /// Generates a patch to transform `other` into `self`\n    pub fn patch(\u0026self, _other: \u0026Self) -\u003e Result\u003cEntityPatch, RestApiError\u003e {\n        todo!()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::language_strings::LanguageStrings;\n    use crate::{LanguageString, RestApi, Statement};\n    use serde_json::json;\n    use wiremock::matchers::{body_partial_json, method, path};\n    use wiremock::{Mock, MockServer, ResponseTemplate};\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_property_get_and_json_serialize() {\n        let p214 = std::fs::read_to_string(\"test_data/P214.json\").unwrap();\n        let v214: Value = serde_json::from_str(\u0026p214).unwrap();\n\n        let mock_path = \"/w/rest.php/wikibase/v1/entities/properties/P214\";\n        let mock_server = MockServer::start().await;\n        Mock::given(method(\"GET\"))\n            .and(path(mock_path))\n            .respond_with(ResponseTemplate::new(200).set_body_json(\u0026v214))\n            .mount(\u0026mock_server)\n            .await;\n        let api = RestApi::builder(\u0026(mock_server.uri() + \"/w/rest.php\"))\n            .unwrap()\n            .build();\n\n        let property = Property::get(EntityId::property(\"P214\"), \u0026api)\n            .await\n            .unwrap();\n        let j = serde_json::to_string(\u0026property).unwrap(); // Convert property to JSON text\n        let v: Value = serde_json::from_str(\u0026j).unwrap(); // Convert to JSON value\n        let property_from_json = Property::from_json(v).unwrap(); // Convert back to property\n        assert_eq!(property, property_from_json); // Check if the reconstituted property is identical to the original\n    }\n\n    #[test]\n    fn test_id() {\n        let id = EntityId::property(\"P214\");\n        let property = Property {\n            id: id.to_owned(),\n            ..Default::default()\n        };\n        assert_eq!(property.id(), id);\n    }\n\n    #[test]\n    fn test_statements() {\n        let mut property = Property::default();\n        assert_eq!(property.statements().len(), 0);\n        property\n            .statements_mut()\n            .insert(Statement::new_string(\"P31\", \"Q42\"));\n        assert_eq!(property.statements().len(), 1);\n    }\n\n    #[test]\n    fn test_labels() {\n        let mut property = Property::default();\n        assert_eq!(property.labels().len(), 0);\n        property\n            .labels_mut()\n            .insert(LanguageString::new(\"en\", \"label\"));\n        assert_eq!(property.labels().len(), 1);\n    }\n\n    #[test]\n    fn test_descriptions() {\n        let mut property = Property::default();\n        assert_eq!(property.descriptions().len(), 0);\n        property\n            .descriptions_mut()\n            .insert(LanguageString::new(\"en\", \"description\"));\n        assert_eq!(property.descriptions().len(), 1);\n    }\n\n    #[test]\n    fn test_aliases() {\n        let mut property = Property::default();\n        assert_eq!(property.aliases().len(), 0);\n        property\n            .aliases_mut()\n            .insert(LanguageString::new(\"en\", \"alias\"));\n        assert_eq!(property.aliases().len(), 1);\n    }\n\n    #[test]\n    fn test_as_aliases() {\n        let mut property = Property::default();\n        property\n            .aliases_mut()\n            .insert(LanguageString::new(\"en\", \"alias\"));\n        let aliases = property.as_aliases(\"en\");\n        assert_eq!(aliases.len(), 1);\n    }\n\n    #[test]\n    fn test_header_info() {\n        let header_info = HeaderInfo::default();\n        let property = Property {\n            header_info: header_info.to_owned(),\n            ..Default::default()\n        };\n        assert_eq!(property.header_info(), \u0026header_info);\n    }\n\n    #[test]\n    fn test_serialize() {\n        let mut property = Property {\n            id: EntityId::property(\"P214\"),\n            ..Default::default()\n        };\n        property\n            .labels_mut()\n            .insert(LanguageString::new(\"en\", \"label\"));\n        property\n            .descriptions_mut()\n            .insert(LanguageString::new(\"en\", \"description\"));\n        property\n            .aliases_mut()\n            .insert(LanguageString::new(\"en\", \"alias\"));\n        let j = serde_json::to_string(\u0026property).unwrap();\n        let v: Value = serde_json::from_str(\u0026j).unwrap();\n        assert_eq!(v[\"id\"], \"P214\");\n        assert_eq!(v[\"labels\"][\"en\"], \"label\");\n        assert_eq!(v[\"descriptions\"][\"en\"], \"description\");\n        assert_eq!(v[\"aliases\"][\"en\"][0], \"alias\");\n    }\n\n    #[test]\n    fn test_from_json() {\n        let v = json!({\n            \"id\": \"P214\",\n            \"labels\": {\"en\": \"label\"},\n            \"descriptions\": {\"en\": \"description\"},\n            \"aliases\": {\"en\": [\"alias\"]},\n            \"statements\": {},\n        });\n        let property = Property::from_json(v).unwrap();\n        assert_eq!(property.id(), EntityId::property(\"P214\"));\n        assert_eq!(property.labels().get_lang(\"en\").unwrap(), \"label\");\n        assert_eq!(\n            property.descriptions().get_lang(\"en\").unwrap(),\n            \"description\"\n        );\n        assert_eq!(property.aliases().get_lang(\"en\"), \u0026[\"alias\"]);\n    }\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_item_post() {\n        let j214 = std::fs::read_to_string(\"test_data/P214.json\").unwrap();\n        let v214: Value = serde_json::from_str(\u0026j214).unwrap();\n        let mut property = Property::from_json(v214).unwrap();\n        let v = property.to_owned();\n\n        let mock_server = MockServer::start().await;\n        Mock::given(method(\"POST\"))\n            .and(path(\"/w/rest.php/wikibase/v1/entities/properties\"))\n            .and(body_partial_json(\n                json!({\"property\": {\"labels\": {\"en\": property.labels().get_lang(\"en\")}}}),\n            ))\n            .respond_with(ResponseTemplate::new(200).set_body_json(\u0026v))\n            .mount(\u0026mock_server)\n            .await;\n        let api = RestApi::builder(\u0026(mock_server.uri() + \"/w/rest.php\"))\n            .unwrap()\n            .build();\n\n        // Check that an error is returned when trying to post an item that already has an ID\n        let r0 = property.post(\u0026api).await;\n        assert_eq!(r0.err().unwrap().to_string(), \"ID already set\");\n\n        // Clear the ID and try again\n        property.id = EntityId::None;\n        let r1 = property.post(\u0026api).await.unwrap();\n        assert_eq!(r1.id(), v.id());\n    }\n}\n","traces":[{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":7}},{"line":37,"address":[],"length":0,"stats":{"Line":7}},{"line":40,"address":[],"length":0,"stats":{"Line":6}},{"line":41,"address":[],"length":0,"stats":{"Line":12}},{"line":43,"address":[],"length":0,"stats":{"Line":6}},{"line":44,"address":[],"length":0,"stats":{"Line":6}},{"line":45,"address":[],"length":0,"stats":{"Line":6}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":6}},{"line":51,"address":[],"length":0,"stats":{"Line":6}},{"line":52,"address":[],"length":0,"stats":{"Line":6}},{"line":53,"address":[],"length":0,"stats":{"Line":6}},{"line":57,"address":[],"length":0,"stats":{"Line":2}},{"line":58,"address":[],"length":0,"stats":{"Line":2}},{"line":63,"address":[],"length":0,"stats":{"Line":4}},{"line":68,"address":[],"length":0,"stats":{"Line":4}},{"line":69,"address":[],"length":0,"stats":{"Line":7}},{"line":70,"address":[],"length":0,"stats":{"Line":3}},{"line":72,"address":[],"length":0,"stats":{"Line":4}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":4}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":4}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":5}},{"line":82,"address":[],"length":0,"stats":{"Line":1}},{"line":84,"address":[],"length":0,"stats":{"Line":8}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":3}},{"line":87,"address":[],"length":0,"stats":{"Line":3}},{"line":89,"address":[],"length":0,"stats":{"Line":4}},{"line":90,"address":[],"length":0,"stats":{"Line":4}},{"line":92,"address":[],"length":0,"stats":{"Line":4}},{"line":93,"address":[],"length":0,"stats":{"Line":4}},{"line":95,"address":[],"length":0,"stats":{"Line":4}},{"line":96,"address":[],"length":0,"stats":{"Line":4}},{"line":98,"address":[],"length":0,"stats":{"Line":4}},{"line":99,"address":[],"length":0,"stats":{"Line":3}},{"line":101,"address":[],"length":0,"stats":{"Line":4}},{"line":107,"address":[],"length":0,"stats":{"Line":2}},{"line":108,"address":[],"length":0,"stats":{"Line":2}},{"line":112,"address":[],"length":0,"stats":{"Line":1}},{"line":113,"address":[],"length":0,"stats":{"Line":1}},{"line":117,"address":[],"length":0,"stats":{"Line":4}},{"line":118,"address":[],"length":0,"stats":{"Line":4}},{"line":122,"address":[],"length":0,"stats":{"Line":2}},{"line":123,"address":[],"length":0,"stats":{"Line":2}},{"line":127,"address":[],"length":0,"stats":{"Line":3}},{"line":128,"address":[],"length":0,"stats":{"Line":3}},{"line":132,"address":[],"length":0,"stats":{"Line":2}},{"line":133,"address":[],"length":0,"stats":{"Line":2}},{"line":137,"address":[],"length":0,"stats":{"Line":3}},{"line":138,"address":[],"length":0,"stats":{"Line":3}},{"line":142,"address":[],"length":0,"stats":{"Line":3}},{"line":143,"address":[],"length":0,"stats":{"Line":3}},{"line":147,"address":[],"length":0,"stats":{"Line":1}},{"line":148,"address":[],"length":0,"stats":{"Line":1}},{"line":149,"address":[],"length":0,"stats":{"Line":1}},{"line":150,"address":[],"length":0,"stats":{"Line":1}},{"line":151,"address":[],"length":0,"stats":{"Line":1}},{"line":153,"address":[],"length":0,"stats":{"Line":3}},{"line":155,"address":[],"length":0,"stats":{"Line":1}},{"line":159,"address":[],"length":0,"stats":{"Line":1}},{"line":160,"address":[],"length":0,"stats":{"Line":1}},{"line":164,"address":[],"length":0,"stats":{"Line":0}}],"covered":59,"coverable":67},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","property_value.rs"],"content":"use serde::ser::{Serialize, SerializeStruct, Serializer};\nuse serde_json::Value;\n\nuse crate::{statement_value::StatementValue, DataType, RestApiError};\n\n#[derive(Debug, Clone, PartialEq, Default)]\npub struct PropertyType {\n    id: String,\n    datatype: Option\u003cDataType\u003e,\n}\n\nimpl PropertyType {\n    /// Creates a new `PropertyType` object from an ID and a `DataType`.\n    pub fn new\u003cS: Into\u003cString\u003e\u003e(id: S, datatype: Option\u003cDataType\u003e) -\u003e Self {\n        Self {\n            id: id.into(),\n            datatype,\n        }\n    }\n\n    /// Creates a new `PropertyType` object from a JSON object.\n    /// # Errors\n    /// Returns an error if the JSON object does not contain the required fields.\n    pub fn from_json(j: \u0026Value) -\u003e Result\u003cSelf, RestApiError\u003e {\n        let datatype_text =\n            j[\"data_type\"]\n                .as_str()\n                .ok_or_else(|| RestApiError::MissingOrInvalidField {\n                    field: \"data_type\".into(),\n                    j: j.to_owned(),\n                })?;\n        let datatype = DataType::new(datatype_text).ok();\n        Ok(Self {\n            id: j[\"id\"]\n                .as_str()\n                .ok_or_else(|| RestApiError::MissingOrInvalidField {\n                    field: \"id\".into(),\n                    j: j.to_owned(),\n                })?\n                .to_string(),\n            datatype,\n        })\n    }\n\n    /// Creates a new `PropertyType` object from an ID, with a default `DataType::WikibaseItem`.\n    pub fn property\u003cS: Into\u003cString\u003e\u003e(id: S) -\u003e Self {\n        Self {\n            id: id.into(),\n            datatype: None,\n        }\n    }\n\n    /// Returns the ID of the `PropertyType`.\n    pub fn id(\u0026self) -\u003e \u0026str {\n        \u0026self.id\n    }\n\n    /// Returns the `DataType` of the `PropertyType`.\n    pub const fn datatype(\u0026self) -\u003e \u0026Option\u003cDataType\u003e {\n        \u0026self.datatype\n    }\n}\n\nimpl Serialize for PropertyType {\n    fn serialize\u003cS\u003e(\u0026self, serializer: S) -\u003e Result\u003cS::Ok, S::Error\u003e\n    where\n        S: Serializer,\n    {\n        let num = 1 + if self.datatype.is_some() { 1 } else { 0 };\n        let mut s = serializer.serialize_struct(\"PropertyType\", num)?;\n        s.serialize_field(\"id\", \u0026self.id)?;\n        if let Some(datatype) = \u0026self.datatype {\n            s.serialize_field(\"data_type\", datatype.as_str())?;\n        }\n        s.end()\n    }\n}\n\n/// Implement the From trait for \u0026str to `PropertyType`, for convenience assignments.\nimpl From\u003c\u0026str\u003e for PropertyType {\n    fn from(s: \u0026str) -\u003e Self {\n        Self::property(s)\n    }\n}\n\n#[derive(Debug, Clone, PartialEq)]\npub struct PropertyValue {\n    property: PropertyType,\n    value: StatementValue,\n}\n\nimpl PropertyValue {\n    pub const fn new(property: PropertyType, value: StatementValue) -\u003e Self {\n        Self { property, value }\n    }\n\n    pub const fn property(\u0026self) -\u003e \u0026PropertyType {\n        \u0026self.property\n    }\n\n    pub const fn value(\u0026self) -\u003e \u0026StatementValue {\n        \u0026self.value\n    }\n}\n\nimpl Serialize for PropertyValue {\n    fn serialize\u003cS\u003e(\u0026self, serializer: S) -\u003e Result\u003cS::Ok, S::Error\u003e\n    where\n        S: Serializer,\n    {\n        let mut s = serializer.serialize_struct(\"PropertyValue\", 2)?;\n        s.serialize_field(\"property\", \u0026self.property)?;\n        s.serialize_field(\"value\", \u0026self.value)?;\n        s.end()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use crate::statement_value_content::StatementValueContent;\n\n    use super::*;\n\n    #[test]\n    fn test_property_type() {\n        let j = serde_json::json!({\n            \"id\": \"P123\",\n            \"data_type\": \"string\",\n        });\n        let p = PropertyType::from_json(\u0026j).unwrap();\n        assert_eq!(p.id(), \"P123\");\n        assert_eq!(p.datatype(), \u0026Some(DataType::String));\n    }\n\n    #[test]\n    fn test_property_value() {\n        let j = serde_json::json!({\n            \"id\": \"P123\",\n            \"data_type\": \"string\",\n        });\n        let p = PropertyType::from_json(\u0026j).unwrap();\n        let v = StatementValueContent::String(\"Hello\".to_string());\n        let pv = PropertyValue::new(p, v.into());\n        assert_eq!(pv.property().id(), \"P123\");\n        assert_eq!(pv.property().datatype(), \u0026Some(DataType::String));\n        assert_eq!(\n            pv.value(),\n            \u0026StatementValue::Value(StatementValueContent::String(\"Hello\".to_string()))\n        );\n    }\n\n    #[test]\n    fn test_property_type_serialize() {\n        let j = serde_json::json!({\n            \"id\": \"P123\",\n            \"data_type\": \"string\",\n        });\n        let p = PropertyType::from_json(\u0026j).unwrap();\n        let json = serde_json::to_string(\u0026p).unwrap();\n        assert_eq!(json, r#\"{\"id\":\"P123\",\"data_type\":\"string\"}\"#);\n    }\n\n    #[test]\n    fn test_property_type_serialize_faulty_data_type() {\n        let j = serde_json::json!({\n            \"id\": \"P123\",\n            \"data_type\": 567,\n        });\n        let pt = PropertyType::from_json(\u0026j);\n        assert!(pt.is_err());\n    }\n\n    #[test]\n    fn test_property_type_serialize_faulty_id() {\n        let j = serde_json::json!({\n            \"id\": 123,\n            \"data_type\": \"string\",\n        });\n        let pt = PropertyType::from_json(\u0026j);\n        assert!(pt.is_err());\n    }\n}\n","traces":[{"line":14,"address":[],"length":0,"stats":{"Line":7}},{"line":16,"address":[],"length":0,"stats":{"Line":7}},{"line":24,"address":[],"length":0,"stats":{"Line":9814}},{"line":25,"address":[],"length":0,"stats":{"Line":9813}},{"line":26,"address":[],"length":0,"stats":{"Line":9814}},{"line":28,"address":[],"length":0,"stats":{"Line":9815}},{"line":29,"address":[],"length":0,"stats":{"Line":1}},{"line":30,"address":[],"length":0,"stats":{"Line":1}},{"line":36,"address":[],"length":0,"stats":{"Line":1}},{"line":37,"address":[],"length":0,"stats":{"Line":1}},{"line":38,"address":[],"length":0,"stats":{"Line":1}},{"line":40,"address":[],"length":0,"stats":{"Line":9812}},{"line":41,"address":[],"length":0,"stats":{"Line":9812}},{"line":46,"address":[],"length":0,"stats":{"Line":20}},{"line":48,"address":[],"length":0,"stats":{"Line":20}},{"line":54,"address":[],"length":0,"stats":{"Line":20}},{"line":55,"address":[],"length":0,"stats":{"Line":20}},{"line":59,"address":[],"length":0,"stats":{"Line":2}},{"line":60,"address":[],"length":0,"stats":{"Line":2}},{"line":65,"address":[],"length":0,"stats":{"Line":3113}},{"line":69,"address":[],"length":0,"stats":{"Line":9339}},{"line":70,"address":[],"length":0,"stats":{"Line":6226}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":6220}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":3113}},{"line":81,"address":[],"length":0,"stats":{"Line":13}},{"line":82,"address":[],"length":0,"stats":{"Line":13}},{"line":93,"address":[],"length":0,"stats":{"Line":6117}},{"line":97,"address":[],"length":0,"stats":{"Line":2}},{"line":98,"address":[],"length":0,"stats":{"Line":2}},{"line":101,"address":[],"length":0,"stats":{"Line":2}},{"line":102,"address":[],"length":0,"stats":{"Line":2}},{"line":107,"address":[],"length":0,"stats":{"Line":2010}},{"line":111,"address":[],"length":0,"stats":{"Line":4020}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":2010}},{"line":114,"address":[],"length":0,"stats":{"Line":2010}}],"covered":35,"coverable":38},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","reference.rs"],"content":"use crate::{\n    property_value::{PropertyType, PropertyValue},\n    statement_value::StatementValue,\n    RestApiError,\n};\nuse serde::ser::{Serialize, SerializeStruct, Serializer};\nuse serde_json::Value;\n\n#[derive(Debug, Clone, PartialEq, Default)]\npub struct Reference {\n    parts: Vec\u003cPropertyValue\u003e,\n    hash: String,\n}\n\nimpl Reference {\n    /// Creates a new Reference object from a JSON structure\n    /// # Errors\n    /// Returns an error if the JSON structure is missing a required field or if a field is invalid\n    pub fn from_json(j: \u0026Value) -\u003e Result\u003cSelf, RestApiError\u003e {\n        // #lizard forgives the complexity\n        let hash = j[\"hash\"]\n            .as_str()\n            .ok_or_else(|| RestApiError::MissingOrInvalidField {\n                field: \"hash\".into(),\n                j: j.to_owned(),\n            })?\n            .to_string();\n        let parts = j[\"parts\"]\n            .as_array()\n            .ok_or_else(|| RestApiError::MissingOrInvalidField {\n                field: \"parts\".into(),\n                j: j.to_owned(),\n            })?\n            .iter() // TODO was par_iter but miri doesn't like rayon...\n            .map(|part| {\n                let property = PropertyType::from_json(\u0026part[\"property\"])?;\n                let value = StatementValue::from_json(\u0026part[\"value\"])?;\n                Ok(PropertyValue::new(property, value))\n            })\n            .collect::\u003cResult\u003cVec\u003cPropertyValue\u003e, RestApiError\u003e\u003e()?;\n        Ok(Reference { parts, hash })\n    }\n\n    /// Returns the parts of the reference\n    pub fn parts(\u0026self) -\u003e \u0026[PropertyValue] {\n        \u0026self.parts\n    }\n\n    /// Returns the hash of the reference\n    pub fn hash(\u0026self) -\u003e \u0026str {\n        \u0026self.hash\n    }\n\n    pub const fn parts_mut(\u0026mut self) -\u003e \u0026mut Vec\u003cPropertyValue\u003e {\n        \u0026mut self.parts\n    }\n}\n\nimpl Serialize for Reference {\n    fn serialize\u003cS\u003e(\u0026self, serializer: S) -\u003e Result\u003cS::Ok, S::Error\u003e\n    where\n        S: Serializer,\n    {\n        let mut s = serializer.serialize_struct(\"Reference\", 2)?;\n        s.serialize_field(\"hash\", \u0026self.hash)?;\n        s.serialize_field(\"parts\", \u0026self.parts)?;\n        s.end()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_parts() {\n        let reference = Reference {\n            parts: vec![PropertyValue::new(\n                PropertyType::new(\"P123\", None),\n                StatementValue::new_string(\"test\"),\n            )],\n            hash: \"hash\".to_string(),\n        };\n        assert_eq!(\n            reference.parts(),\n            \u0026[PropertyValue::new(\n                PropertyType::new(\"P123\", None),\n                StatementValue::new_string(\"test\")\n            )]\n        );\n    }\n\n    #[test]\n    fn test_from_json_err() {\n        let json = r#\"{\"hash\":\"hash\",\"parts\":12345}\"#;\n        assert!(Reference::from_json(\u0026serde_json::from_str(json).unwrap()).is_err());\n    }\n\n    #[test]\n    fn test_parts_mut() {\n        let mut reference = Reference {\n            parts: vec![PropertyValue::new(\n                PropertyType::new(\"P123\", None),\n                StatementValue::new_string(\"test\"),\n            )],\n            hash: \"hash\".to_string(),\n        };\n        reference.parts_mut().push(PropertyValue::new(\n            PropertyType::new(\"P456\", None),\n            StatementValue::new_string(\"test\"),\n        ));\n        assert_eq!(\n            reference.parts(),\n            \u0026[\n                PropertyValue::new(\n                    PropertyType::new(\"P123\", None),\n                    StatementValue::new_string(\"test\")\n                ),\n                PropertyValue::new(\n                    PropertyType::new(\"P456\", None),\n                    StatementValue::new_string(\"test\")\n                )\n            ]\n        );\n    }\n\n    #[test]\n    fn test_hash() {\n        let reference = Reference {\n            parts: vec![PropertyValue::new(\n                PropertyType::new(\"P123\", None),\n                StatementValue::new_string(\"test\"),\n            )],\n            hash: \"hash\".to_string(),\n        };\n        assert_eq!(reference.hash(), \"hash\");\n    }\n}\n","traces":[{"line":19,"address":[],"length":0,"stats":{"Line":1594}},{"line":21,"address":[],"length":0,"stats":{"Line":3187}},{"line":23,"address":[],"length":0,"stats":{"Line":1595}},{"line":24,"address":[],"length":0,"stats":{"Line":1}},{"line":25,"address":[],"length":0,"stats":{"Line":1}},{"line":28,"address":[],"length":0,"stats":{"Line":1592}},{"line":30,"address":[],"length":0,"stats":{"Line":1}},{"line":31,"address":[],"length":0,"stats":{"Line":1}},{"line":32,"address":[],"length":0,"stats":{"Line":1}},{"line":35,"address":[],"length":0,"stats":{"Line":6105}},{"line":36,"address":[],"length":0,"stats":{"Line":9026}},{"line":37,"address":[],"length":0,"stats":{"Line":4513}},{"line":45,"address":[],"length":0,"stats":{"Line":2}},{"line":46,"address":[],"length":0,"stats":{"Line":2}},{"line":50,"address":[],"length":0,"stats":{"Line":1}},{"line":51,"address":[],"length":0,"stats":{"Line":1}},{"line":54,"address":[],"length":0,"stats":{"Line":1}},{"line":55,"address":[],"length":0,"stats":{"Line":1}},{"line":60,"address":[],"length":0,"stats":{"Line":471}},{"line":64,"address":[],"length":0,"stats":{"Line":942}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":471}},{"line":67,"address":[],"length":0,"stats":{"Line":471}}],"covered":22,"coverable":23},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","rest_api.rs"],"content":"use crate::{bearer_token::BearerToken, rest_api_builder::RestApiBuilder, RestApiError};\nuse reqwest::header::HeaderMap;\nuse std::{collections::HashMap, sync::Arc};\nuse tokio::sync::RwLock;\n\n#[derive(Debug, Clone)]\npub struct RestApi {\n    client: reqwest::Client,\n    user_agent: String,\n    api_url: String,\n    api_version: u8,\n    pub token: Arc\u003cRwLock\u003cBearerToken\u003e\u003e,\n}\n\nimpl RestApi {\n    /// Returns a `RestApiBuilder`. Wrapper around `RestApiBuilder::new()`.\n    pub fn builder\u003cS: Into\u003cString\u003e\u003e(api_url: S) -\u003e Result\u003cRestApiBuilder, RestApiError\u003e {\n        RestApiBuilder::new(api_url)\n    }\n\n    /// Returns the user agent\n    pub fn user_agent(\u0026self) -\u003e \u0026str {\n        \u0026self.user_agent\n    }\n\n    /// Returns the API version\n    pub const fn api_version(\u0026self) -\u003e u8 {\n        self.api_version\n    }\n\n    /// Returns a `RequestBuilder` for a Wikibase REST API request\n    /// # Errors\n    /// Returns an error if the headers cannot be created\n    pub async fn wikibase_request_builder\u003cS: Into\u003cString\u003e\u003e(\n        \u0026self,\n        path: S,\n        params: HashMap\u003cString, String\u003e,\n        method: reqwest::Method,\n    ) -\u003e Result\u003creqwest::RequestBuilder, RestApiError\u003e {\n        let mut headers = self.headers().await?;\n        headers.insert(reqwest::header::ACCEPT, \"application/json\".parse()?);\n        match method {\n            reqwest::Method::GET =\u003e {}\n            reqwest::Method::PATCH =\u003e {\n                headers.insert(\n                    reqwest::header::CONTENT_TYPE,\n                    reqwest::header::HeaderValue::from_static(\"json-patch+json\"),\n                );\n            }\n            _ =\u003e {\n                headers.insert(\n                    reqwest::header::CONTENT_TYPE,\n                    reqwest::header::HeaderValue::from_static(\"application/json\"),\n                );\n            }\n        }\n        let wikibase_path = format!(\"{}{}\", self.wikibase_root(), path.into());\n        self.request_builder(\u0026wikibase_path, headers, params, method)\n    }\n\n    /// Returns a `RestApi` instance for Wikidata\n    pub fn wikidata() -\u003e Result\u003cRestApi, RestApiError\u003e {\n        Ok(RestApi::builder(\"https://www.wikidata.org/w/rest.php\")?.build())\n    }\n\n    /// Executes a `reqwest::Request`, and returns a `reqwest::Response`.\n    /// # Errors\n    /// Returns an error if the request cannot be executed\n    pub async fn execute(\n        \u0026self,\n        request: reqwest::Request,\n    ) -\u003e Result\u003creqwest::Response, RestApiError\u003e {\n        self.token.write().await.check(self, \u0026request).await?;\n        let response = self.client.execute(request).await?;\n        Ok(response)\n    }\n\n    /// Returns the `OpenAPI` JSON for the Wikibase REST API\n    pub async fn get_openapi_json(\u0026self) -\u003e Result\u003cserde_json::Value, RestApiError\u003e {\n        let request = self\n            .wikibase_request_builder(\"/openapi.json\", HashMap::new(), reqwest::Method::GET)\n            .await?\n            .build()?;\n        let response = self.execute(request).await?;\n        let json = response.json().await?;\n        Ok(json)\n    }\n\n    /// Returns the API URL\n    pub fn api_url(\u0026self) -\u003e \u0026str {\n        \u0026self.api_url\n    }\n\n    /// Returns the `reqwest::Client`\n    pub const fn client(\u0026self) -\u003e \u0026reqwest::Client {\n        \u0026self.client\n    }\n\n    /// Creates a new `RestApi` instance.\n    /// Only available internally, use `RestApi::builder()` instead.\n    pub(crate) const fn new(\n        client: reqwest::Client,\n        user_agent: String,\n        api_url: String,\n        api_version: u8,\n        token: Arc\u003cRwLock\u003cBearerToken\u003e\u003e,\n    ) -\u003e Self {\n        Self {\n            client,\n            user_agent,\n            api_url,\n            api_version,\n            token,\n        }\n    }\n\n    /// Returns a `HeaderMap` with the user agent and `OAuth2` bearer token (if present).\n    /// Only available internally.\n    pub(crate) async fn headers_from_token(\n        \u0026self,\n        token: \u0026BearerToken,\n    ) -\u003e Result\u003cHeaderMap, RestApiError\u003e {\n        let mut headers = HeaderMap::new();\n        headers.insert(reqwest::header::USER_AGENT, self.user_agent.parse()?);\n        if let Some(access_token) = \u0026token.get() {\n            headers.insert(\n                reqwest::header::AUTHORIZATION,\n                format!(\"Bearer {}\", access_token).parse()?,\n            );\n        }\n        Ok(headers)\n    }\n\n    pub fn token(\u0026self) -\u003e Arc\u003cRwLock\u003cBearerToken\u003e\u003e {\n        self.token.clone()\n    }\n\n    /// Returns the root path for the Wikibase REST API, based on the version number\n    fn wikibase_root(\u0026self) -\u003e String {\n        format!(\"/wikibase/v{}\", self.api_version)\n    }\n\n    /// Builds a `reqwest::RequestBuilder` from the method, client, path, and parameters\n    fn request_builder\u003cS: Into\u003cString\u003e\u003e(\n        \u0026self,\n        path: S,\n        headers: HeaderMap,\n        params: HashMap\u003cString, String\u003e,\n        method: reqwest::Method,\n    ) -\u003e Result\u003creqwest::RequestBuilder, RestApiError\u003e {\n        let url = format!(\"{}{}\", self.api_url, path.into());\n        Ok(match method {\n            reqwest::Method::GET =\u003e self.client.get(url).headers(headers).query(\u0026params),\n            reqwest::Method::POST =\u003e self.client.post(url).headers(headers).form(\u0026params),\n            reqwest::Method::PATCH =\u003e self.client.patch(url).headers(headers).form(\u0026params),\n            reqwest::Method::PUT =\u003e self.client.put(url).headers(headers).form(\u0026params),\n            reqwest::Method::DELETE =\u003e self.client.delete(url).headers(headers).form(\u0026params),\n            _ =\u003e return Err(RestApiError::UnsupportedMethod(method)),\n        })\n    }\n\n    /// Returns a `HeaderMap` with the user agent and `OAuth2` bearer token (if present)\n    async fn headers(\u0026self) -\u003e Result\u003cHeaderMap, RestApiError\u003e {\n        let token = self.token.read().await;\n        self.headers_from_token(\u0026token).await\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use wiremock::matchers::{method, path};\n    use wiremock::{Mock, MockServer, ResponseTemplate};\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_get_openapi_json() {\n        let expected_json = std::fs::read_to_string(\"test_data/openapi.json\").unwrap();\n        let expected_json: serde_json::Value = serde_json::from_str(\u0026expected_json).unwrap();\n        let mock_path = \"/w/rest.php/wikibase/v1/openapi.json\";\n        let mock_server = MockServer::start().await;\n        Mock::given(method(\"GET\"))\n            .and(path(mock_path))\n            .respond_with(ResponseTemplate::new(200).set_body_json(expected_json.clone()))\n            .mount(\u0026mock_server)\n            .await;\n        let api = RestApi::builder(\u0026(mock_server.uri() + \"/w/rest.php\"))\n            .unwrap()\n            .build();\n\n        let json = api.get_openapi_json().await.unwrap();\n        assert_eq!(json, expected_json);\n    }\n\n    #[test]\n    #[cfg_attr(miri, ignore)] // TODO this should work in miri\n    fn test_client() {\n        let client = reqwest::Client::new();\n        let api = RestApi::builder(\"https://test.wikidata.org/w/rest.php\")\n            .unwrap()\n            .with_client(client.clone())\n            .build();\n        assert_eq!(format!(\"{:?}\", api.client), format!(\"{:?}\", client));\n    }\n}\n","traces":[{"line":17,"address":[],"length":0,"stats":{"Line":57}},{"line":18,"address":[],"length":0,"stats":{"Line":57}},{"line":22,"address":[],"length":0,"stats":{"Line":2}},{"line":23,"address":[],"length":0,"stats":{"Line":2}},{"line":27,"address":[],"length":0,"stats":{"Line":2}},{"line":28,"address":[],"length":0,"stats":{"Line":2}},{"line":34,"address":[],"length":0,"stats":{"Line":49}},{"line":40,"address":[],"length":0,"stats":{"Line":98}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":49}},{"line":43,"address":[],"length":0,"stats":{"Line":31}},{"line":44,"address":[],"length":0,"stats":{"Line":4}},{"line":45,"address":[],"length":0,"stats":{"Line":4}},{"line":46,"address":[],"length":0,"stats":{"Line":4}},{"line":47,"address":[],"length":0,"stats":{"Line":4}},{"line":50,"address":[],"length":0,"stats":{"Line":14}},{"line":51,"address":[],"length":0,"stats":{"Line":14}},{"line":52,"address":[],"length":0,"stats":{"Line":14}},{"line":53,"address":[],"length":0,"stats":{"Line":14}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":49}},{"line":73,"address":[],"length":0,"stats":{"Line":98}},{"line":74,"address":[],"length":0,"stats":{"Line":98}},{"line":79,"address":[],"length":0,"stats":{"Line":2}},{"line":80,"address":[],"length":0,"stats":{"Line":2}},{"line":81,"address":[],"length":0,"stats":{"Line":1}},{"line":82,"address":[],"length":0,"stats":{"Line":1}},{"line":84,"address":[],"length":0,"stats":{"Line":1}},{"line":85,"address":[],"length":0,"stats":{"Line":1}},{"line":90,"address":[],"length":0,"stats":{"Line":3}},{"line":91,"address":[],"length":0,"stats":{"Line":3}},{"line":95,"address":[],"length":0,"stats":{"Line":4}},{"line":96,"address":[],"length":0,"stats":{"Line":4}},{"line":101,"address":[],"length":0,"stats":{"Line":57}},{"line":119,"address":[],"length":0,"stats":{"Line":51}},{"line":123,"address":[],"length":0,"stats":{"Line":51}},{"line":124,"address":[],"length":0,"stats":{"Line":51}},{"line":125,"address":[],"length":0,"stats":{"Line":67}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":51}},{"line":134,"address":[],"length":0,"stats":{"Line":6}},{"line":135,"address":[],"length":0,"stats":{"Line":6}},{"line":139,"address":[],"length":0,"stats":{"Line":49}},{"line":140,"address":[],"length":0,"stats":{"Line":49}},{"line":144,"address":[],"length":0,"stats":{"Line":49}},{"line":151,"address":[],"length":0,"stats":{"Line":49}},{"line":152,"address":[],"length":0,"stats":{"Line":49}},{"line":153,"address":[],"length":0,"stats":{"Line":31}},{"line":154,"address":[],"length":0,"stats":{"Line":5}},{"line":155,"address":[],"length":0,"stats":{"Line":4}},{"line":156,"address":[],"length":0,"stats":{"Line":4}},{"line":157,"address":[],"length":0,"stats":{"Line":5}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":98}},{"line":164,"address":[],"length":0,"stats":{"Line":98}},{"line":165,"address":[],"length":0,"stats":{"Line":49}}],"covered":52,"coverable":59},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","rest_api_builder.rs"],"content":"use crate::{bearer_token::BearerToken, RestApi, RestApiError};\nuse std::sync::Arc;\nuse tokio::sync::RwLock;\n\n/// The default user agent\nconst DEFAULT_USER_AGENT: \u0026str = \"Rust Wikibase REST API\";\n\n/// The latest supported version of the Wikibase REST API\nconst WIKIBASE_REST_API_VERSION: u8 = 1;\n\n#[derive(Debug)]\npub struct RestApiBuilder {\n    client: Option\u003creqwest::Client\u003e,\n    token: BearerToken,\n    user_agent: Option\u003cString\u003e,\n    api_url: String,\n    api_version: Option\u003cu8\u003e,\n    renewal_interval: Option\u003cstd::time::Duration\u003e,\n}\n\nimpl RestApiBuilder {\n    /// Sets the REST API URL, specifically the URL ending in \"rest.php\". This in mandatory.\n    /// # Errors\n    /// Returns an error if REST API URL is invalid.\n    pub fn new\u003cS: Into\u003cString\u003e\u003e(api_url: S) -\u003e Result\u003cSelf, RestApiError\u003e {\n        let api_url = Self::validate_api_url(\u0026api_url.into())?;\n        Ok(Self {\n            client: None,\n            token: BearerToken::default(),\n            user_agent: None,\n            api_url,\n            api_version: None,\n            renewal_interval: None,\n        })\n    }\n\n    /// Sets the API version (u8). Default is 1.\n    pub const fn with_api_version(mut self, api_version: u8) -\u003e Self {\n        self.api_version = Some(api_version);\n        self\n    }\n\n    /// Sets the `OAuth2` bearer token.\n    pub fn with_access_token\u003cS: Into\u003cString\u003e\u003e(mut self, access_token: S) -\u003e Self {\n        self.token.set_access_token(access_token);\n        self\n    }\n\n    /// Sets the user agent. By default, the user agent is \"Rust Wikibase REST API; {`package_name`}/{`package_version`}\"\n    pub fn with_user_agent\u003cS: Into\u003cString\u003e\u003e(mut self, user_agent: S) -\u003e Self {\n        self.user_agent = Some(user_agent.into());\n        self\n    }\n\n    /// Sets the `reqwest::Client`. By default, a new `reqwest::Client` is created.\n    pub fn with_client(mut self, client: reqwest::Client) -\u003e Self {\n        self.client = Some(client);\n        self\n    }\n\n    /// Sets the interval for bearer token renewal. By default, the interval is `DEFAULT_RENEWAL_INTERVAL_SEC`.\n    #[cfg(not(tarpaulin_include))]\n    pub const fn with_access_token_renewal(\n        mut self,\n        renewal_interval: std::time::Duration,\n    ) -\u003e Self {\n        self.renewal_interval = Some(renewal_interval);\n        self\n    }\n\n    /// Sets the `OAuth2` client ID and client secret\n    #[cfg(not(tarpaulin_include))]\n    pub fn with_oauth2_info\u003cS1: Into\u003cString\u003e, S2: Into\u003cString\u003e\u003e(\n        mut self,\n        client_id: S1,\n        client_secret: S2,\n    ) -\u003e Self {\n        self.token.set_oauth2_info(client_id, client_secret);\n        self\n    }\n\n    /// Builds the `RestApi`. Returns an error if no REST API URL is set.\n    /// The builder gets consumed by this operation.\n    /// # Returns\n    /// Returns a `RestApi` instance.\n    pub fn build(self) -\u003e RestApi {\n        let api_url = self.api_url;\n        let mut token = self.token;\n        if let Some(interval) = self.renewal_interval {\n            token.set_renewal_interval(interval.as_secs());\n        }\n        let token = Arc::new(RwLock::new(token));\n        let user_agent = self.user_agent.unwrap_or(Self::default_user_agent());\n        let api_version = self.api_version.unwrap_or(WIKIBASE_REST_API_VERSION);\n        let client = self.client.unwrap_or_default(); // TODO check why miri fails here\n        RestApi::new(client, user_agent, api_url, api_version, token)\n    }\n\n    /// Checks if the REST API URL is valid. The URL must end in \"rest.php\".\n    /// Removes anything beyone that.\n    fn validate_api_url(api_url: \u0026str) -\u003e Result\u003cString, RestApiError\u003e {\n        let (base, _rest) = api_url\n            .split_once(\"/rest.php\")\n            .ok_or_else(|| RestApiError::RestApiUrlInvalid(api_url.to_owned()))?;\n        let ret = format!(\"{base}/rest.php\");\n        Ok(ret)\n    }\n\n    /// Returns the default user agent, a versioned string based on `DEFAULT_USER_AGENT`.\n    fn default_user_agent() -\u003e String {\n        format!(\n            \"{DEFAULT_USER_AGENT}; {}/{}\",\n            env!(\"CARGO_PKG_NAME\"),\n            env!(\"CARGO_PKG_VERSION\")\n        )\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::time::Duration;\n\n    #[test]\n    fn test_default_user_agent() {\n        let user_agent = RestApiBuilder::default_user_agent();\n        assert!(user_agent.starts_with(DEFAULT_USER_AGENT));\n        assert!(user_agent.contains(env!(\"CARGO_PKG_NAME\")));\n        assert!(user_agent.contains(env!(\"CARGO_PKG_VERSION\")));\n    }\n\n    #[test]\n    fn test_validate_api_url_default() {\n        let builder = RestApiBuilder::new(\"foobar\");\n        assert!(builder.is_err());\n    }\n\n    #[test]\n    fn test_validate_api_url_api() {\n        let builder = RestApiBuilder::new(\"https://www.wikidata.org/w/api.php\");\n        assert!(builder.is_err());\n    }\n\n    #[test]\n    fn test_validate_api_url_rest_api() {\n        let builder = RestApiBuilder::new(\"https://www.wikidata.org/w/rest.php\");\n        assert!(builder.is_ok());\n    }\n\n    #[test]\n    #[cfg_attr(miri, ignore)] // TODO this should work in miri\n    fn test_user_agent() {\n        let api1 = RestApi::builder(\"https://test.wikidata.org/w/rest.php\")\n            .unwrap()\n            .build();\n        assert_eq!(api1.user_agent(), RestApiBuilder::default_user_agent());\n\n        let api2 = RestApi::builder(\"https://test.wikidata.org/w/rest.php\")\n            .unwrap()\n            .with_user_agent(\"Test User Agent\")\n            .build();\n        assert_eq!(api2.user_agent(), \"Test User Agent\");\n    }\n\n    #[test]\n    #[cfg_attr(miri, ignore)] // TODO this should work in miri\n    fn test_with_api_version() {\n        let api1 = RestApi::builder(\"https://test.wikidata.org/w/rest.php\")\n            .unwrap()\n            .build();\n        assert_eq!(api1.api_version(), WIKIBASE_REST_API_VERSION);\n\n        let api2 = RestApi::builder(\"https://test.wikidata.org/w/rest.php\")\n            .unwrap()\n            .with_api_version(2)\n            .build();\n        assert_eq!(api2.api_version(), 2);\n    }\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_with_access_token_renewal() {\n        let api1 = RestApi::builder(\"https://test.wikidata.org/w/rest.php\")\n            .unwrap()\n            .build();\n        assert_eq!(\n            api1.token().read().await.access_token_renewal_interval(),\n            Duration::from_secs(0)\n        );\n\n        let api2 = RestApi::builder(\"https://test.wikidata.org/w/rest.php\")\n            .unwrap()\n            .with_access_token_renewal(std::time::Duration::from_secs(60))\n            .build();\n        assert_eq!(\n            api2.token().read().await.access_token_renewal_interval(),\n            Duration::from_secs(60)\n        );\n    }\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_with_oauth2_info() {\n        let api1 = RestApi::builder(\"https://test.wikidata.org/w/rest.php\")\n            .unwrap()\n            .build();\n        assert_eq!(*api1.token().read().await.client_id(), None);\n        assert_eq!(*api1.token().read().await.client_secret(), None);\n\n        let api2 = RestApi::builder(\"https://test.wikidata.org/w/rest.php\")\n            .unwrap()\n            .with_oauth2_info(\"client_id\", \"client_secret\")\n            .build();\n        assert_eq!(\n            *api2.token().read().await.client_id(),\n            Some(\"client_id\".to_string())\n        );\n        assert_eq!(\n            *api2.token().read().await.client_secret(),\n            Some(\"client_secret\".to_string())\n        );\n    }\n}\n","traces":[{"line":25,"address":[],"length":0,"stats":{"Line":60}},{"line":26,"address":[],"length":0,"stats":{"Line":120}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":2}},{"line":39,"address":[],"length":0,"stats":{"Line":2}},{"line":40,"address":[],"length":0,"stats":{"Line":2}},{"line":44,"address":[],"length":0,"stats":{"Line":13}},{"line":45,"address":[],"length":0,"stats":{"Line":13}},{"line":46,"address":[],"length":0,"stats":{"Line":13}},{"line":50,"address":[],"length":0,"stats":{"Line":1}},{"line":51,"address":[],"length":0,"stats":{"Line":1}},{"line":52,"address":[],"length":0,"stats":{"Line":1}},{"line":56,"address":[],"length":0,"stats":{"Line":1}},{"line":57,"address":[],"length":0,"stats":{"Line":1}},{"line":58,"address":[],"length":0,"stats":{"Line":1}},{"line":86,"address":[],"length":0,"stats":{"Line":57}},{"line":87,"address":[],"length":0,"stats":{"Line":57}},{"line":88,"address":[],"length":0,"stats":{"Line":57}},{"line":89,"address":[],"length":0,"stats":{"Line":58}},{"line":92,"address":[],"length":0,"stats":{"Line":57}},{"line":93,"address":[],"length":0,"stats":{"Line":57}},{"line":94,"address":[],"length":0,"stats":{"Line":57}},{"line":95,"address":[],"length":0,"stats":{"Line":57}},{"line":96,"address":[],"length":0,"stats":{"Line":57}},{"line":101,"address":[],"length":0,"stats":{"Line":60}},{"line":102,"address":[],"length":0,"stats":{"Line":118}},{"line":104,"address":[],"length":0,"stats":{"Line":124}},{"line":110,"address":[],"length":0,"stats":{"Line":59}},{"line":111,"address":[],"length":0,"stats":{"Line":59}},{"line":113,"address":[],"length":0,"stats":{"Line":59}},{"line":114,"address":[],"length":0,"stats":{"Line":59}}],"covered":30,"coverable":37},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","revision_match.rs"],"content":"use crate::RestApiError;\nuse chrono::prelude::*;\nuse reqwest::header::{HeaderMap, HeaderValue};\n\n#[derive(Debug, Default, Clone, PartialEq)]\npub struct RevisionMatch {\n    modified_since_revisions: Vec\u003cu64\u003e,\n    modified_since_date: Option\u003cNaiveDateTime\u003e,\n    unmodified_since_revisions: Vec\u003cu64\u003e,\n    unmodified_since_date: Option\u003cNaiveDateTime\u003e,\n    if_match: Vec\u003cString\u003e,\n    if_none_match: Vec\u003cString\u003e,\n}\n\nimpl RevisionMatch {\n    pub fn modify_headers(\u0026self, headers: \u0026mut HeaderMap) -\u003e Result\u003c(), RestApiError\u003e {\n        if let Some(date) = self.modified_since_date {\n            let hvs = format!(\"{}\", date.format(\"%c\"));\n            let hv = HeaderValue::from_str(\u0026hvs)?;\n            headers.insert(\"If-Modified-Since\", hv);\n        }\n        if let Some(date) = self.unmodified_since_date {\n            let hvs = format!(\"{}\", date.format(\"%c\"));\n            let hv = HeaderValue::from_str(\u0026hvs)?;\n            headers.insert(\"If-Unmodified-Since\", hv);\n        }\n        // TODO FIXME complete\n        Ok(())\n    }\n\n    pub fn modified_since_revisions(\u0026self) -\u003e \u0026[u64] {\n        \u0026self.modified_since_revisions\n    }\n\n    pub fn set_modified_since_revisions(\u0026mut self, modified_since_revisions: Vec\u003cu64\u003e) {\n        self.modified_since_revisions = modified_since_revisions;\n    }\n\n    pub const fn modified_since_date(\u0026self) -\u003e Option\u003cNaiveDateTime\u003e {\n        self.modified_since_date\n    }\n\n    pub const fn set_modified_since_date(\u0026mut self, modified_since_date: Option\u003cNaiveDateTime\u003e) {\n        self.modified_since_date = modified_since_date;\n    }\n\n    pub fn unmodified_since_revisions(\u0026self) -\u003e \u0026[u64] {\n        \u0026self.unmodified_since_revisions\n    }\n\n    pub fn set_unmodified_since_revisions(\u0026mut self, unmodified_since_revisions: Vec\u003cu64\u003e) {\n        self.unmodified_since_revisions = unmodified_since_revisions;\n    }\n\n    pub const fn unmodified_since_date(\u0026self) -\u003e Option\u003cNaiveDateTime\u003e {\n        self.unmodified_since_date\n    }\n\n    pub const fn set_unmodified_since_date(\n        \u0026mut self,\n        unmodified_since_date: Option\u003cNaiveDateTime\u003e,\n    ) {\n        self.unmodified_since_date = unmodified_since_date;\n    }\n\n    pub fn if_match(\u0026self) -\u003e \u0026[String] {\n        \u0026self.if_match\n    }\n\n    pub fn set_if_match(\u0026mut self, if_match: Vec\u003cString\u003e) {\n        self.if_match = if_match;\n    }\n\n    pub fn if_none_match(\u0026self) -\u003e \u0026[String] {\n        \u0026self.if_none_match\n    }\n\n    pub fn set_if_none_match(\u0026mut self, if_none_match: Vec\u003cString\u003e) {\n        self.if_none_match = if_none_match;\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_revision_match() {\n        // #lizard forgives the complexity\n        let mut revision_match = RevisionMatch::default();\n        assert!(revision_match.modified_since_revisions().is_empty());\n        assert_eq!(revision_match.modified_since_date(), None);\n        assert!(revision_match.unmodified_since_revisions().is_empty());\n        assert_eq!(revision_match.unmodified_since_date(), None);\n        assert!(revision_match.if_match().is_empty());\n        assert!(revision_match.if_none_match().is_empty());\n\n        revision_match.set_modified_since_revisions(vec![1, 2, 3]);\n        assert_eq!(revision_match.modified_since_revisions(), \u0026[1, 2, 3]);\n\n        revision_match.set_modified_since_date(Some(\n            NaiveDate::from_ymd_opt(2021, 1, 1)\n                .unwrap()\n                .and_hms_opt(0, 0, 0)\n                .unwrap(),\n        ));\n        assert_eq!(\n            revision_match.modified_since_date(),\n            Some(\n                NaiveDate::from_ymd_opt(2021, 1, 1)\n                    .unwrap()\n                    .and_hms_opt(0, 0, 0)\n                    .unwrap()\n            )\n        );\n\n        revision_match.set_unmodified_since_revisions(vec![4, 5, 6]);\n        assert_eq!(revision_match.unmodified_since_revisions(), \u0026[4, 5, 6]);\n\n        revision_match.set_unmodified_since_date(Some(\n            NaiveDate::from_ymd_opt(2021, 1, 2)\n                .unwrap()\n                .and_hms_opt(0, 0, 0)\n                .unwrap(),\n        ));\n        assert_eq!(\n            revision_match.unmodified_since_date(),\n            Some(\n                NaiveDate::from_ymd_opt(2021, 1, 2)\n                    .unwrap()\n                    .and_hms_opt(0, 0, 0)\n                    .unwrap()\n            )\n        );\n\n        revision_match.set_if_match(vec![\"1\".to_string(), \"2\".to_string()]);\n        assert_eq!(\n            revision_match.if_match(),\n            \u0026[\"1\".to_string(), \"2\".to_string()]\n        );\n\n        revision_match.set_if_none_match(vec![\"3\".to_string(), \"4\".to_string()]);\n        assert_eq!(\n            revision_match.if_none_match(),\n            \u0026[\"3\".to_string(), \"4\".to_string()]\n        );\n    }\n}\n","traces":[{"line":16,"address":[],"length":0,"stats":{"Line":43}},{"line":17,"address":[],"length":0,"stats":{"Line":43}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":43}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":43}},{"line":31,"address":[],"length":0,"stats":{"Line":2}},{"line":32,"address":[],"length":0,"stats":{"Line":2}},{"line":35,"address":[],"length":0,"stats":{"Line":2}},{"line":36,"address":[],"length":0,"stats":{"Line":2}},{"line":39,"address":[],"length":0,"stats":{"Line":2}},{"line":40,"address":[],"length":0,"stats":{"Line":2}},{"line":43,"address":[],"length":0,"stats":{"Line":1}},{"line":44,"address":[],"length":0,"stats":{"Line":1}},{"line":47,"address":[],"length":0,"stats":{"Line":2}},{"line":48,"address":[],"length":0,"stats":{"Line":2}},{"line":51,"address":[],"length":0,"stats":{"Line":1}},{"line":52,"address":[],"length":0,"stats":{"Line":1}},{"line":55,"address":[],"length":0,"stats":{"Line":2}},{"line":56,"address":[],"length":0,"stats":{"Line":2}},{"line":59,"address":[],"length":0,"stats":{"Line":1}},{"line":63,"address":[],"length":0,"stats":{"Line":1}},{"line":66,"address":[],"length":0,"stats":{"Line":2}},{"line":67,"address":[],"length":0,"stats":{"Line":2}},{"line":70,"address":[],"length":0,"stats":{"Line":1}},{"line":71,"address":[],"length":0,"stats":{"Line":1}},{"line":74,"address":[],"length":0,"stats":{"Line":2}},{"line":75,"address":[],"length":0,"stats":{"Line":2}},{"line":78,"address":[],"length":0,"stats":{"Line":1}},{"line":79,"address":[],"length":0,"stats":{"Line":1}}],"covered":28,"coverable":30},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","search.rs"],"content":"use crate::{entity::EntityType, Language, RestApi, RestApiError};\nuse nutype::nutype;\nuse serde::{Deserialize, Serialize};\nuse serde_json::Value;\nuse std::collections::HashMap;\n\n#[nutype(\n    validate(greater_or_equal = 1, less_or_equal = 500),\n    derive(Debug, Display, Clone, PartialEq)\n)]\npub struct SearchLimit(u16);\n\n#[derive(Debug, Clone, PartialEq, Serialize, Deserialize)]\npub struct SearchResultText {\n    language: String,\n    value: String,\n}\n\nimpl SearchResultText {\n    pub fn language(\u0026self) -\u003e \u0026str {\n        \u0026self.language\n    }\n\n    pub fn value(\u0026self) -\u003e \u0026str {\n        \u0026self.value\n    }\n}\n\n#[derive(Debug, Clone, PartialEq, Serialize, Deserialize)]\npub struct SearchResultMatch {\n    #[serde(rename = \"type\")]\n    match_type: String,\n    language: String,\n    text: String,\n}\n\nimpl SearchResultMatch {\n    pub fn language(\u0026self) -\u003e \u0026str {\n        \u0026self.language\n    }\n\n    pub fn text(\u0026self) -\u003e \u0026str {\n        \u0026self.text\n    }\n\n    pub fn match_type(\u0026self) -\u003e \u0026str {\n        \u0026self.match_type\n    }\n}\n\n#[derive(Debug, Clone, PartialEq, Serialize, Deserialize)]\npub struct SearchResult {\n    id: String,\n    #[serde(rename = \"display-label\")]\n    display_label: Option\u003cSearchResultText\u003e,\n    description: Option\u003cSearchResultText\u003e,\n    #[serde(rename = \"match\")]\n    search_match: SearchResultMatch,\n}\n\nimpl SearchResult {\n    pub fn id(\u0026self) -\u003e \u0026str {\n        \u0026self.id\n    }\n\n    pub fn display_label(\u0026self) -\u003e Option\u003c\u0026SearchResultText\u003e {\n        self.display_label.as_ref()\n    }\n\n    pub fn description(\u0026self) -\u003e Option\u003c\u0026SearchResultText\u003e {\n        self.description.as_ref()\n    }\n\n    pub fn search_match(\u0026self) -\u003e \u0026SearchResultMatch {\n        \u0026self.search_match\n    }\n}\n\n#[derive(Debug)]\npub struct Search {\n    entity_type: EntityType,\n    q: String,\n    language: Language,\n    limit: Option\u003cSearchLimit\u003e,\n    offset: Option\u003cusize\u003e,\n}\n\nimpl Search {\n    pub fn items\u003cS: Into\u003cString\u003e\u003e(q: S, language: Language) -\u003e Self {\n        Self {\n            entity_type: EntityType::Item,\n            q: q.into(),\n            language,\n            limit: None,\n            offset: None,\n        }\n    }\n\n    pub fn properties\u003cS: Into\u003cString\u003e\u003e(q: S, language: Language) -\u003e Self {\n        Self {\n            entity_type: EntityType::Property,\n            q: q.into(),\n            language,\n            limit: None,\n            offset: None,\n        }\n    }\n\n    pub fn with_limit(mut self, limit: SearchLimit) -\u003e Self {\n        self.limit = Some(limit);\n        self\n    }\n\n    pub fn with_offset(mut self, offset: usize) -\u003e Self {\n        self.offset = Some(offset);\n        self\n    }\n\n    async fn generate_json_request(\u0026self, api: \u0026RestApi) -\u003e Result\u003creqwest::Request, RestApiError\u003e {\n        let path = self.get_my_rest_api_path();\n        let mut params = HashMap::new();\n        params.insert(\"q\".to_string(), self.q.to_string());\n        params.insert(\"language\".to_string(), self.language.to_string());\n        if let Some(limit) = \u0026self.limit {\n            params.insert(\"limit\".to_string(), format!(\"{limit}\"));\n        }\n        if let Some(offset) = \u0026self.offset {\n            params.insert(\"offset\".to_string(), offset.to_string());\n        }\n        let mut request = api\n            .wikibase_request_builder(\u0026path, params, reqwest::Method::GET)\n            .await?\n            .build()?;\n        request\n            .headers_mut()\n            .insert(reqwest::header::CONTENT_TYPE, \"application/json\".parse()?);\n        Ok(request)\n    }\n\n    pub async fn get(\u0026self, api: \u0026RestApi) -\u003e Result\u003cVec\u003cSearchResult\u003e, RestApiError\u003e {\n        let request = self.generate_json_request(api).await?;\n        let response = api.execute(request).await?;\n        let response = self.filter_response_error(response).await?;\n        Self::response_to_results(response)\n    }\n\n    fn response_to_results(response: Value) -\u003e Result\u003cVec\u003cSearchResult\u003e, RestApiError\u003e {\n        let results = response[\"results\"]\n            .as_array()\n            .ok_or(RestApiError::MissingResults)?\n            .iter()\n            .filter_map(|result| serde_json::from_value(result.clone()).ok())\n            .collect();\n        Ok(results)\n    }\n\n    fn get_my_rest_api_path(\u0026self) -\u003e String {\n        format!(\"/search/{group}\", group = self.entity_type.group_name())\n    }\n\n    async fn filter_response_error(\n        \u0026self,\n        response: reqwest::Response,\n    ) -\u003e Result\u003cValue, RestApiError\u003e {\n        if !response.status().is_success() {\n            return Err(RestApiError::from_response(response).await);\n        }\n        let j: Value = response.error_for_status()?.json().await?;\n        Ok(j)\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_get_my_rest_api_path() {\n        assert_eq!(\n            Search::items(\"foo\", Language::try_new(\"en\").unwrap()).get_my_rest_api_path(),\n            \"/search/items\"\n        );\n        assert_eq!(\n            Search::properties(\"foo\", Language::try_new(\"en\").unwrap()).get_my_rest_api_path(),\n            \"/search/properties\"\n        );\n    }\n\n    #[test]\n    fn test_response_to_results() {\n        let v = std::fs::read_to_string(\"test_data/test_search_response.json\").unwrap();\n        let v: Value = serde_json::from_str(\u0026v).unwrap();\n        let results = Search::response_to_results(v).unwrap();\n        assert_eq!(results.len(), 4);\n        assert_eq!(results[0].id(), \"Q123\");\n        assert_eq!(results[1].id(), \"Q234\");\n        assert_eq!(results[2].id(), \"Q345\");\n        assert_eq!(results[3].id(), \"Q456\");\n        assert_eq!(results[0].display_label().unwrap().value(), \"potato\");\n        assert_eq!(results[0].description().unwrap().value(), \"staple food\");\n        assert_eq!(results[1].display_label().unwrap().value(), \"potato\");\n        assert_eq!(\n            results[1].description().unwrap().value(),\n            \"species of plant\"\n        );\n        assert!(results[2].description().is_none());\n        assert!(results[3].display_label().is_none());\n        assert_eq!(results[0].search_match().match_type(), \"label\");\n        assert_eq!(results[1].search_match().match_type(), \"label\");\n        assert_eq!(results[2].search_match().match_type(), \"label\");\n        assert_eq!(results[3].search_match().match_type(), \"description\");\n    }\n\n    #[tokio::test]\n    async fn test_search() {\n        let query = \"Magnus Manske\";\n        let language = Language::try_new(\"en\").unwrap();\n        let api = RestApi::builder(\"https://www.wikidata.org/w/rest.php\")\n            .unwrap()\n            .with_api_version(0) // Search\n            .build();\n        let results = Search::items(query, language).get(\u0026api).await.unwrap();\n        // Check for \"Magnus Manske\"\n        assert!(results\n            .iter()\n            .map(|result| result.id())\n            .any(|id| id == \"Q13520818\"));\n        // Check for \"Magnus Manske Day\"\n        assert!(results\n            .iter()\n            .map(|result| result.id())\n            .any(|id| id == \"Q10995651\"));\n    }\n}\n","traces":[{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":4}},{"line":25,"address":[],"length":0,"stats":{"Line":4}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":4}},{"line":47,"address":[],"length":0,"stats":{"Line":4}},{"line":62,"address":[],"length":0,"stats":{"Line":7}},{"line":63,"address":[],"length":0,"stats":{"Line":7}},{"line":66,"address":[],"length":0,"stats":{"Line":3}},{"line":67,"address":[],"length":0,"stats":{"Line":3}},{"line":70,"address":[],"length":0,"stats":{"Line":3}},{"line":71,"address":[],"length":0,"stats":{"Line":3}},{"line":74,"address":[],"length":0,"stats":{"Line":4}},{"line":75,"address":[],"length":0,"stats":{"Line":4}},{"line":89,"address":[],"length":0,"stats":{"Line":2}},{"line":92,"address":[],"length":0,"stats":{"Line":2}},{"line":99,"address":[],"length":0,"stats":{"Line":1}},{"line":102,"address":[],"length":0,"stats":{"Line":1}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":2}},{"line":120,"address":[],"length":0,"stats":{"Line":1}},{"line":121,"address":[],"length":0,"stats":{"Line":1}},{"line":122,"address":[],"length":0,"stats":{"Line":1}},{"line":123,"address":[],"length":0,"stats":{"Line":1}},{"line":124,"address":[],"length":0,"stats":{"Line":1}},{"line":127,"address":[],"length":0,"stats":{"Line":1}},{"line":130,"address":[],"length":0,"stats":{"Line":2}},{"line":131,"address":[],"length":0,"stats":{"Line":1}},{"line":132,"address":[],"length":0,"stats":{"Line":1}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":1}},{"line":140,"address":[],"length":0,"stats":{"Line":2}},{"line":141,"address":[],"length":0,"stats":{"Line":2}},{"line":142,"address":[],"length":0,"stats":{"Line":1}},{"line":143,"address":[],"length":0,"stats":{"Line":1}},{"line":147,"address":[],"length":0,"stats":{"Line":2}},{"line":148,"address":[],"length":0,"stats":{"Line":4}},{"line":150,"address":[],"length":0,"stats":{"Line":2}},{"line":152,"address":[],"length":0,"stats":{"Line":6}},{"line":157,"address":[],"length":0,"stats":{"Line":3}},{"line":158,"address":[],"length":0,"stats":{"Line":3}},{"line":161,"address":[],"length":0,"stats":{"Line":1}},{"line":165,"address":[],"length":0,"stats":{"Line":1}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":3}}],"covered":40,"coverable":54},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","sitelink.rs"],"content":"use async_trait::async_trait;\nuse derivative::Derivative;\nuse serde::ser::{Serialize, SerializeStruct};\nuse serde_json::{json, Value};\n\nuse crate::{\n    EditMetadata, EntityId, HeaderInfo, HttpDelete, HttpGet, HttpMisc, HttpPut, RestApi,\n    RestApiError, RevisionMatch,\n};\n\n#[derive(Derivative, Debug, Clone)]\n#[derivative(PartialEq)]\npub struct Sitelink {\n    wiki: String,\n    title: String,\n    badges: Vec\u003cString\u003e,\n    url: Option\u003cString\u003e,\n    #[derivative(PartialEq = \"ignore\")]\n    header_info: HeaderInfo,\n}\n\nimpl Sitelink {\n    /// Create a new sitelink with the given wiki and title\n    pub fn new\u003cS1: Into\u003cString\u003e, S2: Into\u003cString\u003e\u003e(wiki: S1, title: S2) -\u003e Sitelink {\n        Self::new_complete(wiki.into(), title.into(), Vec::new(), None)\n    }\n\n    /// Create a new sitelink with the given wiki, title, badges, and URL\n    pub fn new_complete(\n        wiki: String,\n        title: String,\n        badges: Vec\u003cString\u003e,\n        url: Option\u003cString\u003e,\n    ) -\u003e Sitelink {\n        Sitelink {\n            wiki,\n            title,\n            badges,\n            url,\n            header_info: HeaderInfo::default(),\n        }\n    }\n\n    /// Create a new sitelink from a JSON object\n    pub fn from_json\u003cS: Into\u003cString\u003e\u003e(wiki: S, j: \u0026Value) -\u003e Result\u003cSelf, RestApiError\u003e {\n        Self::from_json_header_info(wiki, j, HeaderInfo::default())\n    }\n\n    fn string_from_json_header_info(j: \u0026Value, key: \u0026str) -\u003e Result\u003cString, RestApiError\u003e {\n        j[key]\n            .as_str()\n            .ok_or(RestApiError::MissingOrInvalidField {\n                field: key.to_string(),\n                j: j.clone(),\n            })\n            .map(|s| s.to_string())\n    }\n\n    fn badges_from_json_header_info(j: \u0026Value) -\u003e Result\u003cVec\u003cString\u003e, RestApiError\u003e {\n        Ok(j[\"badges\"]\n            .as_array()\n            .ok_or(RestApiError::MissingOrInvalidField {\n                field: \"badges\".to_string(),\n                j: j.clone(),\n            })?\n            .iter()\n            .filter_map(|b| b.as_str())\n            .map(|s| s.to_string())\n            .collect())\n    }\n\n    /// Create a new sitelink from a JSON object with header info\n    pub fn from_json_header_info\u003cS: Into\u003cString\u003e\u003e(\n        wiki: S,\n        j: \u0026Value,\n        header_info: HeaderInfo,\n    ) -\u003e Result\u003cSelf, RestApiError\u003e {\n        let wiki = wiki.into().to_string();\n        let title = Self::string_from_json_header_info(j, \"title\")?;\n        let badges = Self::badges_from_json_header_info(j)?;\n        let url = Some(Self::string_from_json_header_info(j, \"url\")?);\n        let mut ret = Sitelink::new_complete(wiki, title, badges, url);\n        ret.header_info = header_info;\n        Ok(ret)\n    }\n\n    /// Returns the wiki of the sitelink\n    pub fn wiki(\u0026self) -\u003e \u0026str {\n        \u0026self.wiki\n    }\n\n    /// Returns the title of the sitelink\n    pub fn title(\u0026self) -\u003e \u0026str {\n        \u0026self.title\n    }\n\n    /// Returns the badges of the sitelink\n    pub const fn badges(\u0026self) -\u003e \u0026Vec\u003cString\u003e {\n        \u0026self.badges\n    }\n\n    /// Returns the URL of the sitelink\n    pub fn url(\u0026self) -\u003e Option\u003c\u0026str\u003e {\n        self.url.as_deref()\n    }\n\n    fn get_rest_api_path_from_wiki(id: \u0026EntityId, wiki: \u0026str) -\u003e Result\u003cString, RestApiError\u003e {\n        Ok(format!(\n            \"/entities/{group}/{id}/sitelinks/{wiki}\",\n            group = id.group()?\n        ))\n    }\n}\n\nimpl Serialize for Sitelink {\n    fn serialize\u003cS\u003e(\u0026self, serializer: S) -\u003e Result\u003cS::Ok, S::Error\u003e\n    where\n        S: serde::Serializer,\n    {\n        // #lizard forgives the complexity\n        let mut fields = 2;\n        if self.url.is_some() {\n            fields += 1;\n        }\n        let mut s = serializer.serialize_struct(\"Sitelink\", fields)?;\n        s.serialize_field(\"title\", \u0026self.title)?;\n        s.serialize_field(\"badges\", \u0026self.badges)?;\n        if let Some(url) = \u0026self.url {\n            s.serialize_field(\"url\", url)?;\n        }\n        s.end()\n    }\n}\n\nimpl HttpMisc for Sitelink {\n    fn get_my_rest_api_path(\u0026self, id: \u0026EntityId) -\u003e Result\u003cString, RestApiError\u003e {\n        Self::get_rest_api_path_from_wiki(id, self.wiki())\n    }\n}\n\n#[async_trait]\nimpl HttpGet for Sitelink {\n    async fn get_match(\n        id: \u0026EntityId,\n        site_id: \u0026str,\n        api: \u0026RestApi,\n        rm: RevisionMatch,\n    ) -\u003e Result\u003cSelf, RestApiError\u003e {\n        let path = Self::get_rest_api_path_from_wiki(id, site_id)?;\n        let (j, header_info) = Self::get_match_internal(api, \u0026path, rm).await?;\n        Self::from_json_header_info(site_id, \u0026j, header_info)\n    }\n}\n\n#[async_trait]\nimpl HttpDelete for Sitelink {\n    async fn delete_meta(\n        \u0026self,\n        id: \u0026EntityId,\n        api: \u0026mut RestApi,\n        em: EditMetadata,\n    ) -\u003e Result\u003c(), RestApiError\u003e {\n        let j = json!({});\n        let (j, _revision_id) = self\n            .run_json_query(id, reqwest::Method::DELETE, j, api, \u0026em)\n            .await?;\n        match j.as_str() {\n            Some(\"Sitelink deleted\") =\u003e Ok(()),\n            _ =\u003e Err(RestApiError::UnexpectedResponse(j.to_owned())),\n        }\n    }\n}\n\n#[async_trait]\nimpl HttpPut for Sitelink {\n    async fn put_meta(\n        \u0026self,\n        id: \u0026EntityId,\n        api: \u0026mut RestApi,\n        em: EditMetadata,\n    ) -\u003e Result\u003cSitelink, RestApiError\u003e {\n        let j = json!({\n            \"sitelink\": {\n                \"title\": self.title(),\n                \"badges\": self.badges()\n            }\n        });\n        let (j, header_info) = self\n            .run_json_query(id, reqwest::Method::PUT, j, api, \u0026em)\n            .await?;\n        let ret = Self::from_json_header_info(\u0026self.wiki, \u0026j, header_info)?;\n        Ok(ret)\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use wiremock::matchers::{bearer_token, body_partial_json, method, path};\n    use wiremock::{Mock, MockServer, ResponseTemplate};\n\n    #[test]\n    fn test_sitelink() {\n        let wiki = \"enwiki\".to_string();\n        let title = \"Foo\".to_string();\n        let badges = vec![\"Q17437796\".to_string()];\n        let url = \"https://en.wikipedia.org/wiki/Foo\".to_string();\n        let sitelink = Sitelink::new_complete(\n            wiki.clone(),\n            title.clone(),\n            badges.clone(),\n            Some(url.to_string()),\n        );\n        assert_eq!(sitelink.wiki(), wiki);\n        assert_eq!(sitelink.title(), title);\n        assert_eq!(sitelink.badges(), \u0026badges);\n        assert_eq!(sitelink.url().unwrap(), url);\n    }\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_sitelink_get() {\n        let v = std::fs::read_to_string(\"test_data/Q42.json\").unwrap();\n        let v: Value = serde_json::from_str(\u0026v).unwrap();\n        let id = v[\"id\"].as_str().unwrap();\n\n        let mock_path = format!(\"/w/rest.php/wikibase/v1/entities/items/{id}/sitelinks/enwiki\");\n        let mock_server = MockServer::start().await;\n        Mock::given(method(\"GET\"))\n            .and(path(\u0026mock_path))\n            .respond_with(ResponseTemplate::new(200).set_body_json(\u0026v[\"sitelinks\"][\"enwiki\"]))\n            .mount(\u0026mock_server)\n            .await;\n        let api = RestApi::builder(\u0026(mock_server.uri() + \"/w/rest.php\"))\n            .unwrap()\n            .build();\n\n        let sitelink = Sitelink::get(\u0026EntityId::item(id), \"enwiki\", \u0026api)\n            .await\n            .unwrap();\n        assert_eq!(sitelink.wiki(), \"enwiki\");\n        assert_eq!(sitelink.title(), \"Douglas Adams\");\n        assert_eq!(\n            sitelink.url(),\n            Some(\"https://en.wikipedia.org/wiki/Douglas_Adams\")\n        );\n    }\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_sitelink_put() {\n        let page_title = \"Foo Bar\";\n        let v = std::fs::read_to_string(\"test_data/Q42.json\").unwrap();\n        let v: Value = serde_json::from_str(\u0026v).unwrap();\n        let id = v[\"id\"].as_str().unwrap();\n\n        let mock_path = format!(\"/w/rest.php/wikibase/v1/entities/items/{id}/sitelinks/enwiki\");\n        let mock_server = MockServer::start().await;\n        let token = \"FAKE_TOKEN\";\n        Mock::given(body_partial_json(\n            json!({\"sitelink\":{\"badges\":[],\"title\":page_title}}),\n        ))\n        .and(method(\"PUT\"))\n        .and(path(\u0026mock_path))\n        .and(bearer_token(token))\n        .respond_with(\n            ResponseTemplate::new(200)\n                .set_body_json(json!({\"badges\":[],\"title\":page_title,\"url\":\"dummy\"})),\n        )\n        .mount(\u0026mock_server)\n        .await;\n        let mut api = RestApi::builder(\u0026(mock_server.uri() + \"/w/rest.php\"))\n            .unwrap()\n            .with_access_token(token)\n            .build();\n\n        let id = EntityId::item(id);\n        let sitelink = Sitelink::new(\"enwiki\", page_title);\n        let new_sitelink = sitelink.put(\u0026id, \u0026mut api).await.unwrap();\n        assert_eq!(new_sitelink.wiki(), sitelink.wiki());\n        assert_eq!(new_sitelink.title(), sitelink.title());\n    }\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_sitelink_delete() {\n        let v = std::fs::read_to_string(\"test_data/Q42.json\").unwrap();\n        let v: Value = serde_json::from_str(\u0026v).unwrap();\n        let id = v[\"id\"].as_str().unwrap();\n\n        let mock_path = format!(\"/w/rest.php/wikibase/v1/entities/items/{id}/sitelinks/enwiki\");\n        let mock_server = MockServer::start().await;\n        let token = \"FAKE_TOKEN\";\n        Mock::given(method(\"DELETE\"))\n            .and(path(\u0026mock_path))\n            .and(bearer_token(token))\n            .respond_with(ResponseTemplate::new(200).set_body_json(json!(\"Sitelink deleted\")))\n            .mount(\u0026mock_server)\n            .await;\n        let mut api = RestApi::builder(\u0026(mock_server.uri() + \"/w/rest.php\"))\n            .unwrap()\n            .with_access_token(token)\n            .build();\n\n        let id = EntityId::item(id);\n        let new_sitelink = Sitelink::new(\"enwiki\", \"doesn't matter\");\n        new_sitelink.delete(\u0026id, \u0026mut api).await.unwrap();\n    }\n}\n","traces":[{"line":24,"address":[],"length":0,"stats":{"Line":13}},{"line":25,"address":[],"length":0,"stats":{"Line":13}},{"line":29,"address":[],"length":0,"stats":{"Line":1636}},{"line":40,"address":[],"length":0,"stats":{"Line":1636}},{"line":45,"address":[],"length":0,"stats":{"Line":1612}},{"line":46,"address":[],"length":0,"stats":{"Line":1612}},{"line":49,"address":[],"length":0,"stats":{"Line":3228}},{"line":50,"address":[],"length":0,"stats":{"Line":3228}},{"line":52,"address":[],"length":0,"stats":{"Line":3228}},{"line":53,"address":[],"length":0,"stats":{"Line":3228}},{"line":54,"address":[],"length":0,"stats":{"Line":3228}},{"line":56,"address":[],"length":0,"stats":{"Line":9684}},{"line":59,"address":[],"length":0,"stats":{"Line":1614}},{"line":60,"address":[],"length":0,"stats":{"Line":1614}},{"line":61,"address":[],"length":0,"stats":{"Line":1614}},{"line":62,"address":[],"length":0,"stats":{"Line":1614}},{"line":63,"address":[],"length":0,"stats":{"Line":1614}},{"line":64,"address":[],"length":0,"stats":{"Line":1614}},{"line":66,"address":[],"length":0,"stats":{"Line":1614}},{"line":67,"address":[],"length":0,"stats":{"Line":1642}},{"line":68,"address":[],"length":0,"stats":{"Line":28}},{"line":73,"address":[],"length":0,"stats":{"Line":1614}},{"line":78,"address":[],"length":0,"stats":{"Line":1614}},{"line":79,"address":[],"length":0,"stats":{"Line":3228}},{"line":80,"address":[],"length":0,"stats":{"Line":1614}},{"line":81,"address":[],"length":0,"stats":{"Line":1614}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":483}},{"line":89,"address":[],"length":0,"stats":{"Line":483}},{"line":93,"address":[],"length":0,"stats":{"Line":14}},{"line":94,"address":[],"length":0,"stats":{"Line":14}},{"line":98,"address":[],"length":0,"stats":{"Line":2}},{"line":99,"address":[],"length":0,"stats":{"Line":2}},{"line":103,"address":[],"length":0,"stats":{"Line":2}},{"line":104,"address":[],"length":0,"stats":{"Line":2}},{"line":107,"address":[],"length":0,"stats":{"Line":3}},{"line":108,"address":[],"length":0,"stats":{"Line":3}},{"line":109,"address":[],"length":0,"stats":{"Line":3}},{"line":110,"address":[],"length":0,"stats":{"Line":3}},{"line":116,"address":[],"length":0,"stats":{"Line":374}},{"line":121,"address":[],"length":0,"stats":{"Line":374}},{"line":122,"address":[],"length":0,"stats":{"Line":744}},{"line":123,"address":[],"length":0,"stats":{"Line":370}},{"line":125,"address":[],"length":0,"stats":{"Line":748}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":374}},{"line":128,"address":[],"length":0,"stats":{"Line":744}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":374}},{"line":136,"address":[],"length":0,"stats":{"Line":2}},{"line":137,"address":[],"length":0,"stats":{"Line":2}},{"line":149,"address":[],"length":0,"stats":{"Line":2}},{"line":150,"address":[],"length":0,"stats":{"Line":1}},{"line":163,"address":[],"length":0,"stats":{"Line":1}},{"line":164,"address":[],"length":0,"stats":{"Line":2}},{"line":165,"address":[],"length":0,"stats":{"Line":1}},{"line":166,"address":[],"length":0,"stats":{"Line":1}},{"line":168,"address":[],"length":0,"stats":{"Line":2}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":1}},{"line":183,"address":[],"length":0,"stats":{"Line":1}},{"line":184,"address":[],"length":0,"stats":{"Line":1}},{"line":185,"address":[],"length":0,"stats":{"Line":1}},{"line":188,"address":[],"length":0,"stats":{"Line":2}},{"line":189,"address":[],"length":0,"stats":{"Line":1}},{"line":190,"address":[],"length":0,"stats":{"Line":1}},{"line":191,"address":[],"length":0,"stats":{"Line":1}}],"covered":63,"coverable":69},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","sitelinks.rs"],"content":"use crate::{\n    sitelinks_patch::SitelinksPatch, EntityId, FromJson, HeaderInfo, HttpGetEntity, HttpMisc,\n    RestApi, RestApiError, RevisionMatch, Sitelink,\n};\nuse async_trait::async_trait;\nuse derivative::Derivative;\nuse serde::ser::{Serialize, SerializeMap};\nuse serde_json::{json, Value};\n\n#[derive(Derivative, Debug, Clone, Default)]\n#[derivative(PartialEq)]\npub struct Sitelinks {\n    sitelinks: Vec\u003cSitelink\u003e,\n    #[derivative(PartialEq = \"ignore\")]\n    header_info: HeaderInfo,\n}\n\nimpl HttpMisc for Sitelinks {\n    fn get_rest_api_path(id: \u0026EntityId) -\u003e Result\u003cString, RestApiError\u003e {\n        Ok(format!(\n            \"/entities/{group}/{id}/sitelinks\",\n            group = id.group()?\n        ))\n    }\n}\n\nimpl FromJson for Sitelinks {\n    fn header_info(\u0026self) -\u003e \u0026HeaderInfo {\n        \u0026self.header_info\n    }\n\n    fn from_json_header_info(json: \u0026Value, header_info: HeaderInfo) -\u003e Result\u003cSelf, RestApiError\u003e {\n        let sitelinks = json\n            .as_object()\n            .ok_or(RestApiError::MissingOrInvalidField {\n                field: \"Sitelinks\".to_string(),\n                j: json.clone(),\n            })?\n            .iter()\n            .map(|(wiki, j)| Sitelink::from_json(wiki, j))\n            .collect::\u003cResult\u003cVec\u003cSitelink\u003e, RestApiError\u003e\u003e()?;\n        Ok(Sitelinks {\n            sitelinks,\n            header_info,\n        })\n    }\n}\n\n#[async_trait]\nimpl HttpGetEntity for Sitelinks {\n    async fn get_match(\n        id: \u0026EntityId,\n        api: \u0026RestApi,\n        rm: RevisionMatch,\n    ) -\u003e Result\u003cSelf, RestApiError\u003e {\n        let path = Self::get_rest_api_path(id)?;\n        let (j, header_info) = Self::get_match_internal(api, \u0026path, rm).await?;\n        Self::from_json_header_info(\u0026j, header_info)\n    }\n}\n\nimpl Sitelinks {\n    /// Returns the sitelinks\n    pub const fn sitelinks(\u0026self) -\u003e \u0026Vec\u003cSitelink\u003e {\n        \u0026self.sitelinks\n    }\n\n    /// Returns the sitelink for a given wiki\n    pub fn get_wiki\u003cS: Into\u003cString\u003e\u003e(\u0026self, wiki: S) -\u003e Option\u003c\u0026Sitelink\u003e {\n        let wiki = wiki.into();\n        self.sitelinks.iter().find(|s| s.wiki() == wiki)\n    }\n\n    /// Sets the sitelink for a given wiki\n    pub fn set_wiki(\u0026mut self, sitelink: Sitelink) {\n        self.sitelinks.retain(|s| s.wiki() != sitelink.wiki());\n        self.sitelinks.push(sitelink);\n    }\n\n    /// Deletes the sitelink for a given wiki\n    pub fn remove_wiki\u003cS: Into\u003cString\u003e\u003e(\u0026mut self, wiki: S) {\n        let wiki = wiki.into();\n        self.sitelinks.retain(|s| s.wiki() != wiki);\n    }\n\n    /// Returns the number of sitelinks\n    pub fn len(\u0026self) -\u003e usize {\n        self.sitelinks.len()\n    }\n\n    /// Returns true if there are no sitelinks\n    pub fn is_empty(\u0026self) -\u003e bool {\n        self.sitelinks.is_empty()\n    }\n\n    /// Generates a patch to transform `other` into `self`\n    pub fn patch(\u0026self, other: \u0026Self) -\u003e Result\u003cSitelinksPatch, RestApiError\u003e {\n        let patch = json_patch::diff(\u0026json!(\u0026other), \u0026json!(\u0026self));\n        let patch = SitelinksPatch::from_json(\u0026json!(patch))?;\n        Ok(patch)\n    }\n}\n\nimpl Serialize for Sitelinks {\n    fn serialize\u003cS\u003e(\u0026self, serializer: S) -\u003e Result\u003cS::Ok, S::Error\u003e\n    where\n        S: serde::Serializer,\n    {\n        let mut s = serializer.serialize_map(Some(self.sitelinks.len()))?;\n        for sl in \u0026self.sitelinks {\n            s.serialize_entry(sl.wiki(), sl)?;\n        }\n        s.end()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use serde_json::json;\n    use wiremock::matchers::{method, path};\n    use wiremock::{Mock, MockServer, ResponseTemplate};\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_sitelinks_get() {\n        let v = std::fs::read_to_string(\"test_data/Q42.json\").unwrap();\n        let v: Value = serde_json::from_str(\u0026v).unwrap();\n        let id = v[\"id\"].as_str().unwrap();\n\n        let mock_path = format!(\"/w/rest.php/wikibase/v1/entities/items/{id}/sitelinks\");\n        let mock_server = MockServer::start().await;\n        Mock::given(method(\"GET\"))\n            .and(path(\u0026mock_path))\n            .respond_with(ResponseTemplate::new(200).set_body_json(\u0026v[\"sitelinks\"]))\n            .mount(\u0026mock_server)\n            .await;\n        let api = RestApi::builder(\u0026(mock_server.uri() + \"/w/rest.php\"))\n            .unwrap()\n            .build();\n\n        let sitelinks = Sitelinks::get(\u0026EntityId::item(\"Q42\"), \u0026api).await.unwrap();\n        assert_eq!(sitelinks.sitelinks.len(), 122);\n        assert_eq!(\n            sitelinks.get_wiki(\"enwiki\").unwrap().title(),\n            \"Douglas Adams\"\n        );\n    }\n\n    #[test]\n    fn test_sitelinks_json() {\n        let sitelinks = Sitelinks {\n            sitelinks: vec![\n                Sitelink::new_complete(\n                    \"enwiki\".to_string(),\n                    \"Douglas Adams\".to_string(),\n                    vec![],\n                    Some(\"https://en.wikipedia.org/wiki/Douglas_Adams\".to_string()),\n                ),\n                Sitelink::new_complete(\n                    \"dewiki\".to_string(),\n                    \"Douglas Adams\".to_string(),\n                    vec![],\n                    Some(\"https://de.wikipedia.org/wiki/Douglas_Adams\".to_string()),\n                ),\n            ],\n            header_info: HeaderInfo::default(),\n        };\n        let j = json!(sitelinks);\n        assert_eq!(j[\"enwiki\"][\"title\"].as_str().unwrap(), \"Douglas Adams\");\n        assert_eq!(j[\"dewiki\"][\"title\"].as_str().unwrap(), \"Douglas Adams\");\n    }\n\n    #[test]\n    fn test_sitelinks_set_wiki() {\n        let mut sitelinks = Sitelinks::default();\n        sitelinks.set_wiki(Sitelink::new_complete(\n            \"enwiki\".to_string(),\n            \"Douglas Adams\".to_string(),\n            vec![],\n            Some(\"https://en.wikipedia.org/wiki/Douglas_Adams\".to_string()),\n        ));\n        assert_eq!(\n            sitelinks.get_wiki(\"enwiki\").unwrap().title(),\n            \"Douglas Adams\"\n        );\n        sitelinks.set_wiki(Sitelink::new_complete(\n            \"enwiki\".to_string(),\n            \"Douglas Noël Adams\".to_string(),\n            vec![],\n            Some(\"https://en.wikipedia.org/wiki/Douglas_Adams\".to_string()),\n        ));\n        assert_eq!(\n            sitelinks.get_wiki(\"enwiki\").unwrap().title(),\n            \"Douglas Noël Adams\"\n        );\n    }\n\n    #[test]\n    fn test_sitelinks_get_wiki() {\n        let sitelinks = Sitelinks {\n            sitelinks: vec![\n                Sitelink::new_complete(\n                    \"enwiki\".to_string(),\n                    \"Douglas Adams\".to_string(),\n                    vec![],\n                    Some(\"https://en.wikipedia.org/wiki/Douglas_Adams\".to_string()),\n                ),\n                Sitelink::new_complete(\n                    \"dewiki\".to_string(),\n                    \"Douglas Adams\".to_string(),\n                    vec![],\n                    Some(\"https://de.wikipedia.org/wiki/Douglas_Adams\".to_string()),\n                ),\n            ],\n            header_info: HeaderInfo::default(),\n        };\n        assert_eq!(\n            sitelinks.get_wiki(\"enwiki\").unwrap().title(),\n            \"Douglas Adams\"\n        );\n        assert_eq!(\n            sitelinks.get_wiki(\"dewiki\").unwrap().title(),\n            \"Douglas Adams\"\n        );\n        assert!(sitelinks.get_wiki(\"frwiki\").is_none());\n    }\n\n    #[test]\n    fn test_patch() {\n        let mut s1 = Sitelinks::default();\n        s1.set_wiki(Sitelink::new(\"enwiki\", \"Foo\"));\n        s1.set_wiki(Sitelink::new(\"frwiki\", \"Le Foo\"));\n        let mut s2 = Sitelinks::default();\n        s2.set_wiki(Sitelink::new(\"dewiki\", \"Bar\"));\n        s2.set_wiki(Sitelink::new(\"enwiki\", \"Baz\"));\n\n        let patch = s2.patch(\u0026s1).unwrap();\n        let patch_json = json!(patch);\n        assert_eq!(\n            patch_json,\n            json!({\"patch\":[\n                {\"op\":\"add\",\"path\":\"/dewiki\",\"value\":{\"badges\":[],\"title\":\"Bar\"}},\n                {\"op\":\"replace\",\"path\":\"/enwiki/title\",\"value\":\"Baz\"},\n                {\"op\":\"remove\",\"path\":\"/frwiki\"}\n            ]})\n        );\n    }\n\n    #[test]\n    fn test_len() {\n        let mut sitelinks = Sitelinks::default();\n        assert_eq!(sitelinks.len(), 0);\n        sitelinks.set_wiki(Sitelink::new(\"enwiki\", \"Foo\"));\n        assert_eq!(sitelinks.len(), 1);\n    }\n\n    #[test]\n    fn test_is_empty() {\n        let mut sitelinks = Sitelinks::default();\n        assert!(sitelinks.is_empty());\n        sitelinks.set_wiki(Sitelink::new(\"enwiki\", \"Foo\"));\n        assert!(!sitelinks.is_empty());\n    }\n\n    #[test]\n    fn test_get_rest_api_path() {\n        let sitelinks = Sitelinks::default();\n        assert_eq!(\n            sitelinks\n                .get_my_rest_api_path(\u0026EntityId::item(\"Q42\"))\n                .unwrap(),\n            \"/entities/items/Q42/sitelinks\"\n        );\n    }\n\n    #[test]\n    fn test_header_info() {\n        let sitelinks = Sitelinks::default();\n        assert_eq!(sitelinks.header_info(), \u0026HeaderInfo::default());\n    }\n\n    #[test]\n    fn test_serialize() {\n        let sitelinks = Sitelinks {\n            sitelinks: vec![\n                Sitelink::new_complete(\n                    \"enwiki\".to_string(),\n                    \"Douglas Adams\".to_string(),\n                    vec![],\n                    Some(\"https://en.wikipedia.org/wiki/Douglas_Adams\".to_string()),\n                ),\n                Sitelink::new_complete(\n                    \"dewiki\".to_string(),\n                    \"Douglas Adams\".to_string(),\n                    vec![],\n                    Some(\"https://de.wikipedia.org/wiki/Douglas_Adams\".to_string()),\n                ),\n            ],\n            header_info: HeaderInfo::default(),\n        };\n        let j = serde_json::to_value(\u0026sitelinks).unwrap();\n        assert_eq!(j[\"enwiki\"][\"title\"].as_str().unwrap(), \"Douglas Adams\");\n        assert_eq!(j[\"dewiki\"][\"title\"].as_str().unwrap(), \"Douglas Adams\");\n    }\n\n    #[test]\n    fn test_sitelinks() {\n        let mut s = Sitelinks::default();\n        s.set_wiki(Sitelink::new(\"enwiki\", \"foo\"));\n        s.set_wiki(Sitelink::new(\"dewiki\", \"bar\"));\n        let mut pages = s\n            .sitelinks()\n            .iter()\n            .map(|s| s.title().to_string())\n            .collect::\u003cVec\u003cString\u003e\u003e();\n        pages.sort();\n        assert_eq!(pages, vec![\"bar\", \"foo\"]);\n    }\n\n    #[test]\n    fn test_remove_wiki() {\n        let mut s = Sitelinks::default();\n        s.set_wiki(Sitelink::new(\"enwiki\", \"foo\"));\n        s.set_wiki(Sitelink::new(\"dewiki\", \"bar\"));\n        s.remove_wiki(\"enwiki\");\n        let pages = s\n            .sitelinks()\n            .iter()\n            .map(|s| s.title().to_string())\n            .collect::\u003cVec\u003cString\u003e\u003e();\n        assert_eq!(pages, vec![\"bar\"]);\n    }\n}\n","traces":[{"line":19,"address":[],"length":0,"stats":{"Line":2}},{"line":20,"address":[],"length":0,"stats":{"Line":2}},{"line":21,"address":[],"length":0,"stats":{"Line":2}},{"line":22,"address":[],"length":0,"stats":{"Line":2}},{"line":28,"address":[],"length":0,"stats":{"Line":1}},{"line":29,"address":[],"length":0,"stats":{"Line":1}},{"line":32,"address":[],"length":0,"stats":{"Line":11}},{"line":33,"address":[],"length":0,"stats":{"Line":22}},{"line":35,"address":[],"length":0,"stats":{"Line":11}},{"line":36,"address":[],"length":0,"stats":{"Line":11}},{"line":37,"address":[],"length":0,"stats":{"Line":11}},{"line":40,"address":[],"length":0,"stats":{"Line":1623}},{"line":56,"address":[],"length":0,"stats":{"Line":2}},{"line":57,"address":[],"length":0,"stats":{"Line":1}},{"line":64,"address":[],"length":0,"stats":{"Line":2}},{"line":65,"address":[],"length":0,"stats":{"Line":2}},{"line":69,"address":[],"length":0,"stats":{"Line":8}},{"line":70,"address":[],"length":0,"stats":{"Line":8}},{"line":71,"address":[],"length":0,"stats":{"Line":107}},{"line":75,"address":[],"length":0,"stats":{"Line":13}},{"line":76,"address":[],"length":0,"stats":{"Line":31}},{"line":77,"address":[],"length":0,"stats":{"Line":13}},{"line":81,"address":[],"length":0,"stats":{"Line":1}},{"line":82,"address":[],"length":0,"stats":{"Line":1}},{"line":83,"address":[],"length":0,"stats":{"Line":4}},{"line":87,"address":[],"length":0,"stats":{"Line":4}},{"line":88,"address":[],"length":0,"stats":{"Line":4}},{"line":92,"address":[],"length":0,"stats":{"Line":10}},{"line":93,"address":[],"length":0,"stats":{"Line":10}},{"line":97,"address":[],"length":0,"stats":{"Line":2}},{"line":98,"address":[],"length":0,"stats":{"Line":2}},{"line":99,"address":[],"length":0,"stats":{"Line":4}},{"line":105,"address":[],"length":0,"stats":{"Line":9}},{"line":109,"address":[],"length":0,"stats":{"Line":18}},{"line":110,"address":[],"length":0,"stats":{"Line":757}},{"line":111,"address":[],"length":0,"stats":{"Line":374}},{"line":113,"address":[],"length":0,"stats":{"Line":9}}],"covered":37,"coverable":37},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","sitelinks_patch.rs"],"content":"use crate::{\n    patch_entry::PatchEntry, EntityId, HttpMisc, Patch, PatchApply, RestApiError, Sitelinks,\n};\nuse async_trait::async_trait;\nuse serde::Serialize;\nuse serde_json::Value;\n\n#[derive(Debug, Clone, Default, PartialEq, Serialize)]\npub struct SitelinksPatch {\n    patch: Vec\u003cPatchEntry\u003e,\n}\n\nimpl SitelinksPatch {\n    /// Adds a command to replace the title of a sitelink\n    pub fn replace_title\u003cS1: Into\u003cString\u003e, S2: Into\u003cString\u003e\u003e(\u0026mut self, wiki: S1, value: S2) {\n        self.replace(format!(\"/{}/title\", wiki.into()), value.into().into());\n    }\n\n    /// Generates a patch from JSON, presumably from `json_patch`\n    pub fn from_json(j: \u0026Value) -\u003e Result\u003cSelf, RestApiError\u003e {\n        let pe = j\n            .as_array()\n            .ok_or(RestApiError::WrongType {\n                field: \"SitelinksPatch\".into(),\n                j: j.to_owned(),\n            })?\n            .iter()\n            .map(|x| serde_json::from_value(x.clone()).map_err(|e| e.into()))\n            .collect::\u003cResult\u003cVec\u003cPatchEntry\u003e, RestApiError\u003e\u003e()?;\n        Ok(Self { patch: pe })\n    }\n}\n\nimpl Patch for SitelinksPatch {\n    fn patch(\u0026self) -\u003e \u0026Vec\u003cPatchEntry\u003e {\n        \u0026self.patch\n    }\n\n    fn patch_mut(\u0026mut self) -\u003e \u0026mut Vec\u003cPatchEntry\u003e {\n        \u0026mut self.patch\n    }\n}\n\n#[async_trait]\nimpl PatchApply\u003cSitelinks\u003e for SitelinksPatch {}\n\nimpl HttpMisc for SitelinksPatch {\n    fn get_my_rest_api_path(\u0026self, id: \u0026EntityId) -\u003e Result\u003cString, RestApiError\u003e {\n        Ok(format!(\"/entities/{}/{id}/sitelinks\", id.group()?))\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use crate::RestApi;\n    use serde_json::{json, Value};\n    use wiremock::matchers::{bearer_token, body_partial_json, header, method, path};\n    use wiremock::{Mock, MockServer, ResponseTemplate};\n\n    use super::*;\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_sitelinks_patch() {\n        let id = \"Q42\";\n        let page_title = \"Foo Bar\";\n        let v = std::fs::read_to_string(\"test_data/Q42.json\").unwrap();\n        let v: Value = serde_json::from_str(\u0026v).unwrap();\n        let mut new_sitelinks = v[\"sitelinks\"].clone();\n        new_sitelinks[\"enwiki\"][\"title\"] = json!(page_title);\n\n        let mock_path = format!(\"/w/rest.php/wikibase/v1/entities/items/{id}/sitelinks\");\n        let mock_server = MockServer::start().await;\n        let token = \"FAKE_TOKEN\";\n        Mock::given(body_partial_json(\n            json!({\"patch\":[{\"op\": \"replace\",\"path\": \"/enwiki/title\",\"value\": page_title}]}),\n        ))\n        .and(method(\"PATCH\"))\n        .and(path(\u0026mock_path))\n        .and(bearer_token(token))\n        .and(header(\"content-type\", \"application/json-patch+json\"))\n        .respond_with(\n            ResponseTemplate::new(200)\n                .insert_header(\"ETag\", \"12345\")\n                .set_body_json(new_sitelinks),\n        )\n        .mount(\u0026mock_server)\n        .await;\n        let mut api = RestApi::builder(\u0026(mock_server.uri() + \"/w/rest.php\"))\n            .unwrap()\n            .with_access_token(token)\n            .build();\n\n        // Apply patch and check API response\n        let id = EntityId::new(id).unwrap();\n        let mut patch = SitelinksPatch::default();\n        patch.replace_title(\"enwiki\", page_title);\n        let sl = patch.apply(\u0026id, \u0026mut api).await.unwrap();\n        assert_eq!(sl.get_wiki(\"enwiki\").unwrap().title(), page_title);\n    }\n\n    #[test]\n    fn test_replace_title() {\n        let mut patch = SitelinksPatch::default();\n        patch.replace_title(\"enwiki\", \"Foo Bar\");\n        assert_eq!(\n            patch.patch(),\n            \u0026[PatchEntry::new(\n                \"replace\",\n                \"/enwiki/title\",\n                json!(\"Foo Bar\")\n            )]\n        );\n    }\n}\n","traces":[{"line":15,"address":[],"length":0,"stats":{"Line":2}},{"line":16,"address":[],"length":0,"stats":{"Line":2}},{"line":20,"address":[],"length":0,"stats":{"Line":2}},{"line":21,"address":[],"length":0,"stats":{"Line":4}},{"line":23,"address":[],"length":0,"stats":{"Line":2}},{"line":24,"address":[],"length":0,"stats":{"Line":2}},{"line":25,"address":[],"length":0,"stats":{"Line":2}},{"line":28,"address":[],"length":0,"stats":{"Line":8}},{"line":35,"address":[],"length":0,"stats":{"Line":3}},{"line":36,"address":[],"length":0,"stats":{"Line":3}},{"line":39,"address":[],"length":0,"stats":{"Line":2}},{"line":40,"address":[],"length":0,"stats":{"Line":2}},{"line":48,"address":[],"length":0,"stats":{"Line":1}},{"line":49,"address":[],"length":0,"stats":{"Line":2}}],"covered":14,"coverable":14},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","statement.rs"],"content":"use crate::{\n    property_value::{PropertyType, PropertyValue},\n    statement_patch::StatementPatch,\n    statement_value::StatementValue,\n    EditMetadata, EntityId, FromJson, HeaderInfo, HttpMisc, Reference, RestApi, RestApiError,\n    RevisionMatch, StatementRank,\n};\nuse derivative::Derivative;\nuse serde::ser::{Serialize, SerializeStruct, Serializer};\nuse serde_json::{json, Value};\nuse uuid::Uuid;\n\n#[derive(Derivative, Debug, Clone, Default)]\n#[derivative(PartialEq)]\npub struct Statement {\n    statement_id: Option\u003cString\u003e,\n    property: PropertyType,\n    value: StatementValue,\n    rank: StatementRank,\n    references: Vec\u003cReference\u003e,\n    qualifiers: Vec\u003cPropertyValue\u003e,\n    #[derivative(PartialEq = \"ignore\")]\n    header_info: HeaderInfo,\n}\n\nimpl Serialize for Statement {\n    fn serialize\u003cS\u003e(\u0026self, serializer: S) -\u003e Result\u003cS::Ok, S::Error\u003e\n    where\n        S: Serializer,\n    {\n        // #lizard forgives the complexity\n        let mut fields = 5;\n        if self.statement_id.is_some() {\n            fields += 1;\n        }\n        let mut s = serializer.serialize_struct(\"Statement\", fields)?;\n        if let Some(id) = \u0026self.statement_id {\n            s.serialize_field(\"id\", \u0026id)?;\n        }\n        s.serialize_field(\"property\", \u0026self.property)?;\n        s.serialize_field(\"value\", \u0026self.value)?;\n        s.serialize_field(\"rank\", \u0026self.rank.as_str())?;\n        s.serialize_field(\"references\", \u0026self.references)?;\n        s.serialize_field(\"qualifiers\", \u0026self.qualifiers)?;\n        s.end()\n    }\n}\n\nimpl HttpMisc for Statement {\n    fn get_my_rest_api_path(\u0026self, _id: \u0026EntityId) -\u003e Result\u003cString, RestApiError\u003e {\n        let id = self.id().ok_or(RestApiError::MissingId)?;\n        Self::get_rest_api_path_from_id(id)\n    }\n}\n\n// GET/PUT/POST/DELETE\nimpl Statement {\n    /// Convenience function to create a new string statement\n    pub fn new_string(property: \u0026str, s: \u0026str) -\u003e Self {\n        Self {\n            statement_id: None,\n            property: PropertyType::property(property),\n            value: StatementValue::new_string(s),\n            rank: StatementRank::Normal,\n            references: vec![],\n            qualifiers: vec![],\n            header_info: HeaderInfo::default(),\n        }\n    }\n\n    /// Generates a new statement ID\n    pub fn new_id_for_entity(\u0026mut self, entity_id: \u0026EntityId) {\n        let uuid = Uuid::new_v4().to_string().to_ascii_uppercase();\n        self.set_id(Some(format!(\"{entity_id}${uuid}\")));\n    }\n\n    /// Fetches a statement from the API\n    ///\n    /// # Examples\n    ///\n    /// ```no_run\n    /// use wikibase_rest_api::prelude::*;\n    /// #[tokio::main]\n    /// async fn main() {\n    ///     let api = RestApi::wikidata().unwrap();\n    ///     let statement = Statement::get(\"Q42$F078E5B3-F9A8-480E-B7AC-D97778CBBEF9\", \u0026api).await.unwrap();\n    ///     println!(\"{:?}\", statement);\n    /// }\n    /// ```\n    pub async fn get(statement_id: \u0026str, api: \u0026RestApi) -\u003e Result\u003cSelf, RestApiError\u003e {\n        Self::get_match(statement_id, api, RevisionMatch::default()).await\n    }\n\n    /// Creates a new statement via the API. And `id` needs to be set.\n    ///\n    /// Returns a `Statement`, which is **not** the same as the input `Statement`, but should be identical.\n    ///\n    /// # Examples\n    ///\n    /// ```no_run\n    /// use wikibase_rest_api::prelude::*;\n    /// #[tokio::main]\n    /// async fn main() {\n    ///     let mut api = RestApi::wikidata().unwrap(); // Use Wikidata API\n    ///     let mut statement = Statement::new_string(\"P31\", \"Q42\"); // New statement\n    ///     statement.new_id_for_entity(\u0026EntityId::new(\"Q13406268\").unwrap()); // New statement ID for entity\n    ///     statement = statement.put(\u0026mut api).await.unwrap(); // Add statement to entity\n    /// }\n    pub async fn put(\u0026self, api: \u0026mut RestApi) -\u003e Result\u003cSelf, RestApiError\u003e {\n        self.put_match(api, EditMetadata::default()).await\n    }\n\n    /// Deletes a statement via the API\n    pub async fn delete(\u0026self, api: \u0026mut RestApi) -\u003e Result\u003c(), RestApiError\u003e {\n        self.delete_match(api, EditMetadata::default()).await\n    }\n\n    /// Fetches a statement from the API with revision matching\n    pub async fn get_match(\n        statement_id: \u0026str,\n        api: \u0026RestApi,\n        rm: RevisionMatch,\n    ) -\u003e Result\u003cSelf, RestApiError\u003e {\n        let path = Self::get_rest_api_path_from_id(statement_id)?;\n        let (j, header_info) = Self::get_match_internal(api, \u0026path, rm).await?;\n        Self::from_json_header_info(\u0026j, header_info)\n    }\n\n    /// Creates a new statement via the API. And `id` needs to be set.\n    ///\n    /// Returns a `Statement`, which is **not** the same as the input `Statement`, but should be identical.\n    ///\n    /// # Examples\n    ///\n    /// ```no_run\n    /// use wikibase_rest_api::prelude::*;\n    /// #[tokio::main]\n    /// async fn main() {\n    ///     let mut api = RestApi::wikidata().unwrap(); // Use Wikidata API\n    ///     let mut statement = Statement::new_string(\"P31\", \"Q42\"); // New statement\n    ///     statement.new_id_for_entity(\u0026EntityId::new(\"Q13406268\").unwrap()); // New statement ID for entity\n    ///     statement = statement.put_match(\u0026mut api, EditMetadata::default()).await.unwrap();\n    /// }\n    pub async fn put_match(\n        \u0026self,\n        api: \u0026mut RestApi,\n        em: EditMetadata,\n    ) -\u003e Result\u003cSelf, RestApiError\u003e {\n        let j0 = json!({\"statement\": self});\n        let request = self\n            .generate_json_request(\u0026EntityId::None, reqwest::Method::PUT, j0, api, \u0026em)\n            .await?;\n        let response = api.execute(request).await?;\n        let header_info = HeaderInfo::from_header(response.headers());\n        let j: Value = response.error_for_status()?.json().await?;\n        Self::from_json_header_info(\u0026j, header_info)\n    }\n\n    /// Deletes a statement via the API with revision matching\n    pub async fn delete_match(\n        \u0026self,\n        api: \u0026mut RestApi,\n        em: EditMetadata,\n    ) -\u003e Result\u003c(), RestApiError\u003e {\n        let j0 = json!({});\n        let request = self\n            .generate_json_request(\u0026EntityId::None, reqwest::Method::DELETE, j0, api, \u0026em)\n            .await?;\n        let message: Value = api\n            .execute(request)\n            .await?\n            .error_for_status()?\n            .json()\n            .await?;\n        if message == \"Statement deleted\" {\n            return Ok(());\n        }\n        Err(RestApiError::UnexpectedResponse(message))\n    }\n\n    /// Sets the statement property\n    pub fn set_property(\u0026mut self, property: PropertyType) {\n        self.property = property;\n    }\n\n    /// Sets the statement value\n    pub fn set_value(\u0026mut self, value: StatementValue) {\n        self.value = value;\n    }\n\n    /// Sets the statement rank\n    pub const fn set_rank(\u0026mut self, rank: StatementRank) {\n        self.rank = rank;\n    }\n\n    /// Returns the references of the statement, mutable\n    pub const fn references_mut(\u0026mut self) -\u003e \u0026mut Vec\u003cReference\u003e {\n        \u0026mut self.references\n    }\n\n    /// Returns the qualifiers of the statement, mutable\n    pub const fn qualifiers_mut(\u0026mut self) -\u003e \u0026mut Vec\u003cPropertyValue\u003e {\n        \u0026mut self.qualifiers\n    }\n\n    fn get_rest_api_path_from_id(id: \u0026str) -\u003e Result\u003cString, RestApiError\u003e {\n        Ok(format!(\"/statements/{id}\"))\n    }\n}\n\n// FromJson helper function\nimpl Statement {\n    fn generate_id_rank_from_json_header_info(\n        j: \u0026Value,\n    ) -\u003e Result\u003c(String, StatementRank), RestApiError\u003e {\n        let id = j[\"id\"]\n            .as_str()\n            .ok_or(RestApiError::MissingOrInvalidField {\n                field: \"id\".into(),\n                j: j.to_owned(),\n            })?\n            .to_string();\n        let rank_text = j[\"rank\"]\n            .as_str()\n            .ok_or(RestApiError::MissingOrInvalidField {\n                field: \"rank\".into(),\n                j: j.to_owned(),\n            })?;\n        let rank = StatementRank::new(rank_text)?;\n        Ok((id, rank))\n    }\n}\n\nimpl FromJson for Statement {\n    fn header_info(\u0026self) -\u003e \u0026HeaderInfo {\n        \u0026self.header_info\n    }\n\n    fn from_json_header_info(j: \u0026Value, header_info: HeaderInfo) -\u003e Result\u003cSelf, RestApiError\u003e {\n        let (id, rank) = Self::generate_id_rank_from_json_header_info(j)?;\n        let property = PropertyType::from_json(\u0026j[\"property\"])?;\n        let value = StatementValue::from_json(\u0026j[\"value\"])?;\n        Ok(Statement {\n            statement_id: Some(id.to_string()),\n            property,\n            rank,\n            value,\n            references: Self::references_from_json(\u0026j[\"references\"])?,\n            qualifiers: Self::qualifiers_from_json(\u0026j[\"qualifiers\"])?,\n            header_info,\n        })\n    }\n}\n\n// The rest\nimpl Statement {\n    /// Generates a patch to transform `other` into `self`\n    pub fn patch(\u0026self, other: \u0026Self) -\u003e Result\u003cStatementPatch, RestApiError\u003e {\n        let statement_id = match self.statement_id {\n            Some(ref id) =\u003e id,\n            None =\u003e return Err(RestApiError::MissingId),\n        };\n        let patch = json_patch::diff(\u0026json!(\u0026other), \u0026json!(\u0026self));\n        let patch = StatementPatch::from_json(statement_id, \u0026json!(patch))?;\n        Ok(patch)\n    }\n\n    fn references_from_json(j: \u0026Value) -\u003e Result\u003cVec\u003cReference\u003e, RestApiError\u003e {\n        let mut ret = vec![];\n        let array = j.as_array().ok_or(RestApiError::WrongType {\n            field: \"references\".into(),\n            j: j.to_owned(),\n        })?;\n        for reference in array {\n            let ref_from_json = Reference::from_json(reference)?;\n            ret.push(ref_from_json);\n        }\n        Ok(ret)\n    }\n\n    fn qualifiers_from_json(j: \u0026Value) -\u003e Result\u003cVec\u003cPropertyValue\u003e, RestApiError\u003e {\n        let array = j.as_array().ok_or(RestApiError::WrongType {\n            field: \"qualifiers\".into(),\n            j: j.to_owned(),\n        })?;\n        let mut ret = vec![];\n        for pv in array.iter() {\n            let property = PropertyType::from_json(\u0026pv[\"property\"])?;\n            let value = StatementValue::from_json(\u0026pv[\"value\"])?;\n            ret.push(PropertyValue::new(property, value));\n        }\n        Ok(ret)\n    }\n\n    /// Returns the statement ID\n    pub const fn id(\u0026self) -\u003e Option\u003c\u0026String\u003e {\n        self.statement_id.as_ref()\n    }\n\n    /// Sets the statement ID\n    pub fn set_id(\u0026mut self, id: Option\u003cString\u003e) {\n        self.statement_id = id;\n    }\n\n    /// Returns the statement property\n    pub const fn property(\u0026self) -\u003e \u0026PropertyType {\n        \u0026self.property\n    }\n\n    /// Returns the statement value\n    pub const fn value(\u0026self) -\u003e \u0026StatementValue {\n        \u0026self.value\n    }\n\n    /// Returns the statement rank\n    pub const fn rank(\u0026self) -\u003e \u0026StatementRank {\n        \u0026self.rank\n    }\n\n    /// Returns the references of the statement\n    pub fn references(\u0026self) -\u003e \u0026[Reference] {\n        \u0026self.references\n    }\n\n    /// Returns the qualifiers of the statement\n    pub fn qualifiers(\u0026self) -\u003e \u0026[PropertyValue] {\n        \u0026self.qualifiers\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::statement_value_content::StatementValueContent;\n    use wiremock::matchers::{body_partial_json, method, path};\n    use wiremock::{Mock, MockServer, ResponseTemplate};\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_statement_get() {\n        // #lizard forgives the complexity\n        let v = std::fs::read_to_string(\"test_data/test_statement_get.json\").unwrap();\n        let v: Value = serde_json::from_str(\u0026v).unwrap();\n        let statement_id = v[\"id\"].as_str().unwrap().to_string();\n        let mock_path = format!(\"/w/rest.php/wikibase/v1/statements/{statement_id}\",);\n\n        let mock_server = MockServer::start().await;\n        Mock::given(method(\"GET\"))\n            .and(path(\u0026mock_path))\n            .respond_with(ResponseTemplate::new(200).set_body_json(v))\n            .mount(\u0026mock_server)\n            .await;\n\n        let api = RestApi::builder(\u0026(mock_server.uri() + \"/w/rest.php\"))\n            .unwrap()\n            .build();\n        let statement = Statement::get(\u0026statement_id, \u0026api).await.unwrap();\n        assert_eq!(statement.id().unwrap(), \u0026statement_id);\n        assert_eq!(\n            *statement.value(),\n            StatementValue::Value(StatementValueContent::String(\"Q42\".to_string()))\n        );\n    }\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_statement_put() {\n        // #lizard forgives the complexity\n        let v = std::fs::read_to_string(\"test_data/test_statement_put.json\").unwrap();\n        let v: Value = serde_json::from_str(\u0026v).unwrap();\n        let statement_id = v[\"before\"][\"id\"].as_str().unwrap();\n        let mock_path = format!(\"/w/rest.php/wikibase/v1/statements/{statement_id}\");\n        let mock_value_before = StatementValue::Value(StatementValueContent::String(\n            v[\"before\"][\"value\"][\"content\"]\n                .as_str()\n                .unwrap()\n                .to_string(),\n        ));\n        let mock_value_after = StatementValue::Value(StatementValueContent::String(\n            v[\"after\"][\"value\"][\"content\"].as_str().unwrap().to_string(),\n        ));\n\n        let mock_server = MockServer::start().await;\n        Mock::given(method(\"GET\"))\n            .and(path(\u0026mock_path))\n            .respond_with(ResponseTemplate::new(200).set_body_json(\u0026v[\"before\"]))\n            .mount(\u0026mock_server)\n            .await;\n        Mock::given(body_partial_json(json!({\"statement\": \u0026v[\"after\"]})))\n            .and(method(\"PUT\"))\n            .and(path(\u0026mock_path))\n            .respond_with(ResponseTemplate::new(200).set_body_json(\u0026v[\"after\"]))\n            .mount(\u0026mock_server)\n            .await;\n        let mut api = RestApi::builder(\u0026(mock_server.uri() + \"/w/rest.php\"))\n            .unwrap()\n            .build();\n\n        // Get and check statement\n        let mut statement = Statement::get(statement_id, \u0026api).await.unwrap();\n        assert_eq!(*statement.value(), mock_value_before);\n\n        // Change statement\n        statement.value = mock_value_after.to_owned();\n\n        // PUT, and check return value\n        let statement = statement.put(\u0026mut api).await.unwrap();\n        assert_eq!(*statement.value(), mock_value_after);\n    }\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_statement_delete() {\n        // #lizard forgives the complexity\n        let statement_id = \"Q42$F078E5B3-F9A8-480E-B7AC-D97778CBBEF9\";\n        let mock_path = format!(\"/w/rest.php/wikibase/v1/statements/{statement_id}\");\n\n        let statement_id2 = \"no_such_statement\";\n        let mock_path2 = format!(\"/w/rest.php/wikibase/v1/statements/{statement_id2}\");\n\n        let mock_server = MockServer::start().await;\n        Mock::given(method(\"DELETE\"))\n            .and(path(\u0026mock_path))\n            .respond_with(ResponseTemplate::new(200).set_body_json(\"Statement deleted\"))\n            .mount(\u0026mock_server)\n            .await;\n        Mock::given(method(\"DELETE\"))\n            .and(path(\u0026mock_path2))\n            .respond_with(ResponseTemplate::new(200).set_body_json(json!({\n              \"code\": \"invalid-statement-id\",\n              \"message\": format!(\"Not a valid statement ID: {statement_id2}\")\n            })))\n            .mount(\u0026mock_server)\n            .await;\n        let mut api = RestApi::builder(\u0026(mock_server.uri() + \"/w/rest.php\"))\n            .unwrap()\n            .build();\n\n        // Delete\n        let mut statement0 = Statement::new_string(\"P31\", \"Q42\");\n        statement0.set_id(Some(statement_id.to_string()));\n        assert!(statement0.delete(\u0026mut api).await.is_ok());\n\n        // Delete (error)\n        let mut statement1 = Statement::new_string(\"P31\", \"Q42\");\n        statement1.set_id(Some(statement_id2.to_string()));\n        let result = statement1.delete(\u0026mut api).await.unwrap_err().to_string();\n        assert_eq!(\n            result,\n            r#\"Unexpected response: {\"code\":\"invalid-statement-id\",\"message\":\"Not a valid statement ID: no_such_statement\"}\"#\n        );\n    }\n\n    #[test]\n    fn test_patch() {\n        let mut s1 = Statement::default();\n        s1.set_id(Some(\"Q42$F078E5B3-F9A8-480E-B7AC-D97778CBBEF9\".to_string()));\n        s1.set_property(PropertyType::property(\"P31\"));\n        s1.set_value(StatementValue::new_string(\"Q42\"));\n        let mut s2 = s1.clone();\n        s2.set_property(PropertyType::property(\"P32\"));\n        s2.set_value(StatementValue::new_string(\"Q43\"));\n        let patch = s2.patch(\u0026s1).unwrap();\n        let patch_json = json!(patch);\n        assert_eq!(\n            patch_json,\n            json!({\"patch\":[{\"op\":\"replace\",\"path\":\"/property/id\",\"value\":\"P32\"},{\"op\":\"replace\",\"path\":\"/value/content\",\"value\":\"Q43\"}],\"statement_id\":\"Q42$F078E5B3-F9A8-480E-B7AC-D97778CBBEF9\"})\n        );\n    }\n\n    #[test]\n    fn test_set_rank() {\n        let mut s = Statement::default();\n        assert_eq!(s.rank(), \u0026StatementRank::Normal);\n        s.set_rank(StatementRank::Preferred);\n        assert_eq!(s.rank(), \u0026StatementRank::Preferred);\n    }\n\n    #[test]\n    fn test_references_mut() {\n        let mut s = Statement::default();\n        assert_eq!(s.references_mut().len(), 0);\n        s.references_mut().push(Reference::default());\n        assert_eq!(s.references_mut().len(), 1);\n    }\n\n    #[test]\n    fn test_qualifiers_mut() {\n        let mut s = Statement::default();\n        assert_eq!(s.qualifiers_mut().len(), 0);\n        s.qualifiers_mut().push(PropertyValue::new(\n            PropertyType::property(\"P31\"),\n            StatementValue::new_string(\"Q42\"),\n        ));\n        assert_eq!(s.qualifiers_mut().len(), 1);\n    }\n\n    #[test]\n    fn test_rank() {\n        let s = Statement::default();\n        assert_eq!(s.rank(), \u0026StatementRank::Normal);\n    }\n\n    #[test]\n    fn test_references() {\n        let s = Statement::default();\n        assert_eq!(s.references().len(), 0);\n    }\n\n    #[test]\n    fn test_patch_no_id() {\n        let s1 = Statement::default();\n        let s2 = Statement::default();\n        let patch = s2.patch(\u0026s1);\n        assert!(patch.is_err());\n    }\n\n    #[test]\n    fn test_references_from_json_not_array() {\n        let j = json!(123);\n        assert!(Statement::references_from_json(\u0026j).is_err());\n    }\n\n    #[test]\n    fn test_references_from_json_not_a_reference() {\n        let j = json!([123]);\n        assert!(Statement::references_from_json(\u0026j).is_err());\n    }\n\n    #[test]\n    fn test_references_from_json() {\n        let j = json!([\n            Reference::default(),\n            Reference::default(),\n            Reference::default()\n        ]);\n        let references = Statement::references_from_json(\u0026j).unwrap();\n        assert_eq!(references.len(), 3);\n    }\n\n    #[test]\n    fn test_new_id_for_entity() {\n        let entity_id = EntityId::new(\"Q42\").unwrap();\n        let mut statement = Statement::default();\n        statement.new_id_for_entity(\u0026entity_id);\n        assert_eq!(\u0026statement.id().unwrap()[0..4], \"Q42$\");\n    }\n}\n","traces":[{"line":27,"address":[],"length":0,"stats":{"Line":1102}},{"line":32,"address":[],"length":0,"stats":{"Line":1102}},{"line":33,"address":[],"length":0,"stats":{"Line":2203}},{"line":34,"address":[],"length":0,"stats":{"Line":1101}},{"line":36,"address":[],"length":0,"stats":{"Line":2204}},{"line":37,"address":[],"length":0,"stats":{"Line":1101}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":1102}},{"line":41,"address":[],"length":0,"stats":{"Line":1102}},{"line":42,"address":[],"length":0,"stats":{"Line":1102}},{"line":43,"address":[],"length":0,"stats":{"Line":1102}},{"line":44,"address":[],"length":0,"stats":{"Line":1102}},{"line":45,"address":[],"length":0,"stats":{"Line":1102}},{"line":50,"address":[],"length":0,"stats":{"Line":3}},{"line":51,"address":[],"length":0,"stats":{"Line":6}},{"line":59,"address":[],"length":0,"stats":{"Line":4}},{"line":62,"address":[],"length":0,"stats":{"Line":4}},{"line":63,"address":[],"length":0,"stats":{"Line":4}},{"line":65,"address":[],"length":0,"stats":{"Line":4}},{"line":66,"address":[],"length":0,"stats":{"Line":4}},{"line":67,"address":[],"length":0,"stats":{"Line":4}},{"line":72,"address":[],"length":0,"stats":{"Line":1}},{"line":73,"address":[],"length":0,"stats":{"Line":1}},{"line":74,"address":[],"length":0,"stats":{"Line":1}},{"line":90,"address":[],"length":0,"stats":{"Line":4}},{"line":91,"address":[],"length":0,"stats":{"Line":2}},{"line":109,"address":[],"length":0,"stats":{"Line":2}},{"line":110,"address":[],"length":0,"stats":{"Line":1}},{"line":114,"address":[],"length":0,"stats":{"Line":4}},{"line":115,"address":[],"length":0,"stats":{"Line":2}},{"line":119,"address":[],"length":0,"stats":{"Line":2}},{"line":124,"address":[],"length":0,"stats":{"Line":4}},{"line":125,"address":[],"length":0,"stats":{"Line":2}},{"line":144,"address":[],"length":0,"stats":{"Line":1}},{"line":149,"address":[],"length":0,"stats":{"Line":1}},{"line":150,"address":[],"length":0,"stats":{"Line":2}},{"line":151,"address":[],"length":0,"stats":{"Line":1}},{"line":152,"address":[],"length":0,"stats":{"Line":1}},{"line":153,"address":[],"length":0,"stats":{"Line":1}},{"line":155,"address":[],"length":0,"stats":{"Line":2}},{"line":160,"address":[],"length":0,"stats":{"Line":2}},{"line":165,"address":[],"length":0,"stats":{"Line":2}},{"line":166,"address":[],"length":0,"stats":{"Line":4}},{"line":167,"address":[],"length":0,"stats":{"Line":2}},{"line":168,"address":[],"length":0,"stats":{"Line":2}},{"line":169,"address":[],"length":0,"stats":{"Line":2}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":2}},{"line":176,"address":[],"length":0,"stats":{"Line":1}},{"line":178,"address":[],"length":0,"stats":{"Line":1}},{"line":182,"address":[],"length":0,"stats":{"Line":15}},{"line":183,"address":[],"length":0,"stats":{"Line":15}},{"line":187,"address":[],"length":0,"stats":{"Line":3}},{"line":188,"address":[],"length":0,"stats":{"Line":3}},{"line":192,"address":[],"length":0,"stats":{"Line":1}},{"line":193,"address":[],"length":0,"stats":{"Line":1}},{"line":197,"address":[],"length":0,"stats":{"Line":3}},{"line":198,"address":[],"length":0,"stats":{"Line":3}},{"line":202,"address":[],"length":0,"stats":{"Line":3}},{"line":203,"address":[],"length":0,"stats":{"Line":3}},{"line":206,"address":[],"length":0,"stats":{"Line":5}},{"line":207,"address":[],"length":0,"stats":{"Line":5}},{"line":213,"address":[],"length":0,"stats":{"Line":3701}},{"line":216,"address":[],"length":0,"stats":{"Line":7402}},{"line":218,"address":[],"length":0,"stats":{"Line":3701}},{"line":219,"address":[],"length":0,"stats":{"Line":3701}},{"line":220,"address":[],"length":0,"stats":{"Line":3701}},{"line":223,"address":[],"length":0,"stats":{"Line":3701}},{"line":229,"address":[],"length":0,"stats":{"Line":3701}},{"line":235,"address":[],"length":0,"stats":{"Line":1}},{"line":236,"address":[],"length":0,"stats":{"Line":1}},{"line":239,"address":[],"length":0,"stats":{"Line":3701}},{"line":240,"address":[],"length":0,"stats":{"Line":7402}},{"line":241,"address":[],"length":0,"stats":{"Line":3701}},{"line":242,"address":[],"length":0,"stats":{"Line":3701}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":3701}},{"line":250,"address":[],"length":0,"stats":{"Line":3701}},{"line":258,"address":[],"length":0,"stats":{"Line":3}},{"line":259,"address":[],"length":0,"stats":{"Line":5}},{"line":260,"address":[],"length":0,"stats":{"Line":2}},{"line":261,"address":[],"length":0,"stats":{"Line":1}},{"line":263,"address":[],"length":0,"stats":{"Line":2}},{"line":264,"address":[],"length":0,"stats":{"Line":4}},{"line":268,"address":[],"length":0,"stats":{"Line":3704}},{"line":269,"address":[],"length":0,"stats":{"Line":3704}},{"line":270,"address":[],"length":0,"stats":{"Line":7407}},{"line":271,"address":[],"length":0,"stats":{"Line":3704}},{"line":272,"address":[],"length":0,"stats":{"Line":3704}},{"line":274,"address":[],"length":0,"stats":{"Line":6888}},{"line":275,"address":[],"length":0,"stats":{"Line":3186}},{"line":278,"address":[],"length":0,"stats":{"Line":3702}},{"line":281,"address":[],"length":0,"stats":{"Line":3701}},{"line":282,"address":[],"length":0,"stats":{"Line":7402}},{"line":283,"address":[],"length":0,"stats":{"Line":3701}},{"line":284,"address":[],"length":0,"stats":{"Line":3701}},{"line":287,"address":[],"length":0,"stats":{"Line":1595}},{"line":288,"address":[],"length":0,"stats":{"Line":3190}},{"line":289,"address":[],"length":0,"stats":{"Line":1595}},{"line":292,"address":[],"length":0,"stats":{"Line":3701}},{"line":296,"address":[],"length":0,"stats":{"Line":15}},{"line":297,"address":[],"length":0,"stats":{"Line":15}},{"line":301,"address":[],"length":0,"stats":{"Line":13}},{"line":302,"address":[],"length":0,"stats":{"Line":13}},{"line":306,"address":[],"length":0,"stats":{"Line":18}},{"line":307,"address":[],"length":0,"stats":{"Line":18}},{"line":311,"address":[],"length":0,"stats":{"Line":6}},{"line":312,"address":[],"length":0,"stats":{"Line":6}},{"line":316,"address":[],"length":0,"stats":{"Line":3}},{"line":317,"address":[],"length":0,"stats":{"Line":3}},{"line":321,"address":[],"length":0,"stats":{"Line":1}},{"line":322,"address":[],"length":0,"stats":{"Line":1}},{"line":326,"address":[],"length":0,"stats":{"Line":1}},{"line":327,"address":[],"length":0,"stats":{"Line":1}}],"covered":111,"coverable":114},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","statement_patch.rs"],"content":"use crate::{\n    patch_entry::PatchEntry, EditMetadata, EntityId, FromJson, HttpMisc, Patch, PatchApply,\n    RestApi, RestApiError, Statement,\n};\nuse async_trait::async_trait;\nuse serde::Serialize;\nuse serde_json::{json, Value};\n\n#[derive(Debug, Clone, Default, PartialEq, Serialize)]\npub struct StatementPatch {\n    statement_id: String,\n    patch: Vec\u003cPatchEntry\u003e,\n}\n\nimpl HttpMisc for StatementPatch {\n    fn get_my_rest_api_path(\u0026self, _id: \u0026EntityId) -\u003e Result\u003cString, RestApiError\u003e {\n        Ok(format!(\"/statements/{id}\", id = self.statement_id))\n    }\n}\n\nimpl StatementPatch {\n    /// Generates a new `StatementPatch` for a given statement ID\n    pub fn new\u003cS: Into\u003cString\u003e\u003e(id: S) -\u003e Self {\n        Self {\n            statement_id: id.into(),\n            patch: vec![],\n        }\n    }\n\n    /// Generates a patch from JSON, presumably from `json_patch`\n    pub fn from_json\u003cS: Into\u003cString\u003e\u003e(\n        statement_id: S,\n        j: \u0026Value,\n    ) -\u003e Result\u003cStatementPatch, RestApiError\u003e {\n        let pe = j\n            .as_array()\n            .ok_or(RestApiError::WrongType {\n                field: \"StatementPatch\".into(),\n                j: j.to_owned(),\n            })?\n            .iter()\n            .map(|x| serde_json::from_value(x.clone()).map_err(|e| e.into()))\n            .collect::\u003cResult\u003cVec\u003cPatchEntry\u003e, RestApiError\u003e\u003e()?;\n        Ok(StatementPatch {\n            patch: pe,\n            statement_id: statement_id.into(),\n        })\n    }\n\n    /// Adds a command to replace the content of a statement\n    pub fn replace_content(\u0026mut self, value: Value) {\n        self.replace(\"/value/content\".to_string(), value);\n    }\n\n    // Overrides the Patch\u003cStatement\u003e implementation becaue we don't need the EntityId\n    pub async fn apply(\u0026self, api: \u0026mut RestApi) -\u003e Result\u003cStatement, RestApiError\u003e {\n        self.apply_match(api, EditMetadata::default()).await\n    }\n\n    // Overrides the Patch\u003cStatement\u003e implementation becaue we don't need the EntityId\n    pub async fn apply_match(\n        \u0026self,\n        api: \u0026mut RestApi,\n        em: EditMetadata,\n    ) -\u003e Result\u003cStatement, RestApiError\u003e {\n        \u003cSelf as PatchApply\u003cStatement\u003e\u003e::apply_match(self, \u0026EntityId::None, api, em).await\n    }\n}\n\n#[async_trait]\nimpl Patch for StatementPatch {\n    fn patch(\u0026self) -\u003e \u0026Vec\u003cPatchEntry\u003e {\n        \u0026self.patch\n    }\n\n    fn patch_mut(\u0026mut self) -\u003e \u0026mut Vec\u003cPatchEntry\u003e {\n        \u0026mut self.patch\n    }\n}\n\n#[async_trait]\nimpl PatchApply\u003cStatement\u003e for StatementPatch {\n    async fn apply_match(\n        \u0026self,\n        _id: \u0026EntityId,\n        api: \u0026mut RestApi,\n        em: EditMetadata,\n    ) -\u003e Result\u003cStatement, RestApiError\u003e {\n        let j0 = json!({\"patch\":self.patch});\n        let request = self\n            .generate_json_request(\u0026EntityId::None, reqwest::Method::PATCH, j0, api, \u0026em)\n            .await?;\n        let response = api.execute(request).await?;\n        let (j, header_info) = self.filter_response_error(response).await?;\n        Statement::from_json_header_info(\u0026j, header_info)\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use crate::statement_value::StatementValue;\n    use wiremock::matchers::{bearer_token, body_partial_json, header, method, path};\n    use wiremock::{Mock, MockServer, ResponseTemplate};\n\n    use super::*;\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_statement_patch() {\n        let v = std::fs::read_to_string(\"test_data/Q42.json\").unwrap();\n        let v: Value = serde_json::from_str(\u0026v).unwrap();\n        let mut new_statement = v[\"statements\"][\"P31\"][0].clone();\n        new_statement[\"value\"][\"content\"] = json!(\"Q6\");\n\n        let statement_id = \"Q42$F078E5B3-F9A8-480E-B7AC-D97778CBBEF9\";\n        let mock_path = format!(\"/w/rest.php/wikibase/v1/statements/{statement_id}\");\n        let mock_server = MockServer::start().await;\n        let token = \"FAKE_TOKEN\";\n        Mock::given(body_partial_json(\n            json!({\"patch\":[{\"op\": \"replace\",\"path\": \"/value/content\",\"value\": \"Q6\"}]}),\n        ))\n        .and(method(\"PATCH\"))\n        .and(path(\u0026mock_path))\n        .and(bearer_token(token))\n        .and(header(\"content-type\", \"application/json-patch+json\"))\n        .respond_with(\n            ResponseTemplate::new(200)\n                .insert_header(\"ETag\", \"12345\")\n                .set_body_json(new_statement),\n        )\n        .mount(\u0026mock_server)\n        .await;\n        let mut api = RestApi::builder(\u0026(mock_server.uri() + \"/w/rest.php\"))\n            .unwrap()\n            .with_access_token(token)\n            .build();\n\n        // Patch statement\n        let mut patch = StatementPatch::new(statement_id);\n        patch.replace_content(json!(\"Q6\"));\n        let statement = patch.apply(\u0026mut api).await.unwrap();\n        assert_eq!(statement.header_info().revision_id(), Some(12345));\n        assert_eq!(statement.value(), \u0026StatementValue::new_string(\"Q6\"));\n    }\n\n    #[test]\n    fn test_replace_content() {\n        let mut patch = StatementPatch::new(\"Q42$F078E5B3-F9A8-480E-B7AC-D97778CBBEF9\");\n        patch.replace_content(json!(\"Q6\"));\n        assert_eq!(\n            patch.patch(),\n            \u0026[PatchEntry::new(\"replace\", \"/value/content\", json!(\"Q6\"))]\n        );\n    }\n\n    #[test]\n    fn test_get_rest_api_path() {\n        let patch = StatementPatch::new(\"Q42$F078E5B3-F9A8-480E-B7AC-D97778CBBEF9\");\n        assert_eq!(\n            patch\n                .get_my_rest_api_path(\u0026EntityId::new(\"Q42\").unwrap())\n                .unwrap(),\n            \"/statements/Q42$F078E5B3-F9A8-480E-B7AC-D97778CBBEF9\"\n        );\n    }\n}\n","traces":[{"line":16,"address":[],"length":0,"stats":{"Line":2}},{"line":17,"address":[],"length":0,"stats":{"Line":2}},{"line":23,"address":[],"length":0,"stats":{"Line":3}},{"line":25,"address":[],"length":0,"stats":{"Line":3}},{"line":26,"address":[],"length":0,"stats":{"Line":3}},{"line":31,"address":[],"length":0,"stats":{"Line":2}},{"line":35,"address":[],"length":0,"stats":{"Line":4}},{"line":37,"address":[],"length":0,"stats":{"Line":2}},{"line":38,"address":[],"length":0,"stats":{"Line":2}},{"line":39,"address":[],"length":0,"stats":{"Line":2}},{"line":42,"address":[],"length":0,"stats":{"Line":6}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":2}},{"line":52,"address":[],"length":0,"stats":{"Line":2}},{"line":56,"address":[],"length":0,"stats":{"Line":2}},{"line":57,"address":[],"length":0,"stats":{"Line":1}},{"line":61,"address":[],"length":0,"stats":{"Line":1}},{"line":66,"address":[],"length":0,"stats":{"Line":1}},{"line":72,"address":[],"length":0,"stats":{"Line":2}},{"line":73,"address":[],"length":0,"stats":{"Line":2}},{"line":76,"address":[],"length":0,"stats":{"Line":2}},{"line":77,"address":[],"length":0,"stats":{"Line":2}},{"line":89,"address":[],"length":0,"stats":{"Line":1}},{"line":90,"address":[],"length":0,"stats":{"Line":2}},{"line":91,"address":[],"length":0,"stats":{"Line":1}},{"line":92,"address":[],"length":0,"stats":{"Line":1}},{"line":93,"address":[],"length":0,"stats":{"Line":1}},{"line":94,"address":[],"length":0,"stats":{"Line":1}}],"covered":27,"coverable":30},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","statement_rank.rs"],"content":"use crate::RestApiError;\n\n#[derive(Debug, Clone, PartialEq, Default, Copy)]\npub enum StatementRank {\n    #[default]\n    Normal,\n    Preferred,\n    Deprecated,\n}\n\nimpl StatementRank {\n    /// Create a new `StatementRank` from a string\n    pub fn new\u003cS: Into\u003cString\u003e\u003e(s: S) -\u003e Result\u003cSelf, RestApiError\u003e {\n        match s.into().to_lowercase().as_str() {\n            \"normal\" =\u003e Ok(StatementRank::Normal),\n            \"preferred\" =\u003e Ok(StatementRank::Preferred),\n            \"deprecated\" =\u003e Ok(StatementRank::Deprecated),\n            s =\u003e Err(RestApiError::UnknownStatementRank(s.into())),\n        }\n    }\n\n    /// Returns the `StatementRank` as a string\n    pub const fn as_str(\u0026self) -\u003e \u0026str {\n        match self {\n            StatementRank::Normal =\u003e \"normal\",\n            StatementRank::Preferred =\u003e \"preferred\",\n            StatementRank::Deprecated =\u003e \"deprecated\",\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_from_str() {\n        assert_eq!(StatementRank::new(\"normal\").unwrap(), StatementRank::Normal);\n        assert_eq!(\n            StatementRank::new(\"preferred\").unwrap(),\n            StatementRank::Preferred\n        );\n        assert_eq!(\n            StatementRank::new(\"deprecated\").unwrap(),\n            StatementRank::Deprecated\n        );\n        assert!(StatementRank::new(\"unknown\").is_err());\n    }\n\n    #[test]\n    fn test_as_str() {\n        assert_eq!(StatementRank::Normal.as_str(), \"normal\");\n        assert_eq!(StatementRank::Preferred.as_str(), \"preferred\");\n        assert_eq!(StatementRank::Deprecated.as_str(), \"deprecated\");\n    }\n}\n","traces":[{"line":13,"address":[],"length":0,"stats":{"Line":3705}},{"line":14,"address":[],"length":0,"stats":{"Line":3705}},{"line":15,"address":[],"length":0,"stats":{"Line":7336}},{"line":16,"address":[],"length":0,"stats":{"Line":125}},{"line":17,"address":[],"length":0,"stats":{"Line":45}},{"line":18,"address":[],"length":0,"stats":{"Line":1}},{"line":23,"address":[],"length":0,"stats":{"Line":1105}},{"line":24,"address":[],"length":0,"stats":{"Line":1105}},{"line":25,"address":[],"length":0,"stats":{"Line":1082}},{"line":26,"address":[],"length":0,"stats":{"Line":16}},{"line":27,"address":[],"length":0,"stats":{"Line":7}}],"covered":11,"coverable":11},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","statement_value.rs"],"content":"use crate::statement_value_content::StatementValueContent;\nuse crate::RestApiError;\nuse serde::ser::{Serialize, SerializeStruct, Serializer};\nuse serde_json::Value;\n\n#[derive(Debug, Clone, PartialEq, Default)]\npub enum StatementValue {\n    Value(StatementValueContent),\n    SomeValue,\n    #[default]\n    NoValue,\n}\n\nimpl StatementValue {\n    /// Creates a new `StatementValue` object from a JSON object.\n    pub fn from_json(j: \u0026Value) -\u003e Result\u003cSelf, RestApiError\u003e {\n        let value_type = j[\"type\"]\n            .as_str()\n            .ok_or_else(|| RestApiError::MissingOrInvalidField {\n                field: \"type\".into(),\n                j: j.to_owned(),\n            })?;\n        match value_type {\n            \"value\" =\u003e Ok(Self::Value(StatementValueContent::from_json(\n                \u0026j[\"content\"],\n            )?)),\n            \"somevalue\" =\u003e Ok(Self::SomeValue),\n            \"novalue\" =\u003e Ok(Self::NoValue),\n            _ =\u003e Err(RestApiError::UnknownValue(value_type.into())),\n        }\n    }\n\n    /// Creates a new `StatementValue` object from a string, as a String value.\n    pub fn new_string\u003cS: Into\u003cString\u003e\u003e(text: S) -\u003e Self {\n        StatementValue::Value(StatementValueContent::String(text.into()))\n    }\n\n    // TODO more convenience functions\n}\n\n#[cfg(not(tarpaulin_include))] // tarpaulin can't handle the Serialize trait\nimpl Serialize for StatementValue {\n    fn serialize\u003cS\u003e(\u0026self, serializer: S) -\u003e Result\u003cS::Ok, S::Error\u003e\n    where\n        S: Serializer,\n    {\n        // #lizard forgives the complexity\n        match self {\n            StatementValue::Value(content) =\u003e {\n                let mut s = serializer.serialize_struct(\"StatementValue\", 2)?;\n                s.serialize_field(\"type\", \"value\")?;\n                s.serialize_field(\"content\", content)?;\n                s.end()\n            }\n            StatementValue::SomeValue =\u003e {\n                let mut s = serializer.serialize_struct(\"StatementValue\", 1)?;\n                s.serialize_field(\"type\", \"somevalue\")?;\n                s.end()\n            }\n            StatementValue::NoValue =\u003e {\n                let mut s = serializer.serialize_struct(\"StatementValue\", 1)?;\n                s.serialize_field(\"type\", \"novalue\")?;\n                s.end()\n            }\n        }\n    }\n}\n\n/// Implement the From trait for `StatementValueContent` to `StatementValue`, for convenience assignments.\nimpl From\u003cStatementValueContent\u003e for StatementValue {\n    fn from(content: StatementValueContent) -\u003e Self {\n        StatementValue::Value(content)\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::prelude::*;\n    use crate::{entity::Entity, EntityId, Item};\n    use serde_json::json;\n    use wiremock::matchers::{method, path};\n    use wiremock::{Mock, MockServer, ResponseTemplate};\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_somevalue() {\n        let v = std::fs::read_to_string(\"test_data/Q42.json\").unwrap();\n        let v: Value = serde_json::from_str(\u0026v).unwrap();\n        let id = v[\"id\"].as_str().unwrap();\n\n        let mock_path = format!(\"/w/rest.php/wikibase/v1/entities/items/{id}\");\n        let mock_server = MockServer::start().await;\n        Mock::given(method(\"GET\"))\n            .and(path(\u0026mock_path))\n            .respond_with(ResponseTemplate::new(200).set_body_json(\u0026v))\n            .mount(\u0026mock_server)\n            .await;\n        let api = RestApi::builder(\u0026(mock_server.uri() + \"/w/rest.php\"))\n            .unwrap()\n            .build();\n\n        let item = Item::get(EntityId::item(id), \u0026api).await.unwrap();\n        let prop = item.statements().property(\"P2021\")[0].to_owned();\n        let qual = \u0026prop.qualifiers()[0];\n        assert_eq!(qual.value(), \u0026StatementValue::SomeValue);\n    }\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_novalue() {\n        let v = std::fs::read_to_string(\"test_data/Q255.json\").unwrap();\n        let v: Value = serde_json::from_str(\u0026v).unwrap();\n        let id = v[\"id\"].as_str().unwrap();\n\n        let mock_path = format!(\"/w/rest.php/wikibase/v1/entities/items/{id}\");\n        let mock_server = MockServer::start().await;\n        Mock::given(method(\"GET\"))\n            .and(path(\u0026mock_path))\n            .respond_with(ResponseTemplate::new(200).set_body_json(\u0026v))\n            .mount(\u0026mock_server)\n            .await;\n        let api = RestApi::builder(\u0026(mock_server.uri() + \"/w/rest.php\"))\n            .unwrap()\n            .build();\n\n        let item = Item::get(EntityId::item(id), \u0026api).await.unwrap();\n        let prop = item.statements().property(\"P40\")[0];\n        assert_eq!(prop.value(), \u0026StatementValue::NoValue);\n    }\n\n    #[test]\n    fn test_serialize_string() {\n        let s = StatementValue::Value(StatementValueContent::String(\"foo\".to_string()));\n        let j: Value = json!(s);\n        assert_eq!(j, json!({\"type\": \"value\", \"content\": \"foo\"}));\n    }\n\n    #[test]\n    fn test_serialize_time() {\n        let s = StatementValue::Value(StatementValueContent::Time {\n            time: \"+2021-01-01T00:00:00Z\".to_string(),\n            precision: TimePrecision::Day,\n            calendarmodel: \"http://www.wikidata.org/entity/Q1985727\".to_string(),\n        });\n        let j: Value = json!(s);\n        assert_eq!(\n            j,\n            json!({\"type\": \"value\", \"content\": {\"time\": \"+2021-01-01T00:00:00Z\", \"precision\": 11, \"calendarmodel\": \"http://www.wikidata.org/entity/Q1985727\"}})\n        );\n    }\n\n    #[test]\n    fn test_serialize_location() {\n        let s = StatementValue::Value(StatementValueContent::Location {\n            latitude: 37.786971,\n            longitude: -122.399677,\n            precision: 0.0001,\n            globe: \"http://www.wikidata.org/entity/Q2\".to_string(),\n        });\n        let j: Value = json!(s);\n        assert_eq!(\n            j,\n            json!({\"type\": \"value\", \"content\": {\"latitude\": 37.786971, \"longitude\": -122.399677, \"precision\": 0.0001, \"globe\": \"http://www.wikidata.org/entity/Q2\"}})\n        );\n    }\n\n    #[test]\n    fn test_serialize_quantity() {\n        let s = StatementValue::Value(StatementValueContent::Quantity {\n            amount: \"42\".to_string(),\n            unit: \"http://www.wikidata.org/entity/Q11573\".to_string(),\n        });\n        let j: Value = json!(s);\n        assert_eq!(\n            j,\n            json!({\"type\": \"value\", \"content\": {\"amount\": \"42\", \"unit\": \"http://www.wikidata.org/entity/Q11573\"}})\n        );\n    }\n\n    #[test]\n    fn test_serialize_monolingual_text() {\n        let s = StatementValue::Value(StatementValueContent::MonolingualText {\n            language: \"en\".to_string(),\n            text: \"foo\".to_string(),\n        });\n        let j: Value = json!(s);\n        assert_eq!(\n            j,\n            json!({\"type\": \"value\", \"content\": {\"language\": \"en\", \"text\": \"foo\"}})\n        );\n    }\n\n    #[test]\n    fn test_serialize_somevalue() {\n        let s = StatementValue::SomeValue;\n        let j: Value = json!(s);\n        assert_eq!(j, json!({\"type\": \"somevalue\"}));\n    }\n\n    #[test]\n    fn test_serialize_novalue() {\n        let s = StatementValue::NoValue;\n        let j: Value = json!(s);\n        assert_eq!(j, json!({\"type\": \"novalue\"}));\n    }\n\n    #[test]\n    fn test_from_string() {\n        let s = StatementValue::new_string(\"foo\");\n        assert_eq!(\n            s,\n            StatementValue::Value(StatementValueContent::String(\"foo\".to_string()))\n        );\n    }\n\n    #[test]\n    fn test_from_time() {\n        let s = StatementValue::Value(StatementValueContent::Time {\n            time: \"+2021-01-01T00:00:00Z\".to_string(),\n            precision: TimePrecision::Day,\n            calendarmodel: \"http://www.wikidata.org/entity/Q1985727\".to_string(),\n        });\n        assert_eq!(\n            s,\n            StatementValue::Value(StatementValueContent::Time {\n                time: \"+2021-01-01T00:00:00Z\".to_string(),\n                precision: TimePrecision::Day,\n                calendarmodel: \"http://www.wikidata.org/entity/Q1985727\".to_string()\n            })\n        );\n    }\n\n    #[test]\n    fn test_from_location() {\n        let s = StatementValue::Value(StatementValueContent::Location {\n            latitude: 37.786971,\n            longitude: -122.399677,\n            precision: 0.0001,\n            globe: \"http://www.wikidata.org/entity/Q2\".to_string(),\n        });\n        assert_eq!(\n            s,\n            StatementValue::Value(StatementValueContent::Location {\n                latitude: 37.786971,\n                longitude: -122.399677,\n                precision: 0.0001,\n                globe: \"http://www.wikidata.org/entity/Q2\".to_string()\n            })\n        );\n    }\n\n    #[test]\n    fn test_from_quantity() {\n        let s = StatementValue::Value(StatementValueContent::Quantity {\n            amount: \"42\".to_string(),\n            unit: \"http://www.wikidata.org/entity/Q11573\".to_string(),\n        });\n        assert_eq!(\n            s,\n            StatementValue::Value(StatementValueContent::Quantity {\n                amount: \"42\".to_string(),\n                unit: \"http://www.wikidata.org/entity/Q11573\".to_string()\n            })\n        );\n    }\n\n    #[test]\n    fn test_from_monolingual_text() {\n        let s = StatementValue::Value(StatementValueContent::MonolingualText {\n            language: \"en\".to_string(),\n            text: \"foo\".to_string(),\n        });\n        assert_eq!(\n            s,\n            StatementValue::Value(StatementValueContent::MonolingualText {\n                language: \"en\".to_string(),\n                text: \"foo\".to_string()\n            })\n        );\n    }\n\n    #[test]\n    fn test_from_somevalue() {\n        let s = StatementValue::SomeValue;\n        assert_eq!(s, StatementValue::SomeValue);\n    }\n\n    #[test]\n    fn test_from_novalue() {\n        let s = StatementValue::NoValue;\n        assert_eq!(s, StatementValue::NoValue);\n    }\n\n    #[test]\n    fn test_from_json_string() {\n        let j = json!(\"foo\");\n        let s = StatementValueContent::from_json(\u0026j).unwrap();\n        assert_eq!(s, StatementValueContent::String(\"foo\".to_string()));\n    }\n\n    #[test]\n    fn test_from_json_time() {\n        let j = json!({\"time\": \"+2021-01-01T00:00:00Z\", \"precision\": 11, \"calendarmodel\": \"http://www.wikidata.org/entity/Q1985727\"});\n        let s = StatementValueContent::from_json(\u0026j).unwrap();\n        assert_eq!(\n            s,\n            StatementValueContent::Time {\n                time: \"+2021-01-01T00:00:00Z\".to_string(),\n                precision: TimePrecision::Day,\n                calendarmodel: \"http://www.wikidata.org/entity/Q1985727\".to_string()\n            }\n        );\n    }\n\n    #[test]\n    fn test_from_json_location() {\n        let j = json!({\"latitude\": 37.786971, \"longitude\": -122.399677, \"precision\": 0.0001, \"globe\": \"http://www.wikidata.org/entity/Q2\"});\n        let s = StatementValueContent::from_json(\u0026j).unwrap();\n        assert_eq!(\n            s,\n            StatementValueContent::Location {\n                latitude: 37.786971,\n                longitude: -122.399677,\n                precision: 0.0001,\n                globe: \"http://www.wikidata.org/entity/Q2\".to_string()\n            }\n        );\n    }\n\n    #[test]\n    fn test_from_json_quantity() {\n        let j = json!({\"amount\": \"42\", \"unit\": \"http://www.wikidata.org/entity/Q11573\"});\n        let s = StatementValueContent::from_json(\u0026j).unwrap();\n        assert_eq!(\n            s,\n            StatementValueContent::Quantity {\n                amount: \"42\".to_string(),\n                unit: \"http://www.wikidata.org/entity/Q11573\".to_string()\n            }\n        );\n    }\n\n    #[test]\n    fn test_from_json_monolingual_text() {\n        let j = json!({\"language\": \"en\", \"text\": \"foo\"});\n        let s = StatementValueContent::from_json(\u0026j).unwrap();\n        assert_eq!(\n            s,\n            StatementValueContent::MonolingualText {\n                language: \"en\".to_string(),\n                text: \"foo\".to_string()\n            }\n        );\n    }\n\n    #[test]\n    fn test_from_json_error() {\n        let j = json!({\"foo\": \"bar\"});\n        let s = StatementValueContent::from_json(\u0026j);\n        assert!(s.is_err());\n    }\n\n    #[test]\n    fn test_statement_value_contents_serialize_string() {\n        // #lizard forgives the complexity\n        let svc = StatementValueContent::String(\"foo\".to_string());\n        let j: Value = serde_json::to_value(\u0026svc).unwrap();\n        assert_eq!(j, json!(\"foo\"));\n    }\n\n    #[test]\n    fn test_statement_value_contents_serialize_time() {\n        let svc = StatementValueContent::Time {\n            time: \"+2021-01-01T00:00:00Z\".to_string(),\n            precision: TimePrecision::Day,\n            calendarmodel: \"http://www.wikidata.org/entity/Q1985727\".to_string(),\n        };\n        let j: Value = serde_json::to_value(\u0026svc).unwrap();\n        assert_eq!(\n            j,\n            json!({\"time\": \"+2021-01-01T00:00:00Z\", \"precision\": 11, \"calendarmodel\": \"http://www.wikidata.org/entity/Q1985727\"})\n        );\n    }\n\n    #[test]\n    fn test_statement_value_contents_serialize_location() {\n        let svc = StatementValueContent::Location {\n            latitude: 37.786971,\n            longitude: -122.399677,\n            precision: 0.0001,\n            globe: \"http://www.wikidata.org/entity/Q2\".to_string(),\n        };\n        let j: Value = serde_json::to_value(\u0026svc).unwrap();\n        assert_eq!(\n            j,\n            json!({\"latitude\": 37.786971, \"longitude\": -122.399677, \"precision\": 0.0001, \"globe\": \"http://www.wikidata.org/entity/Q2\"})\n        );\n    }\n\n    #[test]\n    fn test_statement_value_contents_serialize_quantity() {\n        let svc = StatementValueContent::Quantity {\n            amount: \"42\".to_string(),\n            unit: \"http://www.wikidata.org/entity/Q11573\".to_string(),\n        };\n        let j: Value = serde_json::to_value(\u0026svc).unwrap();\n        assert_eq!(\n            j,\n            json!({\"amount\": \"42\", \"unit\": \"http://www.wikidata.org/entity/Q11573\"})\n        );\n    }\n\n    #[test]\n    fn test_statement_value_contents_serialize_monolingual_text() {\n        let svc = StatementValueContent::MonolingualText {\n            language: \"en\".to_string(),\n            text: \"foo\".to_string(),\n        };\n        let j: Value = serde_json::to_value(\u0026svc).unwrap();\n        assert_eq!(j, json!({\"language\": \"en\", \"text\": \"foo\"}));\n    }\n}\n","traces":[{"line":16,"address":[],"length":0,"stats":{"Line":9809}},{"line":17,"address":[],"length":0,"stats":{"Line":19618}},{"line":19,"address":[],"length":0,"stats":{"Line":9809}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":9797}},{"line":25,"address":[],"length":0,"stats":{"Line":9797}},{"line":27,"address":[],"length":0,"stats":{"Line":20}},{"line":28,"address":[],"length":0,"stats":{"Line":8}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":18}},{"line":35,"address":[],"length":0,"stats":{"Line":18}},{"line":71,"address":[],"length":0,"stats":{"Line":1}},{"line":72,"address":[],"length":0,"stats":{"Line":1}}],"covered":11,"coverable":14},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","statement_value_content.rs"],"content":"use crate::RestApiError;\nuse serde::ser::{Serialize, SerializeStruct, Serializer};\nuse serde_json::{json, Value};\n\n/// Represents the Gregorian calendar model.\npub const GREGORIAN_CALENDAR: \u0026str = \"http://www.wikidata.org/entity/Q1985727\";\n\n/// Represents the Julian calendar model.\npub const JULIAN_CALENDAR: \u0026str = \"http://www.wikidata.org/entity/Q11184\";\n\n/// Represents the precision of a time value.\n#[derive(Copy, Clone, Debug, PartialEq, Eq, Hash, PartialOrd, Ord)]\npub enum TimePrecision {\n    BillionYears = 0,\n    HundredMillionYears = 1,\n    TenMillionYears = 2,\n    MillionYears = 3,\n    HundredMillennia = 4,\n    TenMillennia = 5,\n    Millennia = 6,\n    Century = 7,\n    Decade = 8,\n    Year = 9,\n    Month = 10,\n    Day = 11,\n    Hour = 12,\n    Minute = 13,\n    Second = 14,\n}\n\nimpl TryFrom\u003cu8\u003e for TimePrecision {\n    type Error = \u0026'static str;\n\n    fn try_from(value: u8) -\u003e Result\u003cSelf, Self::Error\u003e {\n        match value {\n            0 =\u003e Ok(TimePrecision::BillionYears),\n            1 =\u003e Ok(TimePrecision::HundredMillionYears),\n            2 =\u003e Ok(TimePrecision::TenMillionYears),\n            3 =\u003e Ok(TimePrecision::MillionYears),\n            4 =\u003e Ok(TimePrecision::HundredMillennia),\n            5 =\u003e Ok(TimePrecision::TenMillennia),\n            6 =\u003e Ok(TimePrecision::Millennia),\n            7 =\u003e Ok(TimePrecision::Century),\n            8 =\u003e Ok(TimePrecision::Decade),\n            9 =\u003e Ok(TimePrecision::Year),\n            10 =\u003e Ok(TimePrecision::Month),\n            11 =\u003e Ok(TimePrecision::Day),\n            12 =\u003e Ok(TimePrecision::Hour),\n            13 =\u003e Ok(TimePrecision::Minute),\n            14 =\u003e Ok(TimePrecision::Second),\n            _ =\u003e Err(\"Invalid TimePrecision value\"),\n        }\n    }\n}\n\nimpl From\u003cTimePrecision\u003e for u8 {\n    fn from(precision: TimePrecision) -\u003e Self {\n        precision as u8\n    }\n}\n\nimpl TryFrom\u003cu64\u003e for TimePrecision {\n    type Error = \u0026'static str;\n\n    fn try_from(value: u64) -\u003e Result\u003cSelf, Self::Error\u003e {\n        if value \u003e u64::from(u8::MAX) {\n            return Err(\"Value too large for TimePrecision\");\n        }\n        (value as u8).try_into()\n    }\n}\n\nimpl From\u003cTimePrecision\u003e for u64 {\n    fn from(precision: TimePrecision) -\u003e Self {\n        u64::from(u8::from(precision))\n    }\n}\n\n#[derive(Debug, Clone, PartialEq)]\npub enum StatementValueContent {\n    String(String),\n    Time {\n        time: String,\n        precision: TimePrecision,\n        calendarmodel: String,\n    },\n    Location {\n        latitude: f64,\n        longitude: f64,\n        precision: f64,\n        globe: String,\n    },\n    Quantity {\n        amount: String,\n        unit: String,\n    },\n    MonolingualText {\n        language: String,\n        text: String,\n    },\n}\n\nimpl StatementValueContent {\n    /// Creates a new `StatementValueContent` object from a JSON object.\n    pub fn from_json(j: \u0026Value) -\u003e Result\u003cSelf, RestApiError\u003e {\n        // #lizard forgives the complexity\n        if let Some(s) = j.as_str() {\n            return Ok(StatementValueContent::String(s.to_string()));\n        }\n        if let (Some(time), Some(precision), Some(calendarmodel)) = (\n            j[\"time\"].as_str(),\n            j[\"precision\"].as_u64(),\n            j[\"calendarmodel\"].as_str(),\n        ) {\n            return Ok(StatementValueContent::Time {\n                time: time.to_string(),\n                precision: precision\n                    .try_into()\n                    .map_err(|_| RestApiError::InvalidPrecision)?,\n                calendarmodel: calendarmodel.to_string(),\n            });\n        }\n        if let (Some(latitude), Some(longitude), Some(precision), Some(globe)) = (\n            j[\"latitude\"].as_f64(),\n            j[\"longitude\"].as_f64(),\n            j[\"precision\"].as_f64(),\n            j[\"globe\"].as_str(),\n        ) {\n            return Ok(StatementValueContent::Location {\n                latitude,\n                longitude,\n                precision,\n                globe: globe.to_string(),\n            });\n        }\n        if let (Some(amount), Some(unit)) = (j[\"amount\"].as_str(), j[\"unit\"].as_str()) {\n            return Ok(StatementValueContent::Quantity {\n                amount: amount.to_string(),\n                unit: unit.to_string(),\n            });\n        }\n        if let (Some(language), Some(text)) = (j[\"language\"].as_str(), j[\"text\"].as_str()) {\n            return Ok(StatementValueContent::MonolingualText {\n                language: language.to_string(),\n                text: text.to_string(),\n            });\n        }\n        Err(RestApiError::UnknownValue(format!(\"{j:?}\")))\n    }\n}\n\n#[cfg(not(tarpaulin_include))] // tarpaulin can't handle the Serialize trait\nimpl Serialize for StatementValueContent {\n    fn serialize\u003cS\u003e(\u0026self, serializer: S) -\u003e Result\u003cS::Ok, S::Error\u003e\n    where\n        S: Serializer,\n    {\n        match \u0026self {\n            StatementValueContent::String(text) =\u003e serialize_text(text, serializer),\n            StatementValueContent::Time {\n                time,\n                precision,\n                calendarmodel,\n            } =\u003e serailize_time(serializer, time, precision, calendarmodel),\n            StatementValueContent::Location {\n                latitude,\n                longitude,\n                precision,\n                globe,\n            } =\u003e serialize_location(serializer, latitude, longitude, precision, globe),\n            StatementValueContent::Quantity { amount, unit } =\u003e {\n                serialize_quantity(serializer, amount, unit)\n            }\n            StatementValueContent::MonolingualText { language, text } =\u003e {\n                serialize_monolingual_text(serializer, language, text)\n            }\n        }\n    }\n}\n\nfn serialize_text\u003cS\u003e(\n    text: \u0026String,\n    serializer: S,\n) -\u003e Result\u003c\u003cS as Serializer\u003e::Ok, \u003cS as Serializer\u003e::Error\u003e\nwhere\n    S: Serializer,\n{\n    json!(text).serialize(serializer)\n}\n\nfn serialize_monolingual_text\u003cS\u003e(\n    serializer: S,\n    language: \u0026String,\n    text: \u0026String,\n) -\u003e Result\u003c\u003cS as Serializer\u003e::Ok, \u003cS as Serializer\u003e::Error\u003e\nwhere\n    S: Serializer,\n{\n    let mut s = serializer.serialize_struct(\"StatementValueContent\", 2)?;\n    s.serialize_field(\"language\", language)?;\n    s.serialize_field(\"text\", text)?;\n    s.end()\n}\n\nfn serialize_quantity\u003cS\u003e(\n    serializer: S,\n    amount: \u0026String,\n    unit: \u0026String,\n) -\u003e Result\u003c\u003cS as Serializer\u003e::Ok, \u003cS as Serializer\u003e::Error\u003e\nwhere\n    S: Serializer,\n{\n    let mut s = serializer.serialize_struct(\"StatementValueContent\", 2)?;\n    s.serialize_field(\"amount\", amount)?;\n    s.serialize_field(\"unit\", unit)?;\n    s.end()\n}\n\nfn serialize_location\u003cS\u003e(\n    serializer: S,\n    latitude: \u0026f64,\n    longitude: \u0026f64,\n    precision: \u0026f64,\n    globe: \u0026String,\n) -\u003e Result\u003c\u003cS as Serializer\u003e::Ok, \u003cS as Serializer\u003e::Error\u003e\nwhere\n    S: Serializer,\n{\n    let mut s = serializer.serialize_struct(\"StatementValueContent\", 4)?;\n    s.serialize_field(\"latitude\", latitude)?;\n    s.serialize_field(\"longitude\", longitude)?;\n    s.serialize_field(\"precision\", precision)?;\n    s.serialize_field(\"globe\", globe)?;\n    s.end()\n}\n\nfn serailize_time\u003cS\u003e(\n    serializer: S,\n    time: \u0026String,\n    precision: \u0026TimePrecision,\n    calendarmodel: \u0026String,\n) -\u003e Result\u003c\u003cS as Serializer\u003e::Ok, \u003cS as Serializer\u003e::Error\u003e\nwhere\n    S: Serializer,\n{\n    let precision = *precision as u8;\n    let mut s = serializer.serialize_struct(\"StatementValueContent\", 3)?;\n    s.serialize_field(\"time\", time)?;\n    s.serialize_field(\"precision\", \u0026precision)?;\n    s.serialize_field(\"calendarmodel\", calendarmodel)?;\n    s.end()\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_from_u8_conversion() {\n        assert_eq!(\n            TimePrecision::try_from(0_u8),\n            Ok(TimePrecision::BillionYears)\n        );\n        assert_eq!(\n            TimePrecision::try_from(1_u8),\n            Ok(TimePrecision::HundredMillionYears)\n        );\n        assert_eq!(\n            TimePrecision::try_from(2_u8),\n            Ok(TimePrecision::TenMillionYears)\n        );\n        assert_eq!(\n            TimePrecision::try_from(3_u8),\n            Ok(TimePrecision::MillionYears)\n        );\n        assert_eq!(\n            TimePrecision::try_from(4_u8),\n            Ok(TimePrecision::HundredMillennia)\n        );\n        assert_eq!(\n            TimePrecision::try_from(5_u8),\n            Ok(TimePrecision::TenMillennia)\n        );\n        assert_eq!(TimePrecision::try_from(6_u8), Ok(TimePrecision::Millennia));\n        assert_eq!(TimePrecision::try_from(7_u8), Ok(TimePrecision::Century));\n        assert_eq!(TimePrecision::try_from(8_u8), Ok(TimePrecision::Decade));\n        assert_eq!(TimePrecision::try_from(9_u8), Ok(TimePrecision::Year));\n        assert_eq!(TimePrecision::try_from(10_u8), Ok(TimePrecision::Month));\n        assert_eq!(TimePrecision::try_from(11_u8), Ok(TimePrecision::Day));\n        assert_eq!(TimePrecision::try_from(12_u8), Ok(TimePrecision::Hour));\n        assert_eq!(TimePrecision::try_from(13_u8), Ok(TimePrecision::Minute));\n        assert_eq!(TimePrecision::try_from(14_u8), Ok(TimePrecision::Second));\n        assert!(TimePrecision::try_from(15_u8).is_err());\n    }\n\n    #[test]\n    fn test_to_u8_conversion() {\n        assert_eq!(u8::from(TimePrecision::BillionYears), 0);\n        assert_eq!(u8::from(TimePrecision::HundredMillionYears), 1);\n        assert_eq!(u8::from(TimePrecision::TenMillionYears), 2);\n        assert_eq!(u8::from(TimePrecision::MillionYears), 3);\n        assert_eq!(u8::from(TimePrecision::HundredMillennia), 4);\n        assert_eq!(u8::from(TimePrecision::TenMillennia), 5);\n        assert_eq!(u8::from(TimePrecision::Millennia), 6);\n        assert_eq!(u8::from(TimePrecision::Century), 7);\n        assert_eq!(u8::from(TimePrecision::Decade), 8);\n        assert_eq!(u8::from(TimePrecision::Year), 9);\n        assert_eq!(u8::from(TimePrecision::Month), 10);\n        assert_eq!(u8::from(TimePrecision::Day), 11);\n        assert_eq!(u8::from(TimePrecision::Hour), 12);\n        assert_eq!(u8::from(TimePrecision::Minute), 13);\n        assert_eq!(u8::from(TimePrecision::Second), 14);\n    }\n\n    #[test]\n    fn test_from_u64_conversion() {\n        assert_eq!(\n            TimePrecision::try_from(0_u64),\n            Ok(TimePrecision::BillionYears)\n        );\n        assert_eq!(\n            TimePrecision::try_from(1_u64),\n            Ok(TimePrecision::HundredMillionYears)\n        );\n        assert_eq!(\n            TimePrecision::try_from(2_u64),\n            Ok(TimePrecision::TenMillionYears)\n        );\n        assert_eq!(\n            TimePrecision::try_from(3_u64),\n            Ok(TimePrecision::MillionYears)\n        );\n        assert_eq!(\n            TimePrecision::try_from(4_u64),\n            Ok(TimePrecision::HundredMillennia)\n        );\n        assert_eq!(\n            TimePrecision::try_from(5_u64),\n            Ok(TimePrecision::TenMillennia)\n        );\n        assert_eq!(TimePrecision::try_from(6_u64), Ok(TimePrecision::Millennia));\n        assert_eq!(TimePrecision::try_from(7_u64), Ok(TimePrecision::Century));\n        assert_eq!(TimePrecision::try_from(8_u64), Ok(TimePrecision::Decade));\n        assert_eq!(TimePrecision::try_from(9_u64), Ok(TimePrecision::Year));\n        assert_eq!(TimePrecision::try_from(10_u64), Ok(TimePrecision::Month));\n        assert_eq!(TimePrecision::try_from(11_u64), Ok(TimePrecision::Day));\n        assert_eq!(TimePrecision::try_from(12_u64), Ok(TimePrecision::Hour));\n        assert_eq!(TimePrecision::try_from(13_u64), Ok(TimePrecision::Minute));\n        assert_eq!(TimePrecision::try_from(14_u64), Ok(TimePrecision::Second));\n        assert!(TimePrecision::try_from(15_u64).is_err());\n    }\n\n    #[test]\n    fn test_to_u64_conversion() {\n        assert_eq!(u64::from(TimePrecision::BillionYears), 0);\n        assert_eq!(u64::from(TimePrecision::HundredMillionYears), 1);\n        assert_eq!(u64::from(TimePrecision::TenMillionYears), 2);\n        assert_eq!(u64::from(TimePrecision::MillionYears), 3);\n        assert_eq!(u64::from(TimePrecision::HundredMillennia), 4);\n        assert_eq!(u64::from(TimePrecision::TenMillennia), 5);\n        assert_eq!(u64::from(TimePrecision::Millennia), 6);\n        assert_eq!(u64::from(TimePrecision::Century), 7);\n        assert_eq!(u64::from(TimePrecision::Decade), 8);\n        assert_eq!(u64::from(TimePrecision::Year), 9);\n        assert_eq!(u64::from(TimePrecision::Month), 10);\n        assert_eq!(u64::from(TimePrecision::Day), 11);\n        assert_eq!(u64::from(TimePrecision::Hour), 12);\n        assert_eq!(u64::from(TimePrecision::Minute), 13);\n        assert_eq!(u64::from(TimePrecision::Second), 14);\n    }\n}\n","traces":[{"line":34,"address":[],"length":0,"stats":{"Line":1471}},{"line":35,"address":[],"length":0,"stats":{"Line":1471}},{"line":36,"address":[],"length":0,"stats":{"Line":2}},{"line":37,"address":[],"length":0,"stats":{"Line":2}},{"line":38,"address":[],"length":0,"stats":{"Line":2}},{"line":39,"address":[],"length":0,"stats":{"Line":2}},{"line":40,"address":[],"length":0,"stats":{"Line":2}},{"line":41,"address":[],"length":0,"stats":{"Line":2}},{"line":42,"address":[],"length":0,"stats":{"Line":2}},{"line":43,"address":[],"length":0,"stats":{"Line":2}},{"line":44,"address":[],"length":0,"stats":{"Line":2}},{"line":45,"address":[],"length":0,"stats":{"Line":128}},{"line":46,"address":[],"length":0,"stats":{"Line":26}},{"line":47,"address":[],"length":0,"stats":{"Line":1291}},{"line":48,"address":[],"length":0,"stats":{"Line":2}},{"line":49,"address":[],"length":0,"stats":{"Line":2}},{"line":50,"address":[],"length":0,"stats":{"Line":2}},{"line":51,"address":[],"length":0,"stats":{"Line":2}},{"line":57,"address":[],"length":0,"stats":{"Line":30}},{"line":58,"address":[],"length":0,"stats":{"Line":30}},{"line":65,"address":[],"length":0,"stats":{"Line":1455}},{"line":66,"address":[],"length":0,"stats":{"Line":1455}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":1455}},{"line":74,"address":[],"length":0,"stats":{"Line":15}},{"line":75,"address":[],"length":0,"stats":{"Line":15}},{"line":105,"address":[],"length":0,"stats":{"Line":9803}},{"line":107,"address":[],"length":0,"stats":{"Line":17577}},{"line":110,"address":[],"length":0,"stats":{"Line":1439}},{"line":111,"address":[],"length":0,"stats":{"Line":2029}},{"line":112,"address":[],"length":0,"stats":{"Line":2029}},{"line":113,"address":[],"length":0,"stats":{"Line":2029}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":1439}},{"line":123,"address":[],"length":0,"stats":{"Line":9}},{"line":124,"address":[],"length":0,"stats":{"Line":590}},{"line":125,"address":[],"length":0,"stats":{"Line":590}},{"line":126,"address":[],"length":0,"stats":{"Line":590}},{"line":127,"address":[],"length":0,"stats":{"Line":590}},{"line":136,"address":[],"length":0,"stats":{"Line":654}},{"line":142,"address":[],"length":0,"stats":{"Line":1015}},{"line":148,"address":[],"length":0,"stats":{"Line":1}},{"line":181,"address":[],"length":0,"stats":{"Line":2433}},{"line":188,"address":[],"length":0,"stats":{"Line":2433}},{"line":191,"address":[],"length":0,"stats":{"Line":185}},{"line":199,"address":[],"length":0,"stats":{"Line":370}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":185}},{"line":202,"address":[],"length":0,"stats":{"Line":185}},{"line":205,"address":[],"length":0,"stats":{"Line":26}},{"line":213,"address":[],"length":0,"stats":{"Line":52}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":26}},{"line":216,"address":[],"length":0,"stats":{"Line":26}},{"line":219,"address":[],"length":0,"stats":{"Line":5}},{"line":229,"address":[],"length":0,"stats":{"Line":10}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":5}},{"line":232,"address":[],"length":0,"stats":{"Line":5}},{"line":233,"address":[],"length":0,"stats":{"Line":5}},{"line":234,"address":[],"length":0,"stats":{"Line":5}},{"line":237,"address":[],"length":0,"stats":{"Line":467}},{"line":246,"address":[],"length":0,"stats":{"Line":467}},{"line":247,"address":[],"length":0,"stats":{"Line":934}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":467}},{"line":250,"address":[],"length":0,"stats":{"Line":467}},{"line":251,"address":[],"length":0,"stats":{"Line":467}}],"covered":62,"coverable":68},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","statements.rs"],"content":"use crate::{\n    statements_patch::StatementsPatch, EditMetadata, EntityId, FromJson, HeaderInfo, HttpGetEntity,\n    HttpMisc, Patch, RestApi, RestApiError, RevisionMatch, Statement,\n};\nuse async_trait::async_trait;\nuse derivative::Derivative;\nuse serde::ser::{Serialize, SerializeMap};\nuse serde_json::{json, Value};\nuse std::collections::HashMap;\n\n#[derive(Derivative, Debug, Clone, Default)]\n#[derivative(PartialEq)]\npub struct Statements {\n    statements: HashMap\u003cString, Vec\u003cStatement\u003e\u003e, // property =\u003e Statements\n    #[derivative(PartialEq = \"ignore\")]\n    header_info: HeaderInfo,\n}\n\nimpl Statements {\n    /// Creates a new `Statements` object from a JSON structure\n    pub fn from_json(j: \u0026Value) -\u003e Result\u003cSelf, RestApiError\u003e {\n        Self::from_json_header_info(j, HeaderInfo::default())\n    }\n\n    /// Creates a new `Statements` object from a JSON structure with header info\n    pub fn from_json_header_info(j: \u0026Value, header_info: HeaderInfo) -\u003e Result\u003cSelf, RestApiError\u003e {\n        let mut ret = Self::default();\n        let statements_j = j\n            .as_object()\n            .ok_or_else(|| RestApiError::MissingOrInvalidField {\n                field: \"Statements\".into(),\n                j: j.to_owned(),\n            })?;\n        for (property, statements) in statements_j {\n            let statements =\n                statements\n                    .as_array()\n                    .ok_or_else(|| RestApiError::MissingOrInvalidField {\n                        field: property.into(),\n                        j: json!(statements),\n                    })?;\n            let statements = statements\n                .iter()\n                .map(Statement::from_json)\n                .collect::\u003cResult\u003cVec\u003cStatement\u003e, RestApiError\u003e\u003e()?;\n            ret.statements.insert(property.to_owned(), statements);\n        }\n        ret.header_info = header_info;\n        Ok(ret)\n    }\n\n    /// Returns the number of statements\n    pub fn len(\u0026self) -\u003e usize {\n        self.statements.iter().flat_map(|(_, v)| v).count()\n    }\n\n    /// Returns true if there are no statements\n    pub fn is_empty(\u0026self) -\u003e bool {\n        self.statements.is_empty()\n    }\n\n    /// Returns the Statements for a specific property\n    pub fn property\u003cS: Into\u003cString\u003e\u003e(\u0026self, property: S) -\u003e Vec\u003c\u0026Statement\u003e {\n        self.statements\n            .get(\u0026property.into())\n            .map_or_else(Vec::new, |v| v.iter().collect())\n    }\n\n    pub fn insert(\u0026mut self, statement: Statement) {\n        let property = statement.property().to_owned();\n        self.statements\n            .entry(property.id().to_owned())\n            .or_default()\n            .push(statement);\n    }\n\n    pub const fn statements(\u0026self) -\u003e \u0026HashMap\u003cString, Vec\u003cStatement\u003e\u003e {\n        \u0026self.statements\n    }\n\n    pub const fn statements_mut(\u0026mut self) -\u003e \u0026mut HashMap\u003cString, Vec\u003cStatement\u003e\u003e {\n        \u0026mut self.statements\n    }\n\n    pub const fn header_info(\u0026self) -\u003e \u0026HeaderInfo {\n        \u0026self.header_info\n    }\n\n    // Returns a list of all statements with an ID, as HashMap ID =\u003e \u0026Statement\n    fn get_id_statement_map(\u0026self) -\u003e HashMap\u003c\u0026str, \u0026Statement\u003e {\n        self.statements\n            .values()\n            .flat_map(|v| v.iter())\n            .filter_map(|statement| Some((statement.id()?.as_str(), statement)))\n            .collect()\n    }\n\n    // Returns a list of all statements without IDs\n    fn get_statements_without_id(\u0026self) -\u003e Vec\u003c\u0026Statement\u003e {\n        self.statements\n            .values()\n            .flat_map(|v| v.iter())\n            .filter(|statement| statement.id().is_none())\n            .collect()\n    }\n\n    pub fn patch(\u0026self, other: \u0026Self) -\u003e Result\u003cStatementsPatch, RestApiError\u003e {\n        // Statements without ID in other =\u003e fail\n        if !other.get_statements_without_id().is_empty() {\n            return Err(RestApiError::MissingId);\n        }\n\n        let mut patch = StatementsPatch::default();\n        let from_statements_with_id = self.get_id_statement_map();\n        let to_statements_with_id = other.get_id_statement_map();\n\n        Self::patch_modify_remove(\u0026mut patch, \u0026from_statements_with_id, \u0026to_statements_with_id)?;\n        Self::patch_add_new(\u0026mut patch, from_statements_with_id, to_statements_with_id);\n\n        Ok(patch)\n    }\n\n    fn patch_modify_remove(\n        patch: \u0026mut StatementsPatch,\n        from_statements_with_id: \u0026HashMap\u003c\u0026str, \u0026Statement\u003e,\n        to_statements_with_id: \u0026HashMap\u003c\u0026str, \u0026Statement\u003e,\n    ) -\u003e Result\u003c(), RestApiError\u003e {\n        for (statement_id, from_statement) in from_statements_with_id {\n            match to_statements_with_id.get(statement_id) {\n                Some(to_statement) =\u003e {\n                    // Modify statement\n                    let statement_patch = from_statement.patch(to_statement)?;\n                    patch.patch_mut().extend(statement_patch.patch().to_owned());\n                }\n                None =\u003e {\n                    // Remove statement\n                    let statement_path = format!(\"/statements/{statement_id}\"); // TODO check\n                    patch.remove(statement_path);\n                }\n            }\n        }\n        Ok(())\n    }\n\n    fn patch_add_new(\n        patch: \u0026mut StatementsPatch,\n        from_statements_with_id: HashMap\u003c\u0026str, \u0026Statement\u003e,\n        to_statements_with_id: HashMap\u003c\u0026str, \u0026Statement\u003e,\n    ) {\n        // Add new statements\n        for (statement_id, to_statement) in \u0026to_statements_with_id {\n            if !from_statements_with_id.contains_key(statement_id) {\n                // Add new statement\n                let add_path = format!(\"/statements/{statement_id}\"); // TODO check\n                let value = json!(to_statement);\n                patch.add(add_path, value);\n            }\n        }\n    }\n}\n\n// GET\n#[async_trait]\nimpl HttpGetEntity for Statements {\n    async fn get_match(\n        id: \u0026EntityId,\n        api: \u0026RestApi,\n        rm: RevisionMatch,\n    ) -\u003e Result\u003cSelf, RestApiError\u003e {\n        let path = Self::get_rest_api_path(id)?;\n        let (j, header_info) = Self::get_match_internal(api, \u0026path, rm).await?;\n        Self::from_json_header_info(\u0026j, header_info)\n    }\n}\n\n// POST\nimpl Statements {\n    /// Posts a new statement to an entity\n    pub async fn post(\n        \u0026self,\n        id: \u0026EntityId,\n        statement: Statement,\n        api: \u0026mut RestApi,\n    ) -\u003e Result\u003cStatement, RestApiError\u003e {\n        self.post_meta(id, statement, api, EditMetadata::default())\n            .await\n    }\n\n    /// Posts a new statement to an entity with metadata\n    pub async fn post_meta(\n        \u0026self,\n        id: \u0026EntityId,\n        mut statement: Statement,\n        api: \u0026mut RestApi,\n        em: EditMetadata,\n    ) -\u003e Result\u003cStatement, RestApiError\u003e {\n        statement.set_id(None);\n        let j0 = json!({\"statement\": statement});\n        let request = self\n            .generate_json_request(id, reqwest::Method::POST, j0, api, \u0026em)\n            .await?;\n        let response = api.execute(request).await?;\n        let (j, _statement_id) = self.filter_response_error(response).await?;\n        // TODO add to self.statements?\n        Statement::from_json(\u0026j)\n    }\n}\n\nimpl HttpMisc for Statements {\n    fn get_rest_api_path(id: \u0026EntityId) -\u003e Result\u003cString, RestApiError\u003e {\n        Ok(format!(\n            \"/entities/{group}/{id}/statements\",\n            group = id.group()?\n        ))\n    }\n}\n\nimpl Serialize for Statements {\n    fn serialize\u003cS\u003e(\u0026self, serializer: S) -\u003e Result\u003cS::Ok, S::Error\u003e\n    where\n        S: serde::Serializer,\n    {\n        let mut s = serializer.serialize_map(Some(self.statements.len()))?;\n        for (property, statements) in \u0026self.statements {\n            s.serialize_entry(property, statements)?;\n        }\n        s.end()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use crate::statement_value::StatementValue;\n    use http::{HeaderMap, HeaderValue};\n    use wiremock::matchers::{bearer_token, body_partial_json, method, path};\n    use wiremock::{Mock, MockServer, ResponseTemplate};\n\n    use super::*;\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_statements_get() {\n        let v = std::fs::read_to_string(\"test_data/Q42.json\").unwrap();\n        let v: Value = serde_json::from_str(\u0026v).unwrap();\n\n        let mock_path = \"/w/rest.php/wikibase/v1/entities/items/Q42/statements\";\n        let mock_server = MockServer::start().await;\n        Mock::given(method(\"GET\"))\n            .and(path(mock_path))\n            .respond_with(ResponseTemplate::new(200).set_body_json(\u0026v[\"statements\"]))\n            .mount(\u0026mock_server)\n            .await;\n        let api = RestApi::builder(\u0026(mock_server.uri() + \"/w/rest.php\"))\n            .unwrap()\n            .build();\n\n        let statements = Statements::get(\u0026EntityId::item(\"Q42\"), \u0026api).await.unwrap();\n        assert!(!statements.property(\"P31\").is_empty());\n    }\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_statements_post() {\n        // #lizard forgives the complexity\n        let id = EntityId::item(\"Q42\");\n        let v = std::fs::read_to_string(\"test_data/test_statements_post.json\").unwrap();\n        let v: Value = serde_json::from_str(\u0026v).unwrap();\n        let mock_path = \"/w/rest.php/wikibase/v1/entities/items/Q42/statements\";\n        let mock_server = MockServer::start().await;\n        let token = \"FAKE_TOKEN\";\n        Mock::given(method(\"GET\"))\n            .and(path(mock_path))\n            .respond_with(\n                ResponseTemplate::new(200)\n                    .set_body_json(json!({}))\n                    .insert_header(\"ETag\", \"123\"),\n            )\n            .mount(\u0026mock_server)\n            .await;\n        Mock::given(body_partial_json(\n            json!({\"statement\": {\"value\":{\"content\":\"Q5\"}}}),\n        ))\n        .and(method(\"POST\"))\n        .and(path(mock_path))\n        .and(bearer_token(token))\n        .respond_with(ResponseTemplate::new(200).set_body_json(\u0026v))\n        .mount(\u0026mock_server)\n        .await;\n        let mut api = RestApi::builder(\u0026(mock_server.uri() + \"/w/rest.php\"))\n            .unwrap()\n            .with_access_token(token)\n            .build();\n\n        // Get and check existing statements\n        let statements = Statements::get(\u0026id, \u0026api).await.unwrap();\n        assert!(statements.property(\"P31\").is_empty());\n\n        // Create new statement\n        let mut statement = Statement::default();\n        statement.set_property(\"P31\".into());\n        statement.set_value(StatementValue::new_string(\"Q5\"));\n\n        // POST new statement\n        let statement = statements.post(\u0026id, statement, \u0026mut api).await.unwrap();\n        assert_eq!(statement.value(), \u0026StatementValue::new_string(\"Q5\"));\n    }\n\n    #[tokio::test]\n    #[cfg_attr(miri, ignore)]\n    async fn test_eq() {\n        // To ensure that statement lists with and without header info are equal\n        let id = EntityId::item(\"Q42\");\n        let mock_path = \"/w/rest.php/wikibase/v1/entities/items/Q42/statements\";\n        let mock_server = MockServer::start().await;\n        let token = \"FAKE_TOKEN\";\n        Mock::given(method(\"GET\"))\n            .and(path(mock_path))\n            .respond_with(\n                ResponseTemplate::new(200)\n                    .set_body_json(json!({}))\n                    .insert_header(\"ETag\", \"123\"),\n            )\n            .mount(\u0026mock_server)\n            .await;\n        let api = RestApi::builder(\u0026(mock_server.uri() + \"/w/rest.php\"))\n            .unwrap()\n            .with_access_token(token)\n            .build();\n\n        // Get empty statements but with revision ID\n        let statements1 = Statements::get(\u0026id, \u0026api).await.unwrap();\n        let statements2 = Statements::default();\n        assert_eq!(statements1, statements2);\n    }\n\n    #[test]\n    fn test_insert_and_len() {\n        let mut statements = Statements::default();\n        assert_eq!(statements.len(), 0);\n        let mut statement = Statement::default();\n        statement.set_property(\"P31\".into());\n        statements.insert(statement.clone());\n        statements.insert(statement.clone());\n        statement.set_property(\"P1\".into());\n        statements.insert(statement.clone());\n        assert_eq!(statements.len(), 3);\n    }\n\n    #[test]\n    fn test_statements_statements() {\n        let mut statements = Statements::default();\n        let mut statement = Statement::default();\n        statement.set_property(\"P31\".into());\n        statements.insert(statement.clone());\n        statement.set_property(\"P1\".into());\n        statements.insert(statement.clone());\n        assert_eq!(statements.statements().len(), 2);\n        statements.statements_mut().remove(\"P31\");\n        assert_eq!(statements.statements().len(), 1);\n    }\n\n    #[test]\n    fn test_header_info() {\n        let mut headers = HeaderMap::new();\n        headers.insert(\"ETag\", HeaderValue::from_str(\"1234567890\").unwrap());\n        headers.insert(\n            \"Last-Modified\",\n            HeaderValue::from_str(\"Wed, 21 Oct 2015 07:28:00 GMT\").unwrap(),\n        );\n        let hi = HeaderInfo::from_header(\u0026headers);\n        let mut statements = Statements::default();\n        assert_eq!(statements.header_info(), \u0026HeaderInfo::default());\n        statements.header_info = hi.to_owned();\n        assert_eq!(statements.header_info(), \u0026hi);\n    }\n\n    #[test]\n    fn test_get_id_statement_map() {\n        let mut statements = Statements::default();\n        let mut statement = Statement::default();\n        statement.set_id(Some(\"Q1\".into()));\n        statement.set_property(\"P31\".into());\n        statements.insert(statement.clone());\n        statement.set_id(Some(\"Q2\".into()));\n        statement.set_property(\"P1\".into());\n        statements.insert(statement.clone());\n        let id_statement_map = statements.get_id_statement_map();\n        assert_eq!(id_statement_map.len(), 2);\n        assert_eq!(id_statement_map.get(\"Q1\").unwrap().property().id(), \"P31\");\n        assert_eq!(id_statement_map.get(\"Q2\").unwrap().property().id(), \"P1\");\n    }\n\n    #[test]\n    fn test_get_statements_without_id() {\n        let mut statements = Statements::default();\n        let mut statement = Statement::default();\n        statement.set_id(Some(\"Q1\".into()));\n        statement.set_property(\"P31\".into());\n        statements.insert(statement.clone());\n        statement.set_id(None);\n        statement.set_property(\"P1\".into());\n        statements.insert(statement.clone());\n        let statements_without_id = statements.get_statements_without_id();\n        assert_eq!(statements_without_id.len(), 1);\n        assert_eq!(statements_without_id[0].property().id(), \"P1\");\n    }\n\n    #[test]\n    fn test_patch() {\n        let mut statements1 = Statements::default();\n        let mut statement = Statement::default();\n        statement.set_id(Some(\"Q1\".into()));\n        statement.set_property(\"P31\".into());\n        statements1.insert(statement.clone());\n        statement.set_id(Some(\"Q2\".into()));\n        statement.set_property(\"P1\".into());\n        statements1.insert(statement.clone());\n\n        let mut statements2 = Statements::default();\n        statement.set_id(Some(\"Q1\".into()));\n        statement.set_property(\"P31\".into());\n        statements2.insert(statement.clone());\n        statement.set_id(Some(\"Q3\".into()));\n        statement.set_property(\"P1\".into());\n        statements2.insert(statement.clone());\n\n        let patch = statements1.patch(\u0026statements2).unwrap();\n        assert_eq!(patch.patch().len(), 2);\n        assert_eq!(patch.patch()[0].op(), \"remove\");\n        assert_eq!(patch.patch()[1].op(), \"add\");\n    }\n}\n","traces":[{"line":21,"address":[],"length":0,"stats":{"Line":15}},{"line":22,"address":[],"length":0,"stats":{"Line":15}},{"line":26,"address":[],"length":0,"stats":{"Line":18}},{"line":27,"address":[],"length":0,"stats":{"Line":18}},{"line":28,"address":[],"length":0,"stats":{"Line":36}},{"line":30,"address":[],"length":0,"stats":{"Line":18}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":6134}},{"line":35,"address":[],"length":0,"stats":{"Line":3058}},{"line":36,"address":[],"length":0,"stats":{"Line":3058}},{"line":38,"address":[],"length":0,"stats":{"Line":3058}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":3058}},{"line":48,"address":[],"length":0,"stats":{"Line":18}},{"line":49,"address":[],"length":0,"stats":{"Line":18}},{"line":53,"address":[],"length":0,"stats":{"Line":6}},{"line":54,"address":[],"length":0,"stats":{"Line":16}},{"line":58,"address":[],"length":0,"stats":{"Line":17}},{"line":59,"address":[],"length":0,"stats":{"Line":17}},{"line":63,"address":[],"length":0,"stats":{"Line":4}},{"line":64,"address":[],"length":0,"stats":{"Line":4}},{"line":65,"address":[],"length":0,"stats":{"Line":4}},{"line":66,"address":[],"length":0,"stats":{"Line":11}},{"line":69,"address":[],"length":0,"stats":{"Line":15}},{"line":70,"address":[],"length":0,"stats":{"Line":15}},{"line":71,"address":[],"length":0,"stats":{"Line":15}},{"line":72,"address":[],"length":0,"stats":{"Line":15}},{"line":74,"address":[],"length":0,"stats":{"Line":15}},{"line":77,"address":[],"length":0,"stats":{"Line":2}},{"line":78,"address":[],"length":0,"stats":{"Line":2}},{"line":81,"address":[],"length":0,"stats":{"Line":1}},{"line":82,"address":[],"length":0,"stats":{"Line":1}},{"line":85,"address":[],"length":0,"stats":{"Line":2}},{"line":86,"address":[],"length":0,"stats":{"Line":2}},{"line":90,"address":[],"length":0,"stats":{"Line":5}},{"line":91,"address":[],"length":0,"stats":{"Line":5}},{"line":93,"address":[],"length":0,"stats":{"Line":16}},{"line":94,"address":[],"length":0,"stats":{"Line":22}},{"line":99,"address":[],"length":0,"stats":{"Line":3}},{"line":100,"address":[],"length":0,"stats":{"Line":3}},{"line":102,"address":[],"length":0,"stats":{"Line":10}},{"line":103,"address":[],"length":0,"stats":{"Line":10}},{"line":107,"address":[],"length":0,"stats":{"Line":2}},{"line":109,"address":[],"length":0,"stats":{"Line":2}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":2}},{"line":114,"address":[],"length":0,"stats":{"Line":2}},{"line":115,"address":[],"length":0,"stats":{"Line":2}},{"line":117,"address":[],"length":0,"stats":{"Line":2}},{"line":118,"address":[],"length":0,"stats":{"Line":2}},{"line":120,"address":[],"length":0,"stats":{"Line":2}},{"line":123,"address":[],"length":0,"stats":{"Line":2}},{"line":128,"address":[],"length":0,"stats":{"Line":6}},{"line":129,"address":[],"length":0,"stats":{"Line":2}},{"line":130,"address":[],"length":0,"stats":{"Line":1}},{"line":132,"address":[],"length":0,"stats":{"Line":2}},{"line":135,"address":[],"length":0,"stats":{"Line":1}},{"line":137,"address":[],"length":0,"stats":{"Line":1}},{"line":138,"address":[],"length":0,"stats":{"Line":1}},{"line":142,"address":[],"length":0,"stats":{"Line":2}},{"line":145,"address":[],"length":0,"stats":{"Line":2}},{"line":151,"address":[],"length":0,"stats":{"Line":6}},{"line":152,"address":[],"length":0,"stats":{"Line":1}},{"line":154,"address":[],"length":0,"stats":{"Line":1}},{"line":155,"address":[],"length":0,"stats":{"Line":1}},{"line":156,"address":[],"length":0,"stats":{"Line":1}},{"line":170,"address":[],"length":0,"stats":{"Line":6}},{"line":171,"address":[],"length":0,"stats":{"Line":3}},{"line":179,"address":[],"length":0,"stats":{"Line":1}},{"line":185,"address":[],"length":0,"stats":{"Line":1}},{"line":186,"address":[],"length":0,"stats":{"Line":1}},{"line":190,"address":[],"length":0,"stats":{"Line":1}},{"line":197,"address":[],"length":0,"stats":{"Line":1}},{"line":198,"address":[],"length":0,"stats":{"Line":1}},{"line":199,"address":[],"length":0,"stats":{"Line":2}},{"line":200,"address":[],"length":0,"stats":{"Line":1}},{"line":201,"address":[],"length":0,"stats":{"Line":1}},{"line":202,"address":[],"length":0,"stats":{"Line":1}},{"line":203,"address":[],"length":0,"stats":{"Line":1}},{"line":210,"address":[],"length":0,"stats":{"Line":4}},{"line":211,"address":[],"length":0,"stats":{"Line":4}},{"line":212,"address":[],"length":0,"stats":{"Line":4}},{"line":213,"address":[],"length":0,"stats":{"Line":4}},{"line":219,"address":[],"length":0,"stats":{"Line":6}},{"line":223,"address":[],"length":0,"stats":{"Line":12}},{"line":224,"address":[],"length":0,"stats":{"Line":1824}},{"line":225,"address":[],"length":0,"stats":{"Line":909}},{"line":227,"address":[],"length":0,"stats":{"Line":6}}],"covered":85,"coverable":90},{"path":["/","Users","magnusmanske","rust","wikibase_rest_api","src","statements_patch.rs"],"content":"use crate::{patch_entry::PatchEntry, Patch};\nuse serde::Serialize;\n\n#[derive(Debug, Clone, Default, PartialEq, Serialize)]\npub struct StatementsPatch {\n    patch: Vec\u003cPatchEntry\u003e,\n}\n\nimpl Patch for StatementsPatch {\n    fn patch(\u0026self) -\u003e \u0026Vec\u003cPatchEntry\u003e {\n        \u0026self.patch\n    }\n\n    fn patch_mut(\u0026mut self) -\u003e \u0026mut Vec\u003cPatchEntry\u003e {\n        \u0026mut self.patch\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use serde_json::json;\n\n    #[test]\n    fn test_statements_patch() {\n        let mut patch = StatementsPatch::default();\n        patch.add(\"/foo/bar\", json!(\"baz\"));\n        assert_eq!(patch.patch().len(), 1);\n        let expected = PatchEntry::new(\"add\", \"/foo/bar\", json!(\"baz\"));\n        assert_eq!(patch.patch()[0], expected);\n\n        patch.patch_mut().remove(0);\n        assert_eq!(patch.patch().len(), 0);\n    }\n}\n","traces":[{"line":10,"address":[],"length":0,"stats":{"Line":7}},{"line":11,"address":[],"length":0,"stats":{"Line":7}},{"line":14,"address":[],"length":0,"stats":{"Line":5}},{"line":15,"address":[],"length":0,"stats":{"Line":5}}],"covered":4,"coverable":4}]};
        var previousData = null;
    </script>
    <script crossorigin>/** @license React v16.13.1
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
'use strict';(function(d,r){"object"===typeof exports&&"undefined"!==typeof module?r(exports):"function"===typeof define&&define.amd?define(["exports"],r):(d=d||self,r(d.React={}))})(this,function(d){function r(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function w(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function da(){}function L(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function ea(a,b,c){var g,e={},fa=null,d=null;if(null!=b)for(g in void 0!==b.ref&&(d=b.ref),void 0!==b.key&&(fa=""+b.key),b)ha.call(b,g)&&!ia.hasOwnProperty(g)&&(e[g]=b[g]);var h=arguments.length-2;if(1===h)e.children=c;else if(1<h){for(var k=Array(h),f=0;f<h;f++)k[f]=arguments[f+2];e.children=k}if(a&&a.defaultProps)for(g in h=a.defaultProps,
h)void 0===e[g]&&(e[g]=h[g]);return{$$typeof:x,type:a,key:fa,ref:d,props:e,_owner:M.current}}function va(a,b){return{$$typeof:x,type:a.type,key:b,ref:a.ref,props:a.props,_owner:a._owner}}function N(a){return"object"===typeof a&&null!==a&&a.$$typeof===x}function wa(a){var b={"=":"=0",":":"=2"};return"$"+(""+a).replace(/[=:]/g,function(a){return b[a]})}function ja(a,b,c,g){if(C.length){var e=C.pop();e.result=a;e.keyPrefix=b;e.func=c;e.context=g;e.count=0;return e}return{result:a,keyPrefix:b,func:c,
context:g,count:0}}function ka(a){a.result=null;a.keyPrefix=null;a.func=null;a.context=null;a.count=0;10>C.length&&C.push(a)}function O(a,b,c,g){var e=typeof a;if("undefined"===e||"boolean"===e)a=null;var d=!1;if(null===a)d=!0;else switch(e){case "string":case "number":d=!0;break;case "object":switch(a.$$typeof){case x:case xa:d=!0}}if(d)return c(g,a,""===b?"."+P(a,0):b),1;d=0;b=""===b?".":b+":";if(Array.isArray(a))for(var f=0;f<a.length;f++){e=a[f];var h=b+P(e,f);d+=O(e,h,c,g)}else if(null===a||
"object"!==typeof a?h=null:(h=la&&a[la]||a["@@iterator"],h="function"===typeof h?h:null),"function"===typeof h)for(a=h.call(a),f=0;!(e=a.next()).done;)e=e.value,h=b+P(e,f++),d+=O(e,h,c,g);else if("object"===e)throw c=""+a,Error(r(31,"[object Object]"===c?"object with keys {"+Object.keys(a).join(", ")+"}":c,""));return d}function Q(a,b,c){return null==a?0:O(a,"",b,c)}function P(a,b){return"object"===typeof a&&null!==a&&null!=a.key?wa(a.key):b.toString(36)}function ya(a,b,c){a.func.call(a.context,b,
a.count++)}function za(a,b,c){var g=a.result,e=a.keyPrefix;a=a.func.call(a.context,b,a.count++);Array.isArray(a)?R(a,g,c,function(a){return a}):null!=a&&(N(a)&&(a=va(a,e+(!a.key||b&&b.key===a.key?"":(""+a.key).replace(ma,"$&/")+"/")+c)),g.push(a))}function R(a,b,c,g,e){var d="";null!=c&&(d=(""+c).replace(ma,"$&/")+"/");b=ja(b,d,g,e);Q(a,za,b);ka(b)}function t(){var a=na.current;if(null===a)throw Error(r(321));return a}function S(a,b){var c=a.length;a.push(b);a:for(;;){var g=c-1>>>1,e=a[g];if(void 0!==
e&&0<D(e,b))a[g]=b,a[c]=e,c=g;else break a}}function n(a){a=a[0];return void 0===a?null:a}function E(a){var b=a[0];if(void 0!==b){var c=a.pop();if(c!==b){a[0]=c;a:for(var g=0,e=a.length;g<e;){var d=2*(g+1)-1,f=a[d],h=d+1,k=a[h];if(void 0!==f&&0>D(f,c))void 0!==k&&0>D(k,f)?(a[g]=k,a[h]=c,g=h):(a[g]=f,a[d]=c,g=d);else if(void 0!==k&&0>D(k,c))a[g]=k,a[h]=c,g=h;else break a}}return b}return null}function D(a,b){var c=a.sortIndex-b.sortIndex;return 0!==c?c:a.id-b.id}function F(a){for(var b=n(u);null!==
b;){if(null===b.callback)E(u);else if(b.startTime<=a)E(u),b.sortIndex=b.expirationTime,S(p,b);else break;b=n(u)}}function T(a){y=!1;F(a);if(!v)if(null!==n(p))v=!0,z(U);else{var b=n(u);null!==b&&G(T,b.startTime-a)}}function U(a,b){v=!1;y&&(y=!1,V());H=!0;var c=m;try{F(b);for(l=n(p);null!==l&&(!(l.expirationTime>b)||a&&!W());){var g=l.callback;if(null!==g){l.callback=null;m=l.priorityLevel;var e=g(l.expirationTime<=b);b=q();"function"===typeof e?l.callback=e:l===n(p)&&E(p);F(b)}else E(p);l=n(p)}if(null!==
l)var d=!0;else{var f=n(u);null!==f&&G(T,f.startTime-b);d=!1}return d}finally{l=null,m=c,H=!1}}function oa(a){switch(a){case 1:return-1;case 2:return 250;case 5:return 1073741823;case 4:return 1E4;default:return 5E3}}var f="function"===typeof Symbol&&Symbol.for,x=f?Symbol.for("react.element"):60103,xa=f?Symbol.for("react.portal"):60106,Aa=f?Symbol.for("react.fragment"):60107,Ba=f?Symbol.for("react.strict_mode"):60108,Ca=f?Symbol.for("react.profiler"):60114,Da=f?Symbol.for("react.provider"):60109,
Ea=f?Symbol.for("react.context"):60110,Fa=f?Symbol.for("react.forward_ref"):60112,Ga=f?Symbol.for("react.suspense"):60113,Ha=f?Symbol.for("react.memo"):60115,Ia=f?Symbol.for("react.lazy"):60116,la="function"===typeof Symbol&&Symbol.iterator,pa=Object.getOwnPropertySymbols,Ja=Object.prototype.hasOwnProperty,Ka=Object.prototype.propertyIsEnumerable,I=function(){try{if(!Object.assign)return!1;var a=new String("abc");a[5]="de";if("5"===Object.getOwnPropertyNames(a)[0])return!1;var b={};for(a=0;10>a;a++)b["_"+
String.fromCharCode(a)]=a;if("0123456789"!==Object.getOwnPropertyNames(b).map(function(a){return b[a]}).join(""))return!1;var c={};"abcdefghijklmnopqrst".split("").forEach(function(a){c[a]=a});return"abcdefghijklmnopqrst"!==Object.keys(Object.assign({},c)).join("")?!1:!0}catch(g){return!1}}()?Object.assign:function(a,b){if(null===a||void 0===a)throw new TypeError("Object.assign cannot be called with null or undefined");var c=Object(a);for(var g,e=1;e<arguments.length;e++){var d=Object(arguments[e]);
for(var f in d)Ja.call(d,f)&&(c[f]=d[f]);if(pa){g=pa(d);for(var h=0;h<g.length;h++)Ka.call(d,g[h])&&(c[g[h]]=d[g[h]])}}return c},ca={isMounted:function(a){return!1},enqueueForceUpdate:function(a,b,c){},enqueueReplaceState:function(a,b,c,d){},enqueueSetState:function(a,b,c,d){}},ba={};w.prototype.isReactComponent={};w.prototype.setState=function(a,b){if("object"!==typeof a&&"function"!==typeof a&&null!=a)throw Error(r(85));this.updater.enqueueSetState(this,a,b,"setState")};w.prototype.forceUpdate=
function(a){this.updater.enqueueForceUpdate(this,a,"forceUpdate")};da.prototype=w.prototype;f=L.prototype=new da;f.constructor=L;I(f,w.prototype);f.isPureReactComponent=!0;var M={current:null},ha=Object.prototype.hasOwnProperty,ia={key:!0,ref:!0,__self:!0,__source:!0},ma=/\/+/g,C=[],na={current:null},X;if("undefined"===typeof window||"function"!==typeof MessageChannel){var A=null,qa=null,ra=function(){if(null!==A)try{var a=q();A(!0,a);A=null}catch(b){throw setTimeout(ra,0),b;}},La=Date.now();var q=
function(){return Date.now()-La};var z=function(a){null!==A?setTimeout(z,0,a):(A=a,setTimeout(ra,0))};var G=function(a,b){qa=setTimeout(a,b)};var V=function(){clearTimeout(qa)};var W=function(){return!1};f=X=function(){}}else{var Y=window.performance,sa=window.Date,Ma=window.setTimeout,Na=window.clearTimeout;"undefined"!==typeof console&&(f=window.cancelAnimationFrame,"function"!==typeof window.requestAnimationFrame&&console.error("This browser doesn't support requestAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"),
"function"!==typeof f&&console.error("This browser doesn't support cancelAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"));if("object"===typeof Y&&"function"===typeof Y.now)q=function(){return Y.now()};else{var Oa=sa.now();q=function(){return sa.now()-Oa}}var J=!1,K=null,Z=-1,ta=5,ua=0;W=function(){return q()>=ua};f=function(){};X=function(a){0>a||125<a?console.error("forceFrameRate takes a positive int between 0 and 125, forcing framerates higher than 125 fps is not unsupported"):
ta=0<a?Math.floor(1E3/a):5};var B=new MessageChannel,aa=B.port2;B.port1.onmessage=function(){if(null!==K){var a=q();ua=a+ta;try{K(!0,a)?aa.postMessage(null):(J=!1,K=null)}catch(b){throw aa.postMessage(null),b;}}else J=!1};z=function(a){K=a;J||(J=!0,aa.postMessage(null))};G=function(a,b){Z=Ma(function(){a(q())},b)};V=function(){Na(Z);Z=-1}}var p=[],u=[],Pa=1,l=null,m=3,H=!1,v=!1,y=!1,Qa=0;B={ReactCurrentDispatcher:na,ReactCurrentOwner:M,IsSomeRendererActing:{current:!1},assign:I};I(B,{Scheduler:{__proto__:null,
unstable_ImmediatePriority:1,unstable_UserBlockingPriority:2,unstable_NormalPriority:3,unstable_IdlePriority:5,unstable_LowPriority:4,unstable_runWithPriority:function(a,b){switch(a){case 1:case 2:case 3:case 4:case 5:break;default:a=3}var c=m;m=a;try{return b()}finally{m=c}},unstable_next:function(a){switch(m){case 1:case 2:case 3:var b=3;break;default:b=m}var c=m;m=b;try{return a()}finally{m=c}},unstable_scheduleCallback:function(a,b,c){var d=q();if("object"===typeof c&&null!==c){var e=c.delay;
e="number"===typeof e&&0<e?d+e:d;c="number"===typeof c.timeout?c.timeout:oa(a)}else c=oa(a),e=d;c=e+c;a={id:Pa++,callback:b,priorityLevel:a,startTime:e,expirationTime:c,sortIndex:-1};e>d?(a.sortIndex=e,S(u,a),null===n(p)&&a===n(u)&&(y?V():y=!0,G(T,e-d))):(a.sortIndex=c,S(p,a),v||H||(v=!0,z(U)));return a},unstable_cancelCallback:function(a){a.callback=null},unstable_wrapCallback:function(a){var b=m;return function(){var c=m;m=b;try{return a.apply(this,arguments)}finally{m=c}}},unstable_getCurrentPriorityLevel:function(){return m},
unstable_shouldYield:function(){var a=q();F(a);var b=n(p);return b!==l&&null!==l&&null!==b&&null!==b.callback&&b.startTime<=a&&b.expirationTime<l.expirationTime||W()},unstable_requestPaint:f,unstable_continueExecution:function(){v||H||(v=!0,z(U))},unstable_pauseExecution:function(){},unstable_getFirstCallbackNode:function(){return n(p)},get unstable_now(){return q},get unstable_forceFrameRate(){return X},unstable_Profiling:null},SchedulerTracing:{__proto__:null,__interactionsRef:null,__subscriberRef:null,
unstable_clear:function(a){return a()},unstable_getCurrent:function(){return null},unstable_getThreadID:function(){return++Qa},unstable_trace:function(a,b,c){return c()},unstable_wrap:function(a){return a},unstable_subscribe:function(a){},unstable_unsubscribe:function(a){}}});d.Children={map:function(a,b,c){if(null==a)return a;var d=[];R(a,d,null,b,c);return d},forEach:function(a,b,c){if(null==a)return a;b=ja(null,null,b,c);Q(a,ya,b);ka(b)},count:function(a){return Q(a,function(){return null},null)},
toArray:function(a){var b=[];R(a,b,null,function(a){return a});return b},only:function(a){if(!N(a))throw Error(r(143));return a}};d.Component=w;d.Fragment=Aa;d.Profiler=Ca;d.PureComponent=L;d.StrictMode=Ba;d.Suspense=Ga;d.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=B;d.cloneElement=function(a,b,c){if(null===a||void 0===a)throw Error(r(267,a));var d=I({},a.props),e=a.key,f=a.ref,m=a._owner;if(null!=b){void 0!==b.ref&&(f=b.ref,m=M.current);void 0!==b.key&&(e=""+b.key);if(a.type&&a.type.defaultProps)var h=
a.type.defaultProps;for(k in b)ha.call(b,k)&&!ia.hasOwnProperty(k)&&(d[k]=void 0===b[k]&&void 0!==h?h[k]:b[k])}var k=arguments.length-2;if(1===k)d.children=c;else if(1<k){h=Array(k);for(var l=0;l<k;l++)h[l]=arguments[l+2];d.children=h}return{$$typeof:x,type:a.type,key:e,ref:f,props:d,_owner:m}};d.createContext=function(a,b){void 0===b&&(b=null);a={$$typeof:Ea,_calculateChangedBits:b,_currentValue:a,_currentValue2:a,_threadCount:0,Provider:null,Consumer:null};a.Provider={$$typeof:Da,_context:a};return a.Consumer=
a};d.createElement=ea;d.createFactory=function(a){var b=ea.bind(null,a);b.type=a;return b};d.createRef=function(){return{current:null}};d.forwardRef=function(a){return{$$typeof:Fa,render:a}};d.isValidElement=N;d.lazy=function(a){return{$$typeof:Ia,_ctor:a,_status:-1,_result:null}};d.memo=function(a,b){return{$$typeof:Ha,type:a,compare:void 0===b?null:b}};d.useCallback=function(a,b){return t().useCallback(a,b)};d.useContext=function(a,b){return t().useContext(a,b)};d.useDebugValue=function(a,b){};
d.useEffect=function(a,b){return t().useEffect(a,b)};d.useImperativeHandle=function(a,b,c){return t().useImperativeHandle(a,b,c)};d.useLayoutEffect=function(a,b){return t().useLayoutEffect(a,b)};d.useMemo=function(a,b){return t().useMemo(a,b)};d.useReducer=function(a,b,c){return t().useReducer(a,b,c)};d.useRef=function(a){return t().useRef(a)};d.useState=function(a){return t().useState(a)};d.version="16.13.1"});
</script>
    <script crossorigin>/** @license React v16.13.1
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
/*
 Modernizr 3.0.0pre (Custom Build) | MIT
*/
'use strict';(function(I,ea){"object"===typeof exports&&"undefined"!==typeof module?ea(exports,require("react")):"function"===typeof define&&define.amd?define(["exports","react"],ea):(I=I||self,ea(I.ReactDOM={},I.React))})(this,function(I,ea){function k(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function ji(a,b,c,d,e,f,g,h,m){yb=!1;gc=null;ki.apply(li,arguments)}function mi(a,b,c,d,e,f,g,h,m){ji.apply(this,arguments);if(yb){if(yb){var n=gc;yb=!1;gc=null}else throw Error(k(198));hc||(hc=!0,pd=n)}}function lf(a,b,c){var d=a.type||"unknown-event";a.currentTarget=mf(c);mi(d,b,void 0,a);a.currentTarget=null}function nf(){if(ic)for(var a in cb){var b=cb[a],c=ic.indexOf(a);if(!(-1<c))throw Error(k(96,a));if(!jc[c]){if(!b.extractEvents)throw Error(k(97,a));jc[c]=b;c=b.eventTypes;for(var d in c){var e=
void 0;var f=c[d],g=b,h=d;if(qd.hasOwnProperty(h))throw Error(k(99,h));qd[h]=f;var m=f.phasedRegistrationNames;if(m){for(e in m)m.hasOwnProperty(e)&&of(m[e],g,h);e=!0}else f.registrationName?(of(f.registrationName,g,h),e=!0):e=!1;if(!e)throw Error(k(98,d,a));}}}}function of(a,b,c){if(db[a])throw Error(k(100,a));db[a]=b;rd[a]=b.eventTypes[c].dependencies}function pf(a){var b=!1,c;for(c in a)if(a.hasOwnProperty(c)){var d=a[c];if(!cb.hasOwnProperty(c)||cb[c]!==d){if(cb[c])throw Error(k(102,c));cb[c]=
d;b=!0}}b&&nf()}function qf(a){if(a=rf(a)){if("function"!==typeof sd)throw Error(k(280));var b=a.stateNode;b&&(b=td(b),sd(a.stateNode,a.type,b))}}function sf(a){eb?fb?fb.push(a):fb=[a]:eb=a}function tf(){if(eb){var a=eb,b=fb;fb=eb=null;qf(a);if(b)for(a=0;a<b.length;a++)qf(b[a])}}function ud(){if(null!==eb||null!==fb)vd(),tf()}function uf(a,b,c){if(wd)return a(b,c);wd=!0;try{return vf(a,b,c)}finally{wd=!1,ud()}}function ni(a){if(wf.call(xf,a))return!0;if(wf.call(yf,a))return!1;if(oi.test(a))return xf[a]=
!0;yf[a]=!0;return!1}function pi(a,b,c,d){if(null!==c&&0===c.type)return!1;switch(typeof b){case "function":case "symbol":return!0;case "boolean":if(d)return!1;if(null!==c)return!c.acceptsBooleans;a=a.toLowerCase().slice(0,5);return"data-"!==a&&"aria-"!==a;default:return!1}}function qi(a,b,c,d){if(null===b||"undefined"===typeof b||pi(a,b,c,d))return!0;if(d)return!1;if(null!==c)switch(c.type){case 3:return!b;case 4:return!1===b;case 5:return isNaN(b);case 6:return isNaN(b)||1>b}return!1}function L(a,
b,c,d,e,f){this.acceptsBooleans=2===b||3===b||4===b;this.attributeName=d;this.attributeNamespace=e;this.mustUseProperty=c;this.propertyName=a;this.type=b;this.sanitizeURL=f}function xd(a,b,c,d){var e=E.hasOwnProperty(b)?E[b]:null;var f=null!==e?0===e.type:d?!1:!(2<b.length)||"o"!==b[0]&&"O"!==b[0]||"n"!==b[1]&&"N"!==b[1]?!1:!0;f||(qi(b,c,e,d)&&(c=null),d||null===e?ni(b)&&(null===c?a.removeAttribute(b):a.setAttribute(b,""+c)):e.mustUseProperty?a[e.propertyName]=null===c?3===e.type?!1:"":c:(b=e.attributeName,
d=e.attributeNamespace,null===c?a.removeAttribute(b):(e=e.type,c=3===e||4===e&&!0===c?"":""+c,d?a.setAttributeNS(d,b,c):a.setAttribute(b,c))))}function zb(a){if(null===a||"object"!==typeof a)return null;a=zf&&a[zf]||a["@@iterator"];return"function"===typeof a?a:null}function ri(a){if(-1===a._status){a._status=0;var b=a._ctor;b=b();a._result=b;b.then(function(b){0===a._status&&(b=b.default,a._status=1,a._result=b)},function(b){0===a._status&&(a._status=2,a._result=b)})}}function na(a){if(null==a)return null;
if("function"===typeof a)return a.displayName||a.name||null;if("string"===typeof a)return a;switch(a){case Ma:return"Fragment";case gb:return"Portal";case kc:return"Profiler";case Af:return"StrictMode";case lc:return"Suspense";case yd:return"SuspenseList"}if("object"===typeof a)switch(a.$$typeof){case Bf:return"Context.Consumer";case Cf:return"Context.Provider";case zd:var b=a.render;b=b.displayName||b.name||"";return a.displayName||(""!==b?"ForwardRef("+b+")":"ForwardRef");case Ad:return na(a.type);
case Df:return na(a.render);case Ef:if(a=1===a._status?a._result:null)return na(a)}return null}function Bd(a){var b="";do{a:switch(a.tag){case 3:case 4:case 6:case 7:case 10:case 9:var c="";break a;default:var d=a._debugOwner,e=a._debugSource,f=na(a.type);c=null;d&&(c=na(d.type));d=f;f="";e?f=" (at "+e.fileName.replace(si,"")+":"+e.lineNumber+")":c&&(f=" (created by "+c+")");c="\n    in "+(d||"Unknown")+f}b+=c;a=a.return}while(a);return b}function va(a){switch(typeof a){case "boolean":case "number":case "object":case "string":case "undefined":return a;
default:return""}}function Ff(a){var b=a.type;return(a=a.nodeName)&&"input"===a.toLowerCase()&&("checkbox"===b||"radio"===b)}function ti(a){var b=Ff(a)?"checked":"value",c=Object.getOwnPropertyDescriptor(a.constructor.prototype,b),d=""+a[b];if(!a.hasOwnProperty(b)&&"undefined"!==typeof c&&"function"===typeof c.get&&"function"===typeof c.set){var e=c.get,f=c.set;Object.defineProperty(a,b,{configurable:!0,get:function(){return e.call(this)},set:function(a){d=""+a;f.call(this,a)}});Object.defineProperty(a,
b,{enumerable:c.enumerable});return{getValue:function(){return d},setValue:function(a){d=""+a},stopTracking:function(){a._valueTracker=null;delete a[b]}}}}function mc(a){a._valueTracker||(a._valueTracker=ti(a))}function Gf(a){if(!a)return!1;var b=a._valueTracker;if(!b)return!0;var c=b.getValue();var d="";a&&(d=Ff(a)?a.checked?"true":"false":a.value);a=d;return a!==c?(b.setValue(a),!0):!1}function Cd(a,b){var c=b.checked;return M({},b,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=
c?c:a._wrapperState.initialChecked})}function Hf(a,b){var c=null==b.defaultValue?"":b.defaultValue,d=null!=b.checked?b.checked:b.defaultChecked;c=va(null!=b.value?b.value:c);a._wrapperState={initialChecked:d,initialValue:c,controlled:"checkbox"===b.type||"radio"===b.type?null!=b.checked:null!=b.value}}function If(a,b){b=b.checked;null!=b&&xd(a,"checked",b,!1)}function Dd(a,b){If(a,b);var c=va(b.value),d=b.type;if(null!=c)if("number"===d){if(0===c&&""===a.value||a.value!=c)a.value=""+c}else a.value!==
""+c&&(a.value=""+c);else if("submit"===d||"reset"===d){a.removeAttribute("value");return}b.hasOwnProperty("value")?Ed(a,b.type,c):b.hasOwnProperty("defaultValue")&&Ed(a,b.type,va(b.defaultValue));null==b.checked&&null!=b.defaultChecked&&(a.defaultChecked=!!b.defaultChecked)}function Jf(a,b,c){if(b.hasOwnProperty("value")||b.hasOwnProperty("defaultValue")){var d=b.type;if(!("submit"!==d&&"reset"!==d||void 0!==b.value&&null!==b.value))return;b=""+a._wrapperState.initialValue;c||b===a.value||(a.value=
b);a.defaultValue=b}c=a.name;""!==c&&(a.name="");a.defaultChecked=!!a._wrapperState.initialChecked;""!==c&&(a.name=c)}function Ed(a,b,c){if("number"!==b||a.ownerDocument.activeElement!==a)null==c?a.defaultValue=""+a._wrapperState.initialValue:a.defaultValue!==""+c&&(a.defaultValue=""+c)}function ui(a){var b="";ea.Children.forEach(a,function(a){null!=a&&(b+=a)});return b}function Fd(a,b){a=M({children:void 0},b);if(b=ui(b.children))a.children=b;return a}function hb(a,b,c,d){a=a.options;if(b){b={};
for(var e=0;e<c.length;e++)b["$"+c[e]]=!0;for(c=0;c<a.length;c++)e=b.hasOwnProperty("$"+a[c].value),a[c].selected!==e&&(a[c].selected=e),e&&d&&(a[c].defaultSelected=!0)}else{c=""+va(c);b=null;for(e=0;e<a.length;e++){if(a[e].value===c){a[e].selected=!0;d&&(a[e].defaultSelected=!0);return}null!==b||a[e].disabled||(b=a[e])}null!==b&&(b.selected=!0)}}function Gd(a,b){if(null!=b.dangerouslySetInnerHTML)throw Error(k(91));return M({},b,{value:void 0,defaultValue:void 0,children:""+a._wrapperState.initialValue})}
function Kf(a,b){var c=b.value;if(null==c){c=b.children;b=b.defaultValue;if(null!=c){if(null!=b)throw Error(k(92));if(Array.isArray(c)){if(!(1>=c.length))throw Error(k(93));c=c[0]}b=c}null==b&&(b="");c=b}a._wrapperState={initialValue:va(c)}}function Lf(a,b){var c=va(b.value),d=va(b.defaultValue);null!=c&&(c=""+c,c!==a.value&&(a.value=c),null==b.defaultValue&&a.defaultValue!==c&&(a.defaultValue=c));null!=d&&(a.defaultValue=""+d)}function Mf(a,b){b=a.textContent;b===a._wrapperState.initialValue&&""!==
b&&null!==b&&(a.value=b)}function Nf(a){switch(a){case "svg":return"http://www.w3.org/2000/svg";case "math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function Hd(a,b){return null==a||"http://www.w3.org/1999/xhtml"===a?Nf(b):"http://www.w3.org/2000/svg"===a&&"foreignObject"===b?"http://www.w3.org/1999/xhtml":a}function nc(a,b){var c={};c[a.toLowerCase()]=b.toLowerCase();c["Webkit"+a]="webkit"+b;c["Moz"+a]="moz"+b;return c}function oc(a){if(Id[a])return Id[a];
if(!ib[a])return a;var b=ib[a],c;for(c in b)if(b.hasOwnProperty(c)&&c in Of)return Id[a]=b[c];return a}function Jd(a){var b=Pf.get(a);void 0===b&&(b=new Map,Pf.set(a,b));return b}function Na(a){var b=a,c=a;if(a.alternate)for(;b.return;)b=b.return;else{a=b;do b=a,0!==(b.effectTag&1026)&&(c=b.return),a=b.return;while(a)}return 3===b.tag?c:null}function Qf(a){if(13===a.tag){var b=a.memoizedState;null===b&&(a=a.alternate,null!==a&&(b=a.memoizedState));if(null!==b)return b.dehydrated}return null}function Rf(a){if(Na(a)!==
a)throw Error(k(188));}function vi(a){var b=a.alternate;if(!b){b=Na(a);if(null===b)throw Error(k(188));return b!==a?null:a}for(var c=a,d=b;;){var e=c.return;if(null===e)break;var f=e.alternate;if(null===f){d=e.return;if(null!==d){c=d;continue}break}if(e.child===f.child){for(f=e.child;f;){if(f===c)return Rf(e),a;if(f===d)return Rf(e),b;f=f.sibling}throw Error(k(188));}if(c.return!==d.return)c=e,d=f;else{for(var g=!1,h=e.child;h;){if(h===c){g=!0;c=e;d=f;break}if(h===d){g=!0;d=e;c=f;break}h=h.sibling}if(!g){for(h=
f.child;h;){if(h===c){g=!0;c=f;d=e;break}if(h===d){g=!0;d=f;c=e;break}h=h.sibling}if(!g)throw Error(k(189));}}if(c.alternate!==d)throw Error(k(190));}if(3!==c.tag)throw Error(k(188));return c.stateNode.current===c?a:b}function Sf(a){a=vi(a);if(!a)return null;for(var b=a;;){if(5===b.tag||6===b.tag)return b;if(b.child)b.child.return=b,b=b.child;else{if(b===a)break;for(;!b.sibling;){if(!b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}}return null}function jb(a,b){if(null==
b)throw Error(k(30));if(null==a)return b;if(Array.isArray(a)){if(Array.isArray(b))return a.push.apply(a,b),a;a.push(b);return a}return Array.isArray(b)?[a].concat(b):[a,b]}function Kd(a,b,c){Array.isArray(a)?a.forEach(b,c):a&&b.call(c,a)}function pc(a){null!==a&&(Ab=jb(Ab,a));a=Ab;Ab=null;if(a){Kd(a,wi);if(Ab)throw Error(k(95));if(hc)throw a=pd,hc=!1,pd=null,a;}}function Ld(a){a=a.target||a.srcElement||window;a.correspondingUseElement&&(a=a.correspondingUseElement);return 3===a.nodeType?a.parentNode:
a}function Tf(a){if(!wa)return!1;a="on"+a;var b=a in document;b||(b=document.createElement("div"),b.setAttribute(a,"return;"),b="function"===typeof b[a]);return b}function Uf(a){a.topLevelType=null;a.nativeEvent=null;a.targetInst=null;a.ancestors.length=0;10>qc.length&&qc.push(a)}function Vf(a,b,c,d){if(qc.length){var e=qc.pop();e.topLevelType=a;e.eventSystemFlags=d;e.nativeEvent=b;e.targetInst=c;return e}return{topLevelType:a,eventSystemFlags:d,nativeEvent:b,targetInst:c,ancestors:[]}}function Wf(a){var b=
a.targetInst,c=b;do{if(!c){a.ancestors.push(c);break}var d=c;if(3===d.tag)d=d.stateNode.containerInfo;else{for(;d.return;)d=d.return;d=3!==d.tag?null:d.stateNode.containerInfo}if(!d)break;b=c.tag;5!==b&&6!==b||a.ancestors.push(c);c=Bb(d)}while(c);for(c=0;c<a.ancestors.length;c++){b=a.ancestors[c];var e=Ld(a.nativeEvent);d=a.topLevelType;var f=a.nativeEvent,g=a.eventSystemFlags;0===c&&(g|=64);for(var h=null,m=0;m<jc.length;m++){var n=jc[m];n&&(n=n.extractEvents(d,b,f,e,g))&&(h=jb(h,n))}pc(h)}}function Md(a,
b,c){if(!c.has(a)){switch(a){case "scroll":Cb(b,"scroll",!0);break;case "focus":case "blur":Cb(b,"focus",!0);Cb(b,"blur",!0);c.set("blur",null);c.set("focus",null);break;case "cancel":case "close":Tf(a)&&Cb(b,a,!0);break;case "invalid":case "submit":case "reset":break;default:-1===Db.indexOf(a)&&w(a,b)}c.set(a,null)}}function xi(a,b){var c=Jd(b);Nd.forEach(function(a){Md(a,b,c)});yi.forEach(function(a){Md(a,b,c)})}function Od(a,b,c,d,e){return{blockedOn:a,topLevelType:b,eventSystemFlags:c|32,nativeEvent:e,
container:d}}function Xf(a,b){switch(a){case "focus":case "blur":xa=null;break;case "dragenter":case "dragleave":ya=null;break;case "mouseover":case "mouseout":za=null;break;case "pointerover":case "pointerout":Eb.delete(b.pointerId);break;case "gotpointercapture":case "lostpointercapture":Fb.delete(b.pointerId)}}function Gb(a,b,c,d,e,f){if(null===a||a.nativeEvent!==f)return a=Od(b,c,d,e,f),null!==b&&(b=Hb(b),null!==b&&Yf(b)),a;a.eventSystemFlags|=d;return a}function zi(a,b,c,d,e){switch(b){case "focus":return xa=
Gb(xa,a,b,c,d,e),!0;case "dragenter":return ya=Gb(ya,a,b,c,d,e),!0;case "mouseover":return za=Gb(za,a,b,c,d,e),!0;case "pointerover":var f=e.pointerId;Eb.set(f,Gb(Eb.get(f)||null,a,b,c,d,e));return!0;case "gotpointercapture":return f=e.pointerId,Fb.set(f,Gb(Fb.get(f)||null,a,b,c,d,e)),!0}return!1}function Ai(a){var b=Bb(a.target);if(null!==b){var c=Na(b);if(null!==c)if(b=c.tag,13===b){if(b=Qf(c),null!==b){a.blockedOn=b;Pd(a.priority,function(){Bi(c)});return}}else if(3===b&&c.stateNode.hydrate){a.blockedOn=
3===c.tag?c.stateNode.containerInfo:null;return}}a.blockedOn=null}function rc(a){if(null!==a.blockedOn)return!1;var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);if(null!==b){var c=Hb(b);null!==c&&Yf(c);a.blockedOn=b;return!1}return!0}function Zf(a,b,c){rc(a)&&c.delete(b)}function Ci(){for(Rd=!1;0<fa.length;){var a=fa[0];if(null!==a.blockedOn){a=Hb(a.blockedOn);null!==a&&Di(a);break}var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);null!==b?a.blockedOn=b:fa.shift()}null!==
xa&&rc(xa)&&(xa=null);null!==ya&&rc(ya)&&(ya=null);null!==za&&rc(za)&&(za=null);Eb.forEach(Zf);Fb.forEach(Zf)}function Ib(a,b){a.blockedOn===b&&(a.blockedOn=null,Rd||(Rd=!0,$f(ag,Ci)))}function bg(a){if(0<fa.length){Ib(fa[0],a);for(var b=1;b<fa.length;b++){var c=fa[b];c.blockedOn===a&&(c.blockedOn=null)}}null!==xa&&Ib(xa,a);null!==ya&&Ib(ya,a);null!==za&&Ib(za,a);b=function(b){return Ib(b,a)};Eb.forEach(b);Fb.forEach(b);for(b=0;b<Jb.length;b++)c=Jb[b],c.blockedOn===a&&(c.blockedOn=null);for(;0<Jb.length&&
(b=Jb[0],null===b.blockedOn);)Ai(b),null===b.blockedOn&&Jb.shift()}function Sd(a,b){for(var c=0;c<a.length;c+=2){var d=a[c],e=a[c+1],f="on"+(e[0].toUpperCase()+e.slice(1));f={phasedRegistrationNames:{bubbled:f,captured:f+"Capture"},dependencies:[d],eventPriority:b};Td.set(d,b);cg.set(d,f);dg[e]=f}}function w(a,b){Cb(b,a,!1)}function Cb(a,b,c){var d=Td.get(b);switch(void 0===d?2:d){case 0:d=Ei.bind(null,b,1,a);break;case 1:d=Fi.bind(null,b,1,a);break;default:d=sc.bind(null,b,1,a)}c?a.addEventListener(b,
d,!0):a.addEventListener(b,d,!1)}function Ei(a,b,c,d){Oa||vd();var e=sc,f=Oa;Oa=!0;try{eg(e,a,b,c,d)}finally{(Oa=f)||ud()}}function Fi(a,b,c,d){Gi(Hi,sc.bind(null,a,b,c,d))}function sc(a,b,c,d){if(tc)if(0<fa.length&&-1<Nd.indexOf(a))a=Od(null,a,b,c,d),fa.push(a);else{var e=Qd(a,b,c,d);if(null===e)Xf(a,d);else if(-1<Nd.indexOf(a))a=Od(e,a,b,c,d),fa.push(a);else if(!zi(e,a,b,c,d)){Xf(a,d);a=Vf(a,d,null,b);try{uf(Wf,a)}finally{Uf(a)}}}}function Qd(a,b,c,d){c=Ld(d);c=Bb(c);if(null!==c){var e=Na(c);if(null===
e)c=null;else{var f=e.tag;if(13===f){c=Qf(e);if(null!==c)return c;c=null}else if(3===f){if(e.stateNode.hydrate)return 3===e.tag?e.stateNode.containerInfo:null;c=null}else e!==c&&(c=null)}}a=Vf(a,d,c,b);try{uf(Wf,a)}finally{Uf(a)}return null}function fg(a,b,c){return null==b||"boolean"===typeof b||""===b?"":c||"number"!==typeof b||0===b||Kb.hasOwnProperty(a)&&Kb[a]?(""+b).trim():b+"px"}function gg(a,b){a=a.style;for(var c in b)if(b.hasOwnProperty(c)){var d=0===c.indexOf("--"),e=fg(c,b[c],d);"float"===
c&&(c="cssFloat");d?a.setProperty(c,e):a[c]=e}}function Ud(a,b){if(b){if(Ii[a]&&(null!=b.children||null!=b.dangerouslySetInnerHTML))throw Error(k(137,a,""));if(null!=b.dangerouslySetInnerHTML){if(null!=b.children)throw Error(k(60));if(!("object"===typeof b.dangerouslySetInnerHTML&&"__html"in b.dangerouslySetInnerHTML))throw Error(k(61));}if(null!=b.style&&"object"!==typeof b.style)throw Error(k(62,""));}}function Vd(a,b){if(-1===a.indexOf("-"))return"string"===typeof b.is;switch(a){case "annotation-xml":case "color-profile":case "font-face":case "font-face-src":case "font-face-uri":case "font-face-format":case "font-face-name":case "missing-glyph":return!1;
default:return!0}}function oa(a,b){a=9===a.nodeType||11===a.nodeType?a:a.ownerDocument;var c=Jd(a);b=rd[b];for(var d=0;d<b.length;d++)Md(b[d],a,c)}function uc(){}function Wd(a){a=a||("undefined"!==typeof document?document:void 0);if("undefined"===typeof a)return null;try{return a.activeElement||a.body}catch(b){return a.body}}function hg(a){for(;a&&a.firstChild;)a=a.firstChild;return a}function ig(a,b){var c=hg(a);a=0;for(var d;c;){if(3===c.nodeType){d=a+c.textContent.length;if(a<=b&&d>=b)return{node:c,
offset:b-a};a=d}a:{for(;c;){if(c.nextSibling){c=c.nextSibling;break a}c=c.parentNode}c=void 0}c=hg(c)}}function jg(a,b){return a&&b?a===b?!0:a&&3===a.nodeType?!1:b&&3===b.nodeType?jg(a,b.parentNode):"contains"in a?a.contains(b):a.compareDocumentPosition?!!(a.compareDocumentPosition(b)&16):!1:!1}function kg(){for(var a=window,b=Wd();b instanceof a.HTMLIFrameElement;){try{var c="string"===typeof b.contentWindow.location.href}catch(d){c=!1}if(c)a=b.contentWindow;else break;b=Wd(a.document)}return b}
function Xd(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return b&&("input"===b&&("text"===a.type||"search"===a.type||"tel"===a.type||"url"===a.type||"password"===a.type)||"textarea"===b||"true"===a.contentEditable)}function lg(a,b){switch(a){case "button":case "input":case "select":case "textarea":return!!b.autoFocus}return!1}function Yd(a,b){return"textarea"===a||"option"===a||"noscript"===a||"string"===typeof b.children||"number"===typeof b.children||"object"===typeof b.dangerouslySetInnerHTML&&
null!==b.dangerouslySetInnerHTML&&null!=b.dangerouslySetInnerHTML.__html}function kb(a){for(;null!=a;a=a.nextSibling){var b=a.nodeType;if(1===b||3===b)break}return a}function mg(a){a=a.previousSibling;for(var b=0;a;){if(8===a.nodeType){var c=a.data;if(c===ng||c===Zd||c===$d){if(0===b)return a;b--}else c===og&&b++}a=a.previousSibling}return null}function Bb(a){var b=a[Aa];if(b)return b;for(var c=a.parentNode;c;){if(b=c[Lb]||c[Aa]){c=b.alternate;if(null!==b.child||null!==c&&null!==c.child)for(a=mg(a);null!==
a;){if(c=a[Aa])return c;a=mg(a)}return b}a=c;c=a.parentNode}return null}function Hb(a){a=a[Aa]||a[Lb];return!a||5!==a.tag&&6!==a.tag&&13!==a.tag&&3!==a.tag?null:a}function Pa(a){if(5===a.tag||6===a.tag)return a.stateNode;throw Error(k(33));}function ae(a){return a[vc]||null}function pa(a){do a=a.return;while(a&&5!==a.tag);return a?a:null}function pg(a,b){var c=a.stateNode;if(!c)return null;var d=td(c);if(!d)return null;c=d[b];a:switch(b){case "onClick":case "onClickCapture":case "onDoubleClick":case "onDoubleClickCapture":case "onMouseDown":case "onMouseDownCapture":case "onMouseMove":case "onMouseMoveCapture":case "onMouseUp":case "onMouseUpCapture":case "onMouseEnter":(d=
!d.disabled)||(a=a.type,d=!("button"===a||"input"===a||"select"===a||"textarea"===a));a=!d;break a;default:a=!1}if(a)return null;if(c&&"function"!==typeof c)throw Error(k(231,b,typeof c));return c}function qg(a,b,c){if(b=pg(a,c.dispatchConfig.phasedRegistrationNames[b]))c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a)}function Ji(a){if(a&&a.dispatchConfig.phasedRegistrationNames){for(var b=a._targetInst,c=[];b;)c.push(b),b=pa(b);for(b=c.length;0<b--;)qg(c[b],
"captured",a);for(b=0;b<c.length;b++)qg(c[b],"bubbled",a)}}function be(a,b,c){a&&c&&c.dispatchConfig.registrationName&&(b=pg(a,c.dispatchConfig.registrationName))&&(c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a))}function Ki(a){a&&a.dispatchConfig.registrationName&&be(a._targetInst,null,a)}function lb(a){Kd(a,Ji)}function rg(){if(wc)return wc;var a,b=ce,c=b.length,d,e="value"in Ba?Ba.value:Ba.textContent,f=e.length;for(a=0;a<c&&b[a]===e[a];a++);var g=
c-a;for(d=1;d<=g&&b[c-d]===e[f-d];d++);return wc=e.slice(a,1<d?1-d:void 0)}function xc(){return!0}function yc(){return!1}function R(a,b,c,d){this.dispatchConfig=a;this._targetInst=b;this.nativeEvent=c;a=this.constructor.Interface;for(var e in a)a.hasOwnProperty(e)&&((b=a[e])?this[e]=b(c):"target"===e?this.target=d:this[e]=c[e]);this.isDefaultPrevented=(null!=c.defaultPrevented?c.defaultPrevented:!1===c.returnValue)?xc:yc;this.isPropagationStopped=yc;return this}function Li(a,b,c,d){if(this.eventPool.length){var e=
this.eventPool.pop();this.call(e,a,b,c,d);return e}return new this(a,b,c,d)}function Mi(a){if(!(a instanceof this))throw Error(k(279));a.destructor();10>this.eventPool.length&&this.eventPool.push(a)}function sg(a){a.eventPool=[];a.getPooled=Li;a.release=Mi}function tg(a,b){switch(a){case "keyup":return-1!==Ni.indexOf(b.keyCode);case "keydown":return 229!==b.keyCode;case "keypress":case "mousedown":case "blur":return!0;default:return!1}}function ug(a){a=a.detail;return"object"===typeof a&&"data"in
a?a.data:null}function Oi(a,b){switch(a){case "compositionend":return ug(b);case "keypress":if(32!==b.which)return null;vg=!0;return wg;case "textInput":return a=b.data,a===wg&&vg?null:a;default:return null}}function Pi(a,b){if(mb)return"compositionend"===a||!de&&tg(a,b)?(a=rg(),wc=ce=Ba=null,mb=!1,a):null;switch(a){case "paste":return null;case "keypress":if(!(b.ctrlKey||b.altKey||b.metaKey)||b.ctrlKey&&b.altKey){if(b.char&&1<b.char.length)return b.char;if(b.which)return String.fromCharCode(b.which)}return null;
case "compositionend":return xg&&"ko"!==b.locale?null:b.data;default:return null}}function yg(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return"input"===b?!!Qi[a.type]:"textarea"===b?!0:!1}function zg(a,b,c){a=R.getPooled(Ag.change,a,b,c);a.type="change";sf(c);lb(a);return a}function Ri(a){pc(a)}function zc(a){var b=Pa(a);if(Gf(b))return a}function Si(a,b){if("change"===a)return b}function Bg(){Mb&&(Mb.detachEvent("onpropertychange",Cg),Nb=Mb=null)}function Cg(a){if("value"===a.propertyName&&
zc(Nb))if(a=zg(Nb,a,Ld(a)),Oa)pc(a);else{Oa=!0;try{ee(Ri,a)}finally{Oa=!1,ud()}}}function Ti(a,b,c){"focus"===a?(Bg(),Mb=b,Nb=c,Mb.attachEvent("onpropertychange",Cg)):"blur"===a&&Bg()}function Ui(a,b){if("selectionchange"===a||"keyup"===a||"keydown"===a)return zc(Nb)}function Vi(a,b){if("click"===a)return zc(b)}function Wi(a,b){if("input"===a||"change"===a)return zc(b)}function Xi(a){var b=this.nativeEvent;return b.getModifierState?b.getModifierState(a):(a=Yi[a])?!!b[a]:!1}function fe(a){return Xi}
function Zi(a,b){return a===b&&(0!==a||1/a===1/b)||a!==a&&b!==b}function Ob(a,b){if(Qa(a,b))return!0;if("object"!==typeof a||null===a||"object"!==typeof b||null===b)return!1;var c=Object.keys(a),d=Object.keys(b);if(c.length!==d.length)return!1;for(d=0;d<c.length;d++)if(!$i.call(b,c[d])||!Qa(a[c[d]],b[c[d]]))return!1;return!0}function Dg(a,b){var c=b.window===b?b.document:9===b.nodeType?b:b.ownerDocument;if(ge||null==nb||nb!==Wd(c))return null;c=nb;"selectionStart"in c&&Xd(c)?c={start:c.selectionStart,
end:c.selectionEnd}:(c=(c.ownerDocument&&c.ownerDocument.defaultView||window).getSelection(),c={anchorNode:c.anchorNode,anchorOffset:c.anchorOffset,focusNode:c.focusNode,focusOffset:c.focusOffset});return Pb&&Ob(Pb,c)?null:(Pb=c,a=R.getPooled(Eg.select,he,a,b),a.type="select",a.target=nb,lb(a),a)}function Ac(a){var b=a.keyCode;"charCode"in a?(a=a.charCode,0===a&&13===b&&(a=13)):a=b;10===a&&(a=13);return 32<=a||13===a?a:0}function q(a,b){0>ob||(a.current=ie[ob],ie[ob]=null,ob--)}function y(a,b,c){ob++;
ie[ob]=a.current;a.current=b}function pb(a,b){var c=a.type.contextTypes;if(!c)return Ca;var d=a.stateNode;if(d&&d.__reactInternalMemoizedUnmaskedChildContext===b)return d.__reactInternalMemoizedMaskedChildContext;var e={},f;for(f in c)e[f]=b[f];d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=b,a.__reactInternalMemoizedMaskedChildContext=e);return e}function N(a){a=a.childContextTypes;return null!==a&&void 0!==a}function Fg(a,b,c){if(B.current!==Ca)throw Error(k(168));y(B,b);y(G,c)}
function Gg(a,b,c){var d=a.stateNode;a=b.childContextTypes;if("function"!==typeof d.getChildContext)return c;d=d.getChildContext();for(var e in d)if(!(e in a))throw Error(k(108,na(b)||"Unknown",e));return M({},c,{},d)}function Bc(a){a=(a=a.stateNode)&&a.__reactInternalMemoizedMergedChildContext||Ca;Ra=B.current;y(B,a);y(G,G.current);return!0}function Hg(a,b,c){var d=a.stateNode;if(!d)throw Error(k(169));c?(a=Gg(a,b,Ra),d.__reactInternalMemoizedMergedChildContext=a,q(G),q(B),y(B,a)):q(G);y(G,c)}function Cc(){switch(aj()){case Dc:return 99;
case Ig:return 98;case Jg:return 97;case Kg:return 96;case Lg:return 95;default:throw Error(k(332));}}function Mg(a){switch(a){case 99:return Dc;case 98:return Ig;case 97:return Jg;case 96:return Kg;case 95:return Lg;default:throw Error(k(332));}}function Da(a,b){a=Mg(a);return bj(a,b)}function Ng(a,b,c){a=Mg(a);return je(a,b,c)}function Og(a){null===qa?(qa=[a],Ec=je(Dc,Pg)):qa.push(a);return Qg}function ha(){if(null!==Ec){var a=Ec;Ec=null;Rg(a)}Pg()}function Pg(){if(!ke&&null!==qa){ke=!0;var a=0;
try{var b=qa;Da(99,function(){for(;a<b.length;a++){var c=b[a];do c=c(!0);while(null!==c)}});qa=null}catch(c){throw null!==qa&&(qa=qa.slice(a+1)),je(Dc,ha),c;}finally{ke=!1}}}function Fc(a,b,c){c/=10;return 1073741821-(((1073741821-a+b/10)/c|0)+1)*c}function aa(a,b){if(a&&a.defaultProps){b=M({},b);a=a.defaultProps;for(var c in a)void 0===b[c]&&(b[c]=a[c])}return b}function le(){Gc=qb=Hc=null}function me(a){var b=Ic.current;q(Ic);a.type._context._currentValue=b}function Sg(a,b){for(;null!==a;){var c=
a.alternate;if(a.childExpirationTime<b)a.childExpirationTime=b,null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);else if(null!==c&&c.childExpirationTime<b)c.childExpirationTime=b;else break;a=a.return}}function rb(a,b){Hc=a;Gc=qb=null;a=a.dependencies;null!==a&&null!==a.firstContext&&(a.expirationTime>=b&&(ia=!0),a.firstContext=null)}function W(a,b){if(Gc!==a&&!1!==b&&0!==b){if("number"!==typeof b||1073741823===b)Gc=a,b=1073741823;b={context:a,observedBits:b,next:null};if(null===qb){if(null===
Hc)throw Error(k(308));qb=b;Hc.dependencies={expirationTime:0,firstContext:b,responders:null}}else qb=qb.next=b}return a._currentValue}function ne(a){a.updateQueue={baseState:a.memoizedState,baseQueue:null,shared:{pending:null},effects:null}}function oe(a,b){a=a.updateQueue;b.updateQueue===a&&(b.updateQueue={baseState:a.baseState,baseQueue:a.baseQueue,shared:a.shared,effects:a.effects})}function Ea(a,b){a={expirationTime:a,suspenseConfig:b,tag:Tg,payload:null,callback:null,next:null};return a.next=
a}function Fa(a,b){a=a.updateQueue;if(null!==a){a=a.shared;var c=a.pending;null===c?b.next=b:(b.next=c.next,c.next=b);a.pending=b}}function Ug(a,b){var c=a.alternate;null!==c&&oe(c,a);a=a.updateQueue;c=a.baseQueue;null===c?(a.baseQueue=b.next=b,b.next=b):(b.next=c.next,c.next=b)}function Qb(a,b,c,d){var e=a.updateQueue;Ga=!1;var f=e.baseQueue,g=e.shared.pending;if(null!==g){if(null!==f){var h=f.next;f.next=g.next;g.next=h}f=g;e.shared.pending=null;h=a.alternate;null!==h&&(h=h.updateQueue,null!==h&&
(h.baseQueue=g))}if(null!==f){h=f.next;var m=e.baseState,n=0,k=null,ba=null,l=null;if(null!==h){var p=h;do{g=p.expirationTime;if(g<d){var t={expirationTime:p.expirationTime,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null};null===l?(ba=l=t,k=m):l=l.next=t;g>n&&(n=g)}else{null!==l&&(l=l.next={expirationTime:1073741823,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null});Vg(g,p.suspenseConfig);a:{var q=a,r=p;g=b;t=c;switch(r.tag){case 1:q=
r.payload;if("function"===typeof q){m=q.call(t,m,g);break a}m=q;break a;case 3:q.effectTag=q.effectTag&-4097|64;case Tg:q=r.payload;g="function"===typeof q?q.call(t,m,g):q;if(null===g||void 0===g)break a;m=M({},m,g);break a;case Jc:Ga=!0}}null!==p.callback&&(a.effectTag|=32,g=e.effects,null===g?e.effects=[p]:g.push(p))}p=p.next;if(null===p||p===h)if(g=e.shared.pending,null===g)break;else p=f.next=g.next,g.next=h,e.baseQueue=f=g,e.shared.pending=null}while(1)}null===l?k=m:l.next=ba;e.baseState=k;e.baseQueue=
l;Kc(n);a.expirationTime=n;a.memoizedState=m}}function Wg(a,b,c){a=b.effects;b.effects=null;if(null!==a)for(b=0;b<a.length;b++){var d=a[b],e=d.callback;if(null!==e){d.callback=null;d=e;e=c;if("function"!==typeof d)throw Error(k(191,d));d.call(e)}}}function Lc(a,b,c,d){b=a.memoizedState;c=c(d,b);c=null===c||void 0===c?b:M({},b,c);a.memoizedState=c;0===a.expirationTime&&(a.updateQueue.baseState=c)}function Xg(a,b,c,d,e,f,g){a=a.stateNode;return"function"===typeof a.shouldComponentUpdate?a.shouldComponentUpdate(d,
f,g):b.prototype&&b.prototype.isPureReactComponent?!Ob(c,d)||!Ob(e,f):!0}function Yg(a,b,c){var d=!1,e=Ca;var f=b.contextType;"object"===typeof f&&null!==f?f=W(f):(e=N(b)?Ra:B.current,d=b.contextTypes,f=(d=null!==d&&void 0!==d)?pb(a,e):Ca);b=new b(c,f);a.memoizedState=null!==b.state&&void 0!==b.state?b.state:null;b.updater=Mc;a.stateNode=b;b._reactInternalFiber=a;d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=e,a.__reactInternalMemoizedMaskedChildContext=f);return b}function Zg(a,
b,c,d){a=b.state;"function"===typeof b.componentWillReceiveProps&&b.componentWillReceiveProps(c,d);"function"===typeof b.UNSAFE_componentWillReceiveProps&&b.UNSAFE_componentWillReceiveProps(c,d);b.state!==a&&Mc.enqueueReplaceState(b,b.state,null)}function pe(a,b,c,d){var e=a.stateNode;e.props=c;e.state=a.memoizedState;e.refs=$g;ne(a);var f=b.contextType;"object"===typeof f&&null!==f?e.context=W(f):(f=N(b)?Ra:B.current,e.context=pb(a,f));Qb(a,c,e,d);e.state=a.memoizedState;f=b.getDerivedStateFromProps;
"function"===typeof f&&(Lc(a,b,f,c),e.state=a.memoizedState);"function"===typeof b.getDerivedStateFromProps||"function"===typeof e.getSnapshotBeforeUpdate||"function"!==typeof e.UNSAFE_componentWillMount&&"function"!==typeof e.componentWillMount||(b=e.state,"function"===typeof e.componentWillMount&&e.componentWillMount(),"function"===typeof e.UNSAFE_componentWillMount&&e.UNSAFE_componentWillMount(),b!==e.state&&Mc.enqueueReplaceState(e,e.state,null),Qb(a,c,e,d),e.state=a.memoizedState);"function"===
typeof e.componentDidMount&&(a.effectTag|=4)}function Rb(a,b,c){a=c.ref;if(null!==a&&"function"!==typeof a&&"object"!==typeof a){if(c._owner){c=c._owner;if(c){if(1!==c.tag)throw Error(k(309));var d=c.stateNode}if(!d)throw Error(k(147,a));var e=""+a;if(null!==b&&null!==b.ref&&"function"===typeof b.ref&&b.ref._stringRef===e)return b.ref;b=function(a){var b=d.refs;b===$g&&(b=d.refs={});null===a?delete b[e]:b[e]=a};b._stringRef=e;return b}if("string"!==typeof a)throw Error(k(284));if(!c._owner)throw Error(k(290,
a));}return a}function Nc(a,b){if("textarea"!==a.type)throw Error(k(31,"[object Object]"===Object.prototype.toString.call(b)?"object with keys {"+Object.keys(b).join(", ")+"}":b,""));}function ah(a){function b(b,c){if(a){var d=b.lastEffect;null!==d?(d.nextEffect=c,b.lastEffect=c):b.firstEffect=b.lastEffect=c;c.nextEffect=null;c.effectTag=8}}function c(c,d){if(!a)return null;for(;null!==d;)b(c,d),d=d.sibling;return null}function d(a,b){for(a=new Map;null!==b;)null!==b.key?a.set(b.key,b):a.set(b.index,
b),b=b.sibling;return a}function e(a,b){a=Sa(a,b);a.index=0;a.sibling=null;return a}function f(b,c,d){b.index=d;if(!a)return c;d=b.alternate;if(null!==d)return d=d.index,d<c?(b.effectTag=2,c):d;b.effectTag=2;return c}function g(b){a&&null===b.alternate&&(b.effectTag=2);return b}function h(a,b,c,d){if(null===b||6!==b.tag)return b=qe(c,a.mode,d),b.return=a,b;b=e(b,c);b.return=a;return b}function m(a,b,c,d){if(null!==b&&b.elementType===c.type)return d=e(b,c.props),d.ref=Rb(a,b,c),d.return=a,d;d=Oc(c.type,
c.key,c.props,null,a.mode,d);d.ref=Rb(a,b,c);d.return=a;return d}function n(a,b,c,d){if(null===b||4!==b.tag||b.stateNode.containerInfo!==c.containerInfo||b.stateNode.implementation!==c.implementation)return b=re(c,a.mode,d),b.return=a,b;b=e(b,c.children||[]);b.return=a;return b}function l(a,b,c,d,f){if(null===b||7!==b.tag)return b=Ha(c,a.mode,d,f),b.return=a,b;b=e(b,c);b.return=a;return b}function ba(a,b,c){if("string"===typeof b||"number"===typeof b)return b=qe(""+b,a.mode,c),b.return=a,b;if("object"===
typeof b&&null!==b){switch(b.$$typeof){case Pc:return c=Oc(b.type,b.key,b.props,null,a.mode,c),c.ref=Rb(a,null,b),c.return=a,c;case gb:return b=re(b,a.mode,c),b.return=a,b}if(Qc(b)||zb(b))return b=Ha(b,a.mode,c,null),b.return=a,b;Nc(a,b)}return null}function p(a,b,c,d){var e=null!==b?b.key:null;if("string"===typeof c||"number"===typeof c)return null!==e?null:h(a,b,""+c,d);if("object"===typeof c&&null!==c){switch(c.$$typeof){case Pc:return c.key===e?c.type===Ma?l(a,b,c.props.children,d,e):m(a,b,c,
d):null;case gb:return c.key===e?n(a,b,c,d):null}if(Qc(c)||zb(c))return null!==e?null:l(a,b,c,d,null);Nc(a,c)}return null}function t(a,b,c,d,e){if("string"===typeof d||"number"===typeof d)return a=a.get(c)||null,h(b,a,""+d,e);if("object"===typeof d&&null!==d){switch(d.$$typeof){case Pc:return a=a.get(null===d.key?c:d.key)||null,d.type===Ma?l(b,a,d.props.children,e,d.key):m(b,a,d,e);case gb:return a=a.get(null===d.key?c:d.key)||null,n(b,a,d,e)}if(Qc(d)||zb(d))return a=a.get(c)||null,l(b,a,d,e,null);
Nc(b,d)}return null}function q(e,g,h,m){for(var n=null,k=null,l=g,r=g=0,C=null;null!==l&&r<h.length;r++){l.index>r?(C=l,l=null):C=l.sibling;var O=p(e,l,h[r],m);if(null===O){null===l&&(l=C);break}a&&l&&null===O.alternate&&b(e,l);g=f(O,g,r);null===k?n=O:k.sibling=O;k=O;l=C}if(r===h.length)return c(e,l),n;if(null===l){for(;r<h.length;r++)l=ba(e,h[r],m),null!==l&&(g=f(l,g,r),null===k?n=l:k.sibling=l,k=l);return n}for(l=d(e,l);r<h.length;r++)C=t(l,e,r,h[r],m),null!==C&&(a&&null!==C.alternate&&l.delete(null===
C.key?r:C.key),g=f(C,g,r),null===k?n=C:k.sibling=C,k=C);a&&l.forEach(function(a){return b(e,a)});return n}function w(e,g,h,n){var m=zb(h);if("function"!==typeof m)throw Error(k(150));h=m.call(h);if(null==h)throw Error(k(151));for(var l=m=null,r=g,C=g=0,O=null,v=h.next();null!==r&&!v.done;C++,v=h.next()){r.index>C?(O=r,r=null):O=r.sibling;var q=p(e,r,v.value,n);if(null===q){null===r&&(r=O);break}a&&r&&null===q.alternate&&b(e,r);g=f(q,g,C);null===l?m=q:l.sibling=q;l=q;r=O}if(v.done)return c(e,r),m;
if(null===r){for(;!v.done;C++,v=h.next())v=ba(e,v.value,n),null!==v&&(g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);return m}for(r=d(e,r);!v.done;C++,v=h.next())v=t(r,e,C,v.value,n),null!==v&&(a&&null!==v.alternate&&r.delete(null===v.key?C:v.key),g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);a&&r.forEach(function(a){return b(e,a)});return m}return function(a,d,f,h){var m="object"===typeof f&&null!==f&&f.type===Ma&&null===f.key;m&&(f=f.props.children);var n="object"===typeof f&&null!==f;if(n)switch(f.$$typeof){case Pc:a:{n=
f.key;for(m=d;null!==m;){if(m.key===n){switch(m.tag){case 7:if(f.type===Ma){c(a,m.sibling);d=e(m,f.props.children);d.return=a;a=d;break a}break;default:if(m.elementType===f.type){c(a,m.sibling);d=e(m,f.props);d.ref=Rb(a,m,f);d.return=a;a=d;break a}}c(a,m);break}else b(a,m);m=m.sibling}f.type===Ma?(d=Ha(f.props.children,a.mode,h,f.key),d.return=a,a=d):(h=Oc(f.type,f.key,f.props,null,a.mode,h),h.ref=Rb(a,d,f),h.return=a,a=h)}return g(a);case gb:a:{for(m=f.key;null!==d;){if(d.key===m)if(4===d.tag&&d.stateNode.containerInfo===
f.containerInfo&&d.stateNode.implementation===f.implementation){c(a,d.sibling);d=e(d,f.children||[]);d.return=a;a=d;break a}else{c(a,d);break}else b(a,d);d=d.sibling}d=re(f,a.mode,h);d.return=a;a=d}return g(a)}if("string"===typeof f||"number"===typeof f)return f=""+f,null!==d&&6===d.tag?(c(a,d.sibling),d=e(d,f),d.return=a,a=d):(c(a,d),d=qe(f,a.mode,h),d.return=a,a=d),g(a);if(Qc(f))return q(a,d,f,h);if(zb(f))return w(a,d,f,h);n&&Nc(a,f);if("undefined"===typeof f&&!m)switch(a.tag){case 1:case 0:throw a=
a.type,Error(k(152,a.displayName||a.name||"Component"));}return c(a,d)}}function Ta(a){if(a===Sb)throw Error(k(174));return a}function se(a,b){y(Tb,b);y(Ub,a);y(ja,Sb);a=b.nodeType;switch(a){case 9:case 11:b=(b=b.documentElement)?b.namespaceURI:Hd(null,"");break;default:a=8===a?b.parentNode:b,b=a.namespaceURI||null,a=a.tagName,b=Hd(b,a)}q(ja);y(ja,b)}function tb(a){q(ja);q(Ub);q(Tb)}function bh(a){Ta(Tb.current);var b=Ta(ja.current);var c=Hd(b,a.type);b!==c&&(y(Ub,a),y(ja,c))}function te(a){Ub.current===
a&&(q(ja),q(Ub))}function Rc(a){for(var b=a;null!==b;){if(13===b.tag){var c=b.memoizedState;if(null!==c&&(c=c.dehydrated,null===c||c.data===$d||c.data===Zd))return b}else if(19===b.tag&&void 0!==b.memoizedProps.revealOrder){if(0!==(b.effectTag&64))return b}else if(null!==b.child){b.child.return=b;b=b.child;continue}if(b===a)break;for(;null===b.sibling;){if(null===b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}return null}function ue(a,b){return{responder:a,props:b}}
function S(){throw Error(k(321));}function ve(a,b){if(null===b)return!1;for(var c=0;c<b.length&&c<a.length;c++)if(!Qa(a[c],b[c]))return!1;return!0}function we(a,b,c,d,e,f){Ia=f;z=b;b.memoizedState=null;b.updateQueue=null;b.expirationTime=0;Sc.current=null===a||null===a.memoizedState?dj:ej;a=c(d,e);if(b.expirationTime===Ia){f=0;do{b.expirationTime=0;if(!(25>f))throw Error(k(301));f+=1;J=K=null;b.updateQueue=null;Sc.current=fj;a=c(d,e)}while(b.expirationTime===Ia)}Sc.current=Tc;b=null!==K&&null!==K.next;
Ia=0;J=K=z=null;Uc=!1;if(b)throw Error(k(300));return a}function ub(){var a={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};null===J?z.memoizedState=J=a:J=J.next=a;return J}function vb(){if(null===K){var a=z.alternate;a=null!==a?a.memoizedState:null}else a=K.next;var b=null===J?z.memoizedState:J.next;if(null!==b)J=b,K=a;else{if(null===a)throw Error(k(310));K=a;a={memoizedState:K.memoizedState,baseState:K.baseState,baseQueue:K.baseQueue,queue:K.queue,next:null};null===J?z.memoizedState=
J=a:J=J.next=a}return J}function Ua(a,b){return"function"===typeof b?b(a):b}function Vc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=K,e=d.baseQueue,f=c.pending;if(null!==f){if(null!==e){var g=e.next;e.next=f.next;f.next=g}d.baseQueue=e=f;c.pending=null}if(null!==e){e=e.next;d=d.baseState;var h=g=f=null,m=e;do{var n=m.expirationTime;if(n<Ia){var l={expirationTime:m.expirationTime,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,
next:null};null===h?(g=h=l,f=d):h=h.next=l;n>z.expirationTime&&(z.expirationTime=n,Kc(n))}else null!==h&&(h=h.next={expirationTime:1073741823,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,next:null}),Vg(n,m.suspenseConfig),d=m.eagerReducer===a?m.eagerState:a(d,m.action);m=m.next}while(null!==m&&m!==e);null===h?f=d:h.next=g;Qa(d,b.memoizedState)||(ia=!0);b.memoizedState=d;b.baseState=f;b.baseQueue=h;c.lastRenderedState=d}return[b.memoizedState,
c.dispatch]}function Wc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=c.dispatch,e=c.pending,f=b.memoizedState;if(null!==e){c.pending=null;var g=e=e.next;do f=a(f,g.action),g=g.next;while(g!==e);Qa(f,b.memoizedState)||(ia=!0);b.memoizedState=f;null===b.baseQueue&&(b.baseState=f);c.lastRenderedState=f}return[f,d]}function xe(a){var b=ub();"function"===typeof a&&(a=a());b.memoizedState=b.baseState=a;a=b.queue={pending:null,dispatch:null,lastRenderedReducer:Ua,
lastRenderedState:a};a=a.dispatch=ch.bind(null,z,a);return[b.memoizedState,a]}function ye(a,b,c,d){a={tag:a,create:b,destroy:c,deps:d,next:null};b=z.updateQueue;null===b?(b={lastEffect:null},z.updateQueue=b,b.lastEffect=a.next=a):(c=b.lastEffect,null===c?b.lastEffect=a.next=a:(d=c.next,c.next=a,a.next=d,b.lastEffect=a));return a}function dh(a){return vb().memoizedState}function ze(a,b,c,d){var e=ub();z.effectTag|=a;e.memoizedState=ye(1|b,c,void 0,void 0===d?null:d)}function Ae(a,b,c,d){var e=vb();
d=void 0===d?null:d;var f=void 0;if(null!==K){var g=K.memoizedState;f=g.destroy;if(null!==d&&ve(d,g.deps)){ye(b,c,f,d);return}}z.effectTag|=a;e.memoizedState=ye(1|b,c,f,d)}function eh(a,b){return ze(516,4,a,b)}function Xc(a,b){return Ae(516,4,a,b)}function fh(a,b){return Ae(4,2,a,b)}function gh(a,b){if("function"===typeof b)return a=a(),b(a),function(){b(null)};if(null!==b&&void 0!==b)return a=a(),b.current=a,function(){b.current=null}}function hh(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;
return Ae(4,2,gh.bind(null,b,a),c)}function Be(a,b){}function ih(a,b){ub().memoizedState=[a,void 0===b?null:b];return a}function Yc(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];c.memoizedState=[a,b];return a}function jh(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];a=a();c.memoizedState=[a,b];return a}function Ce(a,b,c){var d=Cc();Da(98>d?98:d,function(){a(!0)});Da(97<d?97:d,function(){var d=
X.suspense;X.suspense=void 0===b?null:b;try{a(!1),c()}finally{X.suspense=d}})}function ch(a,b,c){var d=ka(),e=Vb.suspense;d=Va(d,a,e);e={expirationTime:d,suspenseConfig:e,action:c,eagerReducer:null,eagerState:null,next:null};var f=b.pending;null===f?e.next=e:(e.next=f.next,f.next=e);b.pending=e;f=a.alternate;if(a===z||null!==f&&f===z)Uc=!0,e.expirationTime=Ia,z.expirationTime=Ia;else{if(0===a.expirationTime&&(null===f||0===f.expirationTime)&&(f=b.lastRenderedReducer,null!==f))try{var g=b.lastRenderedState,
h=f(g,c);e.eagerReducer=f;e.eagerState=h;if(Qa(h,g))return}catch(m){}finally{}Ja(a,d)}}function kh(a,b){var c=la(5,null,null,0);c.elementType="DELETED";c.type="DELETED";c.stateNode=b;c.return=a;c.effectTag=8;null!==a.lastEffect?(a.lastEffect.nextEffect=c,a.lastEffect=c):a.firstEffect=a.lastEffect=c}function lh(a,b){switch(a.tag){case 5:var c=a.type;b=1!==b.nodeType||c.toLowerCase()!==b.nodeName.toLowerCase()?null:b;return null!==b?(a.stateNode=b,!0):!1;case 6:return b=""===a.pendingProps||3!==b.nodeType?
null:b,null!==b?(a.stateNode=b,!0):!1;case 13:return!1;default:return!1}}function De(a){if(Wa){var b=Ka;if(b){var c=b;if(!lh(a,b)){b=kb(c.nextSibling);if(!b||!lh(a,b)){a.effectTag=a.effectTag&-1025|2;Wa=!1;ra=a;return}kh(ra,c)}ra=a;Ka=kb(b.firstChild)}else a.effectTag=a.effectTag&-1025|2,Wa=!1,ra=a}}function mh(a){for(a=a.return;null!==a&&5!==a.tag&&3!==a.tag&&13!==a.tag;)a=a.return;ra=a}function Zc(a){if(a!==ra)return!1;if(!Wa)return mh(a),Wa=!0,!1;var b=a.type;if(5!==a.tag||"head"!==b&&"body"!==
b&&!Yd(b,a.memoizedProps))for(b=Ka;b;)kh(a,b),b=kb(b.nextSibling);mh(a);if(13===a.tag){a=a.memoizedState;a=null!==a?a.dehydrated:null;if(!a)throw Error(k(317));a:{a=a.nextSibling;for(b=0;a;){if(8===a.nodeType){var c=a.data;if(c===og){if(0===b){Ka=kb(a.nextSibling);break a}b--}else c!==ng&&c!==Zd&&c!==$d||b++}a=a.nextSibling}Ka=null}}else Ka=ra?kb(a.stateNode.nextSibling):null;return!0}function Ee(){Ka=ra=null;Wa=!1}function T(a,b,c,d){b.child=null===a?Fe(b,null,c,d):wb(b,a.child,c,d)}function nh(a,
b,c,d,e){c=c.render;var f=b.ref;rb(b,e);d=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,d,e);return b.child}function oh(a,b,c,d,e,f){if(null===a){var g=c.type;if("function"===typeof g&&!Ge(g)&&void 0===g.defaultProps&&null===c.compare&&void 0===c.defaultProps)return b.tag=15,b.type=g,ph(a,b,g,d,e,f);a=Oc(c.type,null,d,null,b.mode,f);a.ref=b.ref;a.return=b;return b.child=a}g=a.child;if(e<
f&&(e=g.memoizedProps,c=c.compare,c=null!==c?c:Ob,c(e,d)&&a.ref===b.ref))return sa(a,b,f);b.effectTag|=1;a=Sa(g,d);a.ref=b.ref;a.return=b;return b.child=a}function ph(a,b,c,d,e,f){return null!==a&&Ob(a.memoizedProps,d)&&a.ref===b.ref&&(ia=!1,e<f)?(b.expirationTime=a.expirationTime,sa(a,b,f)):He(a,b,c,d,f)}function qh(a,b){var c=b.ref;if(null===a&&null!==c||null!==a&&a.ref!==c)b.effectTag|=128}function He(a,b,c,d,e){var f=N(c)?Ra:B.current;f=pb(b,f);rb(b,e);c=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=
a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,c,e);return b.child}function rh(a,b,c,d,e){if(N(c)){var f=!0;Bc(b)}else f=!1;rb(b,e);if(null===b.stateNode)null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),Yg(b,c,d),pe(b,c,d,e),d=!0;else if(null===a){var g=b.stateNode,h=b.memoizedProps;g.props=h;var m=g.context,n=c.contextType;"object"===typeof n&&null!==n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n));var l=c.getDerivedStateFromProps,k="function"===
typeof l||"function"===typeof g.getSnapshotBeforeUpdate;k||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n);Ga=!1;var p=b.memoizedState;g.state=p;Qb(b,d,g,e);m=b.memoizedState;h!==d||p!==m||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),m=b.memoizedState),(h=Ga||Xg(b,c,h,d,p,m,n))?(k||"function"!==typeof g.UNSAFE_componentWillMount&&"function"!==typeof g.componentWillMount||("function"===typeof g.componentWillMount&&
g.componentWillMount(),"function"===typeof g.UNSAFE_componentWillMount&&g.UNSAFE_componentWillMount()),"function"===typeof g.componentDidMount&&(b.effectTag|=4)):("function"===typeof g.componentDidMount&&(b.effectTag|=4),b.memoizedProps=d,b.memoizedState=m),g.props=d,g.state=m,g.context=n,d=h):("function"===typeof g.componentDidMount&&(b.effectTag|=4),d=!1)}else g=b.stateNode,oe(a,b),h=b.memoizedProps,g.props=b.type===b.elementType?h:aa(b.type,h),m=g.context,n=c.contextType,"object"===typeof n&&null!==
n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n)),l=c.getDerivedStateFromProps,(k="function"===typeof l||"function"===typeof g.getSnapshotBeforeUpdate)||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n),Ga=!1,m=b.memoizedState,g.state=m,Qb(b,d,g,e),p=b.memoizedState,h!==d||m!==p||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),p=b.memoizedState),(l=Ga||Xg(b,c,h,d,m,p,n))?(k||"function"!==typeof g.UNSAFE_componentWillUpdate&&
"function"!==typeof g.componentWillUpdate||("function"===typeof g.componentWillUpdate&&g.componentWillUpdate(d,p,n),"function"===typeof g.UNSAFE_componentWillUpdate&&g.UNSAFE_componentWillUpdate(d,p,n)),"function"===typeof g.componentDidUpdate&&(b.effectTag|=4),"function"===typeof g.getSnapshotBeforeUpdate&&(b.effectTag|=256)):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===
a.memoizedState||(b.effectTag|=256),b.memoizedProps=d,b.memoizedState=p),g.props=d,g.state=p,g.context=n,d=l):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=256),d=!1);return Ie(a,b,c,d,f,e)}function Ie(a,b,c,d,e,f){qh(a,b);var g=0!==(b.effectTag&64);if(!d&&!g)return e&&Hg(b,c,!1),sa(a,b,f);d=b.stateNode;gj.current=b;var h=g&&"function"!==typeof c.getDerivedStateFromError?
null:d.render();b.effectTag|=1;null!==a&&g?(b.child=wb(b,a.child,null,f),b.child=wb(b,null,h,f)):T(a,b,h,f);b.memoizedState=d.state;e&&Hg(b,c,!0);return b.child}function sh(a){var b=a.stateNode;b.pendingContext?Fg(a,b.pendingContext,b.pendingContext!==b.context):b.context&&Fg(a,b.context,!1);se(a,b.containerInfo)}function th(a,b,c){var d=b.mode,e=b.pendingProps,f=D.current,g=!1,h;(h=0!==(b.effectTag&64))||(h=0!==(f&2)&&(null===a||null!==a.memoizedState));h?(g=!0,b.effectTag&=-65):null!==a&&null===
a.memoizedState||void 0===e.fallback||!0===e.unstable_avoidThisFallback||(f|=1);y(D,f&1);if(null===a){void 0!==e.fallback&&De(b);if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;b.memoizedState=Je;b.child=e;return c}d=e.children;b.memoizedState=null;return b.child=Fe(b,null,d,c)}if(null!==a.memoizedState){a=a.child;d=a.sibling;if(g){e=e.fallback;
c=Sa(a,a.pendingProps);c.return=b;if(0===(b.mode&2)&&(g=null!==b.memoizedState?b.child.child:b.child,g!==a.child))for(c.child=g;null!==g;)g.return=c,g=g.sibling;d=Sa(d,e);d.return=b;c.sibling=d;c.childExpirationTime=0;b.memoizedState=Je;b.child=c;return d}c=wb(b,a.child,e.children,c);b.memoizedState=null;return b.child=c}a=a.child;if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;e.child=a;null!==a&&(a.return=e);if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==
a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;c.effectTag|=2;e.childExpirationTime=0;b.memoizedState=Je;b.child=e;return c}b.memoizedState=null;return b.child=wb(b,a,e.children,c)}function uh(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);Sg(a.return,b)}function Ke(a,b,c,d,e,f){var g=a.memoizedState;null===g?a.memoizedState={isBackwards:b,rendering:null,renderingStartTime:0,last:d,tail:c,tailExpiration:0,tailMode:e,
lastEffect:f}:(g.isBackwards=b,g.rendering=null,g.renderingStartTime=0,g.last=d,g.tail=c,g.tailExpiration=0,g.tailMode=e,g.lastEffect=f)}function vh(a,b,c){var d=b.pendingProps,e=d.revealOrder,f=d.tail;T(a,b,d.children,c);d=D.current;if(0!==(d&2))d=d&1|2,b.effectTag|=64;else{if(null!==a&&0!==(a.effectTag&64))a:for(a=b.child;null!==a;){if(13===a.tag)null!==a.memoizedState&&uh(a,c);else if(19===a.tag)uh(a,c);else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===b)break a;for(;null===a.sibling;){if(null===
a.return||a.return===b)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}d&=1}y(D,d);if(0===(b.mode&2))b.memoizedState=null;else switch(e){case "forwards":c=b.child;for(e=null;null!==c;)a=c.alternate,null!==a&&null===Rc(a)&&(e=c),c=c.sibling;c=e;null===c?(e=b.child,b.child=null):(e=c.sibling,c.sibling=null);Ke(b,!1,e,c,f,b.lastEffect);break;case "backwards":c=null;e=b.child;for(b.child=null;null!==e;){a=e.alternate;if(null!==a&&null===Rc(a)){b.child=e;break}a=e.sibling;e.sibling=c;c=e;e=a}Ke(b,
!0,c,null,f,b.lastEffect);break;case "together":Ke(b,!1,null,null,void 0,b.lastEffect);break;default:b.memoizedState=null}return b.child}function sa(a,b,c){null!==a&&(b.dependencies=a.dependencies);var d=b.expirationTime;0!==d&&Kc(d);if(b.childExpirationTime<c)return null;if(null!==a&&b.child!==a.child)throw Error(k(153));if(null!==b.child){a=b.child;c=Sa(a,a.pendingProps);b.child=c;for(c.return=b;null!==a.sibling;)a=a.sibling,c=c.sibling=Sa(a,a.pendingProps),c.return=b;c.sibling=null}return b.child}
function $c(a,b){switch(a.tailMode){case "hidden":b=a.tail;for(var c=null;null!==b;)null!==b.alternate&&(c=b),b=b.sibling;null===c?a.tail=null:c.sibling=null;break;case "collapsed":c=a.tail;for(var d=null;null!==c;)null!==c.alternate&&(d=c),c=c.sibling;null===d?b||null===a.tail?a.tail=null:a.tail.sibling=null:d.sibling=null}}function hj(a,b,c){var d=b.pendingProps;switch(b.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return null;case 1:return N(b.type)&&(q(G),q(B)),
null;case 3:return tb(),q(G),q(B),c=b.stateNode,c.pendingContext&&(c.context=c.pendingContext,c.pendingContext=null),null!==a&&null!==a.child||!Zc(b)||(b.effectTag|=4),wh(b),null;case 5:te(b);c=Ta(Tb.current);var e=b.type;if(null!==a&&null!=b.stateNode)ij(a,b,e,d,c),a.ref!==b.ref&&(b.effectTag|=128);else{if(!d){if(null===b.stateNode)throw Error(k(166));return null}a=Ta(ja.current);if(Zc(b)){d=b.stateNode;e=b.type;var f=b.memoizedProps;d[Aa]=b;d[vc]=f;switch(e){case "iframe":case "object":case "embed":w("load",
d);break;case "video":case "audio":for(a=0;a<Db.length;a++)w(Db[a],d);break;case "source":w("error",d);break;case "img":case "image":case "link":w("error",d);w("load",d);break;case "form":w("reset",d);w("submit",d);break;case "details":w("toggle",d);break;case "input":Hf(d,f);w("invalid",d);oa(c,"onChange");break;case "select":d._wrapperState={wasMultiple:!!f.multiple};w("invalid",d);oa(c,"onChange");break;case "textarea":Kf(d,f),w("invalid",d),oa(c,"onChange")}Ud(e,f);a=null;for(var g in f)if(f.hasOwnProperty(g)){var h=
f[g];"children"===g?"string"===typeof h?d.textContent!==h&&(a=["children",h]):"number"===typeof h&&d.textContent!==""+h&&(a=["children",""+h]):db.hasOwnProperty(g)&&null!=h&&oa(c,g)}switch(e){case "input":mc(d);Jf(d,f,!0);break;case "textarea":mc(d);Mf(d);break;case "select":case "option":break;default:"function"===typeof f.onClick&&(d.onclick=uc)}c=a;b.updateQueue=c;null!==c&&(b.effectTag|=4)}else{g=9===c.nodeType?c:c.ownerDocument;"http://www.w3.org/1999/xhtml"===a&&(a=Nf(e));"http://www.w3.org/1999/xhtml"===
a?"script"===e?(a=g.createElement("div"),a.innerHTML="<script>\x3c/script>",a=a.removeChild(a.firstChild)):"string"===typeof d.is?a=g.createElement(e,{is:d.is}):(a=g.createElement(e),"select"===e&&(g=a,d.multiple?g.multiple=!0:d.size&&(g.size=d.size))):a=g.createElementNS(a,e);a[Aa]=b;a[vc]=d;jj(a,b,!1,!1);b.stateNode=a;g=Vd(e,d);switch(e){case "iframe":case "object":case "embed":w("load",a);h=d;break;case "video":case "audio":for(h=0;h<Db.length;h++)w(Db[h],a);h=d;break;case "source":w("error",a);
h=d;break;case "img":case "image":case "link":w("error",a);w("load",a);h=d;break;case "form":w("reset",a);w("submit",a);h=d;break;case "details":w("toggle",a);h=d;break;case "input":Hf(a,d);h=Cd(a,d);w("invalid",a);oa(c,"onChange");break;case "option":h=Fd(a,d);break;case "select":a._wrapperState={wasMultiple:!!d.multiple};h=M({},d,{value:void 0});w("invalid",a);oa(c,"onChange");break;case "textarea":Kf(a,d);h=Gd(a,d);w("invalid",a);oa(c,"onChange");break;default:h=d}Ud(e,h);var m=h;for(f in m)if(m.hasOwnProperty(f)){var n=
m[f];"style"===f?gg(a,n):"dangerouslySetInnerHTML"===f?(n=n?n.__html:void 0,null!=n&&xh(a,n)):"children"===f?"string"===typeof n?("textarea"!==e||""!==n)&&Wb(a,n):"number"===typeof n&&Wb(a,""+n):"suppressContentEditableWarning"!==f&&"suppressHydrationWarning"!==f&&"autoFocus"!==f&&(db.hasOwnProperty(f)?null!=n&&oa(c,f):null!=n&&xd(a,f,n,g))}switch(e){case "input":mc(a);Jf(a,d,!1);break;case "textarea":mc(a);Mf(a);break;case "option":null!=d.value&&a.setAttribute("value",""+va(d.value));break;case "select":a.multiple=
!!d.multiple;c=d.value;null!=c?hb(a,!!d.multiple,c,!1):null!=d.defaultValue&&hb(a,!!d.multiple,d.defaultValue,!0);break;default:"function"===typeof h.onClick&&(a.onclick=uc)}lg(e,d)&&(b.effectTag|=4)}null!==b.ref&&(b.effectTag|=128)}return null;case 6:if(a&&null!=b.stateNode)kj(a,b,a.memoizedProps,d);else{if("string"!==typeof d&&null===b.stateNode)throw Error(k(166));c=Ta(Tb.current);Ta(ja.current);Zc(b)?(c=b.stateNode,d=b.memoizedProps,c[Aa]=b,c.nodeValue!==d&&(b.effectTag|=4)):(c=(9===c.nodeType?
c:c.ownerDocument).createTextNode(d),c[Aa]=b,b.stateNode=c)}return null;case 13:q(D);d=b.memoizedState;if(0!==(b.effectTag&64))return b.expirationTime=c,b;c=null!==d;d=!1;null===a?void 0!==b.memoizedProps.fallback&&Zc(b):(e=a.memoizedState,d=null!==e,c||null===e||(e=a.child.sibling,null!==e&&(f=b.firstEffect,null!==f?(b.firstEffect=e,e.nextEffect=f):(b.firstEffect=b.lastEffect=e,e.nextEffect=null),e.effectTag=8)));if(c&&!d&&0!==(b.mode&2))if(null===a&&!0!==b.memoizedProps.unstable_avoidThisFallback||
0!==(D.current&1))F===Xa&&(F=ad);else{if(F===Xa||F===ad)F=bd;0!==Xb&&null!==U&&(Ya(U,P),yh(U,Xb))}if(c||d)b.effectTag|=4;return null;case 4:return tb(),wh(b),null;case 10:return me(b),null;case 17:return N(b.type)&&(q(G),q(B)),null;case 19:q(D);d=b.memoizedState;if(null===d)return null;e=0!==(b.effectTag&64);f=d.rendering;if(null===f)if(e)$c(d,!1);else{if(F!==Xa||null!==a&&0!==(a.effectTag&64))for(f=b.child;null!==f;){a=Rc(f);if(null!==a){b.effectTag|=64;$c(d,!1);e=a.updateQueue;null!==e&&(b.updateQueue=
e,b.effectTag|=4);null===d.lastEffect&&(b.firstEffect=null);b.lastEffect=d.lastEffect;for(d=b.child;null!==d;)e=d,f=c,e.effectTag&=2,e.nextEffect=null,e.firstEffect=null,e.lastEffect=null,a=e.alternate,null===a?(e.childExpirationTime=0,e.expirationTime=f,e.child=null,e.memoizedProps=null,e.memoizedState=null,e.updateQueue=null,e.dependencies=null):(e.childExpirationTime=a.childExpirationTime,e.expirationTime=a.expirationTime,e.child=a.child,e.memoizedProps=a.memoizedProps,e.memoizedState=a.memoizedState,
e.updateQueue=a.updateQueue,f=a.dependencies,e.dependencies=null===f?null:{expirationTime:f.expirationTime,firstContext:f.firstContext,responders:f.responders}),d=d.sibling;y(D,D.current&1|2);return b.child}f=f.sibling}}else{if(!e)if(a=Rc(f),null!==a){if(b.effectTag|=64,e=!0,c=a.updateQueue,null!==c&&(b.updateQueue=c,b.effectTag|=4),$c(d,!0),null===d.tail&&"hidden"===d.tailMode&&!f.alternate)return b=b.lastEffect=d.lastEffect,null!==b&&(b.nextEffect=null),null}else 2*Y()-d.renderingStartTime>d.tailExpiration&&
1<c&&(b.effectTag|=64,e=!0,$c(d,!1),b.expirationTime=b.childExpirationTime=c-1);d.isBackwards?(f.sibling=b.child,b.child=f):(c=d.last,null!==c?c.sibling=f:b.child=f,d.last=f)}return null!==d.tail?(0===d.tailExpiration&&(d.tailExpiration=Y()+500),c=d.tail,d.rendering=c,d.tail=c.sibling,d.lastEffect=b.lastEffect,d.renderingStartTime=Y(),c.sibling=null,b=D.current,y(D,e?b&1|2:b&1),c):null}throw Error(k(156,b.tag));}function lj(a,b){switch(a.tag){case 1:return N(a.type)&&(q(G),q(B)),b=a.effectTag,b&4096?
(a.effectTag=b&-4097|64,a):null;case 3:tb();q(G);q(B);b=a.effectTag;if(0!==(b&64))throw Error(k(285));a.effectTag=b&-4097|64;return a;case 5:return te(a),null;case 13:return q(D),b=a.effectTag,b&4096?(a.effectTag=b&-4097|64,a):null;case 19:return q(D),null;case 4:return tb(),null;case 10:return me(a),null;default:return null}}function Le(a,b){return{value:a,source:b,stack:Bd(b)}}function Me(a,b){var c=b.source,d=b.stack;null===d&&null!==c&&(d=Bd(c));null!==c&&na(c.type);b=b.value;null!==a&&1===a.tag&&
na(a.type);try{console.error(b)}catch(e){setTimeout(function(){throw e;})}}function mj(a,b){try{b.props=a.memoizedProps,b.state=a.memoizedState,b.componentWillUnmount()}catch(c){Za(a,c)}}function zh(a){var b=a.ref;if(null!==b)if("function"===typeof b)try{b(null)}catch(c){Za(a,c)}else b.current=null}function nj(a,b){switch(b.tag){case 0:case 11:case 15:case 22:return;case 1:if(b.effectTag&256&&null!==a){var c=a.memoizedProps,d=a.memoizedState;a=b.stateNode;b=a.getSnapshotBeforeUpdate(b.elementType===
b.type?c:aa(b.type,c),d);a.__reactInternalSnapshotBeforeUpdate=b}return;case 3:case 5:case 6:case 4:case 17:return}throw Error(k(163));}function Ah(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.destroy;c.destroy=void 0;void 0!==d&&d()}c=c.next}while(c!==b)}}function Bh(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.create;c.destroy=d()}c=c.next}while(c!==b)}}function oj(a,b,c,d){switch(c.tag){case 0:case 11:case 15:case 22:Bh(3,
c);return;case 1:a=c.stateNode;c.effectTag&4&&(null===b?a.componentDidMount():(d=c.elementType===c.type?b.memoizedProps:aa(c.type,b.memoizedProps),a.componentDidUpdate(d,b.memoizedState,a.__reactInternalSnapshotBeforeUpdate)));b=c.updateQueue;null!==b&&Wg(c,b,a);return;case 3:b=c.updateQueue;if(null!==b){a=null;if(null!==c.child)switch(c.child.tag){case 5:a=c.child.stateNode;break;case 1:a=c.child.stateNode}Wg(c,b,a)}return;case 5:a=c.stateNode;null===b&&c.effectTag&4&&lg(c.type,c.memoizedProps)&&
a.focus();return;case 6:return;case 4:return;case 12:return;case 13:null===c.memoizedState&&(c=c.alternate,null!==c&&(c=c.memoizedState,null!==c&&(c=c.dehydrated,null!==c&&bg(c))));return;case 19:case 17:case 20:case 21:return}throw Error(k(163));}function Ch(a,b,c){"function"===typeof Ne&&Ne(b);switch(b.tag){case 0:case 11:case 14:case 15:case 22:a=b.updateQueue;if(null!==a&&(a=a.lastEffect,null!==a)){var d=a.next;Da(97<c?97:c,function(){var a=d;do{var c=a.destroy;if(void 0!==c){var g=b;try{c()}catch(h){Za(g,
h)}}a=a.next}while(a!==d)})}break;case 1:zh(b);c=b.stateNode;"function"===typeof c.componentWillUnmount&&mj(b,c);break;case 5:zh(b);break;case 4:Dh(a,b,c)}}function Eh(a){var b=a.alternate;a.return=null;a.child=null;a.memoizedState=null;a.updateQueue=null;a.dependencies=null;a.alternate=null;a.firstEffect=null;a.lastEffect=null;a.pendingProps=null;a.memoizedProps=null;a.stateNode=null;null!==b&&Eh(b)}function Fh(a){return 5===a.tag||3===a.tag||4===a.tag}function Gh(a){a:{for(var b=a.return;null!==
b;){if(Fh(b)){var c=b;break a}b=b.return}throw Error(k(160));}b=c.stateNode;switch(c.tag){case 5:var d=!1;break;case 3:b=b.containerInfo;d=!0;break;case 4:b=b.containerInfo;d=!0;break;default:throw Error(k(161));}c.effectTag&16&&(Wb(b,""),c.effectTag&=-17);a:b:for(c=a;;){for(;null===c.sibling;){if(null===c.return||Fh(c.return)){c=null;break a}c=c.return}c.sibling.return=c.return;for(c=c.sibling;5!==c.tag&&6!==c.tag&&18!==c.tag;){if(c.effectTag&2)continue b;if(null===c.child||4===c.tag)continue b;
else c.child.return=c,c=c.child}if(!(c.effectTag&2)){c=c.stateNode;break a}}d?Oe(a,c,b):Pe(a,c,b)}function Oe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?8===c.nodeType?c.parentNode.insertBefore(a,b):c.insertBefore(a,b):(8===c.nodeType?(b=c.parentNode,b.insertBefore(a,c)):(b=c,b.appendChild(a)),c=c._reactRootContainer,null!==c&&void 0!==c||null!==b.onclick||(b.onclick=uc));else if(4!==d&&(a=a.child,null!==a))for(Oe(a,b,c),a=a.sibling;null!==a;)Oe(a,b,c),a=a.sibling}
function Pe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?c.insertBefore(a,b):c.appendChild(a);else if(4!==d&&(a=a.child,null!==a))for(Pe(a,b,c),a=a.sibling;null!==a;)Pe(a,b,c),a=a.sibling}function Dh(a,b,c){for(var d=b,e=!1,f,g;;){if(!e){e=d.return;a:for(;;){if(null===e)throw Error(k(160));f=e.stateNode;switch(e.tag){case 5:g=!1;break a;case 3:f=f.containerInfo;g=!0;break a;case 4:f=f.containerInfo;g=!0;break a}e=e.return}e=!0}if(5===d.tag||6===d.tag){a:for(var h=
a,m=d,n=c,l=m;;)if(Ch(h,l,n),null!==l.child&&4!==l.tag)l.child.return=l,l=l.child;else{if(l===m)break a;for(;null===l.sibling;){if(null===l.return||l.return===m)break a;l=l.return}l.sibling.return=l.return;l=l.sibling}g?(h=f,m=d.stateNode,8===h.nodeType?h.parentNode.removeChild(m):h.removeChild(m)):f.removeChild(d.stateNode)}else if(4===d.tag){if(null!==d.child){f=d.stateNode.containerInfo;g=!0;d.child.return=d;d=d.child;continue}}else if(Ch(a,d,c),null!==d.child){d.child.return=d;d=d.child;continue}if(d===
b)break;for(;null===d.sibling;){if(null===d.return||d.return===b)return;d=d.return;4===d.tag&&(e=!1)}d.sibling.return=d.return;d=d.sibling}}function Qe(a,b){switch(b.tag){case 0:case 11:case 14:case 15:case 22:Ah(3,b);return;case 1:return;case 5:var c=b.stateNode;if(null!=c){var d=b.memoizedProps,e=null!==a?a.memoizedProps:d;a=b.type;var f=b.updateQueue;b.updateQueue=null;if(null!==f){c[vc]=d;"input"===a&&"radio"===d.type&&null!=d.name&&If(c,d);Vd(a,e);b=Vd(a,d);for(e=0;e<f.length;e+=2){var g=f[e],
h=f[e+1];"style"===g?gg(c,h):"dangerouslySetInnerHTML"===g?xh(c,h):"children"===g?Wb(c,h):xd(c,g,h,b)}switch(a){case "input":Dd(c,d);break;case "textarea":Lf(c,d);break;case "select":b=c._wrapperState.wasMultiple,c._wrapperState.wasMultiple=!!d.multiple,a=d.value,null!=a?hb(c,!!d.multiple,a,!1):b!==!!d.multiple&&(null!=d.defaultValue?hb(c,!!d.multiple,d.defaultValue,!0):hb(c,!!d.multiple,d.multiple?[]:"",!1))}}}return;case 6:if(null===b.stateNode)throw Error(k(162));b.stateNode.nodeValue=b.memoizedProps;
return;case 3:b=b.stateNode;b.hydrate&&(b.hydrate=!1,bg(b.containerInfo));return;case 12:return;case 13:c=b;null===b.memoizedState?d=!1:(d=!0,c=b.child,Re=Y());if(null!==c)a:for(a=c;;){if(5===a.tag)f=a.stateNode,d?(f=f.style,"function"===typeof f.setProperty?f.setProperty("display","none","important"):f.display="none"):(f=a.stateNode,e=a.memoizedProps.style,e=void 0!==e&&null!==e&&e.hasOwnProperty("display")?e.display:null,f.style.display=fg("display",e));else if(6===a.tag)a.stateNode.nodeValue=d?
"":a.memoizedProps;else if(13===a.tag&&null!==a.memoizedState&&null===a.memoizedState.dehydrated){f=a.child.sibling;f.return=a;a=f;continue}else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===c)break;for(;null===a.sibling;){if(null===a.return||a.return===c)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}Hh(b);return;case 19:Hh(b);return;case 17:return}throw Error(k(163));}function Hh(a){var b=a.updateQueue;if(null!==b){a.updateQueue=null;var c=a.stateNode;null===c&&(c=a.stateNode=
new pj);b.forEach(function(b){var d=qj.bind(null,a,b);c.has(b)||(c.add(b),b.then(d,d))})}}function Ih(a,b,c){c=Ea(c,null);c.tag=3;c.payload={element:null};var d=b.value;c.callback=function(){cd||(cd=!0,Se=d);Me(a,b)};return c}function Jh(a,b,c){c=Ea(c,null);c.tag=3;var d=a.type.getDerivedStateFromError;if("function"===typeof d){var e=b.value;c.payload=function(){Me(a,b);return d(e)}}var f=a.stateNode;null!==f&&"function"===typeof f.componentDidCatch&&(c.callback=function(){"function"!==typeof d&&
(null===La?La=new Set([this]):La.add(this),Me(a,b));var c=b.stack;this.componentDidCatch(b.value,{componentStack:null!==c?c:""})});return c}function ka(){return(p&(ca|ma))!==H?1073741821-(Y()/10|0):0!==dd?dd:dd=1073741821-(Y()/10|0)}function Va(a,b,c){b=b.mode;if(0===(b&2))return 1073741823;var d=Cc();if(0===(b&4))return 99===d?1073741823:1073741822;if((p&ca)!==H)return P;if(null!==c)a=Fc(a,c.timeoutMs|0||5E3,250);else switch(d){case 99:a=1073741823;break;case 98:a=Fc(a,150,100);break;case 97:case 96:a=
Fc(a,5E3,250);break;case 95:a=2;break;default:throw Error(k(326));}null!==U&&a===P&&--a;return a}function ed(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);var d=a.return,e=null;if(null===d&&3===a.tag)e=a.stateNode;else for(;null!==d;){c=d.alternate;d.childExpirationTime<b&&(d.childExpirationTime=b);null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);if(null===d.return&&3===d.tag){e=d.stateNode;break}d=d.return}null!==e&&
(U===e&&(Kc(b),F===bd&&Ya(e,P)),yh(e,b));return e}function fd(a){var b=a.lastExpiredTime;if(0!==b)return b;b=a.firstPendingTime;if(!Kh(a,b))return b;var c=a.lastPingedTime;a=a.nextKnownPendingLevel;a=c>a?c:a;return 2>=a&&b!==a?0:a}function V(a){if(0!==a.lastExpiredTime)a.callbackExpirationTime=1073741823,a.callbackPriority=99,a.callbackNode=Og(Te.bind(null,a));else{var b=fd(a),c=a.callbackNode;if(0===b)null!==c&&(a.callbackNode=null,a.callbackExpirationTime=0,a.callbackPriority=90);else{var d=ka();
1073741823===b?d=99:1===b||2===b?d=95:(d=10*(1073741821-b)-10*(1073741821-d),d=0>=d?99:250>=d?98:5250>=d?97:95);if(null!==c){var e=a.callbackPriority;if(a.callbackExpirationTime===b&&e>=d)return;c!==Qg&&Rg(c)}a.callbackExpirationTime=b;a.callbackPriority=d;b=1073741823===b?Og(Te.bind(null,a)):Ng(d,Lh.bind(null,a),{timeout:10*(1073741821-b)-Y()});a.callbackNode=b}}}function Lh(a,b){dd=0;if(b)return b=ka(),Ue(a,b),V(a),null;var c=fd(a);if(0!==c){b=a.callbackNode;if((p&(ca|ma))!==H)throw Error(k(327));
xb();a===U&&c===P||$a(a,c);if(null!==t){var d=p;p|=ca;var e=Mh();do try{rj();break}catch(h){Nh(a,h)}while(1);le();p=d;gd.current=e;if(F===hd)throw b=id,$a(a,c),Ya(a,c),V(a),b;if(null===t)switch(e=a.finishedWork=a.current.alternate,a.finishedExpirationTime=c,d=F,U=null,d){case Xa:case hd:throw Error(k(345));case Oh:Ue(a,2<c?2:c);break;case ad:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(1073741823===ta&&(e=Re+Ph-Y(),10<e)){if(jd){var f=a.lastPingedTime;if(0===f||f>=c){a.lastPingedTime=
c;$a(a,c);break}}f=fd(a);if(0!==f&&f!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}a.timeoutHandle=We(ab.bind(null,a),e);break}ab(a);break;case bd:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(jd&&(e=a.lastPingedTime,0===e||e>=c)){a.lastPingedTime=c;$a(a,c);break}e=fd(a);if(0!==e&&e!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}1073741823!==Yb?d=10*(1073741821-Yb)-Y():1073741823===ta?d=0:(d=10*(1073741821-ta)-5E3,e=Y(),c=10*(1073741821-c)-e,d=e-d,0>d&&(d=0),d=
(120>d?120:480>d?480:1080>d?1080:1920>d?1920:3E3>d?3E3:4320>d?4320:1960*sj(d/1960))-d,c<d&&(d=c));if(10<d){a.timeoutHandle=We(ab.bind(null,a),d);break}ab(a);break;case Xe:if(1073741823!==ta&&null!==kd){f=ta;var g=kd;d=g.busyMinDurationMs|0;0>=d?d=0:(e=g.busyDelayMs|0,f=Y()-(10*(1073741821-f)-(g.timeoutMs|0||5E3)),d=f<=e?0:e+d-f);if(10<d){Ya(a,c);a.timeoutHandle=We(ab.bind(null,a),d);break}}ab(a);break;default:throw Error(k(329));}V(a);if(a.callbackNode===b)return Lh.bind(null,a)}}return null}function Te(a){var b=
a.lastExpiredTime;b=0!==b?b:1073741823;if((p&(ca|ma))!==H)throw Error(k(327));xb();a===U&&b===P||$a(a,b);if(null!==t){var c=p;p|=ca;var d=Mh();do try{tj();break}catch(e){Nh(a,e)}while(1);le();p=c;gd.current=d;if(F===hd)throw c=id,$a(a,b),Ya(a,b),V(a),c;if(null!==t)throw Error(k(261));a.finishedWork=a.current.alternate;a.finishedExpirationTime=b;U=null;ab(a);V(a)}return null}function uj(){if(null!==bb){var a=bb;bb=null;a.forEach(function(a,c){Ue(c,a);V(c)});ha()}}function Qh(a,b){var c=p;p|=1;try{return a(b)}finally{p=
c,p===H&&ha()}}function Rh(a,b){var c=p;p&=-2;p|=Ye;try{return a(b)}finally{p=c,p===H&&ha()}}function $a(a,b){a.finishedWork=null;a.finishedExpirationTime=0;var c=a.timeoutHandle;-1!==c&&(a.timeoutHandle=-1,vj(c));if(null!==t)for(c=t.return;null!==c;){var d=c;switch(d.tag){case 1:d=d.type.childContextTypes;null!==d&&void 0!==d&&(q(G),q(B));break;case 3:tb();q(G);q(B);break;case 5:te(d);break;case 4:tb();break;case 13:q(D);break;case 19:q(D);break;case 10:me(d)}c=c.return}U=a;t=Sa(a.current,null);
P=b;F=Xa;id=null;Yb=ta=1073741823;kd=null;Xb=0;jd=!1}function Nh(a,b){do{try{le();Sc.current=Tc;if(Uc)for(var c=z.memoizedState;null!==c;){var d=c.queue;null!==d&&(d.pending=null);c=c.next}Ia=0;J=K=z=null;Uc=!1;if(null===t||null===t.return)return F=hd,id=b,t=null;a:{var e=a,f=t.return,g=t,h=b;b=P;g.effectTag|=2048;g.firstEffect=g.lastEffect=null;if(null!==h&&"object"===typeof h&&"function"===typeof h.then){var m=h;if(0===(g.mode&2)){var n=g.alternate;n?(g.updateQueue=n.updateQueue,g.memoizedState=
n.memoizedState,g.expirationTime=n.expirationTime):(g.updateQueue=null,g.memoizedState=null)}var l=0!==(D.current&1),k=f;do{var p;if(p=13===k.tag){var q=k.memoizedState;if(null!==q)p=null!==q.dehydrated?!0:!1;else{var w=k.memoizedProps;p=void 0===w.fallback?!1:!0!==w.unstable_avoidThisFallback?!0:l?!1:!0}}if(p){var y=k.updateQueue;if(null===y){var r=new Set;r.add(m);k.updateQueue=r}else y.add(m);if(0===(k.mode&2)){k.effectTag|=64;g.effectTag&=-2981;if(1===g.tag)if(null===g.alternate)g.tag=17;else{var O=
Ea(1073741823,null);O.tag=Jc;Fa(g,O)}g.expirationTime=1073741823;break a}h=void 0;g=b;var v=e.pingCache;null===v?(v=e.pingCache=new wj,h=new Set,v.set(m,h)):(h=v.get(m),void 0===h&&(h=new Set,v.set(m,h)));if(!h.has(g)){h.add(g);var x=xj.bind(null,e,m,g);m.then(x,x)}k.effectTag|=4096;k.expirationTime=b;break a}k=k.return}while(null!==k);h=Error((na(g.type)||"A React component")+" suspended while rendering, but no fallback UI was specified.\n\nAdd a <Suspense fallback=...> component higher in the tree to provide a loading indicator or placeholder to display."+
Bd(g))}F!==Xe&&(F=Oh);h=Le(h,g);k=f;do{switch(k.tag){case 3:m=h;k.effectTag|=4096;k.expirationTime=b;var A=Ih(k,m,b);Ug(k,A);break a;case 1:m=h;var u=k.type,B=k.stateNode;if(0===(k.effectTag&64)&&("function"===typeof u.getDerivedStateFromError||null!==B&&"function"===typeof B.componentDidCatch&&(null===La||!La.has(B)))){k.effectTag|=4096;k.expirationTime=b;var H=Jh(k,m,b);Ug(k,H);break a}}k=k.return}while(null!==k)}t=Sh(t)}catch(cj){b=cj;continue}break}while(1)}function Mh(a){a=gd.current;gd.current=
Tc;return null===a?Tc:a}function Vg(a,b){a<ta&&2<a&&(ta=a);null!==b&&a<Yb&&2<a&&(Yb=a,kd=b)}function Kc(a){a>Xb&&(Xb=a)}function tj(){for(;null!==t;)t=Th(t)}function rj(){for(;null!==t&&!yj();)t=Th(t)}function Th(a){var b=zj(a.alternate,a,P);a.memoizedProps=a.pendingProps;null===b&&(b=Sh(a));Uh.current=null;return b}function Sh(a){t=a;do{var b=t.alternate;a=t.return;if(0===(t.effectTag&2048)){b=hj(b,t,P);if(1===P||1!==t.childExpirationTime){for(var c=0,d=t.child;null!==d;){var e=d.expirationTime,
f=d.childExpirationTime;e>c&&(c=e);f>c&&(c=f);d=d.sibling}t.childExpirationTime=c}if(null!==b)return b;null!==a&&0===(a.effectTag&2048)&&(null===a.firstEffect&&(a.firstEffect=t.firstEffect),null!==t.lastEffect&&(null!==a.lastEffect&&(a.lastEffect.nextEffect=t.firstEffect),a.lastEffect=t.lastEffect),1<t.effectTag&&(null!==a.lastEffect?a.lastEffect.nextEffect=t:a.firstEffect=t,a.lastEffect=t))}else{b=lj(t);if(null!==b)return b.effectTag&=2047,b;null!==a&&(a.firstEffect=a.lastEffect=null,a.effectTag|=
2048)}b=t.sibling;if(null!==b)return b;t=a}while(null!==t);F===Xa&&(F=Xe);return null}function Ve(a){var b=a.expirationTime;a=a.childExpirationTime;return b>a?b:a}function ab(a){var b=Cc();Da(99,Aj.bind(null,a,b));return null}function Aj(a,b){do xb();while(null!==Zb);if((p&(ca|ma))!==H)throw Error(k(327));var c=a.finishedWork,d=a.finishedExpirationTime;if(null===c)return null;a.finishedWork=null;a.finishedExpirationTime=0;if(c===a.current)throw Error(k(177));a.callbackNode=null;a.callbackExpirationTime=
0;a.callbackPriority=90;a.nextKnownPendingLevel=0;var e=Ve(c);a.firstPendingTime=e;d<=a.lastSuspendedTime?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:d<=a.firstSuspendedTime&&(a.firstSuspendedTime=d-1);d<=a.lastPingedTime&&(a.lastPingedTime=0);d<=a.lastExpiredTime&&(a.lastExpiredTime=0);a===U&&(t=U=null,P=0);1<c.effectTag?null!==c.lastEffect?(c.lastEffect.nextEffect=c,e=c.firstEffect):e=c:e=c.firstEffect;if(null!==e){var f=p;p|=ma;Uh.current=null;Ze=tc;var g=kg();if(Xd(g)){if("selectionStart"in
g)var h={start:g.selectionStart,end:g.selectionEnd};else a:{h=(h=g.ownerDocument)&&h.defaultView||window;var m=h.getSelection&&h.getSelection();if(m&&0!==m.rangeCount){h=m.anchorNode;var n=m.anchorOffset,q=m.focusNode;m=m.focusOffset;try{h.nodeType,q.nodeType}catch(sb){h=null;break a}var ba=0,w=-1,y=-1,B=0,D=0,r=g,z=null;b:for(;;){for(var v;;){r!==h||0!==n&&3!==r.nodeType||(w=ba+n);r!==q||0!==m&&3!==r.nodeType||(y=ba+m);3===r.nodeType&&(ba+=r.nodeValue.length);if(null===(v=r.firstChild))break;z=r;
r=v}for(;;){if(r===g)break b;z===h&&++B===n&&(w=ba);z===q&&++D===m&&(y=ba);if(null!==(v=r.nextSibling))break;r=z;z=r.parentNode}r=v}h=-1===w||-1===y?null:{start:w,end:y}}else h=null}h=h||{start:0,end:0}}else h=null;$e={activeElementDetached:null,focusedElem:g,selectionRange:h};tc=!1;l=e;do try{Bj()}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=e;do try{for(g=a,h=b;null!==l;){var x=l.effectTag;x&16&&Wb(l.stateNode,"");if(x&128){var A=l.alternate;if(null!==A){var u=
A.ref;null!==u&&("function"===typeof u?u(null):u.current=null)}}switch(x&1038){case 2:Gh(l);l.effectTag&=-3;break;case 6:Gh(l);l.effectTag&=-3;Qe(l.alternate,l);break;case 1024:l.effectTag&=-1025;break;case 1028:l.effectTag&=-1025;Qe(l.alternate,l);break;case 4:Qe(l.alternate,l);break;case 8:n=l,Dh(g,n,h),Eh(n)}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);u=$e;A=kg();x=u.focusedElem;h=u.selectionRange;if(A!==x&&x&&x.ownerDocument&&jg(x.ownerDocument.documentElement,
x)){null!==h&&Xd(x)&&(A=h.start,u=h.end,void 0===u&&(u=A),"selectionStart"in x?(x.selectionStart=A,x.selectionEnd=Math.min(u,x.value.length)):(u=(A=x.ownerDocument||document)&&A.defaultView||window,u.getSelection&&(u=u.getSelection(),n=x.textContent.length,g=Math.min(h.start,n),h=void 0===h.end?g:Math.min(h.end,n),!u.extend&&g>h&&(n=h,h=g,g=n),n=ig(x,g),q=ig(x,h),n&&q&&(1!==u.rangeCount||u.anchorNode!==n.node||u.anchorOffset!==n.offset||u.focusNode!==q.node||u.focusOffset!==q.offset)&&(A=A.createRange(),
A.setStart(n.node,n.offset),u.removeAllRanges(),g>h?(u.addRange(A),u.extend(q.node,q.offset)):(A.setEnd(q.node,q.offset),u.addRange(A))))));A=[];for(u=x;u=u.parentNode;)1===u.nodeType&&A.push({element:u,left:u.scrollLeft,top:u.scrollTop});"function"===typeof x.focus&&x.focus();for(x=0;x<A.length;x++)u=A[x],u.element.scrollLeft=u.left,u.element.scrollTop=u.top}tc=!!Ze;$e=Ze=null;a.current=c;l=e;do try{for(x=a;null!==l;){var F=l.effectTag;F&36&&oj(x,l.alternate,l);if(F&128){A=void 0;var E=l.ref;if(null!==
E){var G=l.stateNode;switch(l.tag){case 5:A=G;break;default:A=G}"function"===typeof E?E(A):E.current=A}}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=null;Cj();p=f}else a.current=c;if(ld)ld=!1,Zb=a,$b=b;else for(l=e;null!==l;)b=l.nextEffect,l.nextEffect=null,l=b;b=a.firstPendingTime;0===b&&(La=null);1073741823===b?a===af?ac++:(ac=0,af=a):ac=0;"function"===typeof bf&&bf(c.stateNode,d);V(a);if(cd)throw cd=!1,a=Se,Se=null,a;if((p&Ye)!==H)return null;
ha();return null}function Bj(){for(;null!==l;){var a=l.effectTag;0!==(a&256)&&nj(l.alternate,l);0===(a&512)||ld||(ld=!0,Ng(97,function(){xb();return null}));l=l.nextEffect}}function xb(){if(90!==$b){var a=97<$b?97:$b;$b=90;return Da(a,Dj)}}function Dj(){if(null===Zb)return!1;var a=Zb;Zb=null;if((p&(ca|ma))!==H)throw Error(k(331));var b=p;p|=ma;for(a=a.current.firstEffect;null!==a;){try{var c=a;if(0!==(c.effectTag&512))switch(c.tag){case 0:case 11:case 15:case 22:Ah(5,c),Bh(5,c)}}catch(d){if(null===
a)throw Error(k(330));Za(a,d)}c=a.nextEffect;a.nextEffect=null;a=c}p=b;ha();return!0}function Vh(a,b,c){b=Le(c,b);b=Ih(a,b,1073741823);Fa(a,b);a=ed(a,1073741823);null!==a&&V(a)}function Za(a,b){if(3===a.tag)Vh(a,a,b);else for(var c=a.return;null!==c;){if(3===c.tag){Vh(c,a,b);break}else if(1===c.tag){var d=c.stateNode;if("function"===typeof c.type.getDerivedStateFromError||"function"===typeof d.componentDidCatch&&(null===La||!La.has(d))){a=Le(b,a);a=Jh(c,a,1073741823);Fa(c,a);c=ed(c,1073741823);null!==
c&&V(c);break}}c=c.return}}function xj(a,b,c){var d=a.pingCache;null!==d&&d.delete(b);U===a&&P===c?F===bd||F===ad&&1073741823===ta&&Y()-Re<Ph?$a(a,P):jd=!0:Kh(a,c)&&(b=a.lastPingedTime,0!==b&&b<c||(a.lastPingedTime=c,V(a)))}function qj(a,b){var c=a.stateNode;null!==c&&c.delete(b);b=0;0===b&&(b=ka(),b=Va(b,a,null));a=ed(a,b);null!==a&&V(a)}function Ej(a){if("undefined"===typeof __REACT_DEVTOOLS_GLOBAL_HOOK__)return!1;var b=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(b.isDisabled||!b.supportsFiber)return!0;try{var c=
b.inject(a);bf=function(a,e){try{b.onCommitFiberRoot(c,a,void 0,64===(a.current.effectTag&64))}catch(f){}};Ne=function(a){try{b.onCommitFiberUnmount(c,a)}catch(e){}}}catch(d){}return!0}function Fj(a,b,c,d){this.tag=a;this.key=c;this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null;this.index=0;this.ref=null;this.pendingProps=b;this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null;this.mode=d;this.effectTag=0;this.lastEffect=this.firstEffect=this.nextEffect=
null;this.childExpirationTime=this.expirationTime=0;this.alternate=null}function Ge(a){a=a.prototype;return!(!a||!a.isReactComponent)}function Gj(a){if("function"===typeof a)return Ge(a)?1:0;if(void 0!==a&&null!==a){a=a.$$typeof;if(a===zd)return 11;if(a===Ad)return 14}return 2}function Sa(a,b){var c=a.alternate;null===c?(c=la(a.tag,b,a.key,a.mode),c.elementType=a.elementType,c.type=a.type,c.stateNode=a.stateNode,c.alternate=a,a.alternate=c):(c.pendingProps=b,c.effectTag=0,c.nextEffect=null,c.firstEffect=
null,c.lastEffect=null);c.childExpirationTime=a.childExpirationTime;c.expirationTime=a.expirationTime;c.child=a.child;c.memoizedProps=a.memoizedProps;c.memoizedState=a.memoizedState;c.updateQueue=a.updateQueue;b=a.dependencies;c.dependencies=null===b?null:{expirationTime:b.expirationTime,firstContext:b.firstContext,responders:b.responders};c.sibling=a.sibling;c.index=a.index;c.ref=a.ref;return c}function Oc(a,b,c,d,e,f){var g=2;d=a;if("function"===typeof a)Ge(a)&&(g=1);else if("string"===typeof a)g=
5;else a:switch(a){case Ma:return Ha(c.children,e,f,b);case Hj:g=8;e|=7;break;case Af:g=8;e|=1;break;case kc:return a=la(12,c,b,e|8),a.elementType=kc,a.type=kc,a.expirationTime=f,a;case lc:return a=la(13,c,b,e),a.type=lc,a.elementType=lc,a.expirationTime=f,a;case yd:return a=la(19,c,b,e),a.elementType=yd,a.expirationTime=f,a;default:if("object"===typeof a&&null!==a)switch(a.$$typeof){case Cf:g=10;break a;case Bf:g=9;break a;case zd:g=11;break a;case Ad:g=14;break a;case Ef:g=16;d=null;break a;case Df:g=
22;break a}throw Error(k(130,null==a?a:typeof a,""));}b=la(g,c,b,e);b.elementType=a;b.type=d;b.expirationTime=f;return b}function Ha(a,b,c,d){a=la(7,a,d,b);a.expirationTime=c;return a}function qe(a,b,c){a=la(6,a,null,b);a.expirationTime=c;return a}function re(a,b,c){b=la(4,null!==a.children?a.children:[],a.key,b);b.expirationTime=c;b.stateNode={containerInfo:a.containerInfo,pendingChildren:null,implementation:a.implementation};return b}function Ij(a,b,c){this.tag=b;this.current=null;this.containerInfo=
a;this.pingCache=this.pendingChildren=null;this.finishedExpirationTime=0;this.finishedWork=null;this.timeoutHandle=-1;this.pendingContext=this.context=null;this.hydrate=c;this.callbackNode=null;this.callbackPriority=90;this.lastExpiredTime=this.lastPingedTime=this.nextKnownPendingLevel=this.lastSuspendedTime=this.firstSuspendedTime=this.firstPendingTime=0}function Kh(a,b){var c=a.firstSuspendedTime;a=a.lastSuspendedTime;return 0!==c&&c>=b&&a<=b}function Ya(a,b){var c=a.firstSuspendedTime,d=a.lastSuspendedTime;
c<b&&(a.firstSuspendedTime=b);if(d>b||0===c)a.lastSuspendedTime=b;b<=a.lastPingedTime&&(a.lastPingedTime=0);b<=a.lastExpiredTime&&(a.lastExpiredTime=0)}function yh(a,b){b>a.firstPendingTime&&(a.firstPendingTime=b);var c=a.firstSuspendedTime;0!==c&&(b>=c?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:b>=a.lastSuspendedTime&&(a.lastSuspendedTime=b+1),b>a.nextKnownPendingLevel&&(a.nextKnownPendingLevel=b))}function Ue(a,b){var c=a.lastExpiredTime;if(0===c||c>b)a.lastExpiredTime=b}
function md(a,b,c,d){var e=b.current,f=ka(),g=Vb.suspense;f=Va(f,e,g);a:if(c){c=c._reactInternalFiber;b:{if(Na(c)!==c||1!==c.tag)throw Error(k(170));var h=c;do{switch(h.tag){case 3:h=h.stateNode.context;break b;case 1:if(N(h.type)){h=h.stateNode.__reactInternalMemoizedMergedChildContext;break b}}h=h.return}while(null!==h);throw Error(k(171));}if(1===c.tag){var m=c.type;if(N(m)){c=Gg(c,m,h);break a}}c=h}else c=Ca;null===b.context?b.context=c:b.pendingContext=c;b=Ea(f,g);b.payload={element:a};d=void 0===
d?null:d;null!==d&&(b.callback=d);Fa(e,b);Ja(e,f);return f}function cf(a){a=a.current;if(!a.child)return null;switch(a.child.tag){case 5:return a.child.stateNode;default:return a.child.stateNode}}function Wh(a,b){a=a.memoizedState;null!==a&&null!==a.dehydrated&&a.retryTime<b&&(a.retryTime=b)}function df(a,b){Wh(a,b);(a=a.alternate)&&Wh(a,b)}function ef(a,b,c){c=null!=c&&!0===c.hydrate;var d=new Ij(a,b,c),e=la(3,null,null,2===b?7:1===b?3:0);d.current=e;e.stateNode=d;ne(e);a[Lb]=d.current;c&&0!==b&&
xi(a,9===a.nodeType?a:a.ownerDocument);this._internalRoot=d}function bc(a){return!(!a||1!==a.nodeType&&9!==a.nodeType&&11!==a.nodeType&&(8!==a.nodeType||" react-mount-point-unstable "!==a.nodeValue))}function Jj(a,b){b||(b=a?9===a.nodeType?a.documentElement:a.firstChild:null,b=!(!b||1!==b.nodeType||!b.hasAttribute("data-reactroot")));if(!b)for(var c;c=a.lastChild;)a.removeChild(c);return new ef(a,0,b?{hydrate:!0}:void 0)}function nd(a,b,c,d,e){var f=c._reactRootContainer;if(f){var g=f._internalRoot;
if("function"===typeof e){var h=e;e=function(){var a=cf(g);h.call(a)}}md(b,g,a,e)}else{f=c._reactRootContainer=Jj(c,d);g=f._internalRoot;if("function"===typeof e){var m=e;e=function(){var a=cf(g);m.call(a)}}Rh(function(){md(b,g,a,e)})}return cf(g)}function Kj(a,b,c){var d=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:gb,key:null==d?null:""+d,children:a,containerInfo:b,implementation:c}}function Xh(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;
if(!bc(b))throw Error(k(200));return Kj(a,b,null,c)}if(!ea)throw Error(k(227));var ki=function(a,b,c,d,e,f,g,h,m){var n=Array.prototype.slice.call(arguments,3);try{b.apply(c,n)}catch(C){this.onError(C)}},yb=!1,gc=null,hc=!1,pd=null,li={onError:function(a){yb=!0;gc=a}},td=null,rf=null,mf=null,ic=null,cb={},jc=[],qd={},db={},rd={},wa=!("undefined"===typeof window||"undefined"===typeof window.document||"undefined"===typeof window.document.createElement),M=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.assign,
sd=null,eb=null,fb=null,ee=function(a,b){return a(b)},eg=function(a,b,c,d,e){return a(b,c,d,e)},vd=function(){},vf=ee,Oa=!1,wd=!1,Z=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.Scheduler,Lj=Z.unstable_cancelCallback,ff=Z.unstable_now,$f=Z.unstable_scheduleCallback,Mj=Z.unstable_shouldYield,Yh=Z.unstable_requestPaint,Pd=Z.unstable_runWithPriority,Nj=Z.unstable_getCurrentPriorityLevel,Oj=Z.unstable_ImmediatePriority,Zh=Z.unstable_UserBlockingPriority,ag=Z.unstable_NormalPriority,Pj=Z.unstable_LowPriority,
Qj=Z.unstable_IdlePriority,oi=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,wf=Object.prototype.hasOwnProperty,yf={},xf={},E={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(a){E[a]=
new L(a,0,!1,a,null,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(a){var b=a[0];E[b]=new L(b,1,!1,a[1],null,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(a){E[a]=new L(a,2,!1,a.toLowerCase(),null,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(a){E[a]=new L(a,2,!1,a,null,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(a){E[a]=
new L(a,3,!1,a.toLowerCase(),null,!1)});["checked","multiple","muted","selected"].forEach(function(a){E[a]=new L(a,3,!0,a,null,!1)});["capture","download"].forEach(function(a){E[a]=new L(a,4,!1,a,null,!1)});["cols","rows","size","span"].forEach(function(a){E[a]=new L(a,6,!1,a,null,!1)});["rowSpan","start"].forEach(function(a){E[a]=new L(a,5,!1,a.toLowerCase(),null,!1)});var gf=/[\-:]([a-z])/g,hf=function(a){return a[1].toUpperCase()};"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(a){var b=
a.replace(gf,hf);E[b]=new L(b,1,!1,a,null,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/1999/xlink",!1)});["xml:base","xml:lang","xml:space"].forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/XML/1998/namespace",!1)});["tabIndex","crossOrigin"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!1)});E.xlinkHref=new L("xlinkHref",1,
!1,"xlink:href","http://www.w3.org/1999/xlink",!0);["src","href","action","formAction"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!0)});var da=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;da.hasOwnProperty("ReactCurrentDispatcher")||(da.ReactCurrentDispatcher={current:null});da.hasOwnProperty("ReactCurrentBatchConfig")||(da.ReactCurrentBatchConfig={suspense:null});var si=/^(.*)[\\\/]/,Q="function"===typeof Symbol&&Symbol.for,Pc=Q?Symbol.for("react.element"):60103,gb=Q?Symbol.for("react.portal"):
60106,Ma=Q?Symbol.for("react.fragment"):60107,Af=Q?Symbol.for("react.strict_mode"):60108,kc=Q?Symbol.for("react.profiler"):60114,Cf=Q?Symbol.for("react.provider"):60109,Bf=Q?Symbol.for("react.context"):60110,Hj=Q?Symbol.for("react.concurrent_mode"):60111,zd=Q?Symbol.for("react.forward_ref"):60112,lc=Q?Symbol.for("react.suspense"):60113,yd=Q?Symbol.for("react.suspense_list"):60120,Ad=Q?Symbol.for("react.memo"):60115,Ef=Q?Symbol.for("react.lazy"):60116,Df=Q?Symbol.for("react.block"):60121,zf="function"===
typeof Symbol&&Symbol.iterator,od,xh=function(a){return"undefined"!==typeof MSApp&&MSApp.execUnsafeLocalFunction?function(b,c,d,e){MSApp.execUnsafeLocalFunction(function(){return a(b,c,d,e)})}:a}(function(a,b){if("http://www.w3.org/2000/svg"!==a.namespaceURI||"innerHTML"in a)a.innerHTML=b;else{od=od||document.createElement("div");od.innerHTML="<svg>"+b.valueOf().toString()+"</svg>";for(b=od.firstChild;a.firstChild;)a.removeChild(a.firstChild);for(;b.firstChild;)a.appendChild(b.firstChild)}}),Wb=function(a,
b){if(b){var c=a.firstChild;if(c&&c===a.lastChild&&3===c.nodeType){c.nodeValue=b;return}}a.textContent=b},ib={animationend:nc("Animation","AnimationEnd"),animationiteration:nc("Animation","AnimationIteration"),animationstart:nc("Animation","AnimationStart"),transitionend:nc("Transition","TransitionEnd")},Id={},Of={};wa&&(Of=document.createElement("div").style,"AnimationEvent"in window||(delete ib.animationend.animation,delete ib.animationiteration.animation,delete ib.animationstart.animation),"TransitionEvent"in
window||delete ib.transitionend.transition);var $h=oc("animationend"),ai=oc("animationiteration"),bi=oc("animationstart"),ci=oc("transitionend"),Db="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Pf=new ("function"===typeof WeakMap?WeakMap:Map),Ab=null,wi=function(a){if(a){var b=a._dispatchListeners,c=a._dispatchInstances;
if(Array.isArray(b))for(var d=0;d<b.length&&!a.isPropagationStopped();d++)lf(a,b[d],c[d]);else b&&lf(a,b,c);a._dispatchListeners=null;a._dispatchInstances=null;a.isPersistent()||a.constructor.release(a)}},qc=[],Rd=!1,fa=[],xa=null,ya=null,za=null,Eb=new Map,Fb=new Map,Jb=[],Nd="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput close cancel copy cut paste click change contextmenu reset submit".split(" "),
yi="focus blur dragenter dragleave mouseover mouseout pointerover pointerout gotpointercapture lostpointercapture".split(" "),dg={},cg=new Map,Td=new Map,Rj=["abort","abort",$h,"animationEnd",ai,"animationIteration",bi,"animationStart","canplay","canPlay","canplaythrough","canPlayThrough","durationchange","durationChange","emptied","emptied","encrypted","encrypted","ended","ended","error","error","gotpointercapture","gotPointerCapture","load","load","loadeddata","loadedData","loadedmetadata","loadedMetadata",
"loadstart","loadStart","lostpointercapture","lostPointerCapture","playing","playing","progress","progress","seeking","seeking","stalled","stalled","suspend","suspend","timeupdate","timeUpdate",ci,"transitionEnd","waiting","waiting"];Sd("blur blur cancel cancel click click close close contextmenu contextMenu copy copy cut cut auxclick auxClick dblclick doubleClick dragend dragEnd dragstart dragStart drop drop focus focus input input invalid invalid keydown keyDown keypress keyPress keyup keyUp mousedown mouseDown mouseup mouseUp paste paste pause pause play play pointercancel pointerCancel pointerdown pointerDown pointerup pointerUp ratechange rateChange reset reset seeked seeked submit submit touchcancel touchCancel touchend touchEnd touchstart touchStart volumechange volumeChange".split(" "),
0);Sd("drag drag dragenter dragEnter dragexit dragExit dragleave dragLeave dragover dragOver mousemove mouseMove mouseout mouseOut mouseover mouseOver pointermove pointerMove pointerout pointerOut pointerover pointerOver scroll scroll toggle toggle touchmove touchMove wheel wheel".split(" "),1);Sd(Rj,2);(function(a,b){for(var c=0;c<a.length;c++)Td.set(a[c],b)})("change selectionchange textInput compositionstart compositionend compositionupdate".split(" "),0);var Hi=Zh,Gi=Pd,tc=!0,Kb={animationIterationCount:!0,
borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,
strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},Sj=["Webkit","ms","Moz","O"];Object.keys(Kb).forEach(function(a){Sj.forEach(function(b){b=b+a.charAt(0).toUpperCase()+a.substring(1);Kb[b]=Kb[a]})});var Ii=M({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0}),ng="$",og="/$",$d="$?",Zd="$!",Ze=null,$e=null,We="function"===typeof setTimeout?setTimeout:void 0,vj="function"===
typeof clearTimeout?clearTimeout:void 0,jf=Math.random().toString(36).slice(2),Aa="__reactInternalInstance$"+jf,vc="__reactEventHandlers$"+jf,Lb="__reactContainere$"+jf,Ba=null,ce=null,wc=null;M(R.prototype,{preventDefault:function(){this.defaultPrevented=!0;var a=this.nativeEvent;a&&(a.preventDefault?a.preventDefault():"unknown"!==typeof a.returnValue&&(a.returnValue=!1),this.isDefaultPrevented=xc)},stopPropagation:function(){var a=this.nativeEvent;a&&(a.stopPropagation?a.stopPropagation():"unknown"!==
typeof a.cancelBubble&&(a.cancelBubble=!0),this.isPropagationStopped=xc)},persist:function(){this.isPersistent=xc},isPersistent:yc,destructor:function(){var a=this.constructor.Interface,b;for(b in a)this[b]=null;this.nativeEvent=this._targetInst=this.dispatchConfig=null;this.isPropagationStopped=this.isDefaultPrevented=yc;this._dispatchInstances=this._dispatchListeners=null}});R.Interface={type:null,target:null,currentTarget:function(){return null},eventPhase:null,bubbles:null,cancelable:null,timeStamp:function(a){return a.timeStamp||
Date.now()},defaultPrevented:null,isTrusted:null};R.extend=function(a){function b(){return c.apply(this,arguments)}var c=this,d=function(){};d.prototype=c.prototype;d=new d;M(d,b.prototype);b.prototype=d;b.prototype.constructor=b;b.Interface=M({},c.Interface,a);b.extend=c.extend;sg(b);return b};sg(R);var Tj=R.extend({data:null}),Uj=R.extend({data:null}),Ni=[9,13,27,32],de=wa&&"CompositionEvent"in window,cc=null;wa&&"documentMode"in document&&(cc=document.documentMode);var Vj=wa&&"TextEvent"in window&&
!cc,xg=wa&&(!de||cc&&8<cc&&11>=cc),wg=String.fromCharCode(32),ua={beforeInput:{phasedRegistrationNames:{bubbled:"onBeforeInput",captured:"onBeforeInputCapture"},dependencies:["compositionend","keypress","textInput","paste"]},compositionEnd:{phasedRegistrationNames:{bubbled:"onCompositionEnd",captured:"onCompositionEndCapture"},dependencies:"blur compositionend keydown keypress keyup mousedown".split(" ")},compositionStart:{phasedRegistrationNames:{bubbled:"onCompositionStart",captured:"onCompositionStartCapture"},
dependencies:"blur compositionstart keydown keypress keyup mousedown".split(" ")},compositionUpdate:{phasedRegistrationNames:{bubbled:"onCompositionUpdate",captured:"onCompositionUpdateCapture"},dependencies:"blur compositionupdate keydown keypress keyup mousedown".split(" ")}},vg=!1,mb=!1,Wj={eventTypes:ua,extractEvents:function(a,b,c,d,e){var f;if(de)b:{switch(a){case "compositionstart":var g=ua.compositionStart;break b;case "compositionend":g=ua.compositionEnd;break b;case "compositionupdate":g=
ua.compositionUpdate;break b}g=void 0}else mb?tg(a,c)&&(g=ua.compositionEnd):"keydown"===a&&229===c.keyCode&&(g=ua.compositionStart);g?(xg&&"ko"!==c.locale&&(mb||g!==ua.compositionStart?g===ua.compositionEnd&&mb&&(f=rg()):(Ba=d,ce="value"in Ba?Ba.value:Ba.textContent,mb=!0)),e=Tj.getPooled(g,b,c,d),f?e.data=f:(f=ug(c),null!==f&&(e.data=f)),lb(e),f=e):f=null;(a=Vj?Oi(a,c):Pi(a,c))?(b=Uj.getPooled(ua.beforeInput,b,c,d),b.data=a,lb(b)):b=null;return null===f?b:null===b?f:[f,b]}},Qi={color:!0,date:!0,
datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0},Ag={change:{phasedRegistrationNames:{bubbled:"onChange",captured:"onChangeCapture"},dependencies:"blur change click focus input keydown keyup selectionchange".split(" ")}},Mb=null,Nb=null,kf=!1;wa&&(kf=Tf("input")&&(!document.documentMode||9<document.documentMode));var Xj={eventTypes:Ag,_isInputEventSupported:kf,extractEvents:function(a,b,c,d,e){e=b?Pa(b):window;var f=
e.nodeName&&e.nodeName.toLowerCase();if("select"===f||"input"===f&&"file"===e.type)var g=Si;else if(yg(e))if(kf)g=Wi;else{g=Ui;var h=Ti}else(f=e.nodeName)&&"input"===f.toLowerCase()&&("checkbox"===e.type||"radio"===e.type)&&(g=Vi);if(g&&(g=g(a,b)))return zg(g,c,d);h&&h(a,e,b);"blur"===a&&(a=e._wrapperState)&&a.controlled&&"number"===e.type&&Ed(e,"number",e.value)}},dc=R.extend({view:null,detail:null}),Yi={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"},di=0,ei=0,fi=!1,gi=!1,ec=dc.extend({screenX:null,
screenY:null,clientX:null,clientY:null,pageX:null,pageY:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,getModifierState:fe,button:null,buttons:null,relatedTarget:function(a){return a.relatedTarget||(a.fromElement===a.srcElement?a.toElement:a.fromElement)},movementX:function(a){if("movementX"in a)return a.movementX;var b=di;di=a.screenX;return fi?"mousemove"===a.type?a.screenX-b:0:(fi=!0,0)},movementY:function(a){if("movementY"in a)return a.movementY;var b=ei;ei=a.screenY;return gi?"mousemove"===
a.type?a.screenY-b:0:(gi=!0,0)}}),hi=ec.extend({pointerId:null,width:null,height:null,pressure:null,tangentialPressure:null,tiltX:null,tiltY:null,twist:null,pointerType:null,isPrimary:null}),fc={mouseEnter:{registrationName:"onMouseEnter",dependencies:["mouseout","mouseover"]},mouseLeave:{registrationName:"onMouseLeave",dependencies:["mouseout","mouseover"]},pointerEnter:{registrationName:"onPointerEnter",dependencies:["pointerout","pointerover"]},pointerLeave:{registrationName:"onPointerLeave",dependencies:["pointerout",
"pointerover"]}},Yj={eventTypes:fc,extractEvents:function(a,b,c,d,e){var f="mouseover"===a||"pointerover"===a,g="mouseout"===a||"pointerout"===a;if(f&&0===(e&32)&&(c.relatedTarget||c.fromElement)||!g&&!f)return null;f=d.window===d?d:(f=d.ownerDocument)?f.defaultView||f.parentWindow:window;if(g){if(g=b,b=(b=c.relatedTarget||c.toElement)?Bb(b):null,null!==b){var h=Na(b);if(b!==h||5!==b.tag&&6!==b.tag)b=null}}else g=null;if(g===b)return null;if("mouseout"===a||"mouseover"===a){var m=ec;var n=fc.mouseLeave;
var l=fc.mouseEnter;var k="mouse"}else if("pointerout"===a||"pointerover"===a)m=hi,n=fc.pointerLeave,l=fc.pointerEnter,k="pointer";a=null==g?f:Pa(g);f=null==b?f:Pa(b);n=m.getPooled(n,g,c,d);n.type=k+"leave";n.target=a;n.relatedTarget=f;c=m.getPooled(l,b,c,d);c.type=k+"enter";c.target=f;c.relatedTarget=a;d=g;k=b;if(d&&k)a:{m=d;l=k;g=0;for(a=m;a;a=pa(a))g++;a=0;for(b=l;b;b=pa(b))a++;for(;0<g-a;)m=pa(m),g--;for(;0<a-g;)l=pa(l),a--;for(;g--;){if(m===l||m===l.alternate)break a;m=pa(m);l=pa(l)}m=null}else m=
null;l=m;for(m=[];d&&d!==l;){g=d.alternate;if(null!==g&&g===l)break;m.push(d);d=pa(d)}for(d=[];k&&k!==l;){g=k.alternate;if(null!==g&&g===l)break;d.push(k);k=pa(k)}for(k=0;k<m.length;k++)be(m[k],"bubbled",n);for(k=d.length;0<k--;)be(d[k],"captured",c);return 0===(e&64)?[n]:[n,c]}},Qa="function"===typeof Object.is?Object.is:Zi,$i=Object.prototype.hasOwnProperty,Zj=wa&&"documentMode"in document&&11>=document.documentMode,Eg={select:{phasedRegistrationNames:{bubbled:"onSelect",captured:"onSelectCapture"},
dependencies:"blur contextmenu dragend focus keydown keyup mousedown mouseup selectionchange".split(" ")}},nb=null,he=null,Pb=null,ge=!1,ak={eventTypes:Eg,extractEvents:function(a,b,c,d,e,f){e=f||(d.window===d?d.document:9===d.nodeType?d:d.ownerDocument);if(!(f=!e)){a:{e=Jd(e);f=rd.onSelect;for(var g=0;g<f.length;g++)if(!e.has(f[g])){e=!1;break a}e=!0}f=!e}if(f)return null;e=b?Pa(b):window;switch(a){case "focus":if(yg(e)||"true"===e.contentEditable)nb=e,he=b,Pb=null;break;case "blur":Pb=he=nb=null;
break;case "mousedown":ge=!0;break;case "contextmenu":case "mouseup":case "dragend":return ge=!1,Dg(c,d);case "selectionchange":if(Zj)break;case "keydown":case "keyup":return Dg(c,d)}return null}},bk=R.extend({animationName:null,elapsedTime:null,pseudoElement:null}),ck=R.extend({clipboardData:function(a){return"clipboardData"in a?a.clipboardData:window.clipboardData}}),dk=dc.extend({relatedTarget:null}),ek={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",
Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},fk={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",
224:"Meta"},gk=dc.extend({key:function(a){if(a.key){var b=ek[a.key]||a.key;if("Unidentified"!==b)return b}return"keypress"===a.type?(a=Ac(a),13===a?"Enter":String.fromCharCode(a)):"keydown"===a.type||"keyup"===a.type?fk[a.keyCode]||"Unidentified":""},location:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,repeat:null,locale:null,getModifierState:fe,charCode:function(a){return"keypress"===a.type?Ac(a):0},keyCode:function(a){return"keydown"===a.type||"keyup"===a.type?a.keyCode:0},which:function(a){return"keypress"===
a.type?Ac(a):"keydown"===a.type||"keyup"===a.type?a.keyCode:0}}),hk=ec.extend({dataTransfer:null}),ik=dc.extend({touches:null,targetTouches:null,changedTouches:null,altKey:null,metaKey:null,ctrlKey:null,shiftKey:null,getModifierState:fe}),jk=R.extend({propertyName:null,elapsedTime:null,pseudoElement:null}),kk=ec.extend({deltaX:function(a){return"deltaX"in a?a.deltaX:"wheelDeltaX"in a?-a.wheelDeltaX:0},deltaY:function(a){return"deltaY"in a?a.deltaY:"wheelDeltaY"in a?-a.wheelDeltaY:"wheelDelta"in a?
-a.wheelDelta:0},deltaZ:null,deltaMode:null}),lk={eventTypes:dg,extractEvents:function(a,b,c,d,e){e=cg.get(a);if(!e)return null;switch(a){case "keypress":if(0===Ac(c))return null;case "keydown":case "keyup":a=gk;break;case "blur":case "focus":a=dk;break;case "click":if(2===c.button)return null;case "auxclick":case "dblclick":case "mousedown":case "mousemove":case "mouseup":case "mouseout":case "mouseover":case "contextmenu":a=ec;break;case "drag":case "dragend":case "dragenter":case "dragexit":case "dragleave":case "dragover":case "dragstart":case "drop":a=
hk;break;case "touchcancel":case "touchend":case "touchmove":case "touchstart":a=ik;break;case $h:case ai:case bi:a=bk;break;case ci:a=jk;break;case "scroll":a=dc;break;case "wheel":a=kk;break;case "copy":case "cut":case "paste":a=ck;break;case "gotpointercapture":case "lostpointercapture":case "pointercancel":case "pointerdown":case "pointermove":case "pointerout":case "pointerover":case "pointerup":a=hi;break;default:a=R}b=a.getPooled(e,b,c,d);lb(b);return b}};(function(a){if(ic)throw Error(k(101));
ic=Array.prototype.slice.call(a);nf()})("ResponderEventPlugin SimpleEventPlugin EnterLeaveEventPlugin ChangeEventPlugin SelectEventPlugin BeforeInputEventPlugin".split(" "));(function(a,b,c){td=a;rf=b;mf=c})(ae,Hb,Pa);pf({SimpleEventPlugin:lk,EnterLeaveEventPlugin:Yj,ChangeEventPlugin:Xj,SelectEventPlugin:ak,BeforeInputEventPlugin:Wj});var ie=[],ob=-1,Ca={},B={current:Ca},G={current:!1},Ra=Ca,bj=Pd,je=$f,Rg=Lj,aj=Nj,Dc=Oj,Ig=Zh,Jg=ag,Kg=Pj,Lg=Qj,Qg={},yj=Mj,Cj=void 0!==Yh?Yh:function(){},qa=null,
Ec=null,ke=!1,ii=ff(),Y=1E4>ii?ff:function(){return ff()-ii},Ic={current:null},Hc=null,qb=null,Gc=null,Tg=0,Jc=2,Ga=!1,Vb=da.ReactCurrentBatchConfig,$g=(new ea.Component).refs,Mc={isMounted:function(a){return(a=a._reactInternalFiber)?Na(a)===a:!1},enqueueSetState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;d=Va(d,a,e);e=Ea(d,e);e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueReplaceState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;
d=Va(d,a,e);e=Ea(d,e);e.tag=1;e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueForceUpdate:function(a,b){a=a._reactInternalFiber;var c=ka(),d=Vb.suspense;c=Va(c,a,d);d=Ea(c,d);d.tag=Jc;void 0!==b&&null!==b&&(d.callback=b);Fa(a,d);Ja(a,c)}},Qc=Array.isArray,wb=ah(!0),Fe=ah(!1),Sb={},ja={current:Sb},Ub={current:Sb},Tb={current:Sb},D={current:0},Sc=da.ReactCurrentDispatcher,X=da.ReactCurrentBatchConfig,Ia=0,z=null,K=null,J=null,Uc=!1,Tc={readContext:W,useCallback:S,useContext:S,
useEffect:S,useImperativeHandle:S,useLayoutEffect:S,useMemo:S,useReducer:S,useRef:S,useState:S,useDebugValue:S,useResponder:S,useDeferredValue:S,useTransition:S},dj={readContext:W,useCallback:ih,useContext:W,useEffect:eh,useImperativeHandle:function(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;return ze(4,2,gh.bind(null,b,a),c)},useLayoutEffect:function(a,b){return ze(4,2,a,b)},useMemo:function(a,b){var c=ub();b=void 0===b?null:b;a=a();c.memoizedState=[a,b];return a},useReducer:function(a,b,c){var d=
ub();b=void 0!==c?c(b):b;d.memoizedState=d.baseState=b;a=d.queue={pending:null,dispatch:null,lastRenderedReducer:a,lastRenderedState:b};a=a.dispatch=ch.bind(null,z,a);return[d.memoizedState,a]},useRef:function(a){var b=ub();a={current:a};return b.memoizedState=a},useState:xe,useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=xe(a),d=c[0],e=c[1];eh(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=
xe(!1),c=b[0];b=b[1];return[ih(Ce.bind(null,b,a),[b,a]),c]}},ej={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Vc,useRef:dh,useState:function(a){return Vc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Vc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Vc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,
b,a),[b,a]),c]}},fj={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Wc,useRef:dh,useState:function(a){return Wc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Wc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Wc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,b,a),[b,a]),c]}},ra=null,Ka=null,Wa=
!1,gj=da.ReactCurrentOwner,ia=!1,Je={dehydrated:null,retryTime:0};var jj=function(a,b,c,d){for(c=b.child;null!==c;){if(5===c.tag||6===c.tag)a.appendChild(c.stateNode);else if(4!==c.tag&&null!==c.child){c.child.return=c;c=c.child;continue}if(c===b)break;for(;null===c.sibling;){if(null===c.return||c.return===b)return;c=c.return}c.sibling.return=c.return;c=c.sibling}};var wh=function(a){};var ij=function(a,b,c,d,e){var f=a.memoizedProps;if(f!==d){var g=b.stateNode;Ta(ja.current);a=null;switch(c){case "input":f=
Cd(g,f);d=Cd(g,d);a=[];break;case "option":f=Fd(g,f);d=Fd(g,d);a=[];break;case "select":f=M({},f,{value:void 0});d=M({},d,{value:void 0});a=[];break;case "textarea":f=Gd(g,f);d=Gd(g,d);a=[];break;default:"function"!==typeof f.onClick&&"function"===typeof d.onClick&&(g.onclick=uc)}Ud(c,d);var h,m;c=null;for(h in f)if(!d.hasOwnProperty(h)&&f.hasOwnProperty(h)&&null!=f[h])if("style"===h)for(m in g=f[h],g)g.hasOwnProperty(m)&&(c||(c={}),c[m]="");else"dangerouslySetInnerHTML"!==h&&"children"!==h&&"suppressContentEditableWarning"!==
h&&"suppressHydrationWarning"!==h&&"autoFocus"!==h&&(db.hasOwnProperty(h)?a||(a=[]):(a=a||[]).push(h,null));for(h in d){var k=d[h];g=null!=f?f[h]:void 0;if(d.hasOwnProperty(h)&&k!==g&&(null!=k||null!=g))if("style"===h)if(g){for(m in g)!g.hasOwnProperty(m)||k&&k.hasOwnProperty(m)||(c||(c={}),c[m]="");for(m in k)k.hasOwnProperty(m)&&g[m]!==k[m]&&(c||(c={}),c[m]=k[m])}else c||(a||(a=[]),a.push(h,c)),c=k;else"dangerouslySetInnerHTML"===h?(k=k?k.__html:void 0,g=g?g.__html:void 0,null!=k&&g!==k&&(a=a||
[]).push(h,k)):"children"===h?g===k||"string"!==typeof k&&"number"!==typeof k||(a=a||[]).push(h,""+k):"suppressContentEditableWarning"!==h&&"suppressHydrationWarning"!==h&&(db.hasOwnProperty(h)?(null!=k&&oa(e,h),a||g===k||(a=[])):(a=a||[]).push(h,k))}c&&(a=a||[]).push("style",c);e=a;if(b.updateQueue=e)b.effectTag|=4}};var kj=function(a,b,c,d){c!==d&&(b.effectTag|=4)};var pj="function"===typeof WeakSet?WeakSet:Set,wj="function"===typeof WeakMap?WeakMap:Map,sj=Math.ceil,gd=da.ReactCurrentDispatcher,
Uh=da.ReactCurrentOwner,H=0,Ye=8,ca=16,ma=32,Xa=0,hd=1,Oh=2,ad=3,bd=4,Xe=5,p=H,U=null,t=null,P=0,F=Xa,id=null,ta=1073741823,Yb=1073741823,kd=null,Xb=0,jd=!1,Re=0,Ph=500,l=null,cd=!1,Se=null,La=null,ld=!1,Zb=null,$b=90,bb=null,ac=0,af=null,dd=0,Ja=function(a,b){if(50<ac)throw ac=0,af=null,Error(k(185));a=ed(a,b);if(null!==a){var c=Cc();1073741823===b?(p&Ye)!==H&&(p&(ca|ma))===H?Te(a):(V(a),p===H&&ha()):V(a);(p&4)===H||98!==c&&99!==c||(null===bb?bb=new Map([[a,b]]):(c=bb.get(a),(void 0===c||c>b)&&bb.set(a,
b)))}};var zj=function(a,b,c){var d=b.expirationTime;if(null!==a){var e=b.pendingProps;if(a.memoizedProps!==e||G.current)ia=!0;else{if(d<c){ia=!1;switch(b.tag){case 3:sh(b);Ee();break;case 5:bh(b);if(b.mode&4&&1!==c&&e.hidden)return b.expirationTime=b.childExpirationTime=1,null;break;case 1:N(b.type)&&Bc(b);break;case 4:se(b,b.stateNode.containerInfo);break;case 10:d=b.memoizedProps.value;e=b.type._context;y(Ic,e._currentValue);e._currentValue=d;break;case 13:if(null!==b.memoizedState){d=b.child.childExpirationTime;
if(0!==d&&d>=c)return th(a,b,c);y(D,D.current&1);b=sa(a,b,c);return null!==b?b.sibling:null}y(D,D.current&1);break;case 19:d=b.childExpirationTime>=c;if(0!==(a.effectTag&64)){if(d)return vh(a,b,c);b.effectTag|=64}e=b.memoizedState;null!==e&&(e.rendering=null,e.tail=null);y(D,D.current);if(!d)return null}return sa(a,b,c)}ia=!1}}else ia=!1;b.expirationTime=0;switch(b.tag){case 2:d=b.type;null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;e=pb(b,B.current);rb(b,c);e=we(null,
b,d,a,e,c);b.effectTag|=1;if("object"===typeof e&&null!==e&&"function"===typeof e.render&&void 0===e.$$typeof){b.tag=1;b.memoizedState=null;b.updateQueue=null;if(N(d)){var f=!0;Bc(b)}else f=!1;b.memoizedState=null!==e.state&&void 0!==e.state?e.state:null;ne(b);var g=d.getDerivedStateFromProps;"function"===typeof g&&Lc(b,d,g,a);e.updater=Mc;b.stateNode=e;e._reactInternalFiber=b;pe(b,d,a,c);b=Ie(null,b,d,!0,f,c)}else b.tag=0,T(null,b,e,c),b=b.child;return b;case 16:a:{e=b.elementType;null!==a&&(a.alternate=
null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;ri(e);if(1!==e._status)throw e._result;e=e._result;b.type=e;f=b.tag=Gj(e);a=aa(e,a);switch(f){case 0:b=He(null,b,e,a,c);break a;case 1:b=rh(null,b,e,a,c);break a;case 11:b=nh(null,b,e,a,c);break a;case 14:b=oh(null,b,e,aa(e.type,a),d,c);break a}throw Error(k(306,e,""));}return b;case 0:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),He(a,b,d,e,c);case 1:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),rh(a,b,d,e,c);
case 3:sh(b);d=b.updateQueue;if(null===a||null===d)throw Error(k(282));d=b.pendingProps;e=b.memoizedState;e=null!==e?e.element:null;oe(a,b);Qb(b,d,null,c);d=b.memoizedState.element;if(d===e)Ee(),b=sa(a,b,c);else{if(e=b.stateNode.hydrate)Ka=kb(b.stateNode.containerInfo.firstChild),ra=b,e=Wa=!0;if(e)for(c=Fe(b,null,d,c),b.child=c;c;)c.effectTag=c.effectTag&-3|1024,c=c.sibling;else T(a,b,d,c),Ee();b=b.child}return b;case 5:return bh(b),null===a&&De(b),d=b.type,e=b.pendingProps,f=null!==a?a.memoizedProps:
null,g=e.children,Yd(d,e)?g=null:null!==f&&Yd(d,f)&&(b.effectTag|=16),qh(a,b),b.mode&4&&1!==c&&e.hidden?(b.expirationTime=b.childExpirationTime=1,b=null):(T(a,b,g,c),b=b.child),b;case 6:return null===a&&De(b),null;case 13:return th(a,b,c);case 4:return se(b,b.stateNode.containerInfo),d=b.pendingProps,null===a?b.child=wb(b,null,d,c):T(a,b,d,c),b.child;case 11:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),nh(a,b,d,e,c);case 7:return T(a,b,b.pendingProps,c),b.child;case 8:return T(a,
b,b.pendingProps.children,c),b.child;case 12:return T(a,b,b.pendingProps.children,c),b.child;case 10:a:{d=b.type._context;e=b.pendingProps;g=b.memoizedProps;f=e.value;var h=b.type._context;y(Ic,h._currentValue);h._currentValue=f;if(null!==g)if(h=g.value,f=Qa(h,f)?0:("function"===typeof d._calculateChangedBits?d._calculateChangedBits(h,f):1073741823)|0,0===f){if(g.children===e.children&&!G.current){b=sa(a,b,c);break a}}else for(h=b.child,null!==h&&(h.return=b);null!==h;){var m=h.dependencies;if(null!==
m){g=h.child;for(var l=m.firstContext;null!==l;){if(l.context===d&&0!==(l.observedBits&f)){1===h.tag&&(l=Ea(c,null),l.tag=Jc,Fa(h,l));h.expirationTime<c&&(h.expirationTime=c);l=h.alternate;null!==l&&l.expirationTime<c&&(l.expirationTime=c);Sg(h.return,c);m.expirationTime<c&&(m.expirationTime=c);break}l=l.next}}else g=10===h.tag?h.type===b.type?null:h.child:h.child;if(null!==g)g.return=h;else for(g=h;null!==g;){if(g===b){g=null;break}h=g.sibling;if(null!==h){h.return=g.return;g=h;break}g=g.return}h=
g}T(a,b,e.children,c);b=b.child}return b;case 9:return e=b.type,f=b.pendingProps,d=f.children,rb(b,c),e=W(e,f.unstable_observedBits),d=d(e),b.effectTag|=1,T(a,b,d,c),b.child;case 14:return e=b.type,f=aa(e,b.pendingProps),f=aa(e.type,f),oh(a,b,e,f,d,c);case 15:return ph(a,b,b.type,b.pendingProps,d,c);case 17:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),b.tag=1,N(d)?(a=!0,Bc(b)):a=!1,rb(b,c),Yg(b,d,e),pe(b,d,e,c),Ie(null,
b,d,!0,a,c);case 19:return vh(a,b,c)}throw Error(k(156,b.tag));};var bf=null,Ne=null,la=function(a,b,c,d){return new Fj(a,b,c,d)};ef.prototype.render=function(a){md(a,this._internalRoot,null,null)};ef.prototype.unmount=function(){var a=this._internalRoot,b=a.containerInfo;md(null,a,null,function(){b[Lb]=null})};var Di=function(a){if(13===a.tag){var b=Fc(ka(),150,100);Ja(a,b);df(a,b)}};var Yf=function(a){13===a.tag&&(Ja(a,3),df(a,3))};var Bi=function(a){if(13===a.tag){var b=ka();b=Va(b,a,null);Ja(a,
b);df(a,b)}};sd=function(a,b,c){switch(b){case "input":Dd(a,c);b=c.name;if("radio"===c.type&&null!=b){for(c=a;c.parentNode;)c=c.parentNode;c=c.querySelectorAll("input[name="+JSON.stringify(""+b)+'][type="radio"]');for(b=0;b<c.length;b++){var d=c[b];if(d!==a&&d.form===a.form){var e=ae(d);if(!e)throw Error(k(90));Gf(d);Dd(d,e)}}}break;case "textarea":Lf(a,c);break;case "select":b=c.value,null!=b&&hb(a,!!c.multiple,b,!1)}};(function(a,b,c,d){ee=a;eg=b;vd=c;vf=d})(Qh,function(a,b,c,d,e){var f=p;p|=4;
try{return Da(98,a.bind(null,b,c,d,e))}finally{p=f,p===H&&ha()}},function(){(p&(1|ca|ma))===H&&(uj(),xb())},function(a,b){var c=p;p|=2;try{return a(b)}finally{p=c,p===H&&ha()}});var mk={Events:[Hb,Pa,ae,pf,qd,lb,function(a){Kd(a,Ki)},sf,tf,sc,pc,xb,{current:!1}]};(function(a){var b=a.findFiberByHostInstance;return Ej(M({},a,{overrideHookState:null,overrideProps:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:da.ReactCurrentDispatcher,findHostInstanceByFiber:function(a){a=Sf(a);
return null===a?null:a.stateNode},findFiberByHostInstance:function(a){return b?b(a):null},findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null}))})({findFiberByHostInstance:Bb,bundleType:0,version:"16.13.1",rendererPackageName:"react-dom"});I.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=mk;I.createPortal=Xh;I.findDOMNode=function(a){if(null==a)return null;if(1===a.nodeType)return a;var b=a._reactInternalFiber;if(void 0===
b){if("function"===typeof a.render)throw Error(k(188));throw Error(k(268,Object.keys(a)));}a=Sf(b);a=null===a?null:a.stateNode;return a};I.flushSync=function(a,b){if((p&(ca|ma))!==H)throw Error(k(187));var c=p;p|=1;try{return Da(99,a.bind(null,b))}finally{p=c,ha()}};I.hydrate=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!0,c)};I.render=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!1,c)};I.unmountComponentAtNode=function(a){if(!bc(a))throw Error(k(40));return a._reactRootContainer?
(Rh(function(){nd(null,null,a,!1,function(){a._reactRootContainer=null;a[Lb]=null})}),!0):!1};I.unstable_batchedUpdates=Qh;I.unstable_createPortal=function(a,b){return Xh(a,b,2<arguments.length&&void 0!==arguments[2]?arguments[2]:null)};I.unstable_renderSubtreeIntoContainer=function(a,b,c,d){if(!bc(c))throw Error(k(200));if(null==a||void 0===a._reactInternalFiber)throw Error(k(38));return nd(a,b,c,!1,d)};I.version="16.13.1"});
</script>
    <script>const e = React.createElement;

function pathToString(path) {
  if (path[0] === '/') {
    return '/' + path.slice(1).join('/');
  } else {
    return path.join('/');
  }
}

function findCommonPath(files) {
  if (!files || !files.length) {
    return [];
  }

  function isPrefix(arr, prefix) {
    if (arr.length < prefix.length) {
      return false;
    }
    for (let i = prefix.length - 1; i >= 0; --i) {
      if (arr[i] !== prefix[i]) {
        return false;
      }
    }
    return true;
  }

  let commonPath = files[0].path.slice(0, -1);
  while (commonPath.length) {
    if (files.every(file => isPrefix(file.path, commonPath))) {
      break;
    }
    commonPath.pop();
  }
  return commonPath;
}

function findFolders(files) {
  if (!files || !files.length) {
    return [];
  }

  let folders = files.filter(file => file.path.length > 1).map(file => file.path[0]);
  folders = [...new Set(folders)]; // unique
  folders.sort();

  folders = folders.map(folder => {
    let filesInFolder = files
      .filter(file => file.path[0] === folder)
      .map(file => ({
        ...file,
        path: file.path.slice(1),
        parent: [...file.parent, file.path[0]],
      }));

    const children = findFolders(filesInFolder); // recursion

    return {
      is_folder: true,
      path: [folder],
      parent: files[0].parent,
      children,
      covered: children.reduce((sum, file) => sum + file.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.coverable, 0),
      prevRun: {
        covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
        coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
      }
    };
  });

  return [
    ...folders,
    ...files.filter(file => file.path.length === 1),
  ];
}

class App extends React.Component {
  constructor(...args) {
    super(...args);

    this.state = {
      current: [],
    };
  }

  componentDidMount() {
    this.updateStateFromLocation();
    window.addEventListener("hashchange", () => this.updateStateFromLocation(), false);
  }

  updateStateFromLocation() {
    if (window.location.hash.length > 1) {
      const current = window.location.hash.substr(1).split('/');
      this.setState({current});
    } else {
      this.setState({current: []});
    }
  }

  getCurrentPath() {
    let file = this.props.root;
    let path = [file];
    for (let p of this.state.current) {
      file = file.children.find(file => file.path[0] === p);
      if (!file) {
        return path;
      }
      path.push(file);
    }
    return path;
  }

  render() {
    const path = this.getCurrentPath();
    const file = path[path.length - 1];

    let w = null;
    if (file.is_folder) {
      w = e(FilesList, {
        folder: file,
        onSelectFile: this.selectFile.bind(this),
        onBack: path.length > 1 ? this.back.bind(this) : null,
      });
    } else {
      w = e(DisplayFile, {
        file,
        onBack: this.back.bind(this),
      });
    }

    return e('div', {className: 'app'}, w);
  }

  selectFile(file) {
    this.setState(({current}) => {
      return {current: [...current, file.path[0]]};
    }, () => this.updateHash());
  }

  back(file) {
    this.setState(({current}) => {
      return {current: current.slice(0, current.length - 1)};
    }, () => this.updateHash());
  }

  updateHash() {
    if (!this.state.current || !this.state.current.length) {
      window.location = '#';
    } else {
      window.location = '#' + this.state.current.join('/');
    }
  }
}

function FilesList({folder, onSelectFile, onBack}) {
  let files = folder.children;
  return e('div', {className: 'display-folder'},
    e(FileHeader, {file: folder, onBack}),
    e('table', {className: 'files-list'},
      e('thead', {className: 'files-list__head'},
        e('tr', null,
          e('th', null, "Path"),
          e('th', null, "Coverage")
        )
      ),
      e('tbody', {className: 'files-list__body'},
        files.map(file => e(File, {file, onClick: onSelectFile}))
      )
    )
  );
}

function File({file, onClick}) {
  const coverage = file.coverable ? file.covered / file.coverable * 100 : -1;
  const coverageDelta = file.prevRun &&
    (file.covered / file.coverable * 100 - file.prevRun.covered / file.prevRun.coverable * 100);

  return e('tr', {
      className: 'files-list__file'
        + (coverage >= 0 && coverage < 50 ? ' files-list__file_low': '')
        + (coverage >= 50 && coverage < 80 ? ' files-list__file_medium': '')
        + (coverage >= 80 ? ' files-list__file_high': '')
        + (file.is_folder ? ' files-list__file_folder': ''),
      onClick: () => onClick(file),
    },
    e('td', null, e('a', null, pathToString(file.path))),
    e('td', null,
      file.covered + ' / ' + file.coverable +
      (coverage >= 0 ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e('span', {title: 'Change from the previous run'},
        (coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : ''))
    )
  );
}

function DisplayFile({file, onBack}) {
  return e('div', {className: 'display-file'},
    e(FileHeader, {file, onBack}),
    e(FileContent, {file})
  );
}

function FileHeader({file, onBack}) {
  const coverage = file.covered / file.coverable * 100;
  const coverageDelta = file.prevRun && (coverage - file.prevRun.covered / file.prevRun.coverable * 100);

  return e('div', {className: 'file-header'},
    onBack ? e('a', {className: 'file-header__back', onClick: onBack}, 'Back') : null,
    e('div', {className: 'file-header__name'}, pathToString([...file.parent, ...file.path])),
    e('div', {className: 'file-header__stat'},
      'Covered: ' + file.covered + ' of ' + file.coverable +
      (file.coverable ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e('span', {title: 'Change from the previous run'},
        (coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : ''))
    )
  );
}

function FileContent({file}) {
  return e('pre', {className: 'file-content'},
    file.content.split(/\r?\n/).map((line, index) => {
      const trace = file.traces.find(trace => trace.line === index + 1);
      const covered = trace && trace.stats.Line;
      const uncovered = trace && !trace.stats.Line;
      return e('code', {
          className: 'code-line'
            + (covered ? ' code-line_covered' : '')
            + (uncovered ? ' code-line_uncovered' : ''),
          title: trace ? JSON.stringify(trace.stats, null, 2) : null,
        }, line);
    })
  );
}

(function(){
  const commonPath = findCommonPath(data.files);
  const prevFilesMap = new Map();

  previousData && previousData.files.forEach((file) => {
    const path = file.path.slice(commonPath.length).join('/');
    prevFilesMap.set(path, file);
  });

  const files = data.files.map((file) => {
    const path = file.path.slice(commonPath.length);
    const { covered = 0, coverable = 0 } = prevFilesMap.get(path.join('/')) || {};
    return {
      ...file,
      path,
      parent: commonPath,
      prevRun: { covered, coverable },
    };
  });

  const children = findFolders(files);

  const root = {
    is_folder: true,
    children,
    path: commonPath,
    parent: [],
    covered: children.reduce((sum, file) => sum + file.covered, 0),
    coverable: children.reduce((sum, file) => sum + file.coverable, 0),
    prevRun: {
      covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
    }
  };

  ReactDOM.render(e(App, {root, prevFilesMap}), document.getElementById('root'));
}());
</script>
</body>
</html>